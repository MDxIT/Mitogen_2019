config
  steps
    stepGroup Broken

    step Edit Storage Location
      form
        include userAccountInfo
        vertical
          text storageContainerId
            screenLabel~ Storage Container ID:
      form
        include userAccountInfo
        vertical
          text storageContainerId
            screenLabel~ Searched for string:
            value= {storageContainerId}
        table
          sqlQuery~
            - select
            -   storageContainerId
            # -   , '' as "new id"
            -   , type
            -   , model
            -   , description
            -   , 'false' as "update"
            - from storageContainerInfo
            - where storageContainerId LIKE '%{storageContainerId}%'
          columnSpecs~ storeInfo
            allowChangedRecordIds
            column 1
              inputType container
                readonly=
                acceptQueue~ any
                size= 35

            # column 2
            #   inputType text
            #     size= 35
            #     validate~ ! select 1 from containers where containerId = '{_thisInput}'
            #       errorMessage~ You must enter a brand new container. This container already exists.
            column 2
              inputType select
                sqlQuery~ select distinct type
                  - from storageContainerInfo
            column 3
              inputType select
                sqlQuery~ select distinct model
                  - from storageContainerInfo
            column 4
              inputType textArea
            column 5
              inputType checkbox
      forRows storeInfo
        ifCondition {_columnInput_storeInfo:5}
          advanced~
          equals~ true
          # sqlPreparedStatement~ update containers
          #   - set containerId = (CASE WHEN ? = '' THEN ? ELSE ? END)
          #   - , containerType = case WHEN ? = 'Storage Unit' then ? else ? end
          #   - where containerId = ?
          #   string {_columnInput_storeInfo:2}
          #   string {_columnInput_storeInfo:1}
          #   string {_columnInput_storeInfo:2}
          #   string {_columnInput_storeInfo:3}
          #   string {_columnInput_storeInfo:3}
          #   string {_columnInput_storeInfo:1}
          #   string {_columnInput_storeInfo:1}
          sqlPreparedStatement~ update storageContainerInfo
            - set type = ?
            - ,model = ?
            - ,description = ?
            - ,eventId = ?
            - where storageContainerId = ?
            # string {_columnInput_storeInfo:2}
            # string {_columnInput_storeInfo:1}
            # string {_columnInput_storeInfo:2}
            string {_columnInput_storeInfo:4}
            string {_columnInput_storeInfo:5}
            string {_columnInput_storeInfo:6}
            long {_eventId}
            string {_columnInput_storeInfo:1}
          # sqlPreparedStatement~ update storage
          #   - set storageContainerId = CASE WHEN ? = '' THEN ? ELSE ? END
          #   - where storageContainerId = ?
          #   string {_columnInput_storeInfo:2}
          #   string {_columnInput_storeInfo:1}
          #   string {_columnInput_storeInfo:2}
          #   string {_columnInput_storeInfo:1}
          # sqlPreparedStatement~ update storage
          #   - set content = CASE WHEN ? = '' THEN ? ELSE ? END
          #   - where content = ?
          #   string {_columnInput_storeInfo:2}
          #   string {_columnInput_storeInfo:1}
          #   string {_columnInput_storeInfo:2}
          #   string {_columnInput_storeInfo:1}
          #sqlPreparedStatement~ update storage
          #  - set storagePath = getStorageParentage(content)
          #  - where content = CASE WHEN ? = '' THEN ? ELSE ? END
          #  string {_columnInput_storeInfo:2}
          #  string {_columnInput_storeInfo:1}
          #  string {_columnInput_storeInfo:2}

    #######################################################
    step Keyword Search
      form
        include userAccountInfo
        vertical
          text Keyword
            required~ true
      form
        include userAccountInfo
        vertical
          table
            class= stdTableSort
            sqlQuery~
              - SELECT c.containerId AS "Sample Info Id", c.containerType as 'Container Type', al.containerId AS "Storage ID", al.containerId AS "RemoveFromStorageId", sp.Property, sp.Value
              - FROM containers c
              - LEFT JOIN (SELECT c.content, co.containerId
              -            FROM contents c
              -            INNER JOIN containers co
              -            ON c.containerId = co.containerId
              -            AND c.attribute = 'self'
              -            AND (c.contentType = 'specimenId' or c.contentType = 'oncoDxId' or c.contentType = 'aliquotId')) al
              - on c.containerId = al.content
              - LEFT JOIN sampleProperties sp
              - ON c.containerId = sp.sampleId
              - AND sp.value LIKE '%{Keyword}%'
              - WHERE (c.containerType = 'specimenId' or c.containerType = 'oncoDxId' or c.containerType= 'aliquotId')
              - AND sp.value <> ''


    step Sample Info Search
      form
        include userAccountInfo
        script
          - $(document).ready(function() {
          -   $('#stepFormSubmitButton').remove();
          -   $(window).scrollTop($('#topNavigationBar').offset().top).scrollLeft($('#topNavigationBar').offset().left);
          -   $('.rangeFrom').parent('td').append('<div class="dateFormat">(mm/dd/yyyy)</div>');
          -   $('.rangeTo').parent('td').append('<div class="dateFormat">(mm/dd/yyyy)</div>');
          -   $('.dateFormat').hide();
          -   $('.property').change(function() {
          -     $(this).attr('selection', $(this).val().length);
          -     if($(this).val() != 'Actual Volume (mL)'
          +         && $(this).val() != 'Concentration (ug/uL)'
          +         &&  $(this).val() != 'Filters Used'
          +         &&  $(this).val() != 'PSA Level (ng/mL)'
          +         &&  $(this).val() != 'Submitted Volume (mL)'
          +         &&  $(this).val() != 'Total Volume Collected (mL)'
          +         &&  $(this).val() !=  'volume'
          +         &&  $(this).val() !=  'Volume (mL)'
          +         && $(this).val().indexOf('Date') == -1
          +         && $(this).val().indexOf('Time') == -1) {
          -       $(this).removeClass('date');
          -       $(this).parent().siblings().children('.rangeFrom').datepicker("destroy");
          -       $(this).parent().siblings().children('.rangeTo').datepicker("destroy");
          -       $(this).parent().siblings().children('.dateFormat').hide()
          -       $(this).parent().siblings().children('.rangeFrom').hide();
          -       $(this).parent().siblings().children('.rangeTo').hide();
          -       $(this).parent().siblings().children('.propertyValues').show();
          -       $(this).parent().siblings().children('.rangeFrom').parent().css('background-color', 'gray');
          -       $(this).parent().siblings().children('.rangeTo').parent().css('background-color', 'gray');
          -       $(this).parent().siblings().children('.propertyValues').parent().css('background-color', 'white');
          -       $(this).parent().siblings().children('.propertyValues').load('/uniflow',{stepName: 'Ajax Search for Sample Property Values', property: $(this).val()});
          -       $(this).addClass('whereValue');
          -       $(this).removeClass('whereRange');
          -     } else {
          -       if($(this).val().indexOf('Date') != -1) {
          -         $(this).addClass('date');
          -         $(this).parent().siblings().children('.rangeFrom').datepicker();
          -         $(this).parent().siblings().children('.rangeTo').datepicker();
          -         $(this).parent().siblings().children('.dateFormat').show()
          -       } else {
          -         $(this).removeClass('date');
          -         $(this).parent().siblings().children('.rangeFrom').datepicker("destroy");
          -         $(this).parent().siblings().children('.rangeTo').datepicker("destroy");
          -         $(this).parent().siblings().children('.dateFormat').hide()
          -       }
          -       $(this).parent().siblings().children('.rangeFrom').show();
          -       $(this).parent().siblings().children('.rangeTo').show();
          -       $(this).parent().siblings().children('.propertyValues').hide();
          -       $(this).parent().siblings().children('.rangeFrom').parent().css('background-color', 'white');
          -       $(this).parent().siblings().children('.rangeTo').parent().css('background-color', 'white');
          -       $(this).parent().siblings().children('.propertyValues').parent().css('background-color', 'gray');
          -       $(this).removeClass('whereValue');
          -       $(this).addClass('whereRange');
          -
          -     }
          -   });
          -   $('#search').click(function() {
          -   var selectStatement = "select q.SampleID,  q.Storage_Location, q.Practice";
          -   var subQuerySelect = " from (select
          +                       co.containerId as SampleID
          +                       , ifnull(s.storagePath, 'not in storage') as Storage_Location
          +                       , pra.Practice"
          -   var subQueryFrom = "
          #Specimen
          +                     from containers co
          #StorageLocation
          +                     left join storage s
          +                     on co.containerId = s.content
          #Practice
          +                     left join (
          +                       select distinct c.content, e.firstName as Practice, e.entityID
          +                       from contents c
          +                       inner join entityRelations er
          +                       on c.containerId = er.memberId
          +                       inner join entities e
          +                       on er.entityId = e.entityId
          +                       where c.contentType = 'specimenId'
          +                       and er.role = 'Patient'
          +                       and e.entityType = 'Organization') pra
          +                     on co.containerId = pra.content";
          -   var subQueryWhere = " where (co.containerType = 'specimenId' or co.containerType = 'oncoDxId')
          +                     and co.containerId <> ''";
          -     $('#spinnerDiv').show();
          -     var whereStatement = "where q.Practice LIKE '" + $('#practice').val() + "'";
          -     var whereStatement2 = '';
          -     var execSQL = '';
          -     var colName = '';
          -     var noCol = $('.property:not([selection="0"])').length;
          -     $('.property:not([selection="0"])').each(function() {
          -         colName = $(this).val().replace(/\s/g, '_').replace(/\(/g, '_').replace(/\)/g, '_').replace(/\//g, '_');
          -         selectStatement = selectStatement + ',q.' + colName;
          -         subQuerySelect = subQuerySelect + ", sp" + noCol + ".value as " + colName;
          -         subQueryFrom = subQueryFrom + " left join sampleProperties sp" + noCol + " on co.containerId = sp" + noCol + ".sampleId and '" + $(this).val() + "' = sp" + noCol + ".property";
          -         subQueryWhere = subQueryWhere ;
          -         if ($(this).hasClass('whereValue')) {
          -           whereStatement2 = whereStatement2 + " and ifnull(q." + colName + ", '') like '" + $(this).parent().siblings().children('.propertyValues').val() + "'";
          -         } else {
          -           if($(this).hasClass('date')) {
          -             whereStatement2 = whereStatement2 + " and ifnull(q." + colName + ", '1900-01-01') between case '" + $(this).parent().siblings().children('.rangeFrom').val() + "' when '' then '1900-01-01' else str_to_date('" + $(this).parent().siblings().children('.rangeFrom').val() + "', '%m/%d/%Y') end and case '" + $(this).parent().siblings().children('.rangeTo').val() + "' when '' then '2100-01-01' else str_to_date('" + $(this).parent().siblings().children('.rangeTo').val() + "', '%m/%d/%Y') end";
          -           } else {
          -             whereStatement2 = whereStatement2 + " and ifnull(q." + colName + ", '') between case '" + $(this).parent().siblings().children('.rangeFrom').val() + "' when '' then 0 else '" + $(this).parent().siblings().children('.rangeFrom').val() + "' end and case '" + $(this).parent().siblings().children('.rangeTo').val() + "' when '' then 10000 else '" + $(this).parent().siblings().children('.rangeTo').val() + "' end";
          -           }
          -         }
          -         noCol = noCol - 1;
          -     });
          -     execSQL = selectStatement + subQuerySelect + subQueryFrom + subQueryWhere + "GROUP BY co.containerId) q " + whereStatement + whereStatement2;
          -     $('#execSQL').val(execSQL);
          -     $("#results").load(
          -       '/uniflow',
          -       {stepName: 'Ajax Execute Query', SQL: execSQL},
          -       function(){
          -         $('#spinnerDiv').hide();
          -         $(window).scrollTop($('#results').offset().top).scrollLeft($('#results').offset().left);
          -
          -         var magic = $('.resultsTable').DataTable({
          -                                           "dom": 'Bfrtip',
          -         buttons: [
          -         'copy', 'csv', 'excel', 'pdf', 'print','colvis'
          -         ]
          -                                        });
          -         magic.columns().eq(0).each(function(colIdx) {
          -           $( 'input', magic.column(colIdx).footer()).on('keyup change', function() {
          -             magic.column(colIdx).search(this.value).draw();
          -           });
          -         });
          -
          -       }
          -     );
          -   });
          - });
        vertical
          fieldset
            legend Select Search Criteria
              class= legend
            div
              id= spinnerDiv
              style= position:fixed;width:150px;left:50%;margin-left: -75px; display:none;
              img
                src= images/spinner.gif
                style= width:150px;
            vertical
              select practice
                id= practice
                screenLabel~ Practice/Source Group
                option %
                sqlQuery~
                  - select firstName
                  - from entities
                  - where entityType = 'Organization'
                  - order by firstName
            vertical
              table
                sqlQuery~
                  - select
                  -   '' as "Property",
                  -   '' as "Value",
                  -   '' as "From",
                  -   '' as "To"
                  - FROM numbers
                  - limit 10
                columnSpecs~ d
                  column 1
                    inputType select
                      option
                      sqlQuery~
                        - select distinct property
                        - from sampleProperties
                        - order by property
                      class= property searchCriteria
                      selection= 0
                  column 2
                    inputType select
                      option %
                      class= propertyValues
                  column 3
                    inputType number
                      class= rangeFrom
                  column 4
                    inputType number
                      class= rangeTo
              button Search
                id= search
                screenLabel~
                a
                  href= #results
              div
                style= display:none;
                textAreaUnEscaped SQL
                  id= execSQL
            div
              id= results


    step Visual Search
      form
        include userAccountInfo
        include d3
        style
          type= text/css
        style
          - rect {
          -   stroke: #fff;
          - }
          - .label {
          #-   font: 10px sans-serif;
          #-   text-anchor: middle;
          - }
        script
          - var mouseX;
          - var mouseY;
          - var stepDivX;
          - var stepDivY;
          - $(document).ready(function() {
          -   var stepDivOffset = $('.step-div').offset();
          -   stepDivX = stepDivOffset.left;
          -   stepDivY = stepDivOffset.top;
          -   $(document).mousemove(function(event) {
          -     mouseX = event.pageX;
          -     mouseY = event.pageY;
          -   });
          #-   $('[name="stepForm"]').bind("keyup", function(e) {
          #-     var code = e.keyCode || e.which;
          #-     if (code  == 13) {
          #-       e.preventDefault();
          #-       doStuff(d3.select($('#'+ $('#searchItem').val()))[0][0][0].__data__);
          #-       return false;
          #-     }
          #-   });
          -   $('#stepFormSubmitButton').remove();
          - var w = 960,
          -     h = 1200,
          -     x = d3.scale.linear().range([0, w]),
          -     y = d3.scale.linear().range([0, h]),
          -     color = d3.scale.category20c();

          - var vis = d3.select("#d3Location").append("svg:svg")
          -     .attr("width", w)
          -     .attr("height", h);

          - var partition = d3.layout.partition()
          -     .children(function(d) { return isNaN(d.value) ? d3.entries(d.value) : null; })
          -     .value(function(d) { return d.value; });

          - $.getJSON('/uniflow?callback=?',{stepName: 'Ajax Archive System'},
          -  function(data,status) {
          -    var containers = {};
          -    var len = data.length;
          -    for (var i = 0; i < len; i++) containers[data[i].storageContainerId] = {};
          -    for (var i = 0; i < len; i++) {
          -      var datum = data[i];
          -      var container = containers[datum.storageContainerId];
          -      container[datum.content] = containers[datum.content] ? containers[datum.content] : datum.sizeCategory;
          -    }
          -    var json = {'ARCHIVE SYSTEM':containers['ARCHIVE SYSTEM']};
          # -  });

          # - d3.json("readme.json", function(json) {
          -   //var data = data(partition(d3.entries([json])[0]));
          -   //console.log(data);
          -   //console.log(d3.entries(json)[0]);
          -   var cell = vis.selectAll("g")
          -       .data(partition(d3.entries(json)[0]))
          -     .enter().append("svg:g")
          #-       .prop("safeD", d3.d)
          -       .attr("transform", function(d) {return "translate(" + x(d.x) + "," + y(d.y) + ")"; })

          #.attr("transform", function(d) {d.g = this; d.g.x = d.x;d.g.oldy = d.y; d.g.markIx = 0;return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; });
          #-     .each(function(d) {d.elements.push(this); })
          -       .on("click", doStuff)
          -       .on("mouseenter", showInfo)
          -       .on("mouseleave", hideInfo);

          -       //.attr("x", function(d) { return x(d.x); })
          -       //.attr("y", function(d) { return y(d.y); });

          -   var rect = cell.append("svg:rect")
          -       .attr("width", function(d) { return x(d.dx); })
          -       .attr("height", function(d) { return y(d.dy); })
          -       .attr("id", function(d) { return d.key; })
          -       .attr("fill", function(d) { return color((d.children ? d : d.parent).key); });


          -   var text = cell.append("svg:text")
          -        .attr("class", "label")
          -        .attr("dx", ".35em")
          -        .attr("dy", "-.35em")
          -        .attr("font-size", function(d) { if(x(d.dx) < 18){return 0} else{return '18px'}; })
          #-       .attr("y",function(d) { return y(d.y); }+200)
          #-       .attr("x",function(d) { return x(d.x); }+15)
          -       .attr("transform", function(d) { return "translate(" + (d.x + d.dx / 2) + "," + (d.y + d.dy / 2) + ")rotate(90)"; })
          -       .text(function(d) { return d.key;});

          -   $('#searchItem').change(function() {
          -     var item = $(this).val();
          -     $(this).select();
          -     $(this).focus();
          -     var array0 = 0;
          #-     console.log(d3.select($('#'+ item)));
          -     console.log(d3.select($('#'+ item))[0][0]);
          -     console.log(d3.select($('#'+ item))[0][0][0].__data__);
          -     doStuff(d3.select($('#'+ item))[0][0][0].__data__);
          -   });

          -   function doStuff(d) {
          -     console.log('click',d)
          -     x.domain([d.x, d.x + d.dx]);
          -     y.domain([d.y, 1]).range([d.y ? 20 : 0, h]);
          -     cell.transition()
          -       .attr("transform", function(d) { return "translate(" + x(d.x) + "," + y(d.y) + ")"; })
          -         .attr("x", function(d) { return x(d.x); })
          -         .attr("y", function(d) { return y(d.y); });

          -     rect.transition()
          -        .duration(750)
          -       //.attr("transform", function(d) { return "translate(" + x(d.x) + "," + y(d.y) + ")"; })
          -       //.attr("x", function(d) { return x(d.x); })
          -       //.attr("y", function(d) { return y(d.y); })
          -       .attr("width", function(d) { return x(d.x + d.dx) - x(d.x); })
          -       .attr("height", function(d) { return y(d.y + d.dy) - y(d.y); });

          -     text.transition()
          -       .duration(750)
          -        .attr("font-size", function(d) { if(x(d.x + d.dx) - x(d.x) < 18){return 0} else{return '18px'}; });
          -   }

          -   function showInfo(d) {
          -     $('#sampleInfo').hide();
          -     var color = $(this).children('rect').attr('fill');
          -     $('#sampleInfo').load('uniflow?callback=?&stepName=Ajax+Get+Stored+Sample+Info&specimenId=' + $(this).children('text').html(),
          -       function(){
          -         $('#sampleInfo').show();
          -         $('#sampleInfo').css({
          -           position:'absolute',
          -           top: mouseY-stepDivY+10,
          -           left: mouseX-stepDivX+10});
          -         $('.specInfoTable > tbody > tr > td.col0').css({'background-color': color, 'text-align':'right'});
          -         $('.specInfoTable > tbody > tr > td').css({'border': '2px solid ' + color, 'border-collapse':'collapse'});
          -         $('.specInfoTable').css({'border-collapse':'collapse'});
          -     });
          -   }

          -   function hideInfo(d) {
          -     $('#sampleInfo').hide();
          -   }
          - });

          - });
        vertical
          text Search Item
            id= searchItem
        div
          id= d3Location
        div
          style= width:200px;
          id= sampleInfo


    step SQL Query
      authorizedGroup UNICONNECT
      authorizedGroup SQLUsers
      accessLevel 12
      form
        include userAccountInfo
        fieldset
          legend Notes
            class= legend
          vertical
            li Only SELECT statements are allowed.
            li Data manipulating SQL (DELETE, UPDATE, INSERT), will return a system exeption.
            li If you include the storageContainerId as a column, the link will drill down to <b>Search Storage</b>.
            li The eventId will also generate a link to <b>Event Details</b>.
        vertical
          textAreaUnEscaped SQL Query
            style= height: 150px; width: 500px
      form
        include userAccountInfo
        table
          sqlQuery~ {SQL Query}


    step Search Aliquots
      form
       include userAccountInfo
        vertical
          text Specimen ID
            required~ true
      form
        formQuery~ select case '{_recId}' when '' then '{Specimen ID}' when 'null' then '{Specimen ID}' else '{_recId}' end as "exoId" from dual
        include userAccountInfo
        vertical
          text Specimen ID
            value= {Specimen ID}
            readonly=
          table
            sqlPreparedQuery~ SELECT c.content AS "Aliquot ID", sp.value AS "Sample Status", sp2.value AS "Aliquot Volume (mL)", case isnull(storagePath) when 1 then 'Not in Storage' else storagePath end as "Storage Location"
              - FROM contents c
              - INNER JOIN containers co
              - ON c.containerId = co.containerId
              - LEFT JOIN sampleProperties sp
              - ON c.content = sp.sampleId
              - AND sp.property = 'status'
              - LEFT JOIN sampleProperties sp2
              - ON c.content = sp2.sampleId
              - AND sp2.property = 'Volume (mL)'
              - left join storage s
              - on c.content = s.content
              - WHERE co.containerId = '{_:exoId}'
              - AND c.attribute = 'self'
              - AND (c.contentType = 'aliquotId' or c.contentType = 'oncoDxId')


    ####################################################################################################
    step Specimen Information
      form
        include userAccountInfo
        fieldset
          legend Instructions
            class= legend
          ul
            li To view/edit exisitng specimen information enter specimen id and submit.
            li To add aliquots to existing specimen enter specimen id and the number of aliquots you would like to create.
            li To enter aliquots without a parent specimen only enter the number of aliquots you would like to create.
            li To enter aliquots with different parent specimen but with information from an existing specimen enter existing specimen id, check Use Info checkbox and enter number of aliquots to create.
            li For creating aliquots without a parent or copying specimen information, a parent id is auto-generated by UNIFlow. This Id can be edited on the next form.
        vertical
          passiveContainer specimenId
            screenLabel~ Specimen ID
            acceptQueue~ any
            style= width:200px
            required~ false
          checkbox copyInfo
            span Use information from Specimen ID for different set of aliquots.
          number aliquots
            screenLabel~ # of Aliquots
            value= 0
            size= 3
      form
        include userAccountInfo
        script
          src= js/jquery/combobox.js
        script
          - $(document).ready(function() {
          -   $('th:contains("hidden")').hide();
          -   $('.hide').parent().hide();
          #-   $('#siteCode').change(function(){
          #-     serachPhysicianBySiteCode()
          #-   });
          -   $('#physicianId').combobox({select: function(event, ui){
          -     searchPracticesByPhysician();
          -     $('#correctPractice').show();
          -     $.getJSON('/uniflow?callback=?&stepName=Ajax+Physician+NPI+Load&physicianId=' + $('#physicianId').val(),{}, function(data,status) {
          -       $('#npi').val(data[0].npi);
          -     });
          -   } });
          -   $('.date').datepicker();
          - });
          - function searchPracticesByPhysician() {
          -   $('#organizationId').load('/uniflow',{stepName: 'Ajax Practices By Physician Search Server', physicianId: $('#physicianId').val()});
          - }
          - function serachPhysicianBySiteCode() {
          -     $.getJSON('/uniflow?callback=?&stepName=Ajax+Physician+By+Site+Code+Search+Server&siteCode=' + $('#siteCode').val(),{}, function(data,status) {
          -       if(data.length == 0) { alert('Site Code not found'); return;}
          -       $('#physicianId').combobox('val', data[0].physicianId);
          -       searchPracticesByPhysician();
          -     });
          - }
          - function searchPatients() {
          -   $('#patientsCandidates').load('/uniflow', {stepName: 'Ajax Patients Search Server',
          -     firstName: $('#patientFirstName').val(),
          -     lastName: $('#patientLastName').val(),
          -     DOB: $('#patientDOB').val(),
          -     SSN: $('#patientSSN').val(),
          -     gender: $('#patientType').val()
          -   });
          - }
          -
          - function setPatient(patientId) {
          -   var patientId = $('#patientId').val();
          -   $.getJSON('/uniflow?callback=?&stepName=Ajax+Patient+Server&patientId=' + patientId,{},
          -     function(data,status) {
          -       $('#patientsCandidates').css('display','none');
          -       document.getElementsByName('newPatientId')[0].value = data[0].Id;
          -       document.getElementsByName('firstName')[0].value = data[0].firstName;
          -       document.getElementsByName('lastName')[0].value = data[0].lastName;
          -       document.getElementsByName('middleName')[0].value = data[0].middleName;
          -       document.getElementsByName('dob')[0].value = data[0].dob;
          -       document.getElementsByName('ssn')[0].value = data[0].ssn;
          -       document.getElementsByName('newPatientGender')[0].value = data[0].gender;
          -       document.getElementsByName('mrn')[0].value = data[0].mrn;
          -       document.getElementsByName('ethnicity')[0].value = data[0].ethnicity;
          -       document.getElementsByName('medications')[0].value = data[0].medications;
          -       document.getElementsByName('problemMedications')[0].value = data[0].problemMedications;
          -       document.getElementsByName('allergies')[0].value = data[0].allergies;
          -       document.getElementsByName('address1')[0].value = data[0].address1;
          -       document.getElementsByName('address2')[0].value = data[0].address2;
          -       document.getElementsByName('city')[0].value = data[0].city;
          -       document.getElementsByName('state')[0].value = data[0].state;
          -       document.getElementsByName('postalCode')[0].value = data[0].postalCode;
          -       document.getElementsByName('country')[0].value = data[0].country;
          -       document.getElementsByName('homePhone')[0].value = data[0].homePhone;
          -       document.getElementsByName('cellPhone')[0].value = data[0].cellPhone;
          -       document.getElementsByName('altPhone')[0].value = data[0].altPhone;
          -       document.getElementsByName('email')[0].value = data[0].email;
          -     }
          -   );
          -   $.getJSON('/uniflow?callback=?&stepName=Ajax+Billing+Server&patientId=' + patientId,{},
          -     function(data,status) {
          -       document.getElementsByName('paymentOption')[0].value = data[0].paymentOption;
          -       document.getElementsByName('medicareNumber')[0].value = data[0].medicareNumber;
          -       document.getElementsByName('parentSignature')[0].value = data[0].parentSignature;
          -       document.getElementsByName('guarantorName')[0].value = data[0].guarantor;
          -       document.getElementsByName('policyHolderName_1')[0].value = data[0].policyHolderName_1;
          -       document.getElementsByName('relationship_1')[0].value = data[0].relationship_1;
          -       document.getElementsByName('insuranceCompany_1')[0].value = data[0].insuranceCompany_1;
          -       document.getElementsByName('policyNumber_1')[0].value = data[0].policyNumber_1;
          -       document.getElementsByName('groupNumber_1')[0].value = data[0].groupNumber_1;
          -       document.getElementsByName('responsibleAddress1_1')[0].value = data[0].responsibleAddress1_1;
          -       document.getElementsByName('responsibleAddress2_1')[0].value = data[0].responsibleAddress2_1;
          -       document.getElementsByName('responsibleCity_1')[0].value = data[0].responsibleCity_1;
          -       document.getElementsByName('responsibleState_1')[0].value = data[0].responsibleState_1;
          -       document.getElementsByName('responsibleZip_1')[0].value = data[0].responsibleZip_1;
          -       document.getElementsByName('phone_1')[0].value = data[0].phone_1;
          -       document.getElementsByName('policyHolderId_1')[0].value = data[0].policyHolderId_1;
          -       document.getElementsByName('policyHolderDOB_1')[0].value = data[0].policyHolderDOB_1;
          -       document.getElementsByName('policyHolderName_2')[0].value = data[0].policyHolderName_2;
          -       document.getElementsByName('relationship_2')[0].value = data[0].relationship_2;
          -       document.getElementsByName('insuranceCompany_2')[0].value = data[0].insuranceCompany_2;
          -       document.getElementsByName('policyNumber_2')[0].value = data[0].policyNumber_2;
          -       document.getElementsByName('groupNumber_2')[0].value = data[0].groupNumber_2;
          -       document.getElementsByName('responsibleAddress1_2')[0].value = data[0].responsibleAddress1_2;
          -       document.getElementsByName('responsibleAddress2_2')[0].value = data[0].responsibleAddress2_2;
          -       document.getElementsByName('responsibleCity_2')[0].value = data[0].responsibleCity_2;
          -       document.getElementsByName('responsibleState_2')[0].value = data[0].responsibleState_2;
          -       document.getElementsByName('responsibleZip_2')[0].value = data[0].responsibleZip_2;
          -       document.getElementsByName('phone_2')[0].value = data[0].phone_2;
          -       document.getElementsByName('policyHolderId_2')[0].value = data[0].policyHolderId_2;
          -       document.getElementsByName('policyHolderDOB_2')[0].value = data[0].policyHolderDOB_2;
          -     }
          -   );
          -   showMedicareFields();
          - }
          -
          - function searchPatientsByOrganization() {
          -  $('#physicianId').load('/uniflow',{stepName: 'Ajax Patients By Organization Search Server'
          -     ,organizationId: $('#organizationId').val()
          -  });
          - }
          -
          - function selectPatient(id) {
          -   $('#patientId').val('test');
          -   alert('stop');
          - }
        formQuery~
          - select
          -   case q.specimenId
          -     when '' then
          -               case '{specimenId}'
          -                 when '' then ' PMDX{_getNextSequence:sampleId}'
          -                 else '{specimenId}'
          -               end
          -     else q.specimenId
          -   end as "specimenId"
          - from (
          - select co.containerId as "specimenId"
          - from contents c
          - inner join containers co
          - on c.content = co.containerId
          - where (c.containerId = '{specimenId}' OR c.containerId = '{_recId}')
          - and (co.containerType = 'specimenId' or co.containerType = 'oncoDxId')
          - union
          - select ''
          - limit 1
          - ) q
        formQuery~
          - select case '{copyInfo}' when 'true' then 'PMDX{_getNextSequence:sampleId}' else case q.specimenId when '' then 'PMDX{_getNextSequence:sampleId}' else q.specimenId end end as "parentSpecId"
          - from (
          - select co.containerId as "specimenId"
          - from contents c
          - inner join containers co
          - on c.content = co.containerId
          - where (c.containerId = '{specimenId}' OR c.containerId = '{_recId}')
          - and (co.containerType = 'specimenId' or co.containerType = 'oncoDxId')
          - union
          - select ''
          - limit 1
          - ) q
        formQuery~ SELECT CASE WHEN EXISTS (SELECT 1 FROM requestForms WHERE specimenId = '{_:specimenId}') THEN 'Update Request Form Information' ELSE 'Testing Not Yet Requested' END AS "infoStatus" FROM dual
        ### organization info
        formQuery~
          - select distinct
          -   e.firstName as "organizationName",
          -   e.entityId as "organizationId",
          -   a.address1 'cLine1',
          -   a.address2 'cLine2',
          -   a.city 'cCity',
          -   a.state 'cState',
          -   a.postalCode 'cZip',
          -   a.country 'cCountryCode',
          -   p.number 'cPhone'
          - from contents c
          - inner join entityRelations er
          - on c.containerId = er.memberId
          - inner join entities e
          - on er.entityId = e.entityId
          - left join entityAddresses a on a.entityId = e.entityId and a.type = 'Primary'
          - left join entityPhones p on p.entityId = e.entityId and p.type = 'Primary'
          - where c.content = '{_:specimenId}'
          - and c.contentType = 'specimenId'
          - and er.role = 'Patient'
          - and e.entityType = 'Organization'
          - union
          - select '', '', '', '', '', '', '', '', '' from dual
          - limit 1
        ### physician info
        formQuery~
          - select
          -   concat(e.firstName, ' ', e.lastName) as "physician1",
          -   p.npi as "npi1",
          -   p.physicianId,
          -   a.address1 as "pLine1",
          -   a.address2 as "pLine2",
          -   a.city as 'pCity',
          -   a.state as 'pState',
          -   a.postalCode as 'pZip',
          -   a.country as 'pCountryCode',
          -   ph.number as 'pPhone'
          - from contents c
          - inner join entityRelations er
          - on c.containerId = er.memberId
          - inner join entities e
          - on er.entityId = e.entityId
          - inner join physicians p
          - on e.entityId = p.physicianId
          - left join entityAddresses a on a.entityId = p.physicianId and a.type = 'Primary'
          - left join entityPhones ph on ph.entityId = p.physicianId and ph.type = 'Primary'
          - where c.content = '{_:specimenId}'
          - and (c.contentType = 'specimenId' or c.contentType = 'oncoDxId')
          - and er.role = 'Patient'
          - and e.entityType = 'Physician'
          - union
          - select '', '', '', '', '', '', '', '', '', '' from dual
          - limit 1
        ### patient info
        formQuery~
          - select
          -   e.firstName,
          -   e.middleName,
          -   e.lastName,
          -   p.patientId,
          -   p.dob,
          -   p.mrn,
          -   p.ssn,
          -   p.gender,
          -   p.ethnicity,
          -   pc.medications,
          -   pc.problemMedications,
          -   pc.allergies,
          -   pc.subjectId,
          # -   p.age,
          -   pn1.number as "homePhone",
          -   pn2.number as "cellPhone",
          -   pn3.number as "altPhone",
          -   em.email,
          -   pa.address1,
          -   pa.address2,
          -   pa.city,
          -   pa.state,
          -   pa.postalCode,
          -   pa.country
          - from contents c
          - inner join entities e
          - on c.containerId = e.entityId
          - inner join patients p
          - on e.entityId = p.patientId
          - left join patientClinical pc on p.patientId = pc.patientId
          - left join entityPhones pn1 on pn1.entityId = p.patientId and pn1.type = 'Home'
          - left join entityPhones pn2 on pn2.entityId = p.patientId and pn2.type = 'Cell'
          - left join entityPhones pn3 on pn3.entityId = p.patientId and pn3.type = 'Alt'
          - left join entityEmails em on em.entityId = p.patientId and em.type = 'Primary'
          - left join entityAddresses pa on pa.entityId = p.patientId and pa.type = 'Primary'
          - where c.content = '{_:specimenId}'
          - and (c.contentType = 'specimenId' or c.contentType = 'oncoDxId')
          - union
          - select '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '' from dual


        formQuery~ select date_format(value, '%m/%d/%Y') AS "collectionDate"
          - from sampleProperties
          - where sampleId = '{_:specimenId}'
          - and property = 'Collection Date'
          - union select '' from dual
        formQuery~ select value AS "collectionTime"
          - from sampleProperties
          - where sampleId = '{_:specimenId}'
          - and property = 'Collection Time'
          - union select '' from dual
        formQuery~ select value AS "collectionTimePeriod"
          - from sampleProperties
          - where sampleId = '{_:specimenId}'
          - and property = 'Collection Time Period'
          - union select '' from dual
        formQuery~ select value AS "sampleType"
          - from sampleProperties
          - where sampleId = '{_:specimenId}'
          - and property = 'Sample Type'
          - union select '' from dual
        formQuery~ select value AS "tissueType"
          - from sampleProperties
          - where sampleId = '{_:specimenId}'
          - and property = 'Tissue Type'
          - union select '' from dual
        formQuery~ select value AS "diagnostic"
          - from sampleProperties
          - where sampleId = '{_:specimenId}'
          - and property = 'Diagnostic'
          - union select '' from dual
        formQuery~ select value AS "histopatholigicDiagnosis"
          - from sampleProperties
          - where sampleId = '{_:specimenId}'
          - and property = 'Histopathologic Diagnostic'
          - union select '' from dual
        formQuery~ select value AS "tubes"
          - from sampleProperties
          - where sampleId = '{_:specimenId}'
          - and property = 'Number of Tubes'
          - union select '' from dual
        formQuery~ select date_format(value, '%m/%d/%Y') AS "dateReceived"
          - from sampleProperties
          - where sampleId = '{_:specimenId}'
          - and property = 'Date Received'
          - union select '' from dual
        #formQuery~ select value AS "shipCondition"
        #  - from sampleProperties
        #  - where sampleId = '{_:specimenId}'
        #  - and property = 'Shipping Condition'
        #  - union select '' from dual
        formQuery~ select value AS "description"
          - from sampleProperties
          - where sampleId = '{_:specimenId}'
          - and property = 'Description'
          - union select '' from dual
        formQuery~ select value AS "clinicalHistory"
          - from sampleProperties
          - where sampleId = '{_:specimenId}'
          - and property = 'Clinical History'
          - union select '' from dual
        formQuery~ select value AS "icdCodes1"
          - from sampleProperties
          - where sampleId = '{_:specimenId}'
          - and property = 'ICD Code 1'
          - union select '' from dual
        formQuery~ select value AS "icdCodes2"
          - from sampleProperties
          - where sampleId = '{_:specimenId}'
          - and property = 'ICD Code 2'
          - union select '' from dual
        formQuery~ select value AS "icdCodes3"
          - from sampleProperties
          - where sampleId = '{_:specimenId}'
          - and property = 'ICD Code 3'
          - union select '' from dual
        formQuery~ select value AS "icdCodes4"
          - from sampleProperties
          - where sampleId = '{_:specimenId}'
          - and property = 'ICD Code 4'
          - union select '' from dual
        formQuery~ select value AS "icdCodes5"
          - from sampleProperties
          - where sampleId = '{_:specimenId}'
          - and property = 'ICD Code 5'
          - union select '' from dual
        formQuery~ select value AS "icdCodes6"
          - from sampleProperties
          - where sampleId = '{_:specimenId}'
          - and property = 'ICD Code 6'
          - union select '' from dual

        formQuery~ select case '{copyInfo}' when 'true' then 'SAMP{_getNextSequence:sampleId}' else '{_:specimenId}' end as "newParentId"
        formQuery~ select case '{aliquots}' when '' then 0 when 'null' then 0 else '{aliquots}' end as "aliquots"
        vertical
          hidden aliquots
            value= {aliquots}
            screenLabel~
          passiveContainer specimenId
            screenLabel~ Specimen ID
            acceptQueue~ any
            value= {_:newParentId}
            #readonly=
            style= background-color:transparent; border:0;width:200px;


          text Info DB Status
            value= {_:infoStatus}
            readonly=
            style= background-color:transparent; border:0;
        fieldset
          legend Comments
            class= comments
          vertical
            table
              sqlPreparedQuery~
                - select * from (
                - select distinct cp.containerId, cp.value as "Comment", e.eventDate, e.userId, e.step
                - from contents c
                - inner join containerProperties cp
                - on c.containerId = cp.containerId
                - inner join events e
                - on cp.eventId = e.eventId
                - where c.content = '{_:specimenId}'
                - and cp.property = 'comment'
                - union
                - select distinct c.containerId, concat('Person Contacted: ', personContacted, '\r\n Time to Reach: ', timeToReach, '\r\n Contact Type: ', contactType, '\r\n Note: ', note), e.eventDate, employeeId, 'Contact Customer'
                - from contents c
                - inner join customerCommunications cc
                - on c.containerId = cc.reqId
                - inner join events e
                - on cc.eventId = e.eventId
                - where c.content = '{_:specimenId}') q
                - order by q.eventDate
        fieldset
          legend Aliquots
            class= legend
          vertical
            table
              caption Existing Aliquots
              sqlPreparedQuery~ SELECT c.content AS "Aliquot ID", sp.value AS "Sample Status", sp2.value AS "Aliquot Volume (mL)", getStorageParentage(c.content) AS "storage location"
                - FROM contents c
                - INNER JOIN containers co
                - ON c.containerId = co.containerId
                - LEFT JOIN sampleProperties sp
                - ON c.content = sp.sampleId
                - AND sp.property = 'status'
                - LEFT JOIN sampleProperties sp2
                - ON c.content = sp2.sampleId
                - AND sp2.property = 'Volume (mL)'
                - WHERE co.containerId = '{_:specimenId}'
                - AND c.attribute = 'self'
                - AND (c.contentType = 'aliquotId' or c.contentType = 'oncoDxId')

            table
              caption Create New Aliquots
              sqlPreparedQuery~ SELECT '' as 'Aliquots', 'Storage' as 'Action', '20' as 'Volume (mL)' FROM numbers LIMIT {_:aliquots}
              columnSpecs~ aliquots
                allowChangedRecordIds
                column 1
                  inputType container
                    style= background-image: url(images/barcodebkg.jpg);
                    new~ true
                    required~ false
                    addContent~
                    containerType~ aliquotId
                    contentType~ aliquotId
                      if~ ! select 1 from storage where content = '{_thisInput}'
                        insertQueue~ Store in Box
                column 3
                  inputType text
                    style= width:40px;

        fieldset
          legend Sample Entity Information
            class= legend
          vertical2
            select organizationId
              id= organizationId
              onChange= javascript:searchPatientsByOrganization();
              screenLabel~ Customer
              style= border-color: red;
              option
              sqlPreparedQuery~ SELECT firstName,entityId from entities where entityType = 'Organization' order by firstName
              option  oncoDx
              value= {_resultSet:organizationId}
          vertical2
            select physicianId
              id= physicianId
              style= border-color: red;
              screenLabel~ Physician
              value= {_resultSet:physician1}
              sqlPreparedQuery~ select concat(p.firstName,' ',p.lastName),p.entityId from entities p
                - INNER JOIN entityRelations op ON op.memberId=p.entityId
                -   and p.entityId = '{_resultSet:physicianId}'
                - WHERE op.entityId='{_resultSet:organizationId}' AND p.entityType='Physician'
              sqlPreparedQuery~ select concat(p.firstName,' ',p.lastName),p.entityId from entities p
                - INNER JOIN entityRelations op ON op.memberId=p.entityId
                -   and p.entityId <> '{_resultSet:physicianId}'
                - WHERE op.entityId='{_resultSet:organizationId}' AND p.entityType='Physician'
            vertical2
              text npi1
                screenLabel~ Primary: NPI
                value= {_resultSet:npi1}
                readonly=
                style= width:50px;
              vertical2
                output physician1
                  screenLabel~
                  value= {_resultSet:physician1}
          vertical
            fieldSet
              legend Find Patient
              div
              vertical
                simpleTable
                  tr
                    td &nbsp;Last Name
                    td &nbsp;First Name
                    td &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DOB
                    td &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SSN
                    td &nbsp;&nbsp;Gender
                  tr
                    style= display: none;
                    td Patient Id
                      colspan= 3
                      text patientId
                  tr
                    td
                      text patientLastName
                        style= border-color:red;
                          - width:80px
                        id= patientLastName
                        onchange= javascript:return searchPatients();
                    td
                      text patientFirstName
                        style= width:80px
                        id= patientFirstName
                        onchange= javascript:return searchPatients();
                    td
                      text patientDOB
                        style= width:90px
                        id= patientDOB
                        title= mm/dd/yyyy
                        onchange= javascript:return searchPatients();
                    td
                      text patientSSN
                        style= width:80px
                        id= patientSSN
                        onchange=
                          #- javascript:
                          #- alert('here');
                          - return searchPatients();
                    td
                      select patientGender
                        id= patientType
                        setName~ gender
                        title= SETNAME:gender
                        required~ false
                        option Male
                          value= M
                        option Female
                          value= F
                        option Unknown
                          value= U
                        onchange= javascript:return searchPatient();
                      colspan= 2
              div
                id= patientsCandidates
          div
            id= new_Patient
          vertical
            fieldSet
              legend Patient
                style= color:blue;
                onClick= $('#newPatient').toggle();
              div
                id= newPatient
                #style= display:none;
                vertical2
                  vertical
                    div
                      vertical
                        text newPatientId
                          screenLabel~
                          id= patientId
                          value= {_resultSet:patientId}
                          readonly=
                          style= display:none;
                        text firstName
                          screenLabel~ First Name
                          value= {_resultSet:firstName}
                        text middleName
                          screenLabel~ Middle
                          value= {_resultSet:middleName}
                        text lastName
                          screenLabel~ Last Name
                          value= {_resultSet:lastName}
                        text mrn
                          screenLabel~ MRN/Patient ID
                          value= {_resultSet:mrn}
                        text dob
                          screenLabel~ DOB (mm/dd/yyyy)
                          title= mm/dd/yyyy
                          value= {_resultSet:dob}
                        select newPatientGender
                          screenLabel~ Gender
                          setName~ gender
                          title= SETNAME:gender
                          required~ false
                          option Male
                            value= M
                          option Female
                            value= F
                          option Unknown
                            value= U
                          value= {_resultSet:gender}
                    div
                      class= pgx
                      vertical
                        span Ethnicity
                        select ethnicity
                          screenLabel~
                          id= ethnicity
                          option
                          option African American
                          option Asian
                          option Caucasian
                          option Hispanic
                          option Native Indian
                          option Other
                          value= {_resultSet:ethnicity}
                        span Current Medications
                        textArea medications
                          screenLabel~
                          style= width:300px;
                          value= {_resultSet:medications}
                        span Medications that have been problematic
                        textArea problemMedications
                          screenLabel~
                          style= width:300px;
                          value= {_resultSet:problemMedications}
                        span Drug Allergies
                        textArea allergies
                          screenLabel~
                          style= width:300px;
                          value= {_resultSet:allergies}
                  fieldset
                    legend Contact Info
                    vertical
                      text address1
                        screenLabel~ AddressLine1
                        value= {_resultSet:address1}
                      text address2
                        screenLabel~ AddressLine2
                        value= {_resultSet:address2}
                      text city
                        screenLabel~ City
                        value= {_resultSet:city}
                      text state
                        screenLabel~ State
                        value= {_resultSet:state}
                      text postalCode
                        screenLabel~ Zip
                        value= {_resultSet:postalCode}
                      text country
                        screenLabel~ Country Code
                        value= {_resultSet:country}
                    hr
                    vertical
                      text homePhone
                        screenLabel~ Home Phone
                        value= {_resultSet:homePhone}
                      text cellPhone
                        screenLabel~ Cell Phone
                        value= {_resultSet:cellPhone}
                      text altPhone
                        screenLabel~ Work/Alt. Phone
                        value= {_resultSet:altPhone}
                      text email
                        screenLabel~ Email
                        value= {_resultSet:email}
                      text ssn
                        screenLabel~ SSN
                        value= {_resultSet:ssn}

        fieldset
          legend Request Testing Information
            class= legend
          vertical2
            fieldset
              legend Collection Information
              vertical
                date collectionDate
                  screenLabel~ Collection Date
                  value= {_:collectionDate}
                  id= collectionDate
                  span (mm/dd/yyyy)
                  onblur= fixDate($(this));
                  #validate~ format (\d|\d\d)/(\d|\d\d)/\d\d\d\d
                text collectionTime
                  value= {_:collectionTime}
                  screenLabel~ Collection Time
                  span (hr:mm)
                select collectionTimePeriod
                  screenLabel~ am/pm
                  option
                  option am
                  option pm
                date dateReceived
                  screenLabel~ Date Received
                  value= {_:dateReceived}
                  span (mm/dd/yyyy)
                #select shipCondition
                #  value= {_:shipCondition}
                #  screenLabel~ Shipping Condition
                #  setName~ shippingCondition
                #  required~ false
                select sampleType
                  screenLabel~ Sample Type
                  value= {_resultSet:sampleType}
                  sqlQuery~ select displayValue,value
                    - from validValues
                    - where setName like 'CDx%'
                    - or setName like 'PGx%'

            fieldset
              id= slideFields
              legend Tissue Information
              vertical
                text tissueType
                  screenLabel~ Tissue Type
                  value= {_resultSet:tissueType}
                textArea histodiagnostic
                  screenLabel~ Diagnosis
                  value= {_resultSet:diagnostic}
                textArea histopatholigicDiagnosis
                  screenLabel~ Histopathologic Diagnosis
                  value= {_resultSet:histopatholigicDiagnosis}
                textArea clinicalHistory
                  screenLabel~ Clinical History
                  value= {_resultSet:clinicalHistory}
                text tubes
                  screenLabel~ # Tubes
                  value= {_resultSet:tubes}
                text description
                  screenLabel~ Description
                  value= {_resultSet:description}


            fieldset
              legend ICD-9-CM Codes
              vertical2
                text icdCodes1
                  screenLabel~ Code1
                  value= {_resultSet:icdCodes1}
                text icdCodes2
                  screenLabel~ Code2
                  value= {_resultSet:icdCodes2}
                text icdCodes3
                  screenLabel~ Code3
                  value= {_resultSet:icdCodes3}
                text icdCodes4
                  screenLabel~ Code4
                  value= {_resultSet:icdCodes4}
                text icdCodes5
                  screenLabel~ Code5
                  value= {_resultSet:icdCodes5}
                text icdCodes6
                  screenLabel~ Code6
                  value= {_resultSet:icdCodes6}


        fieldset
          legend Additional Sample Information
            class= legend
          h4 Existing Sample Information
          vertical
            table
              sqlPreparedQuery~
                - SELECT sp.property as "Property", sp.value as "Value", 'false' as "Update", sp.sampleId as ""
                - FROM sampleProperties sp
                - inner join validValues v
                - on sp.property = v.value
                - where sp.sampleId = '{_:specimenId}'
                - and v.setName = 'Additional Sample Information'
              columnSpecs~ addInfo
                allowChangedRecordIds
                column 1
                  inputType text
                    readonly=
                column 2
                  inputType text
                    size= 40
                column 3
                  inputType checkbox
                column 4
                  inputType container
                    style= display:none;

          h4 Add Sample Information
          vertical
            table
              sqlPreparedQuery~
                - SELECT sp.property as "Property", sp.value as "Value", '{_:specimenId}' as ""
                - FROM validValues v
                - left join sampleProperties sp
                - on v.value = sp.property
                - and '{_:specimenId}' = sp.sampleId
                - where v.setName = 'Additional Sample Information'
                - and sp.value is null
                - limit 5
              columnSpecs~ addInfo2
                allowChangedRecordIds
                column 1
                  inputType select
                    setName~ Additional Sample Information
                    title= SETNAME:Additional Sample Information
                    required~ false
                column 2
                  inputType text
                    size= 40
                column 3
                  inputType container
                    style= display:none;
                    acceptQueue~ any
      forRows aliquots
        ifCondition length({_columnInput_aliquots:1}) > 0
          sqlPreparedStatement~ insert into contents (containerId, attribute, contentType, content, eventId)
            + select ?, 'self', 'aliquotId', ?, ?
            + FROM dual
            + WHERE ? <> ''
            string {specimenId}
            string {_columnInput_aliquots:1}
            long {_eventId}
            string {_columnInput_aliquots:1}
          sqlPreparedStatement~ INSERT INTO sampleProperties (sampleId, property, value, eventId)
            - VALUES (?, 'Volume (mL)', ?, ?)
            string {_columnInput_aliquots:1}
            string {_columnInput_aliquots:3}
            long {_eventId}
          sqlPreparedStatement~ INSERT INTO sampleProperties (sampleId, property, value, eventId)
            - VALUES (?, 'status', 'aliquoted at storage', ?)
            string {_columnInput_aliquots:1}
            long {_eventId}
          sqlPreparedStatement~ INSERT INTO sampleProperties (sampleId, property, value, eventId)
            - VALUES (?, 'statusHistory', 'aliquoted at storage', ?)
            string {_columnInput_aliquots:1}
            long {_eventId}
      forRows addInfo
        ifCondition SELECT 1 FROM DUAL WHERE '{_columnInput_addInfo:3}' = 'true' AND '{_columnInput_addInfo:1}' <> ''
          sqlPreparedStatement~ update sampleProperties
            - set value = ?, eventId = ?
            - where sampleId = ?
            - and property = ?
            string {_columnInput_addInfo:2}
            long {_eventId}
            string {_columnInput_addInfo:4}
            string {_columnInput_addInfo:2}
      forRows addInfo2
        ifCondition {_columnInput_addInfo2:1}_BLANK <> _BLANK
          sqlPreparedStatement~ insert into sampleProperties (sampleId, property, value, eventId)
            - select ?, ?, ?, ?
            string {_columnInput_addInfo2:3}
            string {_columnInput_addInfo2:1}
            string {_columnInput_addInfo2:2}
            long {_eventId}
      setFormQueryResult
        sqlPreparedQuery select case when '{newPatientId}' = '' then '-1' else '{newPatientId}' end as 'patientId' from dual

      ifCondition select 1 from dual where '{_resultSet:patientId}' = '-1' and ('{firstName}' <> '' or '{lastName}' <> '')
        setFormQueryResult
          sqlPreparedQuery select 'PA{_getNextSequence:patientId}' as 'patientId' from dual
        ### new persons record
        sqlPreparedStatement
          - insert into entities (entityId,entityType,firstName,lastName,middleName,status,eventId)
          - values (?,'Patient',?,?,?,'active',?)
          string {_resultSet:patientId}
          string {firstName}
          string {lastName}
          string {middleName}
          long {_eventId}
        sqlPreparedStatement
          - insert into patients (patientId,dob,ssn,gender,mrn,ethnicity, eventId)
          - values (?,?,?,?,?,?,?)
          string {_resultSet:patientId}
          string {dob}
          string {ssn}
          string {newPatientGender}
          string {mrn}
          string {ethnicity}
          long {_eventId}
        sqlPreparedStatement
          - insert into patientClinical (patientId, problemMedications, allergies, medications, eventId)
          - values (?, ?, ?, ?, ?)
          string {_resultSet:patientId}
          string {problemMedications}
          string {allergies}
          string {medications}
          long {_eventId}
        sqlPreparedStatement
          - insert into containers (containerId, containerType, eventId)
          - values (?, 'Patient', ?)
          string {_resultSet:patientId}
          long {_eventId}
        sqlPreparedStatement
          - insert into contents (containerId, attribute, contentType, content, eventId)
          - values (?, 'self', 'Patient', ?, ?)
          string {_resultSet:patientId}
          string {_resultSet:patientId}
          long {_eventId}
        ### Add Patient to organization ###
        sqlPreparedStatement~ insert into entityRelations (memberId, entityId, role, eventId)
          - values(?, ?, 'Patient', ?)
          string {_resultSet:patientId}
          string {organizationId}
          long {_eventId}
        else
          ifCondition select 1 from dual where '{_resultSet:patientId}' <> '-1'
            ### update persons record
            sqlPreparedStatement
              - update entities set entityType = 'Patient', firstName = ?, lastName = ?, middleName = ?
              - where entityId = ?
              string {firstName}
              string {lastName}
              string {middleName}
              string {_resultSet:patientId}
            sqlPreparedStatement
              - update patients set dob = ?, ssn = ?, gender = ?, mrn = ?, ethnicity = ?
              - where patientId = ?
              string {dob}
              string {ssn}
              string {newPatientGender}
              string {mrn}
              string {ethnicity}
              string {_resultSet:patientId}
            sqlPreparedStatement~ update patientClinical
              - set medications = ?, problemMedications = ?, allergies = ?
              - where patientId = ?
              string {medications}
              string {problemMedications}
              string {allergies}
              string {_resultSet:patientId}

      ### patient tables
      ### address
      ###   currently forcing addressType = 'Primary'
      sqlPreparedStatement
        - delete from entityAddresses
        - where entityId = ?
        -  and type = 'Primary'
        string {_resultSet:patientId}
      sqlPreparedStatement
        - insert into entityAddresses (entityId,address1,address2,city,state,postalCode,country,type,eventId)
        - select ?,?,?,?,?,?,?,'Primary',?
        - from dual
        - WHERE length(?) > 0 and ? <> '-1'
        string {_resultSet:patientId}
        string {address1}
        string {address2}
        string {city}
        string {state}
        string {postalCode}
        string {country}
        long {_eventId}
        string {address1}
        string {_resultSet:patientId}

      sqlPreparedStatement
        - delete from entityPhones
        - where entityId = ?
        string {_resultSet:patientId}
      sqlPreparedStatement
        - insert into entityPhones (entityId,number,type,eventId)
        - select ?,?,'Home',?
        - from dual
        - WHERE length(?) > 0 and ? <> '-1'
        string {_resultSet:patientId}
        string {homePhone}
        long {_eventId}
        string {homePhone}
        string {_resultSet:patientId}
      sqlPreparedStatement
        - insert into entityPhones (entityId,number,type,eventId)
        - select ?,?,'Cell',?
        - from dual
        - WHERE length(?) > 0 and ? <> '-1'
        string {_resultSet:patientId}
        string {cellPhone}
        long {_eventId}
        string {cellPhone}
        string {_resultSet:patientId}
      sqlPreparedStatement
        - insert into entityPhones (entityId,number,type,eventId)
        - select ?,?,'Alt',?
        - from dual
        - WHERE length(?) > 0 and ? <> '-1'
        string {_resultSet:patientId}
        string {altPhone}
        long {_eventId}
        string {altPhone}
        string {_resultSet:patientId}



      ### email
      ###   currently forcing emailType = 'Primary'
      sqlPreparedStatement
        - delete from entityEmails
        - where entityId = ?
        -  and type = 'Primary'
        string {_resultSet:patientId}
      sqlPreparedStatement
        - insert into entityEmails (entityId,type,email,eventId)
        - select ?,'Primary',?,?
        - from dual
        - where length(?) > 0 and ? <> '-1'
        string {_resultSet:patientId}
        string {email}
        long {_eventId}
        string {email}
        string {_resultSet:patientId}

      forEach select specimenId from requestForms where Id = '{_recId}' and 'changeSpecimen' = 'true'
      ### Update contents, container and containerHistory table when changing SpecimenId ###
        sqlPreparedStatement~ update contents set content = ?, eventId = ?
          - where content = ?
          string {specimenId}
          long {_eventId}
          string {_resultSet:specimenId}
        sqlPreparedStatement~ update containers set containerId = ?, eventId = ?
          - where containerId = ?
          string {specimenId}
          long {_eventId}
          string {_resultSet:specimenId}
        sqlPreparedStatement~ update contents set containerId = ?, eventId = ?
          - where containerId = ?
          string {specimenId}
          long {_eventId}
          string {_resultSet:specimenId}

      sqlPreparedStatement~ insert into entityRelations (entityId, memberId, role, eventId)
        - select ?, ?, 'Patient', ?
        - from dual
        - where not exists (select 1 from entityRelations where entityId = ? and memberId = 'patientId')
        string {physicianId}
        string {_:patientId}
        long {_eventId}
        string {physicianId}
      sqlPreparedStatement~ insert into entityRelations (entityId, memberId, role, eventId)
        - values (?, ?, 'Patient', ?)
        string {organizationId}
        string {_:patientId}
        long {_eventId}


      ### Patient Relations ###
      sqlPreparedStatement~ insert into entityRelations (memberId, entityId, role, eventId)
        - (select ?, ?, 'Patient', ? from dual
        -  where not exists (select * from entityRelations where memberId = ? and entityId = ?))
        string {_resultSet:patientId}
        string {organizationId}
        long {_eventId}
        string {_resultSet:patientId}
        string {organizationId}
      sqlPreparedStatement~ insert into entityRelations (memberId, entityId, role, eventId)
        - (select ?, ?, 'Patient', ? from dual
        -  where not exists (select * from entityRelations where memberId = ? and entityId = ?))
        string {_resultSet:patientId}
        string {physicianId}
        long {_eventId}
        string {_resultSet:patientId}
        string {physicianId}
      sqlPreparedStatement~ insert into contents (containerId, attribute, contentType, content, eventId)
        - (select ?, 'self', 'specimenId', ?, ? from dual
        -  where not exists (select * from contents where containerId = ? and content = ?))
        string {_resultSet:patientId}
        string {specimenId}
        long {_eventId}
        string {_resultSet:patientId}
        string {specimenId}


      ifCondition select 1 from sampleProperties where  sampleId = '{specimenId}' and property = 'Collection Date'
        sqlPreparedStatement~ update sampleProperties
          - set value = ?, eventId = ?
          - where sampleId = ?
          - and property = 'Collection Date'
          - and value <> ?
          string {collectionDate}
          long {_eventId}
          string {specimenId}
          string {collectionDate}
        else
          ifCondition select 1 from dual where '{collectionDate}' <> ''
            sqlPreparedStatement~ insert into sampleProperties (sampleId, property, value, eventId)
              - values (?, 'Collection Date', ?, ?)
              string {specimenId}
              string {collectionDate}
              long {_eventId}

      ifCondition select 1 from sampleProperties where  sampleId = '{specimenId}' and property = 'Collection Time'
        sqlPreparedStatement~ update sampleProperties
          - set value = ?, eventId = ?
          - where sampleId = ?
          - and property = 'Collection Time'
          - and value <> ?
          string {collectionTime}
          long {_eventId}
          string {specimenId}
          string {collectionTime}


        else
          ifCondition select 1 from dual where '{collectionTime}' <> ''
            sqlPreparedStatement~ insert into sampleProperties (sampleId, property, value, eventId)
              - values (?, 'Collection Time', ?, ?)
              string {specimenId}
              string {collectionTime}
              long {_eventId}


      ifCondition select 1 from sampleProperties where  sampleId = '{specimenId}' and property = 'Collection Time Period'
        sqlPreparedStatement~ update sampleProperties
          - set value = ?, eventId = ?
          - where sampleId = ?
          - and property = 'Collection Time Period'
          - and value <> ?
          string {collectionTimePeriod}
          long {_eventId}
          string {specimenId}
          string {collectionTimePeriod}
        else~
          ifCondition select 1 from dual where '{collectionTimePeriod}' <> ''
            sqlPreparedStatement~ insert into sampleProperties (sampleId, property, value, eventId)
              - values (?, 'Collection Time Period', ?, ?)
              string {specimenId}
              string {collectionTimePeriod}
              long {_eventId}

      ifCondition select 1 from sampleProperties where  sampleId = '{specimenId}' and property = 'Sample Type'
        sqlPreparedStatement~ update sampleProperties
          - set value = ?, eventId = ?
          - where sampleId = ?
          - and property = 'Sample Type'
          - and value <> ?
          string {sampleType}
          long {_eventId}
          string {specimenId}
          string {sampleType}
        else
          ifCondition select 1 from dual where '{sampleType}' <> ''
            sqlPreparedStatement~ insert into sampleProperties (sampleId, property, value, eventId)
              - values (?, 'Sample Type', ?, ?)
              string {specimenId}
              string {sampleType}
              long {_eventId}

      ifCondition select 1 from sampleProperties where  sampleId = '{specimenId}' and property = 'Tissue Type'
        sqlPreparedStatement~ update sampleProperties
          - set value = ?, eventId = ?
          - where sampleId = ?
          - and property = 'Tissue Type'
          - and value <> ?
          string {tissueType}
          long {_eventId}
          string {specimenId}
          string {tissueType}
        else
          ifCondition select 1 from dual where '{tissueType}' <> ''
            sqlPreparedStatement~ insert into sampleProperties (sampleId, property, value, eventId)
              - values (?, 'Tissue Type', ?, ?)
              string {specimenId}
              string {tissueType}
              long {_eventId}

      ifCondition select 1 from sampleProperties where  sampleId = '{specimenId}' and property = 'Diagnosis'
        sqlPreparedStatement~ update sampleProperties
          - set value = ?, eventId = ?
          - where sampleId = ?
          - and property = 'Diagnostic'
          - and value <> ?
          string {histodiagnostic}
          long {_eventId}
          string {specimenId}
          string {histodiagnostic}
        else
          ifCondition select 1 from dual where '{histodiagnostic}' <> ''
            sqlPreparedStatement~ insert into sampleProperties (sampleId, property, value, eventId)
              - values (?, 'Diagnostic', ?, ?)
              string {specimenId}
              string {histodiagnostic}
              long {_eventId}

      ifCondition select 1 from sampleProperties where  sampleId = '{specimenId}' and property = 'Histopathologic Diagnosis'
        sqlPreparedStatement~ update sampleProperties
          - set value = ?, eventId = ?
          - where sampleId = ?
          - and property = 'Histopathologic Diagnosis'
          - and value <> ?
          string {histopatholigicDiagnosis}
          long {_eventId}
          string {specimenId}
          string {histopatholigicDiagnosis}
        else
          ifCondition select 1 from dual where '{histopatholigicDiagnosis}' <> ''
            sqlPreparedStatement~ insert into sampleProperties (sampleId, property, value, eventId)
              - values (?, 'Histopathologic Diagnosis', ?, ?)
              string {specimenId}
              string {histopatholigicDiagnosis}
              long {_eventId}

      ifCondition select 1 from sampleProperties where  sampleId = '{specimenId}' and property = 'Number of Tubes'
        sqlPreparedStatement~ update sampleProperties
          - set value = ?, eventId = ?
          - where sampleId = ?
          - and property = 'Number of Tubes'
          - and value <> ?
          string {tubes}
          long {_eventId}
          string {specimenId}
          string {tubes}
        else
          ifCondition select 1 from dual where '{tubes}' <> ''
            sqlPreparedStatement~ insert into sampleProperties (sampleId, property, value, eventId)
              - values (?, 'Number of Tubes', ?, ?)
              string {specimenId}
              string {tubes}
              long {_eventId}

      ifCondition select 1 from sampleProperties where  sampleId = '{specimenId}' and property = 'Date Received'
        sqlPreparedStatement~ update sampleProperties
          - set value = ?, eventId = ?
          - where sampleId = ?
          - and property = 'Date Received'
          - and value <> ?
          string {dateReceived}
          long {_eventId}
          string {specimenId}
          string {dateReceived}
        else
          ifCondition select 1 from dual where '{dateReceived}' <> ''
            sqlPreparedStatement~ insert into sampleProperties (sampleId, property, value, eventId)
              - values (?, 'Date Received', ?, ?)
              string {specimenId}
              string {dateReceived}
              long {_eventId}

      ifCondition select 1 from sampleProperties where  sampleId = '{specimenId}' and property = 'Description'
        sqlPreparedStatement~ update sampleProperties
          - set value = ?, eventId = ?
          - where sampleId = ?
          - and property = 'Description'
          - and value <> ?
          string {description}
          long {_eventId}
          string {specimenId}
          string {description}
        else
          ifCondition select 1 from dual where '{description}' <> ''
            sqlPreparedStatement~ insert into sampleProperties (sampleId, property, value, eventId)
              - values (?, 'Description', ?, ?)
              string {specimenId}
              string {description}
              long {_eventId}

      ifCondition select 1 from sampleProperties where  sampleId = '{specimenId}' and property = 'Clinical History'
        sqlPreparedStatement~ update sampleProperties
          - set value = ?, eventId = ?
          - where sampleId = ?
          - and property = 'Clinical History'
          - and value <> ?
          string {clinicalHistory}
          long {_eventId}
          string {specimenId}
          string {clinicalHistory}
        else
          ifCondition select 1 from dual where '{clinicalHistory}' <> ''
            sqlPreparedStatement~ insert into sampleProperties (sampleId, property, value, eventId)
              - values (?, 'Clinical History', ?, ?)
              string {specimenId}
              string {clinicalHistory}
              long {_eventId}

      ifCondition select 1 from sampleProperties where  sampleId = '{specimenId}' and property = 'ICD Code 1'
        sqlPreparedStatement~ update sampleProperties
          - set value = ?, eventId = ?
          - where sampleId = ?
          - and property = 'ICD Code 1'
          - and value <> ?
          string {icdCodes1}
          long {_eventId}
          string {specimenId}
          string {icdCodes1}
        else
          ifCondition select 1 from dual where '{icdCodes1}' <> ''
            sqlPreparedStatement~ insert into sampleProperties (sampleId, property, value, eventId)
              - values (?, 'ICD Code 1', ?, ?)
              string {specimenId}
              string {icdCodes1}
              long {_eventId}

      ifCondition select 1 from sampleProperties where  sampleId = '{specimenId}' and property = 'ICD Code 2'
        sqlPreparedStatement~ update sampleProperties
          - set value = ?, eventId = ?
          - where sampleId = ?
          - and property = 'ICD Code 2'
          - and value <> ?
          string {icdCodes2}
          long {_eventId}
          string {specimenId}
          string {icdCodes2}
        else
          ifCondition select 1 from dual where '{icdCodes2}' <> ''
            sqlPreparedStatement~ insert into sampleProperties (sampleId, property, value, eventId)
              - values (?, 'ICD Code 2',  ?, ?)
              string {specimenId}
              string {icdCodes2}
              long {_eventId}

      ifCondition select 1 from sampleProperties where  sampleId = '{specimenId}' and property = 'ICD Code 3'
        sqlPreparedStatement~ update sampleProperties
          - set value = ?, eventId = ?
          - where sampleId = ?
          - and property = 'ICD Code 3'
          - and value <> ?
          string {icdCodes3}
          long {_eventId}
          string {specimenId}
          string {icdCodes3}
        else
          ifCondition select 1 from dual where '{icdCodes3}' <> ''
            sqlPreparedStatement~ insert into sampleProperties (sampleId, property, value, eventId)
              - values (?, 'ICD Code 3', ?, ?)
              string {specimenId}
              string {icdCodes3}
              long {_eventId}

      ifCondition select 1 from sampleProperties where  sampleId = '{specimenId}' and property = 'ICD Code 4'
        sqlPreparedStatement~ update sampleProperties
          - set value = ?, eventId = ?
          - where sampleId = ?
          - and property = 'ICD Code 4'
          - and value <> ?
          string {icdCodes4}
          long {_eventId}
          string {specimenId}
          string {icdCodes4}
        else
          ifCondition select 1 from dual where '{icdCodes4}' <> ''
            sqlPreparedStatement~ insert into sampleProperties (sampleId, property, value, eventId)
              - values (?, 'ICD Code 4', ?, ?)
              string {specimenId}
              string {icdCodes4}
              long {_eventId}

      ifCondition select 1 from sampleProperties where  sampleId = '{specimenId}' and property = 'ICD Code 5'
        sqlPreparedStatement~ update sampleProperties
          - set value = ?, eventId = ?
          - where sampleId = ?
          - and property = 'ICD Code 5'
          - and value <> ?
          string {icdCodes5}
          long {_eventId}
          string {specimenId}
          string {icdCodes5}
        else
          ifCondition select 1 from dual where '{icdCodes5}' <> ''
            sqlPreparedStatement~ insert into sampleProperties (sampleId, property,  value, eventId)
              - values (?, 'ICD Code 5',  ?, ?)
              string {specimenId}
              string {icdCodes5}
              long {_eventId}

      ifCondition select 1 from sampleProperties where  sampleId = '{specimenId}' and property = 'ICD Code 6'
        sqlPreparedStatement~ update sampleProperties
          - set value = ?, eventId = ?
          - where sampleId = ?
          - and property = 'ICD Code 6'
          - and value <> ?
          string {icdCodes6}
          long {_eventId}
          string {specimenId}
          string {icdCodes6}
        else
          ifCondition select 1 from dual where '{icdCodes6}' <> ''
            sqlPreparedStatement~ insert into sampleProperties (sampleId, property,  value, eventId)
              - values (?, 'ICD Code 6',  ?, ?)
              string {specimenId}
              string {icdCodes6}
              long {_eventId}






      allowDuplicateContainerIds true

    step Upload Sample Data
      form
        script
          src= js/jquery/combobox.js
        include userAccountInfo
        script
          - $(document).ready(function() {
          -   $('.addAutoComplete').combobox();
          - });
        vertical
          fieldSet
            legend Instructions
              class= legend
            Li Note that the red bordered fields are required.  If your file does not have these fields you must create them in your file first.
            li Select Practice/Organization with which to associate the samples.
            li For each listed property enter the column letter to map to in your file.
            li Leave not-applicable columns n/a.
            li For properties not listed use the Additional Sample Information section to designate the appropriate properties.
            li Preferably use already existing properties in the dropdown provided, if a property does not exist, you can type it in and it will be created.
            li The additional properties have an autocomplete and will provide you with close match suggestions as you type.
            li Verify that all information is correct, and all columns are mapped correctly.
            li Remove the column names/header row from your file and save your file as a CSV or comma separated text file for upload.
            li Use the Sample Data Choose File button to navigate to the header-free file for upload.
            li Clicking submit will upload the file and insert data into the storage system as mapped.
          fieldSet
            legend Sample
              class= legend
            vertical
              select practiceId
                screenLabel~ Practice/Organization
                option
                sqlPreparedQuery~
                  - select firstName, entityId
                  - from entities
                  - where entityType = 'Practice'
                  - or entityType = 'Organization'
                  - order by firstName
                required~ true
                style= border: 2px solid red;
              select aliquotId
                screenLabel~ Aliquot ID
                style= border: 2px solid red;
                required~ true
                value= n/a
                setName~ excelColumns
              select sampleType
                screenLabel~ Sample Type
                style= border: 2px solid red;
                required~ true
                value= n/a
                setName~ excelColumns
              select collectionDate
                screenLabel~ Collection Date
                style= border: 2px solid red;
                required~ true
                value= n/a
                setName~ excelColumns
          fieldSet
            legend Storage Information
              class= legend
            vertical
              select boxId
                screenLabel~ Storage Box
                value= n/a
                setName~ excelColumns
              select well
                screenLabel~ Location in Box
                span ([A-Z][0-9][1-9])
                value= n/a
                setName~ excelColumns

          fieldSet
            legend Patient Information
              class= legend
            vertical
              select subjectId
                screenLabel~ Subject ID/Patient ID
                style= border: 2px solid red;
                required~ true
                value= n/a
                setName~ excelColumns
              select firstName
                screenLabel~ First Name
                value= n/a
                setName~ excelColumns
              select middleName
                screenLabel~ Middle Name
                value= n/a
                setName~ excelColumns
              select lastName
                screenLabel~ Last Name
                value= n/a
                setName~ excelColumns
              select age
                screenLabel~ Age
                value= n/a
                setName~ excelColumns
              select dob
                screenLabel~ Date of Birth
                value= n/a
                setName~ excelColumns
              select gender
                screenLabel~ Gender
                value= n/a
                setName~ excelColumns
              select ethnicity
                screenLabel~ Ethnicity
                value= n/a
                setName~ excelColumns
              select mrn
                screenLabel~ MRN
                value= n/a
                setName~ excelColumns
          fieldSet
            legend Additional Sample Information
              class= legend
            div
              style= display:none;
              select sampleProperties
                id= sampleProperties
                sqlPreparedQuery~
                  - select distinct property
                  - from sampleProperties
            rowGroups
              rowGroup
                span Property
                span Column
              rowGroup
                select property1
                  class= addAutoComplete
                  screenLabel~
                  option
                  sqlPreparedQuery~
                    - select distinct property
                    - from sampleProperties
                select value1
                  screenLabel~
                  value= n/a
                  setName~ excelColumns
              rowGroup
                select property2
                  class= addAutoComplete
                  screenLabel~
                  option
                  sqlPreparedQuery~
                    - select distinct property
                    - from sampleProperties
                select value2
                  screenLabel~
                  value= n/a
                  setName~ excelColumns
              rowGroup
                select property3
                  class= addAutoComplete
                  screenLabel~
                  option
                  sqlPreparedQuery~
                    - select distinct property
                    - from sampleProperties
                select value3
                  screenLabel~
                  value= n/a
                  setName~ excelColumns
              rowGroup
                select property4
                  class= addAutoComplete
                  screenLabel~
                  option
                  sqlPreparedQuery~
                    - select distinct property
                    - from sampleProperties
                select value4
                  screenLabel~
                  value= n/a
                  setName~ excelColumns
              rowGroup
                select property5
                  class= addAutoComplete
                  screenLabel~
                  option
                  sqlPreparedQuery~
                    - select distinct property
                    - from sampleProperties
                select value5
                  screenLabel~
                  value= n/a
                  setName~ excelColumns
              rowGroup
                select property6
                  class= addAutoComplete
                  screenLabel~
                  option
                  sqlPreparedQuery~
                    - select distinct property
                    - from sampleProperties
                select value6
                  screenLabel~
                  value= n/a
                  setName~ excelColumns
              rowGroup
                select property7
                  class= addAutoComplete
                  screenLabel~
                  option
                  sqlPreparedQuery~
                    - select distinct property
                    - from sampleProperties
                select value7
                  screenLabel~
                  value= n/a
                  setName~ excelColumns
              rowGroup
                select property8
                  class= addAutoComplete
                  screenLabel~
                  option
                  sqlPreparedQuery~
                    - select distinct property
                    - from sampleProperties
                select value8
                  screenLabel~
                  value= n/a
                  setName~ excelColumns
              rowGroup
                select property9
                  class= addAutoComplete
                  screenLabel~
                  option
                  sqlPreparedQuery~
                    - select distinct property
                    - from sampleProperties
                select value9
                  screenLabel~
                  value= n/a
                  setName~ excelColumns
              rowGroup
                select property10
                  class= addAutoComplete
                  screenLabel~
                  option
                  sqlPreparedQuery~
                    - select distinct property
                    - from sampleProperties
                select value10
                  screenLabel~
                  value= n/a
                  setName~ excelColumns
              rowGroup
                span Comments/Notes
                select comments
                  screenLabel~
                  value= n/a
                  setName~ excelColumns

          fieldSet
            legend Upload File
              class= legend
            vertical
              file Sample Data
                destinationFolderName~ sampleData

      jython
        #f = open('/Users/martynashallenberg/labmgmt/public/sampleData/{Sample Data}')
        f = open('public/sampleData/{Sample Data}')
        for allLines in f:
          allLines = allLines.replace('\t',',')
          allLines = allLines.replace('\r\n','\n')
          allLines = allLines.replace('\r','\n')
          lines = allLines.split('\n')
          for line in lines:
            fields = line.split(',')
            if fields[0] != '':

              insertDataSQL = switchboard.connection.prepareStatement( "INSERT INTO storageDataUpload (
                + practiceId
                + , aliquotId, sampleType, collectionDate
                + , storageBox, storageWell
                + , subjectId, firstName, middleName, lastName, age, dob, gender, ethnicity, mrn
                + , property1, value1
                + , property2, value2
                + , property3, value3
                + , property4, value4
                + , property5, value5
                + , property6, value6
                + , property7, value7
                + , property8, value8
                + , property9, value9
                + , property10, value10
                + , comments, eventId)
                + VALUES
                + (?
                + , ?, ?, ?
                + , ?, ?
                + , ?, ?, ?, ?, ?, ?, ?, ?, ?
                + , ?, ?
                + , ?, ?
                + , ?, ?
                + , ?, ?
                + , ?, ?
                + , ?, ?
                + , ?, ?
                + , ?, ?
                + , ?, ?
                + , ?, ?
                + , ?, ?)")

              #### PRACTICE & ALIQUOT
              insertDataSQL.setString(1, '{practiceId}')
              insertDataSQL.setString(2, fields[{aliquotId}])
              insertDataSQL.setString(3, fields[{sampleType}])
              insertDataSQL.setString(4, fields[{collectionDate}])

              ### STORAGE LOCATION
              if '{boxId}' != 'n/a':
                insertDataSQL.setString(5, fields[{boxId}])
              else:
                insertDataSQL.setString(5, '')
              if '{well}' != 'n/a':
                insertDataSQL.setString(6, fields[{well}])
              else:
                insertDataSQL.setString(6, '')

              ### PATIENT INFO
              if '{subjectId}' != 'n/a':
                insertDataSQL.setString(7, fields[{subjectId}])
              else:
                insertDataSQL.setString(7, '')
              if '{firstName}' != 'n/a':
                insertDataSQL.setString(8, fields[{firstName}])
              else:
                insertDataSQL.setString(8, '')
              if '{middleName}' != 'n/a':
                insertDataSQL.setString(9, fields[{middleName}])
              else:
                insertDataSQL.setString(9, '')
              if '{lastName}' != 'n/a':
                insertDataSQL.setString(10, fields[{lastName}])
              else:
                insertDataSQL.setString(10, '')
              if '{age}' != 'n/a':
                insertDataSQL.setString(11, fields[{age}])
              else:
                insertDataSQL.setString(11, '')
              if '{dob}' != 'n/a':
                insertDataSQL.setString(12, fields[{dob}])
              else:
                insertDataSQL.setString(12, '')
              if '{gender}' != 'n/a':
                insertDataSQL.setString(13, fields[{gender}])
              else:
                insertDataSQL.setString(13, '')
              if '{ethnicity}' != 'n/a':
                insertDataSQL.setString(14, fields[{ethnicity}])
              else:
                insertDataSQL.setString(14, '')
              if '{mrn}' != 'n/a':
                insertDataSQL.setString(15, fields[{mrn}])
              else:
                insertDataSQL.setString(15, '')

              ### PROPERTY 1
              insertDataSQL.setString(16, '{property1}')
              if '{value1}' != 'n/a':
                insertDataSQL.setString(17, fields[{value1}])
              else:
                insertDataSQL.setString(17, '')
              ### PROPERTY 2
              insertDataSQL.setString(18, '{property2}')
              if '{value2}' != 'n/a':
                insertDataSQL.setString(19, fields[{value2}])
              else:
                insertDataSQL.setString(19, '')
              ### PROPERTY 3
              insertDataSQL.setString(20, '{property3}')
              if '{value3}' != 'n/a':
                insertDataSQL.setString(21, fields[{value3}])
              else:
                insertDataSQL.setString(21, '')
              ### PROPERTY 4
              insertDataSQL.setString(22, '{property4}')
              if '{value4}' != 'n/a':
                insertDataSQL.setString(23, fields[{value4}])
              else:
                insertDataSQL.setString(23, '')
              ### PROPERTY 5
              insertDataSQL.setString(24, '{property5}')
              if '{value5}' != 'n/a':
                insertDataSQL.setString(25, fields[{value5}])
              else:
                insertDataSQL.setString(25, '')
              ### PROPERTY 6
              insertDataSQL.setString(26, '{property6}')
              if '{value6}' != 'n/a':
                insertDataSQL.setString(27, fields[{value6}])
              else:
                insertDataSQL.setString(27, '')
              ### PROPERTY 7
              insertDataSQL.setString(28, '{property7}')
              if '{value7}' != 'n/a':
                insertDataSQL.setString(29, fields[{value7}])
              else:
                insertDataSQL.setString(29, '')
              ### PROPERTY 8
              insertDataSQL.setString(30, '{property8}')
              if '{value8}' != 'n/a':
                insertDataSQL.setString(31, fields[{value8}])
              else:
                insertDataSQL.setString(31, '')
              ### PROPERTY 9
              insertDataSQL.setString(32, '{property9}')
              if '{value9}' != 'n/a':
                insertDataSQL.setString(33, fields[{value9}])
              else:
                insertDataSQL.setString(33, '')
              ### PROPERTY 10
              insertDataSQL.setString(34, '{property10}')
              if '{value10}' != 'n/a':
                insertDataSQL.setString(35, fields[{value10}])
              else:
                insertDataSQL.setString(35, '')

              ### COMMENTS
              if '{comments}' != 'n/a':
                insertDataSQL.setString(36, fields[{comments}])
              else:
                insertDataSQL.setString(36, '')

              ### EVENTID
              insertDataSQL.setLong(37, switchboard.eventId)

              insertDataSQL.executeUpdate()

        f.close()

      # sql
      #   - insert into entityRelations (entityId, memberId, role, eventId)
      #   - select '{practiceId}', '{physicianId}', 'Principal Investigator', {_eventId}
      #   - from dual
      #   - where '{physicianId}' <> ''
      #   - and not exists (select 1
      #   -                 from entityRelations
      #   -                 where entityId = '{practiceId}'
      #   -                 and memberId = '{physicianId}'
      #   -                 and role = 'Principal Investigator')

      ### CREATE PATIENTS
      forEach
        - select distinct
        -   subjectId, firstName, middleName, lastName, age, dob, gender, ethnicity, mrn
        - from storageDataUpload
        - where eventId = {_eventId}

        ### UPDATE PATIENT INFO IF SUBJECT ID EXISTS FOR PRACTICE
        ifCondition select 1 from entityRelations er
          - inner join patients p
          - on er.memberId = p.patientId
          - where er.entityId = '{practiceId}'
          - and p.subjectId = '{_:subjectId}'

          setFormQueryResult
            sqlPreparedQuery select patientId
              - from entityRelations er
              - inner join patients p
              - on er.memberId = p.patientId
              - where er.entityId = '{practiceId}'
              - and p.subjectId = '{_:subjectId}'

          sqlPreparedStatement
            - update storageDataUpload
            - set patientId = ?
            - where subjectId = ?
            - and eventId = ?
            string {_:patientId}
            string {_:subjectId}
            long {_eventId}

          sqlPreparedStatement
            - update entities
            - set firstName = ?
            - where firstName <> ?
            - and ? <> ''
            - and entityId = ?
            string {_:firstName}
            string {_:firstName}
            string {_:firstName}
            string {_:patientId}

          sqlPreparedStatement
            - update entities
            - set middleName = ?
            - where middleName <> ?
            - and ? <> ''
            - and entityId = ?
            string {_:middleName}
            string {_:middleName}
            string {_:middleName}
            string {_:patientId}
          sqlPreparedStatement
            - update entities
            - set lastName = ?
            - where lastName <> ?
            - and ? <> ''
            - and entityId = ?
            string {_:lastName}
            string {_:lastName}
            string {_:lastName}
            string {_:patientId}
          sqlPreparedStatement
            - update patients
            - set age = ?
            - where age <> ?
            - and ? <> ''
            - and patientId = ?
            string {_:age}
            string {_:age}
            string {_:age}
            string {_:patientId}
          sqlPreparedStatement
            - update patients
            - set dob = ?
            - where dob <> ?
            - and ? <> ''
            - and patientId = ?
            string {_:dob}
            string {_:dob}
            string {_:dob}
            string {_:patientId}
          sqlPreparedStatement
            - update patients
            - set gender = ?
            - where gender <> ?
            - and ? <> ''
            - and patientId = ?
            string {_:gender}
            string {_:gender}
            string {_:gender}
            string {_:patientId}
          sqlPreparedStatement
            - update patients
            - set ethnicity = ?
            - where ethnicity <> ?
            - and ? <> ''
            - and patientId = ?
            string {_:ethnicity}
            string {_:ethnicity}
            string {_:ethnicity}
            string {_:patientId}
          sqlPreparedStatement
            - update patients
            - set mrn = ?
            - where mrn <> ?
            - and ? <> ''
            - and patientId = ?
            string {_:mrn}
            string {_:mrn}
            string {_:mrn}
            string {_:patientId}

        ### CREATE NEW PATIENT IF SUBJECT ID DOES NOT EXISTS FOR PRACTICE
        ifCondition ! select 1 from entityRelations er
          - inner join patients p
          - on er.memberId = p.patientId
          - where er.entityId = '{practiceId}'
          - and p.subjectId = '{_:subjectId}'

          setFormQueryResult
            sqlPreparedQuery select 'PA{_getNextSequence:patientId}' as "patientId"

          sqlPreparedStatement
            - update storageDataUpload
            - set patientId = ?
            - where subjectId = ?
            - and eventId = ?
            string {_:patientId}
            string {_:subjectId}
            long {_eventId}
          sqlPreparedStatement
            - insert into containers (containerId, containerType, eventId)
            - values (?, 'patientId', ?)
            string {_:patientId}
            long {_eventId}

          sqlPreparedStatement
            - insert into containerHistory (containerId, eventId)
            - values (?, ?)
            string {_:patientId}
            long {_eventId}
          sqlPreparedStatement
            - insert into contents (containerId, attribute, contentType, content, eventId)
            - values (?, 'self', 'patientId', ?, ?)
            string {_:patientId}
            string {_:patientId}
            long {_eventId}

          sqlPreparedStatement
            - insert into entities (entityId, entityType, firstName, middleName, lastName, status, eventId)
            - values (?, 'Patient', ?, ?, ?, 'active', ?)
            string {_:patientId}
            string {_:firstName}
            string {_:middleName}
            string {_:lastName}
            long {_eventId}
          sqlPreparedStatement
            - insert into entityRelations (entityId, memberId, role, eventId)
            - values (?, ?, 'Patient', ?)
            string {practiceId}
            string {_:patientId}
            long {_eventId}
          sqlPreparedStatement
            - insert into patients (patientId, subjectId, dob, mrn, gender, ethnicity, age, eventId)
            - values (?, ?, ?, ?, ?, ?, ?, ?)
            string {_:patientId}
            string {_:subjectId}
            string {_:dob}
            string {_:mrn}
            string {_:gender}
            string {_:ethnicity}
            string {_:age}
            long {_eventId}

      ## CREATE SPECIMEN
      forEach
        - select distinct
        -   patientId, sampleType, collectionDate,
        -   property1, value1, property2, value2, property3, value3, property4, value4, property5, value5,
        -   property6, value6, property7, value7, property8, value8, property9, value9, property10, value10
        - from storageDataUpload
        - where eventId = {_eventId}

        ### IF SAMPLE ID EXISTS UPDATE PROPERTIES
        ifCondition
          advanced~
          sqlPreparedQuery~ select 1 from contents c
            - inner join sampleProperties sp
            - on c.content = sp.sampleId
            - inner join sampleProperties sp2
            - on c.content = sp2.sampleId
            - where c.contentType = 'specimenId'
            - and c.containerId = ?
            - and sp.property = 'Sample Type'
            - and sp.value = ?
            - and sp2.property = 'Collection Date'
            - and sp2.value = ?
            string {_:patientId}
            string {_:sampleType}
            string {_:collectionDate}

          setFormQueryResult
            sqlPreparedQuery select c.content as "sampleId"
              - from contents c
              - inner join sampleProperties sp
              - on c.content = sp.sampleId
              - inner join sampleProperties sp2
              - on c.content = sp2.sampleId
              - where c.contentType = 'specimenId'
              - and c.containerId = '{_:patientId}'
              - and sp.property = 'Sample Type'
              - and sp.value = '{_:sampleType}'
              - and sp2.property = 'Collection Date'
              - and sp2.value = '{_:collectionDate}'

          sqlPreparedStatement
            - update storageDataUpload
            - set specimenId = ?
            - where patientId = ?
            - and sampleType = ?
            - and collectionDate = ?
            - and eventId = ?
            string {_:sampleId}
            string {_:patientId}
            string {_:sampleType}
            string {_:collectionDate}
            long {_eventId}

          ### 1-10 ###
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            - (select ?, ?, ?, ?
            -  from dual
            - where not exists (select 1 from sampleProperties where sampleId = ? and property = ?))
            string {_:sampleId}
            string {_:property1}
            string {_:value1}
            long {_eventId}
            string {_:sampleId}
            string {_:property1}

          sqlPreparedStatement
            - update sampleProperties
            - set value = ?, eventId = ?
            - where sampleId = ?
            - and property = ?
            - and value <> ?
            - and eventId <> ?
            - and ? <> ''
            string {_:value1}
            long {_eventId}
            string {_:sampleId}
            string {_:property1}
            string {_:value1}
            long {_eventId}
            string {_:value1}
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            - (select ?, ?, ?, ?
            -  from dual
            - where not exists (select 1 from sampleProperties where sampleId = ? and property = ?))
            string {_:sampleId}
            string {_:property2}
            string {_:value2}
            long {_eventId}
            string {_:sampleId}
            string {_:property2}

          sqlPreparedStatement
            - update sampleProperties
            - set value = ?, eventId = ?
            - where sampleId = ?
            - and property = ?
            - and value <> ?
            - and eventId <> ?
            - and ? <> ''
            string {_:value2}
            long {_eventId}
            string {_:sampleId}
            string {_:property2}
            string {_:value2}
            long {_eventId}
            string {_:value2}
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            - (select ?, ?, ?, ?
            -  from dual
            - where not exists (select 1 from sampleProperties where sampleId = ? and property = ?))
            string {_:sampleId}
            string {_:property3}
            string {_:value3}
            long {_eventId}
            string {_:sampleId}
            string {_:property3}
          sqlPreparedStatement
            - update sampleProperties
            - set value = ?, eventId = ?
            - where sampleId = ?
            - and property = ?
            - and value <> ?
            - and eventId <> ?
            - and ? <> ''
            string {_:value3}
            long {_eventId}
            string {_:sampleId}
            string {_:property3}
            string {_:value3}
            long {_eventId}
            string {_:value3}
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            - (select ?, ?, ?, ?
            -  from dual
            - where not exists (select 1 from sampleProperties where sampleId = ? and property = ?))
            string {_:sampleId}
            string {_:property4}
            string {_:value4}
            long {_eventId}
            string {_:sampleId}
            string {_:property4}
          sqlPreparedStatement
            - update sampleProperties
            - set value = ?, eventId = ?
            - where sampleId = ?
            - and property = ?
            - and value <> ?
            - and eventId <> ?
            - and ? <> ''
            string {_:value4}
            long {_eventId}
            string {_:sampleId}
            string {_:property4}
            string {_:value4}
            long {_eventId}
            string {_:value4}
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            - (select ?, ?, ?, ?
            -  from dual
            - where not exists (select 1 from sampleProperties where sampleId = ? and property = ?))
            string {_:sampleId}
            string {_:property5}
            string {_:value5}
            long {_eventId}
            string {_:sampleId}
            string {_:property5}
          sqlPreparedStatement
            - update sampleProperties
            - set value = ?, eventId = ?
            - where sampleId = ?
            - and property = ?
            - and value <> ?
            - and eventId <> ?
            - and ? <> ''
            string {_:value5}
            long {_eventId}
            string {_:sampleId}
            string {_:property5}
            string {_:value5}
            long {_eventId}
            string {_:value5}
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            - (select ?, ?, ?, ?
            -  from dual
            - where not exists (select 1 from sampleProperties where sampleId = ? and property = ?))
            string {_:sampleId}
            string {_:property6}
            string {_:value6}
            long {_eventId}
            string {_:sampleId}
            string {_:property6}
          sqlPreparedStatement
            - update sampleProperties
            - set value = ?, eventId = ?
            - where sampleId = ?
            - and property = ?
            - and value <> ?
            - and eventId <> ?
            - and ? <> ''
            string {_:value6}
            long {_eventId}
            string {_:sampleId}
            string {_:property6}
            string {_:value6}
            long {_eventId}
            string {_:value6}
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            - (select ?, ?, ?, ?
            -  from dual
            - where not exists (select 1 from sampleProperties where sampleId = ? and property = ?))
            string {_:sampleId}
            string {_:property7}
            string {_:value7}
            long {_eventId}
            string {_:sampleId}
            string {_:property7}
          sqlPreparedStatement
            - update sampleProperties
            - set value = ?, eventId = ?
            - where sampleId = ?
            - and property = ?
            - and value <> ?
            - and eventId <> ?
            - and ? <> ''
            string {_:value7}
            long {_eventId}
            string {_:sampleId}
            string {_:property7}
            string {_:value7}
            long {_eventId}
            string {_:value7}
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            - (select ?, ?, ?, ?
            -  from dual
            - where not exists (select 1 from sampleProperties where sampleId = ? and property = ?))
            string {_:sampleId}
            string {_:property8}
            string {_:value8}
            long {_eventId}
            string {_:sampleId}
            string {_:property8}
          sqlPreparedStatement
            - update sampleProperties
            - set value = ?, eventId = ?
            - where sampleId = ?
            - and property = ?
            - and value <> ?
            - and eventId <> ?
            - and ? <> ''
            string {_:value8}
            long {_eventId}
            string {_:sampleId}
            string {_:property8}
            string {_:value8}
            long {_eventId}
            string {_:value8}
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            - (select ?, ?, ?, ?
            -  from dual
            - where not exists (select 1 from sampleProperties where sampleId = ? and property = ?))
            string {_:sampleId}
            string {_:property9}
            string {_:value9}
            long {_eventId}
            string {_:sampleId}
            string {_:property9}
          sqlPreparedStatement
            - update sampleProperties
            - set value = ?, eventId = ?
            - where sampleId = ?
            - and property = ?
            - and value <> ?
            - and eventId <> {_eventId}
            - and ? <> ''
            string {_:value9}
            long {_eventId}
            string {_:sampleId}
            string {_:property9}
            string {_:value9}
            long {_eventId}
            string {_:value9}
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            - (select ?, ?, ?, {?
            -  from dual
            - where not exists (select 1 from sampleProperties where sampleId = ? and property = ?))
            string {_:sampleId}
            string {_:property10}
            string {_:value10}
            long {_eventId}
            string {_:sampleId}
            string {_:property10}
          sqlPreparedStatement
            - update sampleProperties
            - set value = ?, eventId = ?
            - where sampleId = ?
            - and property = ?
            - and value <> ?
            - and eventId <> ?
            - and ? <> ''
            string {_:value10}
            long {_eventId}
            string {_:sampleId}
            string {_:property10}
            string {_:value10}
            long {_eventId}
            string {_:value10}

        ### IF SAMPLE ID DOES NOT EXISTS INSERT PROPERTIES
        ifCondition
          advanced~
          not~
            sqlPreparedQuery~ select 1 from contents c
              - inner join sampleProperties sp
              - on c.content = sp.sampleId
              - inner join sampleProperties sp2
              - on c.content = sp2.sampleId
              - where c.contentType = 'specimenId'
              - and c.containerId = ?
              - and sp.property = 'Sample Type'
              - and sp.value = ?
              - and sp2.property = 'Collection Date'
              - and sp2.value = ?
              string {_:patientId}
              string {_:sampleType}
              string {_:collectionDate}

          setFormQueryResult
            sqlPreparedQuery select 'SP{_getNextSequence:patientId}' as "sampleId"

          sqlPreparedStatement
            - update storageDataUpload
            - set specimenId = ?
            - where patientId = ?
            - and sampleType = ?
            - and collectionDate = ?
            - and eventId = ?
            string {_:sampleId}
            string {_:patientId}
            string {_:sampleType}
            string {_:collectionDate}
            long {_eventId}

          sqlPreparedStatement
            - insert into containers (containerId, containerType, eventId)
            - values (?, 'specimenId', ?)
            string {_:sampleId}
            long {_eventId}
          sqlPreparedStatement
            - insert into containerHistory (containerId, eventId)
            - values (?, ?)
            string {_:sampleId}
            long {_eventId}
          sqlPreparedStatement
            - insert into contents (containerId, attribute, contentType, content, eventId)
            - values (?, 'self', 'specimenId', ?, ?)
            string {_:sampleId}
            string {_:sampleId}
            long {_eventId}
          sqlPreparedStatement
            - insert into contents (containerId, attribute, contentType, content, eventId)
            - values (?, 'self', 'specimenId', ?, ?)
            string {_:patientId}
            string {_:sampleId}
            long {_eventId}
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            - values (?, 'Sample Type', ?, ?)
            string {_:sampleId}
            string {_:sampleType}
            long {_eventId}

          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            - values (?, 'Collection Date', ?, ?)
            string {_:sampleId}
            string {_:collectionDate}
            long {_eventId}

            ### 1-10 ###
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            - select ?, ?, ?, ?
            - from dual
            - where ? <> ''
            string {_:sampleId}
            string {_:property1}
            string {_:value1}
            long {_eventId}
            string {_:property1}
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            - select ?, ?, ?, ?
            - from dual
            - where ? <> ''
            string {_:sampleId}
            string {_:property2}
            string {_:value2}
            long {_eventId}
            string {_:property2}
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            - select ?, ?, ?, ?
            - from dual
            - where ? <> ''
            string {_:sampleId}
            string {_:property3}
            string {_:value3}
            long {_eventId}
            string {_:property3}
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            - select ?, ?, ?, ?
            - from dual
            - where ? <> ''
            string {_:sampleId}
            string {_:property4}
            string {_:value4}
            long {_eventId}
            string {_:property4}
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            - select ?, ?, ?, ?
            - from dual
            - where ? <> ''
            string {_:sampleId}
            string {_:property5}
            string {_:value5}
            long {_eventId}
            string {_:property5}
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            - select ?, ?, ?, ?
            - from dual
            - where ? <> ''
            string {_:sampleId}
            string {_:property6}
            string {_:value6}
            long {_eventId}
            string {_:property6}
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            - select ?, ?, ?, ?
            - from dual
            - where ? <> ''
            string {_:sampleId}
            string {_:property7}
            string {_:value7}
            long {_eventId}
            string {_:property7}
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            - select ?, ?, ?, ?
            - from dual
            - where ? <> ''
            string {_:sampleId}
            string {_:property8}
            string {_:value8}
            long {_eventId}
            string {_:property8}
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            - select ?, ?, ?, ?
            - from dual
            - where ? <> ''
            string {_:sampleId}
            string {_:property9}
            string {_:value9}
            long {_eventId}
            string {_:property9}
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            - select ?, ?, ?, ?
            - from dual
            - where ? <> ''
            string {_:sampleId}
            string {_:property10}
            string {_:value10}
            long {_eventId}
            string {_:property10}

      ## CREATE ALIQUOTS
      forEach
        - select distinct
        -   aliquotId, storageBox, storageWell, specimenId
        - from storageDataUpload
        - where eventId = {_eventId}

        sqlPreparedStatement
          - insert ignore into containers (containerId, containerType, eventId)
          - values (?, 'aliquotId', ?)
          string {_:aliquotId}
          long {_eventId}
        sqlPreparedStatement
          - insert into containerHistory (containerId, eventId)
          - values (?, ?)
          string {_:aliquotId}
          long {_eventId}
        sqlPreparedStatement
          - insert into contents (containerId, attribute, contentType, content, eventId)
          - select ?, 'self', 'aliquotId', ?, ?
          - from dual
          - where not exists (select 1 from contents where containerId = ? and content = ?)
          string {_:aliquotId}
          string {_:aliquotId}
          long {_eventId}
          string {_:aliquotId}
          string {_:aliquotId}
        sqlPreparedStatement
          - insert into contents (containerId, attribute, contentType, content, eventId)
          - select '{_:aliquotId}', 'self', 'specimenId', '{_:specimenId}', {_eventId}
          - from dual
          - where not exists (select 1 from contents where containerId = '{_:aliquotId}' and content = '{_:specimenId}')
          string {_:aliquotId}
          string {_:specimenId}
          long {_eventId}
          string {_:aliquotId}
          string {_:specimenId}

        sqlPreparedStatement~ delete from storage where content = '{_:aliquotId}' and '{_:storageBox}' <> '' and '{_:storageWell}' <> ''
          string {_:aliquotId}
          string {_:storageBox}
          string {_:storageWell}

        sqlPreparedStatement
          - insert ignore into storage (storageContainerId, location, contentType, content, eventId)
          - select ?,
          -         case length(?)
          -           when 3 then ?
          -           when 2 then concat(left(?,1),'0',right(?,1))
          -         end
          -         , 'aliquotId'
          -         , ?
          -         , ?
          - from dual where ? <> '' and ? <> ''
          string {_:storageBox}
          string {_:storageWell}
          string {_:storageWell}
          string {_:storageWell}
          string {_:storageWell}
          string {_:aliquotId}
          long {_eventId}
          string {_:storageBox}
          string {_:storageWell}
        ifCondition
          advanced~
          not~
            sqlPreparedQuery~ select containerId from containers where containerId = ?
              string {_:storageBox}
          sqlPreparedStatement~ insert into containers (containerId, containerType, eventId) values
            - (?, 'Storage Box', ?)
            string {_:storageBox}
            long {_eventId}
          sqlPreparedStatement~ insert into contents (containerId, attribute, contentType, content, eventId) values
            - (?, 'self','Storage Box', ?, ?)
            string {_:storageBox}
            string {_:storageBox}
            long {_eventId}

      forEach select storageContainerId
        - from storage
        - where eventId = {_eventId}

        ifCondition
          advanced~
          not~
            sqlPreparedQuery~ select 1 from storage where content = ?
              string {_:storageContainerId}
          sqlPreparedStatement
            - insert into storage (storageContainerId, location, contentType, content, eventId)
            - values ('ARCHIVE SYSTEM', 'self', 'Storage Box', ?, ?)
            string {_:storageContainerId}
            long {_eventId}

        #sql call reassignStoragePaths('{_:storageContainerId}')

      validateSql~ ! select 1 from storageDataUpload sdu
        - inner join patients p
        - on sdu.patientId = p.patientId
        - and sdu.eventId = p.eventId
        - inner join containers c
        - on sdu.aliquotId = c.containerId
        - where sdu.eventId = {_eventId}
        - and c.containerType = 'aliquotId'
        - and c.eventId <> {_eventId}
        errorMessage~ There are aliquotIds in your upload file which have been previously associated with a different patient. Please review your data.


    step Request Testing from Storage
      form
        include userAccountInfo
        vertical
          container specimenId
            screenLabel~ Specimen ID
            acceptQueue~ any
          #select testType
          #  screenLabel~ Test Type
          #  setName~ formType
          #  required~ true
      form
        include userAccountInfo
        formQuery~ SELECT CASE '{specimenId}' WHEN '' THEN '{_recId}' ELSE '{specimenId}' END AS specimen
        formQuery~ select reqId from requestSpecimens where specimenId = '{_:specimen}'
          - union select 'NEW' from dual
        script
          - $(document).ready(function() {
          -   $('#editButton').click(function() {
          -     window.open('/uniflow?stepName=Specimen+Information&lastForm=Y&recId=' + $('#specimenId').val(), "_parent");
          -   });
          - });
        div
          style= float:left;
          vertical
            fieldset
              legend Sample Status Info
                class= legend
              vertical
                container specimenId
                  id= specimenId
                  screenLabel~ Specimen ID
                  readonly=
                  value= {_:specimen}
                  acceptQueue~ any
                  style= background-color:transparent; border:0;
                text requestId
                  screenLabel~ Accession ID
                  value= {_:reqId}
                  style= background-color:transparent; border:0;
                  readonly=
              vertical
                table
                  caption Sample History
                  sqlPreparedQuery~
                    - select distinct e.step, e.userId, e.eventDate
                    - from containerHistory h
                    - inner join events e
                    - on h.eventId = e.eventId
                    - where h.containerId = '{_:specimen}'
                    - order by e.eventId
                table
                  caption Currently on Queue
                  sqlPreparedQuery~
                    - select q.containerId as container, q.step, e.userId, e.eventDate
                    - from queues q
                    - inner join events e
                    - on q.eventId = e.eventId
                    - where q.containerId = '{_:reqId}'
                    - or q.containerId = '{_:specimen}'

        div
          style= float:left;
          vertical
            fieldset
              legend Sample Information
                class= legend
              vertical
                table
                  sqlPreparedQuery~
                    - select distinct Property, Value
                    - from contents c
                    - inner join sampleProperties sp
                    - on c.content = sp.sampleId
                    - where c.containerId = '{_:specimen}'
                    - and (c.contentType = 'specimenId' or c.contentType = 'sampleId')
        div
          style= clear:both;
          vertical
            fieldset
              legend Test Selection
                class= legend
                style= font-weight:bold;
              vertical
                select queueStep
                  screenLabel~ Queue to Step
                  option QC Requisition
                  required~ true
                select test
                  screenLabel~ Test
                  setName~ formType
                  title= SETNAME:formType
      allowDuplicateContainerIds true

      ### Insert into queues
      ifCondition {queueStep}
        advanced~
        equals~ QC Requisition
        and~ {requestId}
        not~
          equals~ NEW
        sqlPreparedStatement
          - insert into queues (containerId, step, eventId)
          - values (?,'QC Requisition',?)
          string {requestId}
          long {_eventId}

      ifCondition {queueStep}
        advanced~
        not~
          equals~ QC Requisition
        sqlPreparedStatement
          - insert into queues (containerId, step, eventId)
          - values (?,?,?)
          string {specimenId}
          string {queueStep}
          long {_eventId}


      ifCondition {requestId}
        advanced~
        equals~ NEW
        setFormQueryResult
          sqlPreparedQuery select prefix as 'sequencePrefix' from sequencePrefix where sequenceName = ?
            string reqId
        setFormQueryResult
          sqlPreparedQuery {_:sequencePrefix}
          setFormQueryResult reqId1
            value= {_:prefix}{_getNextSequence:reqId}
        sqlPreparedStatement
          - insert into containers (containerId, containerType, eventId)
          - values (?,'requestId', ?)
          string {_:reqId1}
          long {_eventId}
        sqlPreparedStatement
          - insert into contents (containerId, attribute, contentType, content, eventId)
          - values (?,'self', 'requestId', ?, ?)
          string {_:reqId1}
          string {_:reqId1}
          long {_eventId}
        sqlPreparedStatement
          - insert into requestForms
          -   (Id,patientId,physicianId,organizationId,specimenId,
          -   tissueType,sampleType, testType,
          -   histodiagnostic,tubes,otherDescription,
          -   collectionDate,collectionTime,amPm,receivedDate,clinicalHistory,histopatholigicDiagnosis,
          -   icdCodes1,icdCodes2,icdCodes3,icdCodes4,icdCodes5,icdCodes6,eventId
          -   )
          - SELECT ?, pat.containerId, phy.entityId, pra.entityId, c.content,
          -         sp.value, sp2.value, ?,
          -         sp3.value, sp4.value, sp5.value,
          -         sp6.value, sp7.value, sp8.value, sp9.value, sp10.value, sp11.value,
          -         sp12.value, sp13.value, sp14.value, sp15.value, sp16.value, sp17.value, ?
          - FROM contents c
          - left join sampleProperties sp
          - on c.content = sp.sampleId
          - and 'Tissue Type' = sp.property
          - left join sampleProperties sp2
          - on c.content  = sp2.sampleId
          - and 'Sample Type' = sp2.property
          - left join sampleProperties sp3
          - on c.content  = sp3.sampleId
          - and 'Diagnostic' = sp3.property
          - left join sampleProperties sp4
          - on c.content  = sp4.sampleId
          - and 'Number of Tubes' = sp4.property
          - left join sampleProperties sp5
          - on c.content  = sp5.sampleId
          - and 'Description' = sp5.property
          - left join sampleProperties sp6
          - on c.content  = sp6.sampleId
          - and 'Collection Date' = sp6.property
          - left join sampleProperties sp7
          - on c.content  = sp7.sampleId
          - and 'Collection Time' = sp7.property
          - left join sampleProperties sp8
          - on c.content  = sp8.sampleId
          - and 'Collection Time Period' = sp8.property
          - left join sampleProperties sp9
          - on c.content = sp9.sampleId
          - and 'Date Received' = sp9.property
          - left join sampleProperties sp10
          - on c.content = sp10.sampleId
          - and 'Clinical History' = sp10.property
          - left join sampleProperties sp11
          - on c.content = sp11.sampleId
          - and 'Histopathologic Diagnosis' = sp11.property
          - left join sampleProperties sp12
          - on c.content  = sp12.sampleId
          - and 'ICD Code 1' = sp12.property
          - left join sampleProperties sp13
          - on c.content  = sp13.sampleId
          - and 'ICD Code 2' = sp13.property
          - left join sampleProperties sp14
          - on c.content  = sp14.sampleId
          - and 'ICD Code 3' = sp14.property
          - left join sampleProperties sp15
          - on c.content  = sp15.sampleId
          - and 'ICD Code 4' = sp15.property
          - left join sampleProperties sp16
          - on c.content  = sp16.sampleId
          - and 'ICD Code 5' = sp16.property
          - left join sampleProperties sp17
          - on c.content  = sp17.sampleId
          - and 'ICD Code 6' = sp17.property
          - left join (
          -   select c.containerId, c.content, e.age, e.ethnicity, e.gender
          -   from contents c
          -   inner join patients e
          -   on c.containerId = e.patientId) pat
          - on c.content  = pat.content
          - left join (select er.entityId, er.memberId
          - from entityRelations er
          - inner join entities e
          - on er.entityId = e.entityId
          - where e.entityType = 'Organization') pra
          - on pat.containerId = pra.memberId
          - left join (select er.entityId, er.memberId
          - from entityRelations er
          - inner join entities e
          - on er.entityId = e.entityId
          - where e.entityType = 'Physician') phy
          - on pat.containerId = phy.memberId
          - left join (select er.entityId, er.memberId
          - from entityRelations er
          - inner join entities e
          - on er.entityId = e.entityId
          - where e.entityType = 'Clinical Contact') ass
          - on pat.containerId = ass.memberId
          - where c.content = ?
          - and (c.contentType = 'specimenId' or c.contentType = 'sampleId')
          - limit 1
          string {_:reqId1}
          string {test}
          long {_eventId}
          string {specimenId}
      ifCondition
        advanced~
        sqlPreparedQuery~ select 1 from requestForms where id = ?
          string {requestId}
        sqlPreparedStatement
          - update requestForms rf
          - inner join contents c
          - on rf.specimenId = c.content
          - inner join sampleProperties sp
          - on c.containerId = sp.sampleProperty
          - set rf.tissueType = sp.value
          - where c.content = ?
          - and (c.contentType = 'specimenId' or c.contentType = 'sampleId')
          - and sp.property = 'Tissue Type'
          - and rf.tissueType <> sp.value
          string {specimenId}
        sqlPreparedStatement
          - update requestForms rf
          - inner join contents c
          - on rf.specimenId = c.content
          - inner join sampleProperties sp
          - on c.containerId = sp.sampleProperty
          - set rf.sampleType = sp.value
          - where c.content = ?
          - and (c.contentType = 'specimenId' or c.contentType = 'sampleId')
          - and sp.property = 'Sample Type'
          - and rf.sampleType <> sp.value
          string {specimenId}
        sqlPreparedStatement
          - update requestForms rf
          - inner join contents c
          - on rf.specimenId = c.content
          - inner join sampleProperties sp
          - on c.containerId = sp.sampleProperty
          - set rf.histodiagnostic = sp.value
          - where c.content = ?
          - and (c.contentType = 'specimenId' or c.contentType = 'sampleId')
          - and sp.property = 'Diagnostic'
          - and rf.histodiagnostic <> sp.value
          string {specimenId}
        sqlPreparedStatement
          - update requestForms rf
          - inner join contents c
          - on rf.specimenId = c.content
          - inner join sampleProperties sp
          - on c.containerId = sp.sampleProperty
          - set rf.tubes = sp.value
          - where c.content = ?
          - and (c.contentType = 'specimenId' or c.contentType = 'sampleId')
          - and sp.property = 'Number of Tubes'
          - and rf.tubes <> sp.value
          string {specimenId}
        sqlPreparedStatement
          - update requestForms rf
          - inner join contents c
          - on rf.specimenId = c.content
          - inner join sampleProperties sp
          - on c.containerId = sp.sampleProperty
          - set rf.otherDescription = sp.value
          - where c.content = ?
          - and (c.contentType = 'specimenId' or c.contentType = 'sampleId')
          - and sp.property = 'Description'
          - and rf.otherDescription <> sp.value
          string {specimenId}
        sqlPreparedStatement
          - update requestForms rf
          - inner join contents c
          - on rf.specimenId = c.content
          - inner join sampleProperties sp
          - on c.containerId = sp.sampleProperty
          - set rf.collectionDate = sp.value
          - where c.content = ?
          - and (c.contentType = 'specimenId' or c.contentType = 'sampleId')
          - and sp.property = 'Collection Date'
          - and f.collectionDate <> sp.value
          string {specimenId}
        sqlPreparedStatement
          - update requestForms rf
          - inner join contents c
          - on rf.specimenId = c.content
          - inner join sampleProperties sp
          - on c.containerId = sp.sampleProperty
          - set rf.collectionTime = sp.value
          - where c.content = ?
          - and (c.contentType = 'specimenId' or c.contentType = 'sampleId')
          - and sp.property = 'Collection Time'
          - and rf.collectionTime <> sp.value
          string {specimenId}
        sqlPreparedStatement
          - update requestForms rf
          - inner join contents c
          - on rf.specimenId = c.content
          - inner join sampleProperties sp
          - on c.containerId = sp.sampleProperty
          - set rf.amPm = sp.value
          - where c.content = ?
          - and (c.contentType = 'specimenId' or c.contentType = 'sampleId')
          - and sp.property = 'Collection Time Period'
          - and rf.amPm <> sp.value
          string {specimenId}
        sqlPreparedStatement
          - update requestForms rf
          - inner join contents c
          - on rf.specimenId = c.content
          - inner join sampleProperties sp
          - on c.containerId = sp.sampleProperty
          - set rf.receivedDate = sp.value
          - where c.content = ?
          - and (c.contentType = 'specimenId' or c.contentType = 'oncoDxId')
          - and sp.property = 'Date Received'
          - and rf.receivedDate <> sp.value
          string {specimenId}
        sqlPreparedStatement
          - update requestForms rf
          - inner join contents c
          - on rf.specimenId = c.content
          - inner join sampleProperties sp
          - on c.containerId = sp.sampleProperty
          - set rf.clinicalHistory = sp.value
          - where c.content = ?
          - and (c.contentType = 'specimenId' or c.contentType = 'oncoDxId')
          - and sp.property = 'Clinical History'
          - and rf.clinicalHistory <> sp.value
          string {specimenId}
        sqlPreparedStatement
          - update requestForms rf
          - inner join contents c
          - on rf.specimenId = c.content
          - inner join sampleProperties sp
          - on c.containerId = sp.sampleProperty
          - set rf.histopatholigicDiagnosis = sp.value
          - where c.content = ?
          - and (c.contentType = 'specimenId' or c.contentType = 'oncoDxId')
          - and sp.property = 'Histopathologic Diagnosis'
          - and rf.histopatholigicDiagnosis <> sp.value
          string {specimenId}
        sqlPreparedStatement
          - update requestForms rf
          - inner join contents c
          - on rf.specimenId = c.content
          - inner join sampleProperties sp
          - on c.containerId = sp.sampleProperty
          - set rf.icdCodes1 = sp.value
          - where c.content = ?
          - and (c.contentType = 'specimenId' or c.contentType = 'oncoDxId')
          - and sp.property = 'ICD Code 1'
          - and rf.icdCodes1 <> sp.value
          string {specimenId}
        sqlPreparedStatement
          - update requestForms rf
          - inner join contents c
          - on rf.specimenId = c.content
          - inner join sampleProperties sp
          - on c.containerId = sp.sampleProperty
          - set rf.icdCodes2 = sp.value
          - where c.content = ?
          - and (c.contentType = 'specimenId' or c.contentType = 'oncoDxId')
          - and sp.property = 'ICD Code 2'
          - and rf.icdCodes2 <> sp.value
          string {specimenId}
        sqlPreparedStatement
          - update requestForms rf
          - inner join contents c
          - on rf.specimenId = c.content
          - inner join sampleProperties sp
          - on c.containerId = sp.sampleProperty
          - set rf.icdCodes3 = sp.value
          - where c.content = ?
          - and (c.contentType = 'specimenId' or c.contentType = 'oncoDxId')
          - and sp.property = 'ICD Code 3'
          - and rf.icdCodes3 <> sp.value
          string {specimenId}
        sqlPreparedStatement
          - update requestForms rf
          - inner join contents c
          - on rf.specimenId = c.content
          - inner join sampleProperties sp
          - on c.containerId = sp.sampleProperty
          - set rf.icdCodes4 = sp.value
          - where c.content = ?
          - and (c.contentType = 'specimenId' or c.contentType = 'oncoDxId')
          - and sp.property = 'ICD Code 4'
          - and rf.icdCodes4 <> sp.value
          string {specimenId}
        sqlPreparedStatement
          - update requestForms rf
          - inner join contents c
          - on rf.specimenId = c.content
          - inner join sampleProperties sp
          - on c.containerId = sp.sampleProperty
          - set rf.icdCodes5 = sp.value
          - where c.content = ?
          - and (c.contentType = 'specimenId' or c.contentType = 'oncoDxId')
          - and sp.property = 'ICD Code 5'
          - and rf.icdCodes5 <> sp.value
          string {specimenId}
        sqlPreparedStatement
          - update requestForms rf
          - inner join contents c
          - on rf.specimenId = c.content
          - inner join sampleProperties sp
          - on c.containerId = sp.sampleProperty
          - set rf.icdCodes6 = sp.value
          - where c.content = ?
          - and (c.contentType = 'specimenId' or c.contentType = 'oncoDxId')
          - and sp.property = 'ICD Code 6'
          - and rf.icdCodes6 <> sp.value,
          string {specimenId}

      forEach select id from requestForms where eventId = {_eventId}
        sqlPreparedStatement~ insert into containers (containerId, containerType, eventId)
          - values (?, 'requestId', ?)
          string {_:id}
          long {_eventId}
        sqlPreparedStatement~ insert into containerHistory (containerId, eventId)
          - values (?, ?)
          string {_:id}
          long {_eventId}
        sqlPreparedStatement~ insert into contents (containerId, attribute, contentType, content, eventId)
          - values (?, 'self', 'requestId', ?, ?)
          string {_:id}
          string {_:id}
          long {_eventId}

        sqlPreparedStatement~ insert into queues
          - values (?, 'Create New Report', ?)
          string {_:id}
          long {_eventId}
        ### update contents table
        sqlPreparedStatement~ insert into contents (containerId,attribute, contentType, content, eventId)
          - (SELECT ?,'patientId','patientId', p.patientId, ?
          -  FROM contents c
          -  inner join contents c2
          -  on c.content = c2.content
          -  inner join patients p
          -  on c.containerId = p.patientId
          -  WHERE c.containerId = ?
          -  AND c.contentType = 'specimenId'
          -  AND c2.contentType = 'specimenId')
          string {_:id}
          long {_eventId}
          string {specimenId}
        sqlPreparedStatement~ insert into contents (containerId,attribute, contentType, content, eventId)
          -  (select ?,'specimenId','specimenId',c.content,?
          -   from contents c
          -   where c.containerId = ?
          -   and c.contentType = 'specimenId')
          string {_:id}
          long {_eventId}
          string {specimenId}
        sqlPreparedStatement~ insert into queues (containerId, step, eventId)
          - values (?, 'QC Requisition', ?)
          string {_:id}
          long {_eventId}
########################################################################################################
###### old Dashboard steps###########
    step User Dashboard
      form
        include userAccountInfo
        include highcharts
        script
          - $(document).ready(function(){
          -   if($('#chpwd').val() == 'yes'){
          -     window.open('/uniflow?stepName=Change+Your+Password&updateStepGroups=true&userStepGroups=Users', '_self');
          -   }
          -  $('.formDiv').css('background-color','white');
          - }); //End of Document Ready!!
          configureIf~ {_accountId}
            advanced~
            equals~ OrderingUser
            or~
              equals~ ReportingUser

        script
          - $(document).ready(function() {
          -   $('#tabs').tabs();
          -   $('#stepFormSubmitButton').hide();
          -   drawPieChart('labWorkPie', 'Ajax Load Lab Work Pie', 'Lab Containers Distribution');
          -   drawBarChart('submits', 'Ajax Top 10 Tasks Performed', $('#startDate').val(), $('#endDate').val(), 'Top 10 Tasks Performed');
          -   drawTATChart('Ajax Load Test Types For TAT', 'Ajax Get TAT By Form Type By Month');
          - });
          - function loadTable(div, step, startDate, endDate)
          - {
          - $('#' + div).load('/uniflow',{stepName: step, startDate: startDate, endDate: endDate});
          - $('#' + div).toggle();
          - }
          - function drawPieChart(div, step, title) {
          -
          -     var pieChart;
          -     var optionsChart2;
          -
          -     optionsChart2 = jQuery.extend(true,{}, piechartOptions);
          -     optionsChart2.chart.renderTo= div;
          -     optionsChart2.chart.height= 500;
          -     optionsChart2.chart.width= 700;
          -     optionsChart2.exporting.enabled= false;
          -     optionsChart2.title.text= title;
          -     $.getJSON('/uniflow?callback=?&stepName='+step,{},
          -    function(data,status)
          -    {
          -       var total=0
          -       optionsChart2.series[0].data=[]
          -       for(i=0; i<data.length; i++) {
          -         total+=parseInt(data[i].Count)
          -       }
          -       for(i=0; i<data.length; i++) {
          -         temp=((data[i].Count/total)*100).toFixed(2);
          -         tempArray=[data[i].xValue,parseFloat(temp)]
          -         optionsChart2.series[0].data.push(tempArray);
          -       }
          -       pieChart = new Highcharts.Chart(optionsChart2);
          -    });
          -
          -  }
          - function drawPieChart2(div, step, title) {
          -     var pieChart;
          -     var optionsChart2;
          -
          -     optionsChart2 = jQuery.extend(true,{}, piechartOptions);
          -     optionsChart2.chart.renderTo= div;
          -     optionsChart2.chart.height= 500;
          -     optionsChart2.chart.width= 700;
          -     optionsChart2.exporting.enabled= false;
          -     optionsChart2.title.text= title;
          -       optionsChart2.series[0].data=[];
          -       optionsChart2.series[0].data.push(['Accessioning', 20]);
          -       optionsChart2.series[0].data.push(['Receiving', 12]);
          -       optionsChart2.series[0].data.push(['Billing', 11]);
          -       optionsChart2.series[0].data.push(['Rework', 4]);
          -       optionsChart2.series[0].data.push(['NGS', 15]);
          -       optionsChart2.series[0].data.push(['CDx', 5]);
          -       optionsChart2.series[0].data.push(['PGx', 18]);
          -       optionsChart2.series[0].data.push(['Reporting', 15]);
          -       pieChart = new Highcharts.Chart(optionsChart2);
          -    }
          - function drawBarChart(div, step, startDate, endDate, title)
          - {
          -     var barChart
          -     var optionsChart
          -
          -     optionsChart = jQuery.extend(true,{}, barchartOptions);
          -     optionsChart.chart.renderTo= div;
          -     optionsChart.chart.height= 550;
          -     optionsChart.chart.width= 800;
          -     optionsChart.exporting.enabled= false;
          -     optionsChart.title.text= title;
          -     optionsChart.yAxis.title.text= '# of Submits';
          -     optionsChart.xAxis.title.text= 'Step';
          -     $.getJSON('/uniflow?callback=?&stepName='+step+'&startDate='+startDate+'&endDate='+endDate,{},
          -    function(data,status)
          -    {
          -
          -       var topCount=1.0
          -         optionsChart.series[0]=[];
          -         optionsChart.series[0].data=[];
          -         optionsChart.series[0].name='# Submits';
          -         optionsChart.xAxis.categories=[];
          -
          -       for(var i=0; i<data.length; i++) {
          -         optionsChart.xAxis.categories.push(data[i].xValue)
          -         optionsChart.series[0].data.push(parseFloat(data[i].Count))
          -         if (parseFloat(data[i].Count) > topCount) {
          -           topCount=data[i].Count
          -         }
          -       }
          -       topCount=(topCount*1.10);
          -       optionsChart.yAxis.max=parseInt(topCount);
          -       barChart = new Highcharts.Chart(optionsChart);
          -
          -
          -    });
          - }
          - function drawTATChart(step1, step2) {
          -  var lineChart;
          -  var optionsChart;
          -
          -   optionsChart = jQuery.extend(true,{}, linechartOptions);
          -   optionsChart.chart.renderTo= tatLine;
          -   optionsChart.chart.width= 800;
          -   optionsChart.exporting.enabled= false;
          -   optionsChart.title.text= 'Last 90 Days Average TAT By Test Type';
          -   optionsChart.yAxis.title.text= 'DAYS';
          -   optionsChart.xAxis.title.text= 'DATE';
          -   optionsChart.xAxis.labels.rotation= -45;
          -   optionsChart.tooltip.valueSuffix= '';
          -     $.getJSON('/uniflow?callback=?&stepName='+step1,{},
          -    function(data,status)
          -    {
          -
          -       for(var i = 0; i < data.length; i++) {
          -         optionsChart.series[i]=[];
          -         optionsChart.series[i].data=[];
          -         optionsChart.series[i].name= data[i].Series;
          -        }
          -       $.getJSON('/uniflow?callback=?&stepName='+step2,{},
          -       function(data1,status)
          -       {
          -           optionsChart.xAxis.categories=[];
          -           for(var k = 0; k < data.length; k++) {
          -             for(var j = 0; j < data1.length; j++) {
          -               if(data1[j].Series == optionsChart.series[k].name) {
          -                  optionsChart.xAxis.categories.push(data1[j].xValue);
          -                  optionsChart.series[k].data.push([data1[j].xValue, parseFloat(data1[j].yValue)]);
          -                  console.log(optionsChart.series[k].name); console.log(data1[j].xValue, data1[j].yValue);
          -               }
          -               else { optionsChart.series[k].data.push([data1[j].xValue, 0]); }
          -              }
          -            }
          -     lineChart = new Highcharts.Chart(optionsChart);
          -        });
          -    });
          - }

          - function drawJQueryLineChart() {
          -
          -
          -
          -  var lineChart;
          -  var optionsChart;
          -
          -   optionsChart = jQuery.extend(true,{}, linechartOptions);
          -   optionsChart.chart.renderTo= tatLine;
          -   optionsChart.chart.width= 800;
          -   optionsChart.exporting.enabled= false;
          -   optionsChart.title.text= 'Average Monthly TAT By Test Type';
          -   optionsChart.yAxis.title.text= 'DAYS';
          -   optionsChart.xAxis.title.text= 'DATE';
          -   optionsChart.xAxis.labels.rotation= -45;
          -   optionsChart.tooltip.valueSuffix= '';
          -   optionsChart.yAxis.plotBands[0] = [];
          -    optionsChart.yAxis.plotBands[0].zIndex= '2';
          -    optionsChart.yAxis.plotBands[0].color= '#EEFEF0';
          -    optionsChart.yAxis.plotBands[0].from= 3;
          -    optionsChart.yAxis.plotBands[0].to= 5;
          -       optionsChart.series[0]=[];
          -       optionsChart.series[0].data=[];
          -       optionsChart.series[1]=[];
          -       optionsChart.series[1].data=[];
          -       optionsChart.series[2]=[];
          -       optionsChart.series[2].data=[];
          -       optionsChart.series[0].name='PGx';
          -       optionsChart.series[1].name='CDx';
          -       optionsChart.series[2].name='NGS';
          -       optionsChart.xAxis.categories=[];
          -         optionsChart.series[0].data.push(['January', 4], ['February', 7], ['March',2], ['April',3.5], ['May',3], ['June',2], ['July', 4.5]);
          -         optionsChart.series[1].data.push(['January',2],['February',3],['March',4],['April',5],['May',3],['June',2],['July',1]);
          -         optionsChart.series[2].data.push(['January',3],['February',1],['March',5],['April',2],['May',4],['June',1],['July',3]);
          -       lineChart = new Highcharts.Chart(optionsChart);
          - }
          - $(document).ready(function() {
          -   if($('#chpwd').val() == 'yes'){
          -     window.open('/uniflow?stepName=Change+Your+Password&updateStepGroups=true&userStepGroups=Users', '_self');
          -   }
          - });
          configureIf~ {_accountId}
            advanced~
            not~
              equals~ OrderingUser
            and~
              not~
                equals~ ReportingUser

        formQuery~
          - (select replace('{_accountId}', 'chpwd', '') as organizationName from dual)
        formQuery~
          - select case left('{_accountId}',5) when 'chpwd' then 'yes' else 'no' end as 'chpwd'
        formQuery~
          - select concat(name,' of ', '{_resultSet:organizationName}') name from userInfo where userId = '{_userId}'
          - union select '' as 'name' from dual
        hidden chpwd
          value= {_:chpwd}
          id= chpwd
        formQuery~ select curDate() as 'endDate', DATE_SUB(curDate(), INTERVAL 90 DAY) as 'startDate' from dual
        formQuery~ select DATE_FORMAT(e.eventDate, '%m/%d/%Y') as 'lastUpdate', e.eventDate as 'lastUpdateDate'
          - from events e
          - left join userInfo u on e.eventId = u.passwordUpdateEventId
          - where u.userId = '{_userId}'
          - union select 'Not Updated Yet' as 'lastUpdate', curDate() as 'lastUpdateDate'
          - from dual
        formQuery~ select DATE_FORMAT(DATE_ADD('{_resultSet:lastUpdateDate}', INTERVAL 90 DAY), '%m/%d/%Y') as 'change'
          - from dual
        formQuery~ select YEAR(curDate()) as 'currentYear' from dual
        ## ACCESSIONING ##
        formQuery~ SELECT COUNT(q.containerId)as 'qcReq' FROM queues q WHERE q.step = 'QC Requisition'
          - union select '0' as 'qcReq' from dual
        formQuery~ SELECT COUNT(q.containerId) as 'contact' FROm queues q WHERE q.step = 'Contact Customer'
          - union select '0' as 'contact' from dual
        formQuery~ SELECT ('{_resultSet:qcReq}' + '{_resultSet:contact}') as 'accTot' FROM dual
          - union select '0' as 'accTot' from dual
        ## RECEIVING ##
        formQuery~ SELECT COUNT(q.containerId) as 'recSamp' FROM queues q WHERE q.step = 'Receive Specimens'
          - union select '0' as 'recSamp' from dual
        formQuery~ SELECT COUNT(q.containerId) as 'assMethods' FROM queues q WHERE q.step = 'Assign Specimen Methods'
          - union select '0' as 'assMethods' from dual
        formQuery~ SELECT COUNT(q.containerId) as 'proSpecs' FROM queues q WHERE q.step = 'Process Specimens'
          - union select '0' as 'proSpecs' from dual
        formQuery~ SELECT ('{_resultSet:recSamp}' + '{_resultSet:assMethods}' + '{_resultSet:proSpecs}') as 'recTot' FROM dual
          - union select '0' as 'recTot' from dual
        ## EXTRACTION ##
        formQuery~ SELECT COUNT(q.containerId) as 'ext' FROM queues q WHERE q.step = 'Extraction - Extract DNA'
          - union select '0' as 'ext' from dual
        formQuery~ SELECT ('{_resultSet:ext}') as 'extTot' FROM dual
          - union select '0' as 'exTot' from dual
        formQuery~ SELECT COUNT(q.containerId) as 'triage' FROM queues q WHERE q.step = 'Specimen Triage'
          - union select '0' as 'triage' from dual
        ## REPORTING ##
        formQuery~ SELECT COUNT(q.containerId) as 'correct' FROM queues q WHERE q.step = 'Correct Report'
          - union select '0' as 'correct' from dual
        formQuery~ SELECT COUNT(q.containerId) as 'addend' FROM queues q WHERE q.step = 'Addend Report'
          - union select '0' as 'added' from dual
        formQuery~ SELECT COUNT(q.containerId) as 'signRep' FROM queues q WHERE q.step = 'Sign Out Report'
          - union select '0' as 'signRep' from dual
        formQuery~ SELECT ('{_resultSet:signRep}' + '{_resultSet:addend}' + '{_resultSet:correct}') as 'repTot' FROM dual
          - union select '0' as 'repTot' from dual
        ## QC RESOURCES ##
        formQuery~ SELECT COUNT(q.containerId) as 'qcReagents' FROM queues q WHERE q.step = 'QC Reagent'
          - union select '0' as 'qcReagents' from dual
        formQuery~ SELECT COUNT(q.containerId) as 'qcControls' FROM queues q WHERE q.step = 'QC Control'
          - union select '0' as 'qcControls' from dual
        formQuery~ SELECT COUNT(DISTINCT qu.containerId) as 'qcInstruments' FROM qualifications qu
          - INNER JOIN instruments i on qu.containerId = i.instrumentId
          - WHERE qu.expirationDate <= curDate()
          - union select '0' as 'qcInstruments' from dual
        ## TASKS DUE ##
        formQuery~ SELECT COUNT(DISTINCT qu.containerId) as 'mainInstruments' FROM qualifications qu
          - INNER JOIN instruments i on qu.containerId = i.instrumentId
          - INNER JOIN taskManagement tm on qu.qualification = tm.task
          - WHERE tm.taskType = 'Maintenance' and qu.expirationDate <= curDate()
          - union select '0' as 'mainInstruments' from dual
        formQuery~ SELECT COUNT(DISTINCT qu.containerId) as 'calibInstruments' FROM qualifications qu
          - INNER JOIN instruments i on qu.containerId = i.instrumentId
          - INNER JOIN taskManagement tm on qu.qualification = tm.task
          - WHERE tm.taskType = 'Calibration' and qu.expirationDate <= curDate()
          - union select '0' as 'calibInstruments' from dual
        ## IN USE RESOURCES ##
        formQuery~ select COUNT(r.reagentId) as 'reagentsInUse' FROM reagents r WHERE r.status = 'In Use' and r.expirationDate > curDate()
          - union select '0' as 'reagentsInUse' from dual
        formQuery~ select COUNT(i.instrumentId) as 'instrInService' FROM instruments i WHERE i.status = 'In Service'
          - union select '0' as 'instrInService' from dual
        formQuery~ select COUNT(c.controlId) as 'controlsInUse' FROM controls c WHERE c.status = 'In Use' and c.expirationDate > curDate()
          - union select '0' as 'controlsInUse' from dual
        formQuery~ select COUNT(c.consumableId) as 'consInUse' FROM consumables c WHERE c.status = 'In Use' and c.expirationDate > curDate()
          - union select '0' as 'consInUse' from dual
        ## EXPIRED RESOURCES ##
        formQuery~ select COUNT(r.reagentId) as 'reagentsExp' FROM reagents r WHERE r.status = 'In Use' and r.expirationDate < curDate()
          - union select '0' as 'reagentsExp' from dual
        formQuery~ select COUNT(c.controlId) as 'controlsExp' FROM controls c WHERE c.status = 'In Use' and c.expirationDate < curDate()
          - union select '0' as 'controlsExp' from dual
        formQuery~ select COUNT(c.consumableId) as 'consExp' FROM consumables c WHERE c.status = 'In Use' and c.expirationDate < curDate()
          - union select '0' as 'consExp' from dual
        ## PURCHASE ORDER COUNTES ##
        formQuery~ select COUNT(distinct poNumber) as 'requested' from orderLog where status = 'requested'
          - union select '0' as 'requested' from dual
        formQuery~ select COUNT(distinct poNumber) as 'hold' from orderLog where status = 'on hold'
          - union select '0' as 'hold' from dual
        formQuery~ select COUNT(distinct poNumber) as 'half' from orderLog where status = 'half approved'
          - union select '0' as 'half' from dual
        formQuery~ select COUNT(distinct poNumber) as 'approved' from orderLog where status = 'approved'
          - union select '0' as 'approved' from dual
        formQuery~ select COUNT(distinct poNumber) as 'pending' from orderLog where status = 'pending'
          - union select '0' as 'pending' from dual
        formQuery~ select ('{_resultSet:requested}' + '{_resultSet:hold}' + '{_resultSet:half}' + '{_resultSet:approved}' + '{_resultSet:pending}') as 'orderTot' FROM dual
          - union select '0' as 'orderTot' from dual
        ## BILLING ##
        formQuery~ SELECT COUNT(q.containerId) as 'readyBill' from queues q WHERE q.step = 'Ready For Billing'
          - union select '0' as 'readyBill' from dual
        formQuery~ SELECT COUNT(q.containerId) as 'exportBill' from queues q WHERE q.step = 'Export For Billing'
          - union select '0' as 'exportBill' from dual
        formQuery~ SELECT COUNT(q.containerId) as 'holdBill' from queues q WHERE q.step = 'On Hold For Biling'
          - union select '0' as 'holdBill' from dual
        formQuery~ SELECT ('{_resultSet:readyBill}' + '{_resultSet:exportBill}' + '{_resultSet:holdBill}') as 'billTot' FROM dual
          - union select '0' as 'billTot' from dual
        ## CYTOGENETICS ##
        formQuery~ SELECT COUNT(q.containerId) as 'cytoCount' from queues q WHERE (q.step LIKE 'Culture - %' OR q.step LIKE 'Karyo - %' OR q.step LIKE 'FISH - %')
          - union select '0' as 'cytoCount' from dual
        ## MICROARRAY ##
        formQuery~ SELECT COUNT(q.containerId) as 'microCount' from queues q WHERE  q.step LIKE 'Microarray - %'
          - union select '0' as 'microCount' from dual
        ## PCR ##
        formQuery~ SELECT COUNT(q.containerId) as 'pcrCount' from queues q WHERE  q.step LIKE 'PCR - %'
          - union select '0' as 'pcrCount' from dual
        ## IMMUNO GEL ##
        formQuery~ SELECT COUNT(q.containerId) as 'gelCount' from queues q WHERE  q.step LIKE 'Gel - %'
          - union select '0' as 'gelCount' from dual
        ## SANGER ##
        formQuery~ SELECT COUNT(q.containerId) as 'sangerCount' from queues q WHERE  q.step LIKE 'Sanger - %'
          - union select '0' as 'sangerCount' from dual
        ## NGS ##
        formQuery~ SELECT COUNT(q.containerId) as 'ngsCount' from queues q WHERE  q.step LIKE 'NGS - %'
          - union select '0' as 'ngsCount' from dual
        ## PGx ##
        formQuery~ SELECT COUNT(q.containerId) as 'pgxCount' from queues q WHERE  q.step LIKE 'PGx%'
          - union select '0' as 'pgxCount' from dual
        vertical
          hidden startDate
            screenLabel~
            value= {_:startDate}
            id= startDate
          hidden endDate
            screenLabel~
            value= {_:endDate}
            id= endDate
        vertical
          fieldSet
            configureIf~ {_accountId}
              advanced~
              equals~ OrderingUser
              or~
                equals~ ReportingUser
            legend
              span {_resultSet:name} -  Welcome to Precision Molecular Diagnostics
            vertical
              table
                caption User Information
                sqlQuery~ select name as 'Name', userId as 'User Id', email as 'Email Address', phone as 'Phone Number' from userInfo where userId = '{_userId}'
                verticalMode~
              p Click <a href="/uniflow?stepName=Change+Your+Contact+Info" class=button>Here</a> to change contact information.
        div
          configureIf~ {_accountId}
            advanced~
            not~
              equals~ OrderingUser
            and~
              not~
                equals~ ReportingUser

          id= tabs
          ul
            li
              a Personalized
                href= #mine
            li
              a Lab View
                href= #labview
          div
            id= mine
            vertical
              fieldSet
                legend
                  span Welcome {_userId}
                vertical
                  div
                    div
                      style= float:left; padding:5px; border-right:1px solid #ddd;
                      vertical
                        h4 User Information
                        table
                          sqlQuery~ select ui.name as 'Name',
                            - ui.userId as 'User Id',
                            - ui.email as 'Email Address',
                            - ui.phone as 'Phone Number',
                            - ui.accountId as 'Account',
                            - ui.accessLevel as 'Access Level',
                            - GROUP_CONCAT(up.authorizedStep SEPARATOR '</br>') as 'Privileges'
                            - from userInfo ui
                            - left join userPrivileges up on ui.userId = up.userId
                            -  where ui.userId = '{_userId}'
                            - group by up.userId
                          verticalMode~
                        p To update information, click <a href="/uniflow?stepName=Change+Your+Contact+Info" class= button>Here</a>
                    div
                      style= float:left; padding:5px;
                      vertical
                        h4 Password
                        span You last changed your password on <b>{_:lastUpdate}</b>.
                        span Please be sure to change your password every 90 days.
                        span Change your password by: <b>{_:change}</b>.
                        p You can change your password <a href="/uniflow?stepName=Change+Your+Password" class= button>Here</a>
                    div
                      style= float:left; width:300px;
                      vertical
                        h4 Last Work Completed
                        vertical
                          table
                            style= width:300px;
                            sqlQuery~ select e.step as 'Step', DATE_FORMAT(e.eventDate, '%m/%d/%Y') as 'Date', e.comments as 'Comments'
                              - from events e
                              - where e.userId = '{_userId}'
                              - order by eventId desc
                              - limit 5
            vertical
              fieldset
                legend
                vertical
                  div
                    id= submits
                hr
                vertical
                  div
                    id= labWorkPie
                hr
                vertical
                  div
                    id= tatLine
                hr
                vertical
                  div
                    id= gauge
            vertical
              fieldSet
                legend Resources
                vertical
                  div
                    id= Resources
                    div
                      class= dashBlock
                      id= reagents
                      style= float:left; border-right:1px solid #eee; margin-right:30px;
                      vertical
                        h4 REAGENTS
                        span <b>Needs QC:</b> {_:qcReagents}
                        span <b>In Use:</b> {_:reagentsInUse}
                        span <b>Expired:</b> {_:reagentsExp}
                    div
                      class= dashBlock
                      id= controls
                      style= float:left;margin-right:10px;
                      vertical
                        h4 CONTROLS
                        span <b>Needs QC:</b> {_:qcControls}
                        span <b>In Use:</b>  {_:controlsInUse}
                        span <b>Expired:</b> {_:reagentsExp}
                    div
                      class= dashBlock
                      id= consumables
                      style= float:left; margin-right:10px;
                      vertical
                        h4 CONSUMABLES
                        span <b>Needs QC:</b> 0
                        span <b>In Use:</b> {_:consInUse}
                        span <b>Expired:</b> {_:consExp}
                    div
                      class= dashBlock
                      id= instruments
                      style= width:125px; float:left; margin-right:10px;
                      vertical
                        h4 INSTRUMENTS
                        span <b>Maintenance:</b> {_:mainInstruments}
                        span <b>Calibration:</b> {_:calibInstruments}
                        span <b>In Service:</b> {_:instrInService}
          div
            id= labview
            vertical
              div
                div
                  style= float:left; color:#777; background-color:aaaaaa; width:190px; padding:.75em; margin-right:15px;
                    - -webkit-box-shadow: 4px 4px 14px 0px rgba(50, 50, 50, 0.6); -moz-box-shadow: 4px 4px 14px 0px rgba(50, 50, 50, 0.6);
                    - box-shadow: 4px 4px 14px 0px rgba(50, 50, 50, 0.6);
                  vertical
                    h4 Total Items Queued
                      style= font-size:1.3em;
                    vertical
                      span <b>Accessioning - </b>
                        id= acc
                        style= padding:1em; border-bottom:1px solid #aaaaaa;
                        span {_:accTot}
                          style= color:#e79d35
                      br
                      span <b>Receiving - </b>
                        id= rec
                        style= padding:1em; border-bottom:1px solid #aaaaaa;
                        span {_:recTot}
                          style= color:#e79d35
                      br
                      span <b>Extraction - </b>
                        id= extraction
                        style= padding:1em; border-bottom:1px solid #aaaaaa;
                        span {_:extTot}
                          style= color:#e79d35
                      br
                      span <b>PCR - </b>
                        id= pcr
                        style= padding:1em; border-bottom:1px solid #aaaaaa;
                        span {_:pcrCount}
                          style= color:#e79d35
                      br
                      span <b>Cytogenetics - </b>
                        id= cytogenetics
                        style= padding:1em; border-bottom:1px solid #aaaaaa;
                        span {_:cytoCount}
                          style= color:#e79d35
                      br
                      span <b>Microarray - </b>
                        id= microarray
                        style= padding:1em; border-bottom:1px solid #aaaaaa;
                        span {_:microCount}
                          style= color:#e79d35
                      br
                      span <b>Immunology - </b>
                        id= immuno
                        style= padding:1em; border-bottom:1px solid #aaaaaa;
                        span {_:gelCount}
                          style= color:#e79d35
                      br
                      span <b>Sanger - </b>
                        id= sanger
                        style= padding:1em; border-bottom:1px solid #aaaaaa;
                        span {_:sangerCount}
                          style= color:#e79d35
                      br
                      span <b>NGS - </b>
                        id= ngs
                        style= padding:1em; border-bottom:1px solid #aaaaaa;
                        span {_:ngsCount}
                          style= color:#e79d35
                      br
                      span <b>PGx - </b>
                        id= pgx
                        style= padding:1em; border-bottom:1px solid #aaaaaa;
                        span {_:ngsCount}
                          style= color:#e79d35

                      br
                      span <b>Reporting - </b>
                        id= rep
                        style= padding:1em; border-bottom:1px solid #aaaaaa;
                        span {_:repTot}
                          style= color:#e79d35
                      br
                      span <b>Purchase Orders - </b>
                        id= order
                        style= padding:1em; border-bottom:1px solid #aaaaaa;
                        span {_:orderTot}
                          style= color:#e79d35
                      br
                      span <b>Reagents - </b>
                        id= reagent
                        style= padding:1em; border-bottom:1px solid #aaaaaa;
                        span {_:qcReagents}
                          style= color:#e79d35
                      br
                      span <b>Instruments - </b>
                        id= instrument
                        style= padding:1em; border-bottom:1px solid #aaaaaa;
                        span {_:qcInstruments}
                          style= color:#e79d35
                      br
                      span <b>Controls - </b>
                        id= control
                        style= padding:1em;
                        span {_:qcControls}
                          style= color:#e79d35
                div
                  style= float:left; width:690px;
                  div
                    class= labviewBox
                    id= accBox
                    vertical
                      align= center
                      h4 <u>Accessioning</u>
                      span QC Requisition: <em>{_:qcReq}</em>
                      span Contact Customer: <em>{_:contact}</em>
                  div
                    class= labviewBox
                    id= recBox
                    vertical
                      align= center
                      h4 <u>Receiving </u>
                      span Receive Specimens: <em>{_:recSamp}</em>
                      span Assign Methods: <em>{_:assMethods}</em>
                      span Process Specimens: <em>{_:proSpecs}</em>
                  div
                    class= labviewBox
                    id= extBox
                    vertical
                      align= center
                      h4 <u>Extraction </u>
                      span DNA Extraction: <em>{_:ext}</em>
                      span Specimen Triage: <em>{_:triage}</em>
                  div
                    class= labviewBox
                    id= repBox
                    vertical
                      align= center
                      h4 <u>Reporting</u>
                      span Sign Out: <em>{_:signRep}</em>
                      span Addend: <em>{_:addend}</em>
                      span Correct: <em>{_:correct}</em>
                  div
                    class= labviewBox
                    id= resourceBox
                    vertical
                      align= center
                      h4 <u>Resources</u>
                      span QC Controls: <em>{_:qcControls}</em>
                      span QC Reagents: <em>{_:qcReagents}</em>
                      span QC Instruments: <em>{_:qcInstruments}</em>
                  div
                    class= labviewBox
                    id= orderBox
                    vertical
                      align= center
                      h4 <u>Purchase Ordering</u>
                      span Requested: <em>{_:requested}</em>
                      span On Hold: <em>{_:hold}</em>
                      span Approved: <em>{_:approved}</em>
                      span Half Approved: <em>{_:half}</em>
                      span Pending: <em>{_:pending}</em>

    step Management Dashboards
      form
        include userAccountInfo
        include highcharts
        script
          - $(document).ready(function(){
          -  $('#stepFormSubmitButton').hide();
          -  drawBarChart('tatTypeChart', 'Ajax Load TAT By Test Type', 'Avg TAT By Test Type (DAYS)', 'DAYS', 'Test Type', 'Type');
          -  drawBarChart('tatTestChart', 'Ajax Load TAT By Test', 'Avg TAT By Test (HOURS)', 'HOURS', 'Test Name', 'Test');
          -  drawPieChart('sampleTypePie', 'Ajax Load Sample Type Counts', 'Received Sample Types Pie');
          -  drawPieChart('testTypePie', 'Ajax Load Test Type Counts', 'Ordered Test Types Pie');
          -  drawPieChart('testPie', 'Ajax Load Panel Counts', 'Ordered Panels Pie');
          -  drawColumnChart('testTypeColumn', 'Ajax Load Test Type Counts', 'Ordered Test Type Totals', '# Requests', 'Test Type', 'Type');
          -  drawColumnChart('orgChart', 'Ajax Load Top 15 Organizations', 'Top 15 Requesting Organizations', '# Requests', 'Organization', 'Count');
          -  drawColumnChart('testColumn', 'Ajax Load Panel Counts', 'Ordered Panel Totals', '# Requests', 'Test Name', 'Count');
          - });
          - function drawGauge(div)
          - {
          -     var gaugeChart;
          -     var optionsChart;
          -     optionsChart = jQuery.extend(true,{}, gaugechartOptions);
          -     optionsChart.chart.renderTo= div;
          -       gaugeChart = new Highcharts.Chart(optionsChart);
          - }
          - function drawBarChart(div, step, title, yLabel, xLabel, seriesName)
          - {
          -     var barChart
          -     var optionsChart
          -     var sName = seriesName;
          -
          -     optionsChart = jQuery.extend(true,{}, barchartOptions);
          -     optionsChart.chart.renderTo= div;
          -     optionsChart.chart.type= 'bar';
          -     optionsChart.chart.height= 400;
          -     optionsChart.chart.width= 490;
          -     optionsChart.exporting.enabled= false;
          -     optionsChart.title.text= title;
          -     optionsChart.yAxis.title.text= yLabel;
          -     optionsChart.xAxis.title.text= xLabel;
          -     optionsChart.xAxis.labels.rotation= 0;
          -     optionsChart.plotOptions.series.dataLabels.x= -10;
          -     optionsChart.plotOptions.series.dataLabels.y= 0;
          -
          -     $.getJSON('/uniflow?callback=?&stepName='+step,{},
          -    function(data,status)
          -    {
          -
          -         optionsChart.series[0]=[];
          -         optionsChart.series[0].data=[];
          -         optionsChart.series[0].name= sName;
          -         optionsChart.xAxis.categories=[];
          -
          -       for(var i=0; i<data.length; i++) {
          -         optionsChart.xAxis.categories.push(data[i].xValue)
          -         optionsChart.series[0].data.push(parseFloat(data[i].Count))
          -       }
          -       barChart = new Highcharts.Chart(optionsChart);
          -
          -
          -    });
          - }
          - function drawColumnChart(div, step, title, yLabel, xLabel, seriesName)
          - {
          -     var columnChart
          -     var optionsChart
          -     var sName = seriesName;
          -
          -     optionsChart = jQuery.extend(true,{}, barchartOptions);
          -     optionsChart.chart.renderTo= div;
          -     optionsChart.chart.height= 500;
          -     optionsChart.chart.width= 500;
          -     optionsChart.exporting.enabled= false;
          -     if(div == 'orgChart'){optionsChart.chart.width= 800;}
          -     optionsChart.title.text= title;
          -     optionsChart.yAxis.title.text= yLabel;
          -     optionsChart.xAxis.title.text= xLabel;
          -     optionsChart.xAxis.labels.rotation= -60;
          -     if(div == 'testColumn'){optionsChart.plotOptions.series.dataLabels.rotation= 270;
          -       optionsChart.plotOptions.series.dataLabels.x= 3;
          -       optionsChart.plotOptions.series.dataLabels.y= -25}
          -
          -     $.getJSON('/uniflow?callback=?&stepName='+step,{},
          -    function(data,status)
          -    {
          -
          -         optionsChart.series[0]=[];
          -         optionsChart.series[0].data=[];
          -         optionsChart.series[0].name= sName;
          -         optionsChart.xAxis.categories=[];
          -
          -       for(var i=0; i<data.length; i++) {
          -         optionsChart.xAxis.categories.push(data[i].xValue)
          -         optionsChart.series[0].data.push(parseFloat(data[i].Count))
          -       }
          -       columnChart = new Highcharts.Chart(optionsChart);
          -
          -
          -    });
          - }
          - function drawPieChart(div, step, title) {
          -     var pieChart;
          -     var optionsChart2;
          -
          -     optionsChart2 = jQuery.extend(true,{}, piechartOptions);
          -     optionsChart2.chart.renderTo= div;
          -     optionsChart2.chart.height= 500;
          -     optionsChart2.chart.width= 520;
          -     optionsChart2.exporting.enabled= false;
          -     optionsChart2.title.text= title;
          -
          -     $.getJSON('/uniflow?callback=?&stepName='+step,{},
          -    function(data,status)
          -    {
          -       var total=0
          -       optionsChart2.series[0].data=[]
          -       for(i=0; i<data.length; i++) {
          -         total+=parseInt(data[i].Count)
          -       }
          -       for(i=0; i<data.length; i++) {
          -         temp=((data[i].Count/total)*100).toFixed(2);
          -         tempArray=[data[i].xValue,parseFloat(temp)]
          -         optionsChart2.series[0].data.push(tempArray);
          -       }
          -       pieChart = new Highcharts.Chart(optionsChart2);
          -    });
          -
          -  }
        formQuery~ select DATE_FORMAT(curDate(), '%m/%d/%Y') as 'now', DATE_FORMAT(DATE_SUB(curDate(), INTERVAL 90 DAY), '%m/%d/%Y') as 'past' from dual
        formQuery~ select COUNT(rf.Id) as 'newReqCount'
          - from requestForms rf
          - inner join events e on rf.eventId = e.eventId
          - where e.eventDate BETWEEN DATE_SUB(curDate(), INTERVAL 90 DAY) AND curDate()
        formQuery~ select COUNT(containerId) as 'qcReqCount'
          - from queues where step = 'QC Requisition'
        formQuery~ select COUNT(containerId) as 'contactCount'
          - from queues where step = 'Contact Customer'
        formQuery~ select COUNT(specimenId) as 'recCount' from requestSpecimens
          - where receivedDate BETWEEN DATE_SUB(curDate(), INTERVAL 90 DAY) AND curDate()
        formQuery~ select COUNT(rs.specimenId) as 'unaccCount'
          - from requestSpecimens rs
          - inner join events e on rs.eventId = e.eventId
          - where rs.condition = 'unacceptable'
          - and e.eventDate BETWEEN DATE_SUB(curDate(), INTERVAL 90 DAY) AND curDate()
        formQuery~ select COUNT(q.containerId) as 'readySamples'
          - from queues q
          - inner join events e on q.eventId = e.eventId
          - where q.step = 'Process Specimens'
          - and e.eventDate BETWEEN DATE_SUB(curDate(), INTERVAL 90 DAY) AND curDate()
        formQuery~ select COUNT(rs.specimenId) as 'cancelledSamples'
          - from requestSpecimens rs
          - inner join events e on rs.eventId = e.eventId
          - where rs.status = 'cancelled'
          - and e.eventDate BETWEEN DATE_SUB(curDate(), INTERVAL 90 DAY) AND curDate()
        formQuery~ select COUNT(rd.reportId) as 'signedCount'
          - from reportDetails rd
          - inner join events e on rd.signedEventId = e.eventId
          - where e.eventDate BETWEEN DATE_SUB(curDate(), INTERVAL 90 DAY) AND curDate()
        formQuery~ select COUNT(rd.reportId) as 'addendCount'
          - from reportDetails rd
          - inner join events e on rd.addendumEventId = e.eventId
          - where e.eventDate BETWEEN DATE_SUB(curDate(), INTERVAL 90 DAY) AND curDate()
        formQuery~ select COUNT(rd.reportId) as 'correctedCount'
          - from reportDetails rd
          - inner join events e on rd.correctedEventId = e.eventId
          - where e.eventDate BETWEEN DATE_SUB(curDate(), INTERVAL 90 DAY) AND curDate()

        vertical
          span From <b>{_:past}</b> TO <b>{_:now}</b>...
            class= legend
          vertical
            div
              div
                style= float:left; margin-right:50px;
                legend Accessioning
                vertical
                  span <b>New Requisitions:</b> <font style=color:blue>{_:newReqCount}</font>
                  span <b>QC Requisitions (On Queue):</b> <font style=color:blue>{_:qcReqCount}</font>
                  span <b>Contact Customer (On Queue):</b> <font style=color:blue>{_:contactCount}</font>
              div
                style= float:left;margin-right:50px;
                legend Receiving
                vertical
                  span <b>Total Received:</b> <font style=color:blue>{_:recCount}</font>
                  span <b>Total Unacceptable:</b> <font style=color:blue>{_:unaccCount}</font>
                  span <b>Ready for Processong:</b> <font style=color:blue>{_:readySamples}</font>
                  span <b>Cancelled Specimens:</b>  <font style=color:blue>{_:cancelledSamples}</font>
              div
                style= float:left; margin-right:20px;
                legend Reporting
                vertical
                  span <b>Total Signed:</b> <font style=color:blue>{_:signedCount}</font>
                  span <b>Total Addended:</b> <font style=color:blue>{_:addendCount}</font>
                  span <b>Total Corrected:</b> <font style=color:blue>{_:correctedCount}</font>
        hr
        vertical
          div
            div
              id= tatTypeChart
              style= float:left
            div
              style= float:left
              id= sampleTypePie
        hr
        vertical
          div
            div
              style= float:left
              id= testTypePie
            div
              style= float:left
              id= testTypeColumn
        hr
        vertical
          div
            div
              style= float:left
              id= testPie
            div
              style= float:left
              id= testColumn
        hr
        vertical
          div
            style= padding:15px;
            id= orgChart

    step Accession Dashboard
      form
        include userAccountInfo
        include highcharts
        script
          - $(function() { $('#stepFormSubmitButton').hide(); });
          - function loadYearlyTable (div, step, year)
          - {
          -    $('#' + div).load('/uniflow',{stepName: step, year: year });
          - }
          - function loadTable(div, step, start, end, client, payor) {
          - $('#' + div).load('/uniflow',{stepName: step, startDate: start, endDate: end, client: client, payor: payor },
          -       function(){
          -         var magic = $('#' + div + 'Table').dataTable({
          -                                           "dom": 'CT<"clear">lfrtip<"clear spacer">T',
          -                                           "oTableTools": {
          -                                             "aButtons": [
          -                                                 {

          -                                                   "sExtends":    "print",
          -                                                   "sButtonText": "Print",
          -                                                   "oSelectorOpts": {filter: 'applied', order: 'current'},
          -                                                   "mColumns": "visible"
          -                                                 },
          -                                                 {
          -                                                   "sExtends":    "copy",
          -                                                   "sButtonText": "Copy",
          -                                                   "oSelectorOpts": {filter: 'applied', order: 'current'},
          -                                                   "mColumns": "visible"
          -                                                 },
          -                                                 {
          -                                                   "sExtends":    "csv",
          -                                                   "sButtonText": "csv",
          -                                                   "oSelectorOpts": {filter: 'applied', order: 'current'},
          -                                                   "mColumns": "visible"
          -                                                 },
          -                                                 {
          -                                                   "sExtends":    "pdf",
          -                                                   "sButtonText": "pdf",
          -                                                   "oSelectorOpts": {filter: 'applied', order: 'current'},
          -                                                   "mColumns": "visible"
          -                                                 }
          -                                             ]
          -                                       } });
          -         magic.columns().eq(0).each(function(colIdx) {
          -           $( 'input', magic.column(colIdx).footer()).on('keyup change', function() {
          -             magic.column(colIdx).search(this.value).draw();
          -           });
          -         });
          -       }
          -     );
          - }
          - function drawBarChart(div, step, startDate, endDate, client, payor, title, xAxis, yAxis)
          - {
          -     var barChart
          -     var optionsChart
          -
          -     optionsChart = jQuery.extend(true,{}, barchartOptions);
          -     optionsChart.chart.renderTo= div;
          -     optionsChart.chart.height= 400;
          -     optionsChart.chart.width= 600;
          -     optionsChart.exporting.enabled= true;
          -     optionsChart.title.text= title;
          -     optionsChart.yAxis.title.text= yAxis;
          -     optionsChart.xAxis.title.text= xAxis;
          -     optionsChart.xAxis.labels.rotation= -75;
          -
          -     $.getJSON('/uniflow?callback=?&stepName='+step+'&startDate='+startDate+'&endDate='+endDate+'&client='+client+'&payor='+payor,{},
          -    function(data,status)
          -    {
          -
          -       var topCount=1.0
          -         optionsChart.series[0]=[];
          -         optionsChart.series[0].data=[];
          -         optionsChart.series[0].name='# Accessioned';
          -
          -         optionsChart.xAxis.categories=[];
          -
          -       for(var i=0; i<data.length; i++) {
          -         optionsChart.xAxis.categories.push(data[i].xValue)
          -         optionsChart.series[0].data.push(parseFloat(data[i].count))
          -         if (parseFloat(data[i].count) > topCount) {
          -           topCount=data[i].count
          -         }
          -       }
          -       topCount=(topCount*1.10);
          -       optionsChart.yAxis.max=parseInt(topCount);
          -       barChart = new Highcharts.Chart(optionsChart);
          -
          -
          -    });
          - }
          -
          - function setResult (div, id, step, startDate, endDate, client, payor)
          - {
          -     $.getJSON('/uniflow?callback=?&stepName='+step+'&startDate='+startDate+'&endDate='+endDate+'&client='+client+'&payor='+payor,{},
          -    function(data,status)
          -    {
          -       $('#' + id).empty();
          -       $('#' + id).append('<b>Total Accessioned: </b></br></br>').append(data[0].count);
          -       $('#' + div).show();
          -    });
          - }
          - function drawMultiBarChart(div, startDate, endDate, client, payor, title, xAxis, yAxis)
          - {
          -     var barChart
          -     var optionsChart
          -
          -     optionsChart = jQuery.extend(true,{}, barchartOptions);
          -     optionsChart.chart.renderTo= div;
          -     optionsChart.chart.height= 600;
          -     optionsChart.chart.width= 600;
          -     optionsChart.title.text= title;
          -     optionsChart.yAxis.title.text= yAxis;
          -     optionsChart.xAxis.title.text= xAxis;
          -     optionsChart.xAxis.labels.rotation= -75;
          -     optionsChart.plotOptions.series.dataLabels.x= 0;
          -     optionsChart.plotOptions.series.dataLabels.y= 0;
          -
          -
          -
          -
          -       $.getJSON('uniflow?callback=?&stepName=Ajax+Get+Distinct+Organization+for+Accesioned&startDate='+startDate+'&endDate='+endDate+'&client='+client+'&payor='+payor,{},
          -        function(data1, status) {
          -           optionsChart.xAxis.categories=[];
          -           for (var m = 0; m < data1.length; m++)
          -           {
          -               optionsChart.xAxis.categories.push(data1[m].clientName);
          -            }
          -
          -        var topCount=1.0
          -
          -       $.getJSON('uniflow?callback=?&stepName=Ajax+Get+Distinct+Payment+Option+for+Accessioned&startDate='+startDate+'&endDate='+endDate+'&client='+client+'&payor='+payor,{},
          -        function(data2, status) {
          -           for(var i =0; i < data2.length; i++)
          -            {
          -               var dataPayor = data2[i].payorType;
          -               optionsChart.series[i]=[];
          -               optionsChart.series[i].data=[];
          -               optionsChart.series[i].name= dataPayor;
          -              $.getJSON('/uniflow?callback=?&stepName=Ajax+Get+Accessioned+With+Payor+and+Client&startDate='+startDate+'&endDate='+endDate+'&client='+client+'&payor='+dataPayor,{},
          -              function(data,status)
          -                {
          -
          -                     for(var j=0; j < data3.length; j++)
          -
          -                      { optionsChart.series[i].data.push(parseFloat(data[j].count)); }
          -                });
          -
          -             }
          -
          -       barChart = new Highcharts.Chart(optionsChart);
          -
          -       });
          -    });
          - }
        formQuery~ select DATE_FORMAT(DATE_SUB(curDate(), INTERVAL 90 DAY), '%m/%d/%Y') as 'startDate',
          - DATE_FORMAT(curDate(), '%m/%d/%Y') as 'endDate' from dual
        formQuery~ select YEAR(curDate()) as 'currentYear' from dual
        formQuery~ select YEAR(DATE_SUB(curDate(), INTERVAL 365 DAY)) as 'lastYear' from dual
        h3 Accessioned By Client & Payor
        span ** Leave Client & Payor Blank To See Totals for All **
        rowGroups
          rowGroup
            date startDate
              id= start
              class= jCalendar
              value= {_:startDate}
              screenLabel~ Start Date
            date endDate
              id= end
              class= jCalendar
              value= {_:endDate}
              screenLabel~ End Date
            select Client
              id= client
              option
              sqlQuery~ select distinct firstName, entityId
                - from entities
                - where entityType = 'Organization'
                - order by firstName
            select Payor
              id= payor
              option
              sqlQuery~ select distinct paymentOption from patientBilling
            button
              value= Load Data
              onclick= setResult('totalAccession', 'totalAcc', 'Ajax Load Accessioned Count By Payor and Client', $('#start').val(), $('#end').val(), $('#client').val(), $('#payor').val());
                - loadTable('accessioned', 'Ajax Get Accessioned By Payor and Client Table', $('#start').val(), $('#end').val(), $('#client').val(), $('#payor').val());
                - loadTable('detailedAccessioned', 'Ajax Get Accessioned By Payor and Client Detailed Table', $('#start').val(), $('#end').val(), $('#client').val(), $('#payor').val());
                - drawBarChart('clientChart', 'Ajax Get Total Accessioned By Client', $('#start').val(), $('#end').val(), $('#client').val(), $('#payor').val(), 'Total Accessioned By Client', 'Client', '#Accessioned');
                - drawBarChart('payorChart', 'Ajax Get Total Accessioned By Payor', $('#start').val(), $('#end').val(), $('#client').val(), $('#payor').val(), 'Total Accessioned By Payor', 'Payment Option', '#Accessioned');
        vertical

          div
            div
              style= float:left; margin-top:15px;
              div
                id= totalAccession
                style= display:none;
                class= dashBlock
                span
                  id= totalAcc
              hr
              div
                id= accessioned
                style= margin-top:25px;
            div
              style= float:left; border-left:1px solid #eee; margin-left:10px;
              div
                id= clientChart
              div
                id= payorChart
        hr
        vertical
          div
            id= detailedAccessioned
        hr
        vertical
        h3 Accessioned By Provider
        span ** Leave Provider Blank to See Totals for All **
        rowGroups
          rowGroup
            date startDate
              id= start1
              class= jCalndar
              value= {_:startDate}
              screenLabel~ Start Date
            date endDate
              id= end1
              class= jCalendar
              value= {_:endDate}
              screenLabel~ End Date
            select Provider
              id= provider
              option
              sqlQuery~ select distinct CONCAT(en.firstName, ' ', en.middleName, ' ', en.lastName), en.entityId
                - from entities en
                - where en.entityType = 'Physician'
                - order by en.firstName
            button
              value= Load Data
              onClick=
                - drawBarChart('providerChart', 'Ajax Get Total Accessioned By Provider', $('#start1').val(), $('#end1').val(), $('#provider').val(), '', 'Total Accessioned By Provider', 'Provider', '#Accessioned');
                - loadTable('providerTable', 'Ajax Load Accessioned By Provider Table', $('#start1').val(), $('#end1').val(), $('#provider').val(), '');
        vertical
          div
            id= providerChart
          div
            id= providerTable
        hr
        h3 Yearly Accesioned Totals By Client
        rowGroups
          rowGroup
            select Year
              id= year
              option {_:currentYear}
              option {_:lastYear}

            button
              value= Load Tables
              onClick=
                - loadYearlyTable('yearlyAccessionedByPayor', 'Ajax Load Yearly Accessioned By Payor', $('#year').val());
                - loadYearlyTable('yearlyAccessionedByProvider', 'Ajax Load Yearly Accessioned By Provider', $('#year').val());
        vertical
          span ** Please give these tables a minute to load.  A year's worth of data is being processed. **
        vertical
          div
            id= yearlyAccessionedByClient
          div
            id= yearlyAccessionedByPayor
          div
            id= yearlyAccessionedByProvider
        vertical
          div
            id= testsRequestedByDay

    step Lookup Patient History
      form
        include userAccountInfo
        script
          - function searchPatients() {
          -   $('#patientsCandidates').load('/uniflow', {stepName: 'Ajax Patients Search Server Dashboards',
          -     firstName: $('#patientFirstName').val(),
          -     lastName: $('#patientLastName').val(),
          -     MRN: $('#patientMRN').val(),
          -     DOB: $('#patientDOB').val(),
          -     gender: $('#patientType').val()
          -   },function(){
          -     $('th:contains("Hidden")').addClass('hide');
          -     $('td.col0').addClass('hide');
          -     $('.hide').hide();
          -
          -  });
          - }
        script
          - $(document).ready(function() {
          -   $('th:contains("Hidden")').addClass('hide');
          -   $('.hide').hide();
          - });
        vertical
          text _recId
            screenLabel~ Patient Id
        vertical
          fieldset
            legend Find Patient
            vertical
              simpleTable
                tr
                  td &nbsp;Master Patient Id
                  td &nbsp;Last Name
                  td &nbsp;First Name
                  td &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DOB
                  td &nbsp;&nbsp;Gender
                tr
                  style= display: none;
                  td Patient Id
                    colspan= 3
                    text patientId
                tr
                  td
                    text patientMRN
                      style= border-color:red;
                        - width:100px
                      id= patientMRN
                      onchange= javascript:return searchPatients();
                  td
                    text patientLastName
                      style= width:90px
                      id= patientLastName
                      onchange= javascript:return searchPatients();
                  td
                    text patientFirstName
                      style= width:80px
                      id= patientFirstName
                      onchange= javascript:return searchPatients();
                  td
                    text patientDOB
                      style= width:90px
                      id= patientDOB
                      placeholder= yyyy-mm-dd
                      onchange= javascript:return searchPatients();
                  td
                    select patientGender
                      id= patientType
                      setName~ gender
                      required~ false
                      option Male
                        value= M
                      option Female
                        value= F
                      option Unknown
                        value= U
                      onchange= javascript:return searchPatient();
                    colspan= 2
            div
              id= patientsCandidates
                style= max-height:150px;overflow:scroll;
      form
        include userAccountInfo
        script
          - $(document).ready(function() {
          -     $('#stepFormSubmitButton').hide();
          - })
        vertical
          fieldset
            style= width:300px;float:left;margin-right:30px;
            legend Patient Information
            vertical
              table
                caption Patient Name
                sqlPreparedQuery~ SELECT
                  -   p.entityType as 'Type'
                  -   ,p.entityId 'Patient Id'
                  -   ,p.firstName 'First'
                  -   ,p.middleName 'Middle'
                  -   ,p.lastName 'Last'
                  -   from entities p
                  -   WHERE p.entityId=?
                  string {_recId}
              table
                caption Demographics
                sqlPreparedQuery~
                  - SELECT
                  - pa.dob 'DOB',
                  - case when
                  - (
                  -   SELECT up.authorizedStep
                  -   FROM userPrivileges up
                  -   WHERE up.userId = ?
                  -     AND up.authorizedStep = 'canViewFullSSN'
                  -     and up.status = 'active'
                  -   union all
                  -   SELECT 'NoAccess'
                  -   FROM dual limit 1
                  - ) = 'canViewFullSSN' THEN pa.ssn
                  -   ELSE CASE WHEN pa.ssn = '' THEN ''
                  -   ELSE concat('###-##-',right(pa.ssn,4)) END
                  - END as 'SSN',
                  - pa.gender 'Gender',
                  - pa.mrn 'MRN',
                  - pa.ethnicity 'Ethnicity'
                  - FROM patients pa
                  - WHERE pa.patientId = ?
                  string {_userId}
                  string {_recId}
              table
                caption Clinical Info
                sqlPreparedQuery~ select pc.problemMedications as 'Problem Meds'
                  - , pc.allergies as 'Allergies'
                  - , pc.medications as 'Medications'
                  - from patientClinical pc
                  - where patientId = ?
                  string {_recId}
              table
                caption Step History
                sqlPreparedQuery~
                  - select e.step as 'Step'
                  - , e.eventDate as 'Date'
                  - , e.userId as 'User'
                  - , e.comments as 'Comments'
                  - from containerHistory ch
                  - inner join events e on ch.eventId = e.eventId
                  - where ch.containerId = ?
                  string {_recId}
        vertical
          fieldset
            legend Contact Information
            vertical
              table
                caption Address
                sqlPreparedQuery~ SELECT a.address1 as 'Add1'
                  - ,a.address2 as 'Add2'
                  - ,a.city as 'City'
                  - ,a.state as 'State'
                  - ,a.postalCode as 'Zip'
                  - ,a.country as 'Country'
                  - ,a.type 'Type'
                  - from entityAddresses a
                  - WHERE a.entityId=? and ? <> ''
                  string {_recId}
                  string {_recId}
              table
                caption Physician(s)
                sqlPreparedQuery~ select ph.title as 'Title'
                  - ,ph.npi as 'NPI'
                  - ,ph.license as 'License'
                  - ,ph.expires as 'Expires'
                  -   from physicians ph
                  -   inner join requestForms rf on rf.physicianId = ph.physicianId
                  -   where rf.patientId = ?
                  string {_recId}
              table
                caption Billing Information
                sqlPreparedQuery~ select
                  -    paymentOption as 'Payment'
                  -    ,medicareNumber as 'Medicare/Medicaid'
                  -    ,guarantor as 'Gaurantor'
                  -    ,policyHolderName_1 as 'Policy Holder'
                  -    ,relationship_1 as 'Relationship'
                  -    ,insuranceCompany_1 as 'Insurance'
                  -    ,policyNumber_1 as 'Policy#'
                  -    ,groupNumber_1 as 'Group#'
                  -     ,policyHolderId_1 as 'Holder'
                  -     ,policyHolderDOB_1 as 'DOB'
                  -   from patientBilling
                  -   where patientId = ?
                  string {_recId}
        vertical
          id= requestInfo
          fieldset
            legend Accession Information
            vertical
              table
                caption Requsition
                sqlPreparedQuery~ select r.Id as 'Requisition Id'
                  - , e.firstName as 'Practice Name'
                  - , CONCAT(e1.firstName, ' ', e1.LastName) as 'Physician'
                  - , r.testType as 'Form Type'
                  - , r.billTo as 'Billed To'
                  - from requestForms r
                  - inner join entities e1 on r.physicianId = e1.entityId
                  - inner join entities e on r.organizationId = e.entityId
                  - where r.patientId = ?
                  string {_recId}
              table
                caption Specimens
                sqlPreparedQuery~ select
                  -  rs.specimenId as 'Specimen Id'
                  - , rs.sampleType as 'Sample Type'
                  - , rs.collectionDate as 'Collection Date'
                  - ,concat(rs.collectionTime,' ',rs.amPm) as 'Collection Time'
                  - , rs.condition as 'Condition'
                  - , rs.status as 'Status'
                  - from requestSpecimens rs
                  - inner join requestForms rf on rf.Id = rs.reqId
                  - where rf.patientId = ?
                  string {_recId}
              table
                caption Reports
                sqlPreparedQuery~ select rd.reportId as 'Report Id'
                  - , rd.reportType as 'Type'
                  - , rd.panelCode as 'Panel Code'
                  -  from reportDetails rd
                  - inner join requestForms rf on rd.requestId = rf.Id
                  - where rf.patientId = ?
                  string {_recId}
              table
                caption Clinical Info
                verticalMode~
                sqlPreparedQuery~ select diagnosis as 'Diagnosis'
                  - , histoDiagnosis as 'Histo Diagnosis'
                  - , presentationAge as 'Presentation Age'
                  - , medications as 'Medications'
                  - , problemMedications as 'Problem Medications'
                  - , allergies as 'Allergies'
                  - , clinicalNotes as 'Clinical Notes'
                  - , clinicalHistory as 'Clinical History'
                  - , geneticCounselor as 'Counselor'
                  - from patientClinical
                  - where patientId = ?
                  string {_recId}

    step TAT Reports
      form
        include userAccountInfo
        include highcharts
        script
          - $(function() { $('#stepFormSubmitButton').hide(); });
          - function setResult (div, id, step, startDate, endDate)
          - {
          -     $.getJSON('/uniflow?callback=?&stepName='+step+'&startDate='+startDate+'&endDate='+endDate,{},
          -    function(data,status)
          -    {
          -       $('#' + id).empty();
          -       $('#' + id).append('<b>Average TAT in Days: </b></br></br>').append(data[0].tat);
          -       $('#' + div).show();
          -    });
          - }
          - function drawJQueryLineChart(div, title, step1, step2, startDate, endDate, xAxis, yAxis) {
          -
          -  var lineChart;
          -  var optionsChart;
          -
          -   optionsChart = jQuery.extend(true,{}, linechartOptions);
          -   optionsChart.chart.renderTo= div;
          -   optionsChart.chart.width= 800;
          -   optionsChart.title.text= title;
          -   optionsChart.yAxis.title.text= yAxis;
          -   optionsChart.xAxis.title.text= xAxis;
          -   optionsChart.xAxis.labels.rotation= -65;
          -   optionsChart.tooltip.valueSuffix= '';
          -   optionsChart.yAxis.plotBands[0] = [];
          -   optionsChart.xAxis.categories=[];
          -
          -       optionsChart.series[0]=[];
          -       optionsChart.series[0].data=[];
          -       optionsChart.series[0].name='TAT';
          -
          -     $.getJSON('/uniflow?callback=?&stepName='+step1+'&startDate='+startDate+'&endDate='+endDate,{},
          -    function(data,status)
          -    {
          -      var mean = parseFloat(data[0].tat);
          -      optionsChart.yAxis.plotBands[0].zIndex= '2';
          -      optionsChart.yAxis.plotBands[0].color= '#ff0000';
          -      optionsChart.yAxis.plotBands[0].from= (mean - .05);
          -      optionsChart.yAxis.plotBands[0].to= (mean + .05);

          -
          -     $.getJSON('/uniflow?callback=?&stepName='+step2+'&startDate='+startDate+'&endDate='+endDate,{},
          -    function(data,status)
          -    {
          -       for(var i = 0; i < data.length; i++) {
          -
          -         optionsChart.xAxis.categories.push(data[i].xValue);
          -         optionsChart.series[0].data.push(data[i].Count);  }
          -
          -       lineChart = new Highcharts.Chart(optionsChart);
          -
          -       });
          -    });
          - }
          - function loadTable(div, step, start, end) {
          - $('#' + div).load('/uniflow',{stepName: step, startDate: start, endDate: end },
          -       function(){
          -         var magic = $('#' + div + 'Table').dataTable({
          -                                           "dom": 'CT<"clear">lfrtip<"clear spacer">T',
          -                                           "oTableTools": {
          -                                             "aButtons": [
          -                                                 {

          -                                                   "sExtends":    "print",
          -                                                   "sButtonText": "Print",
          -                                                   "oSelectorOpts": {filter: 'applied', order: 'current'},
          -                                                   "mColumns": "visible"
          -                                                 },
          -                                                 {
          -                                                   "sExtends":    "copy",
          -                                                   "sButtonText": "Copy",
          -                                                   "oSelectorOpts": {filter: 'applied', order: 'current'},
          -                                                   "mColumns": "visible"
          -                                                 },
          -                                                 {
          -                                                   "sExtends":    "csv",
          -                                                   "sButtonText": "csv",
          -                                                   "oSelectorOpts": {filter: 'applied', order: 'current'},
          -                                                   "mColumns": "visible"
          -                                                 },
          -                                                 {
          -                                                   "sExtends":    "pdf",
          -                                                   "sButtonText": "pdf",
          -                                                   "oSelectorOpts": {filter: 'applied', order: 'current'},
          -                                                   "mColumns": "visible"
          -                                                 }
          -                                             ]
          -                                       } });
          -         $('#' + div + 'Table tbody tr').each(function(){
          -           var timeelapsed = $(this).children('td').eq(3).html().split(' ');
          -           if(timeelapsed[0] < 0){
          -             $(this).children('td').eq(3).css('color', 'red');
          -           }
          -         });
          -       }
          -     );
          - }
        formQuery~ select DATE_FORMAT(DATE_SUB(curDate(), INTERVAL 300 DAY), '%m/%d/%Y') as 'startDate',
          - DATE_FORMAT(curDate(), '%m/%d/%Y') as 'endDate' from dual
        vertical
        h3 Average TAT Over Time
        rowGroups
          rowGroup
            date startDate
              id= start
              class= jCalendar
              value= {_:startDate}
              screenLabel~ Start Date
            date endDate
              id= end
              class= jCalendar
              value= {_:endDate}
              screenLabel~ End Date
            button
              value= Load Data
              onclick= setResult('tatAvg', 'theMean', 'Ajax Get Average TAT', $('#start').val(), $('#end').val());
                - drawJQueryLineChart('tatByDateRange', 'Average TAT By Date', 'Ajax Get Average TAT', 'Ajax Get TAT By Date', $('#start').val(), $('#end').val(), 'Date', 'TAT (Days)');
                - loadTable('tatDetails', 'Ajax Load TAT Table', $('#start').val(), $('#end').val());
        vertical
          div
            id= tatAvg
            class= dashBlock
            style= display:none;
            span
              id= theMean
          div
            id= tatByDateRange
          span ** The chart displays the average TAT for all requisitions accessioned on the given dates **
          div
            id= tatDetails

    step Test Dashboards
      form
        include userAccountInfo
        include highcharts
        script
          - $(function() { $('#stepFormSubmitButton').hide(); });
          - function setResult (div, id, text, step, startDate, endDate, testType)
          - {
          -     $.getJSON('/uniflow?callback=?&stepName='+step+'&startDate='+startDate+'&endDate='+endDate+'&test='+testType,{},
          -    function(data,status)
          -    {
          -       $('#' + id).empty();
          -       $('#' + id).append('<b>'+text+'</b></br></br>').append(data[0].Count);
          -       $('#' + div).show();
          -    });
          - }
          - function loadTable(div, step, start, end, testName) {
          - $('#' + div).load('/uniflow',{stepName: step, startDate: start, endDate: end, test: testName },
          -       function(){
          -         var magic = $('#' + div + 'Table').dataTable({
          -                                           "dom": 'CT<"clear">lfrtip<"clear spacer">T',
          -                                           "oTableTools": {
          -                                             "aButtons": [
          -                                                 {

          -                                                   "sExtends":    "print",
          -                                                   "sButtonText": "Print",
          -                                                   "oSelectorOpts": {filter: 'applied', order: 'current'},
          -                                                   "mColumns": "visible"
          -                                                 },
          -                                                 {
          -                                                   "sExtends":    "copy",
          -                                                   "sButtonText": "Copy",
          -                                                   "oSelectorOpts": {filter: 'applied', order: 'current'},
          -                                                   "mColumns": "visible"
          -                                                 },
          -                                                 {
          -                                                   "sExtends":    "csv",
          -                                                   "sButtonText": "csv",
          -                                                   "oSelectorOpts": {filter: 'applied', order: 'current'},
          -                                                   "mColumns": "visible"
          -                                                 },
          -                                                 {
          -                                                   "sExtends":    "pdf",
          -                                                   "sButtonText": "pdf",
          -                                                   "oSelectorOpts": {filter: 'applied', order: 'current'},
          -                                                   "mColumns": "visible"
          -                                                 }
          -                                             ]
          -                                       } });
          -         magic.columns().eq(0).each(function(colIdx) {
          -           $( 'input', magic.column(colIdx).footer()).on('keyup change', function() {
          -             magic.column(colIdx).search(this.value).draw();
          -           });
          -         });
          -       }
          -     );
          - }
          - function drawColumnChart(div, step, title, yLabel, xLabel, seriesName, startDate, endDate, testName)
          - {
          -     var columnChart
          -     var optionsChart
          -     var sName = seriesName;
          -
          -     optionsChart = jQuery.extend(true,{}, barchartOptions);
          -     optionsChart.chart.renderTo= div;
          -     optionsChart.chart.height= 500;
          -     optionsChart.chart.width= 1600;
          -     optionsChart.title.text= title;
          -     optionsChart.yAxis.title.text= yLabel;
          -     optionsChart.xAxis.title.text= xLabel;
          -     optionsChart.xAxis.labels.rotation= -60;
          -     optionsChart.plotOptions.series.dataLabels.y= 0;
          -
          -
          -     $.getJSON('/uniflow?callback=?&stepName='+step+'&startDate='+startDate+'&endDate='+endDate+'&test='+testName,{},
          -    function(data,status)
          -    {
          -
          -         optionsChart.series[0]=[];
          -         optionsChart.series[0].data=[];
          -         optionsChart.series[0].name= sName;
          -         optionsChart.xAxis.categories=[];
          -
          -       for(var i=0; i<data.length; i++) {
          -         optionsChart.xAxis.categories.push(data[i].xValue)
          -         optionsChart.series[0].data.push(parseFloat(data[i].Count))
          -       }
          -       columnChart = new Highcharts.Chart(optionsChart);
          -
          -
          -    });
          - }
        formQuery~ select DATE_FORMAT(DATE_SUB(curDate(), INTERVAL 90 DAY), '%m/%d/%Y') as 'startDate',
          - DATE_FORMAT(curDate(), '%m/%d/%Y') as 'endDate' from dual
        vertical
        h3 Tests Requested Over Time
        rowGroups
          rowGroup
            date startDate
              id= start
              class= datePicker
              value= {_:startDate}
              screenLabel~ Start Date
            date endDate
              id= end
              class= datePicker
              value= {_:endDate}
              screenLabel~ End Date
            select Test Name
              id= testName
              option ALL
              sqlQuery~ select DISTINCT name from tests where disabled <> '1'  order by name
            button
              value= Load Data
              onclick= setResult('testTotal', 'theTotal','Total Tests Requested: ' , 'Ajax Get Total Tests Requested', $('#start').val(), $('#end').val(), $('#testName').val());
                - setResult('testCompTotal', 'theCompTotal','Total Tests Completed: ', 'Ajax Get Total Tests Completed', $('#start').val(), $('#end').val(), $('#testName').val());
                - loadTable('testTable', 'Ajax Load Test Counts Table', $('#start').val(), $('#end').val(), $('#testName').val());
                - loadTable('testTablePerDay', 'Ajax Load Test Counts Per Day Table', $('#start').val(), $('#end').val(), $('#testName').val());
                - loadTable('testsCompleted', 'Ajax Get Completed Tests By Month', $('#year').val(), '', '', '');
                - drawColumnChart('testChart', 'Ajax Get Test Counts Over Time', 'Total Tests Requested Over Time', 'Count', 'TestName', 'Test Type', $('#start').val(), $('#end').val(), $('#testName').val())

        rowGroups
          rowGroup
            div
              id= testTotal
              class= dashBlock
              style= display:none;
              span
                id= theTotal
            div
              id= testCompTotal
              class= dashBlock
              style= display:none;
              span
                id= theCompTotal
        vertical
          div
            div
              id= testPie
              style= float:left;
            div
              id= testChart
              style= float:left;
        h3 Total Requested For Each Test
        vertical
          div
            id= testTable
        h3 Total Tests Requested Per Day
        vertical
          div
            id= testTablePerDay
        h3 Montly Completed Tests
        vertical
          select Year
            id= year
            option 2017
            option 2016

        vertical
          div
            id= testsCompleted

    step Current Lab Stats
      form
        include userAccountInfo
        formQuery~ select curDate() as 'Now' from dual

        formQuery~ select COUNT(containerId) as 'QCRec' from queues where step = 'QC Requisition'

        formQuery~ select COUNT(containerId) as 'Rec' from queues where step = 'Receive Specimens'

        formQuery~
          - select count(containerId) as 'reports'
          - from queues
          - where ( step = 'Correct Report'
          - or step = 'Sign Out Report'
          - or step = 'Addend Report')

        formQuery~ select count(rf.Id) as 'TodayRequest'
          - from requestForms rf
          - inner join events e on e.eventId = rf.eventId
          - and date_format(e.eventDate,'%y-%m-%d') = date_format(curdate(),'%y-%m-%d')

        formQuery~ select COUNT(containerId) as 'report' from queues where step = 'Sign Out Report'

        formQuery~ select count(*) as 'TodayReport'
          - from containerHistory ch
          - inner join events e on e.eventId = ch.eventId
          - where e.step = 'Sign Out Report'
          - and date_format(e.eventDate,'%y-%m-%d') = date_format(curdate(),'%y-%m-%d')
        script
          - $(function() { $('#stepFormSubmitButton').hide(); });
          -
        vertical
          fieldset
            legend Lab Work Flow Stats
              class= legend
            vertical
              h1
              div
                rowGroups
                  rowGroup
                    div
                      class= dashBlock
                      span QC Requisition
                        class= dashLegend
                        style= position:relative; top:-10px;
                      vertical
                        style=  margin: 0 auto;
                        button
                          value= {_resultSet:QCRec}
                          style= position:relative; font-family:Helvetica; color:#4E6697; font-size:.8em; width:30px;
                          onClick= toggleTable('qcrequisition')
                    img
                      src= images/rightArrow.png
                      style= height:25px; width:25px;
                    div
                      class= dashBlock
                      span Receiving
                        class= dashLegend
                        style= position:relative; top:-10px;
                      vertical
                        style= margin: 0 auto;
                        button
                          value= {_resultSet:Rec}
                          style= position:relative; font-family:Helvetica; color:#4E6697; font-size:.8em; width:30px;
                          onClick= toggleTable('receiving')
                    img
                      src= images/rightArrow.png
                      style= height:25px; width:25px;
                    div
                      class= dashBlock
                      span Reporting
                        class= dashLegend
                        style= position:relative; top:-10px;
                      vertical
                        button
                          value= {_resultSet:reports}
                          style= position:relative; font-family:Helvetica; color:#4E6697; font-size:.8em; width:50px;
                          onClick= toggleTable('report')
        vertical
          fieldset
            legend Reporting Stats
            vertical
              rowGroups
                rowGroup
                  div
                    class= dashBlock
                    span Requests Accessioned
                      class= dashLegend
                      style= position:relative; top:-10px;
                    vertical
                      style= margin: 0 auto;
                      button
                        value= {_resultSet:TodayRequest}
                        style= position:relative; font-family:Helvetica; color:blue; font-size:.8em; width:30px;
                  div
                    class= dashBlock
                    span Specimens Received
                      class= dashLegend
                      style= position:relative; top:-10px;
                    vertical
                      style= margin: 0 auto;
                      button
                        value= {_resultSet:TodayRequest}
                        style= position:relative; font-family:Helvetica; color:blue; font-size:.8em; width:30px;
                  div
                    class= dashBlock
                    span Tests In Process
                      class= dashLegend
                      style= position:relative; top:-10px;
                    vertical
                      button
                        value= {_resultSet:report}
                        style= position:relative; font-family:Helvetica; color:blue; font-size:.8em; width:30px;
                  div
                    class= dashBlock
                    span Reports Signed
                      class= dashLegend
                      style= position:relative; top:-10px;
                    vertical
                      style= margin: 0 auto;
                      button
                        value= {_resultSet:TodayReport}
                        style= position:relative; font-family:Helvetica; color:blue; font-size:.8em; width:30px;

              vertical
                div
                  id= todayRequest
                  fieldset
                    legend Today's Requests
                    vertical
                      table
                        sqlQuery~ select rf.Id 'Request Id', e.eventDate 'Entered', u.name 'By', e.comments 'Comments'
                          + from requestForms rf
                          + inner join events e on rf.eventId = e.eventId
                          - inner join userInfo u on u.userId = e.userId
                          - where date_format(e.eventDate,'%y %m %d') = date_format(curdate(),'%y %m %d')
                          + order by e.eventDate
                div
                  id= todayRequest
                  fieldset
                    legend Today's Specimens
                    vertical
                      table
                        sqlQuery~ select rs.specimenId 'Specimen Id', e.eventDate 'Received', u.name 'By', e.comments 'Comments'
                          + from requestSpecimens rs
                          + inner join events e on rs.eventId = e.eventId
                          - inner join userInfo u on u.userId = e.userId
                          - where e.step = 'Receive Specimens' and rs.condition = 'acceptable'
                          - and date_format(e.eventDate,'%y %m %d') = date_format(curdate(),'%y %m %d')
                          + order by e.eventDate
                div
                  id= todayReport
                  fieldset
                    legend Today's Reports
                    vertical
                      table
                        sqlQuery~ select ch.containerId 'Report Id', e.eventDate 'Signed', u.name 'By', e.comments 'Comments'
                          + from containerHistory ch
                          + inner join events e on ch.eventId = e.eventId
                          - left join userInfo u on u.userId = e.userId
                          - where e.step = 'Sign Out Report'
                          - and date_format(e.eventDate,'%y %m %d') = date_format(curdate(),'%y %m %d')
                          + order by e.eventDate

    step Container Path
      form
        include userAccountInfo
        script
          - $(document).ready(function() {
          -   $('#stepFormSubmitButton').hide();
          -  });
          - function buildPath(containerId){
          -    $('#samplePath').empty();
          -    $('#stepPath').empty();
          -    $('#userPath').empty();
          -    $('#timePath').empty();
          -    $('#historyTable').empty();
          -    $('#containerPath').empty();
          -
          -     $('#historyTable').load('/uniflow',{stepName: 'Ajax Load Sample History Table', containerId: containerId});
          -     $.getJSON('/uniflow?callback=?&stepName=Ajax+Load+Sample+History&containerId='+containerId,{},
          -    function(data,status)
          -    {
          -
          -       var end = (data.length - 1);
          -
          -       for(var i=0; i<data.length; i++) {
          -       if( i == end) { $('#stepPath').append('<div style=float:left;margin-bottom:15px;><span class=legend>'+data[i].step+'</span></div>');
          -              $('#userPath').append('<div style=float:left;margin-bottom:15px;><span class=legend>'+data[i].userId+'</span></div>');
          -              $('#timePath').append('<div style=float:left;margin-bottom:15px;><span class=legend>'+data[i].eventDate+'</span></div>');
          -              $('#samplePath').append('<div class=pathBlock style=float:left;>'
          -                + '<span><b>CONTAINER(S):</b> '+data[i].containerId+'</span></br>'
          -                + '<span><b>STEP:</b> '+data[i].step+'</span></br>'
          -                + '<span><b>DATETIME:</b> '+data[i].eventDate+'</span></br>'
          -                + '<span><b>USERID:</b> '+data[i].userId+'</span></br>'
          -                + '<span><b>COMMENTS:</b> '+data[i].comments+'</span></div>');
          -       }
          -       else { $('#stepPath').append('<div style=float:left;margin-bottom:15px;><span class=legend>'+data[i].step+'</span>'
          -                + '<div style=float:right;padding-top:2px;><img src=images/three-dots.png height=15 width=25></div></div>');
          -              $('#userPath').append('<div style=float:left;margin-bottom:15px;><span class=legend>'+data[i].userId+'</span>'
          -                + '<div style=float:right;padding-top:2px;><img src=images/three-dots.png height=15 width=25></div></div>');
          -              $('#timePath').append('<div style=float:left;margin-bottom:15px;><span class=legend>'+data[i].eventDate+'</span>'
          -                + '<div style=float:right;padding-top:2px;><img src=images/three-dots.png height=15 width=25></div></div>');
          -              $('#samplePath').append('<div style=float:left;><div class=pathBlock style=float:left;>'
          -                + '<span><b>CONTAINER(S):</b> '+data[i].containerId+'</span></br>'
          -                + '<span><b>STEP:</b> '+data[i].step+'</span></br>'
          -                + '<span><b>DATETIME:</b> '+data[i].eventDate+'</span></br>'
          -                + '<span><b>USERID:</b> '+data[i].userId+'</span></br>'
          -                + '<span><b>COMMENTS:</b> '+data[i].comments+'</span></div>'
          -                + '<div style=float:right;height:150px;padding-top:20px;><img src=images/arrow-right.png height=42 width=42></div></div>');
          -            }
          -        }
          -    });
          -     $.getJSON('/uniflow?callback=?&stepName=Ajax+Load+Container+Flow&containerId='+containerId,{},
          -    function(data,status)
          -    {
          -       var orgEventId = data[0].eventId;
          -
          -       for(var i=0; i<data.length; i++) {
          -           if(i == 0){ $('#containerPath').append('<div style=float:left;><p class=legend>'+data[i].container+'</p>');}
          -           else {
          -             var eventId = data[i].eventId;
          -             if(orgEventId == eventId)
          -             {
          -                $('#containerPath').append('<p class=legend>'+data[i].container+'</p>');
          -             }
          -             else
          -             {
          -               orgEventId = data[i].eventId;
          -               $('#containerPath').append('</div>');
          -               $('#containerPath').append('<div style=float:left><p class=legend>'+data[i].container+'</p>');
          -             }
          -           }
          -
          -       }
          -
          -    });
          -
          - }
        vertical
          text Container ID
            id= requestId
          button
            value= Show Path
            onclick= buildPath($('#requestId').val());
        hr
        vertical
          h4 Container Path
        vertical
          div
            id= containerPath
        hr
        vertical
          h4 Step Path
        vertical
          div
            id= stepPath
        hr
        vertical
          h4 User Path
        vertical
          div
            id= userPath
        hr
        vertical
          h4 Time Path
        vertical
          div
            id= timePath
        hr
        vertical
          h4 Detailed Path
        vertical
          div
            id= samplePath
        hr
        vertical
          h4 Table Format
        vertical
          div
            id= historyTable

    ######################################## START OF MANAGEMENT DASHBOARD AJAX ########################################
    stepGroup Dashboard Ajax

    step Ajax Requisition Distribution Bar
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ SELECT COUNT(DISTINCT q.containerId) as 'Count',
          - q.step as 'xValue'
          - FROM queues q
          - INNER JOIN requestForms r on q.containerId = r.Id
          - and IFNULL(r.signedEventId,'') = ''
          - and q.step NOT LIKE ?
          - and q.step NOT REGEXP '^_'
          - group by xValue
          - order by Count desc
          string %Bill%

    step Ajax Top 10 Tasks Performed
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ SELECT COUNT(e.eventId) as 'Count'
          - , e.step as 'xValue'
          - from events e
          - where e.userId = ?
          - and e.eventDate BETWEEN ? and ?
          - and e.step NOT LIKE ? and e.step NOT LIKE ? and e.step NOT LIKE ?
          - group by e.step
          - order by Count desc
          - limit 10
          string {_userId}
          string {startDate}
          string {endDate}
          string Ajax%
          string POST%
          string GET%

    step Ajax Load Lab Work Pie
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~
          - select COUNT(q.containerId) as 'Count' , 'Accessioning' as 'xValue' from queues q where q.step = 'QC Requisition'
          - UNION
          - select COUNT(q.containerId) as 'Count' , 'Receiving' as 'xValue'
          - from queues q where q.step IN ('Receive Specimens', 'Assign Specimen Methods', 'Process Specimens')
          - UNION
          - select COUNT(q.containerId) as 'Count', 'Extraction' as 'xValue'
          - from queues q where q.step LIKE ?
          - UNION
          - select COUNT(q.containerId) as 'Count', 'PCR' as 'xValue'
          - from queues q where q.step LIKE ?
          - UNION
          - SELECT COUNT(q.containerId) as 'Count', 'Cyto' as 'xValue'
          - from queues q WHERE (q.step LIKE ? OR q.step LIKE ? OR q.step LIKE ?)
          - UNION
          - SELECT COUNT(q.containerId) as 'Count', 'Mico' as 'xValue'
          - from queues q WHERE  q.step LIKE ?
          - UNION
          - SELECT COUNT(q.containerId) as 'Count', 'Gel' as 'xValue'
          - from queues q WHERE  q.step LIKE ?
          - UNION
          - SELECT COUNT(q.containerId) as 'Count', 'Sanger' as 'xValue'
          - from queues q WHERE  q.step LIKE ?
          - UNION
          - SELECT COUNT(q.containerId) as 'Count', 'NGS' as 'xValue'
          - from queues q WHERE  q.step LIKE ?
          - UNION
          - SELECT COUNT(q.containerId) as 'Count', 'PGx' as 'xValue'
          - from queues q WHERE  q.step LIKE ?
          - UNION
          - SELECT COUNT(q.containerId) as 'Count', 'Reporting' as 'xValue'
          - from queues q WHERE  q.step IN ('Sign Out Report', 'Addend Report', 'Correct Report')
          string Extraction%
          string PCR%
          string Culture%
          string Karyo%
          string FISH%
          string Microarray%
          string Gel%
          string Sanger%
          string NGS%
          string PGx%

    step Ajax Load Sample History
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select GROUP_CONCAT(DISTINCT CONCAT(ch.containerId,'-', co.containerType) SEPARATOR ' | ') as 'containerId',
          - e.step, DATE_FORMAT(e.eventDate, '%b %D %Y  @  %H:%i') as 'eventDate',
          - IFNULL(CONCAT(u.name,' (', u.accountId, ')'), e.userId) as 'userId', e.comments
          - from containerHistory ch
          - inner join contents c on ch.containerId = c.containerId
          - inner join events e on ch.eventId = e.eventId
          - inner join containers co on ch.containerId = co.containerId
          - left outer join userInfo u on e.userId = u.userId
          - where c.content = ?
          - group by ch.eventId
          - order by ch.eventId
          string {containerId}

    step Ajax Load Sample History Table
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxQuery
      table
        sqlPreparedQuery~ select
          - ch.containerId as 'containerId',
          - e.step, DATE_FORMAT(e.eventDate, '%b %D %Y  @  %H:%i') as 'eventDate',
          - e.userId, e.comments
          - from containerHistory ch
          - inner join contents c on ch.containerId = c.containerId
          - inner join events e on ch.eventId = e.eventId
          - inner join containers co on ch.containerId = co.containerId
          - where c.content = ?
          - group by ch.eventId
          - order by ch.eventId
          string {containerId}

    step Ajax Load Container Flow
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select CONCAT(c.containerId, ' (', co.containerType,')') as 'container', c.eventId
          - from contents c
          - inner join containers co on c.containerId = co.containerId
          - where c.content = ?
          - order by c.eventId
          string {containerId}

    step Ajax Load Sample Type Counts
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select COUNT(rs.specimenId) as 'Count', rs.sampleType as 'xValue'
          - from requestSpecimens rs
          - inner join events e on rs.eventId = e.eventId
          - where e.eventDate BETWEEN DATE_SUB(curDate(), INTERVAL 90 DAY) AND curDate()
          - and rs.sampleType <> '' and rs.specimenId NOT LIKE ?
          - group by rs.sampleType
          - order by Count desc
          string %-EXT%

    step Ajax Load Test Type Counts
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select COUNT(r.id) as 'Count', r.testType as 'xValue'
          - from requestForms r
          - inner join events e on r.eventId = e.eventId
          - where e.eventDate BETWEEN DATE_SUB(curDate(), INTERVAL 90 DAY) AND curDate()
          - and r.testType <> ''
          - group by r.testType
          - order by Count desc

    step Ajax Load Top 15 Organizations
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select COUNT(r.organizationId) as 'Count', o.firstName as 'xValue'
          - from requestForms r
          - inner join entities o on r.organizationid = o.entityId
          - inner join events e on r.eventId = e.eventId
          - where e.eventDate BETWEEN DATE_SUB(curDate(), INTERVAL 90 DAY) AND curDate()
          - group by o.firstName
          - order by Count desc
          - limit 15

    step Ajax Load TAT By Test Type
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select
          - ROUND((SUM(DATEDIFF(e2.eventDate, e.eventDate))/ COUNT(rf.Id)),1) as 'Count'
          - , rf.testType as 'xValue'
          - from requestForms rf
          - inner join reportDetails rd on rf.Id = rd.requestId
          - inner join events e on rf.eventId = e.eventId
          - inner join events e2 on rd.signedEventId = e2.eventId
          - where e2.eventDate BETWEEN DATE_SUB(curDate(), INTERVAL 90 DAY) AND curDate()
          - group by rf.testType

    step Ajax Load Panel Counts
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select p.name as 'xValue', COUNT(p.name) as 'Count'
          - from testPanels p
          - inner join reqTestPanels rtp on p.id = rtp.panelId
          - inner join events e on rtp.eventId = e.eventId
          - where e.eventDate BETWEEN DATE_SUB(curDate(), INTERVAL 90 DAY) AND curDate()
          - group by p.name

    step Ajax Load TAT By Test
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select ROUND((SUM(TIMESTAMPDIFF(Hour, e.eventDate, e2.eventDate))/COUNT(rt.testId)),1) as 'Count', t.name as 'xValue'
          - from reqTests rt
          - inner join tests t on rt.testId = t.Id
          - inner join events e on rt.eventId = e.eventId
          - inner join containerHistory ch on rt.reqId = (SELECT SUBSTRING_INDEX(ch.containerId, '-', -1))
          - inner join events e2 on ch.eventId = e2.eventId
          - where e2.step = 'Sign Out Report'
          - and e2.eventDate BETWEEN DATE_SUB(curDate(), INTERVAL 90 DAY) AND curDate()
          - group by t.name

    step Ajax Get TAT By Form Type By Month
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select ROUND((5 * (DATEDIFF(e2.eventDate, e.eventDate) DIV 7) + MID('0123444401233334012222340111123400012345001234550', 7 * WEEKDAY(e.eventDate) + WEEKDAY(e2.eventDate) + 1, 1)),1) as 'yValue'
          - ,CONCAT(MONTHNAME(e2.eventDate), ' ', YEAR(e2.eventDate)) as 'xValue'
          - ,CONCAT(COUNT(rf.Id), ' Reqs') as 'Count'
          - , rf.testType as 'Series'
          - from requestForms rf
          - inner join reportDetails rd on rf.Id = rd.requestId
          - inner join events e on rf.eventId = e.eventId
          - inner join events e2 on rd.signedEventId = e2.eventId
          - where e2.eventDate BETWEEN DATE_SUB(curDate(), INTERVAL 6 MONTH) AND curDate()
          - group by rf.testType, MONTHNAME(e2.eventDate)
          - order by e2.eventDate

    step Ajax Load Test Types For TAT
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select DISTINCT rf.testType as 'Series'
          - from requestForms rf
          - inner join reportDetails rd on rf.Id = rd.requestId
          - inner join events e on rf.eventId = e.eventId
          - inner join events e2 on rd.signedEventId = e2.eventId
          - where e.eventDate BETWEEN DATE_SUB(curDate(), INTERVAL 6 MONTH) AND curDate()
          - group by rf.testType, MONTHNAME(e2.eventDate)

    ############### START OF AJAX FOR EXTRACTION LEVEY JENNINGS ####################################
    step Ajax Get Control Results
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select c.result
          - from controlResults c
          - where c.controlType = ?
          - AND c.runDate BETWEEN ? AND DATE_ADD(?, INTERVAL 1 DAY)
          - AND c.assayName LIKE ?
          - AND c.QC <> 'invalid'
          - AND c.result <> 'drop' AND result <> ''
          - AND c.instrumentId LIKE (SELECT CASE  WHEN ? = 'Viia7' THEN 'E00143' WHEN ? = 'All' THEN '%'
          - WHEN ? = 'Qubit' THEN 'E00194' WHEN ? = 'Nanodrop' THEN 'E00213'
          - WHEN ? ='Bioanalyzer' THEN 'E00282' ELSE ? END)
          string {control}
          string {startDate}
          string {endDate}
          string {testType}%
          string {instrument}
          string {instrument}
          string {instrument}
          string {instrument}
          string {instrument}
          string {instrument}

    step Ajax Show Extraction Control Results
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select distinct c.result as 'lambda', c1.result as 'neg', Date_Format(c.runDate,'%m/%d/%Y') as 'date'
          - from controlResults c
          - inner join controlResults c1 on c.eventId = c1.eventId
          - where c.controlType = 'Lambda DNA'
          - and c1.controlType = 'Negative Control' and c.assayName LIKE ?
          - and c.runDate BETWEEN ? AND DATE_ADD(?, INTERVAL 1 DAY)
          - AND c.instrumentId LIKE (SELECT CASE WHEN ? = 'Viia7' THEN 'E00143' WHEN ? = 'All' THEN '%'
          - WHEN ? = 'Qubit' THEN 'E00194' WHEN ? = 'Nanodrop' THEN 'E00213'
          - WHEN ? ='Bioanalyzer' THEN 'E00282' ELSE ? END)
          - order by c.runDate asc
          string {testType}%
          string {startDate}
          string {endDate}
          string {instrument}
          string {instrument}
          string {instrument}
          string {instrument}
          string {instrument}
          string {instrument}

    step Ajax Show BRAF Control Results
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select distinct c.result as 'positive', c1.result as 'ntc', c2.result as 'hex',
          -  Date_Format(c.runDate,'%m/%d/%Y') as 'date'
          - from controlResults c
          - inner join controlResults c1 on c.eventId = c1.eventId
          - inner join controlResults c2 on c.eventId = c2.eventId
          - where c.controlType = 'V600E Positive FAM'
          - and c1.controlType = 'NTC FAM' and c2.controlType = 'V600E NTC HEX' and c.assayName LIKE ?
          - and c.runDate BETWEEN ? AND DATE_ADD(?, INTERVAL 1 DAY)
          - order by c.runDate asc
          string {testType}%
          string {startDate}
          string {endDate}

    step Ajax Show EGFR Control Results
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~  select distinct c.result as 'internal', c1.result as 't790m', c2.result as 'deletions',
          - c3.result as 'l858r', c4.result as 'l861q', c5.result as 'g719x', c6.result as 's768i',
          - c7.result as 'insertions',
          -  Date_Format(c.runDate,'%m/%d/%Y') as 'date'
          - from controlResults c
          - inner join controlResults c1 on c.eventId = c1.eventId
          - inner join controlResults c2 on c.eventId = c2.eventId
          - inner join controlResults c3 on c.eventId = c3.eventId
          - inner join controlResults c4 on c.eventId = c4.eventId
          - inner join controlResults c5 on c.eventId = c5.eventId
          - inner join controlResults c6 on c.eventId = c6.eventId
          - inner join controlResults c7 on c.eventId = c7.eventId
          - where c.controlType = 'Internal Control'
          - and c1.controlType = 'T790M' and c2.controlType = 'Deletions'
          - and c3.controlType = 'L858R' and c4.controlType = 'L861Q'
          - and c5.controlType = 'G719X' and c6.controlType = 'S768I'
          - and c7.controlType = 'Insertions'
          - and c.assayName LIKE ?
          - and c.runDate BETWEEN ? AND DATE_ADD(?, INTERVAL 1 DAY)
          - order by c.runDate asc
          string {testType}%
          string {startDate}
          string {endDate}

    step Ajax Show PGx Control Results
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select distinct c.result as 'high', c1.result as 'low', c2.result as 'ntc',
          -  Date_Format(c.runDate,'%m/%d/%Y') as 'date'
          - from controlResults c
          - inner join controlResults c1 on c.eventId = c1.eventId
          - inner join controlResults c2 on c.eventId = c2.eventId
          - where c.controlType = 'High Positive'
          - and c1.controlType = 'Low Positive' and c2.controlType = 'NTC' and c.assayName LIKE ?
          - and c1.result <> 'drop' and c2.result <> 'drop' and c.result <> 'drop'
          - and c.runDate BETWEEN ? AND DATE_ADD(?, INTERVAL 1 DAY)
          - order by c.runDate asc
          string {testType}%
          string {startDate}
          string {endDate}

    step Ajax Show Control Results Table 3
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxQuery
      table
        sqlPreparedQuery~ select c.assayName as 'Assay', c.controlType as 'Control',
          - c.result as 'Result', c.QC as 'valid/invalid', Date_Format(c.runDate,'%m/%d/%Y') as 'date'
          - from controlResults c
          - where c.assayName = ?
          - and c.runDate BETWEEN ? AND DATE_ADD(?, INTERVAL 1 DAY)
          - AND c.instrumentId LIKE (SELECT CASE WHEN ? = 'Viia7' THEN 'E00143' WHEN ? = 'All' THEN '%'
          - WHEN ? = 'Qubit' THEN 'E00194' WHEN ? = 'Nanodrop' THEN 'E00213'
          - WHEN ? ='Bioanalyzer' THEN 'E00282' ELSE ? END)
          string {testType}
          string {startDate}
          string {endDate}
          string {instrument}
          string {instrument}
          string {instrument}
          string {instrument}
          string {instrument}
          string {instrument}

    step Ajax Show Control Results Table 2
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxQuery
      table
        sqlPreparedQuery~ select c.assayName as 'Assay', c.controlType as 'Control',
          - c.result as 'Result', c.QC as 'valid/invalid', Date_Format(c.runDate,'%m/%d/%Y') as 'date'
          - from controlResults c
          - where c.assayName = ? and c.controlType = ?
          - and c.runDate BETWEEN ? AND DATE_ADD(?, INTERVAL 1 DAY)
          string {testType}
          string {controlType}
          string {startDate}
          string {endDate}

    step Ajax Load EGFR Control Chart By Type
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select distinct c.result as 'result',
          - Date_Format(c.runDate,'%m/%d/%Y') as 'date'
          - from controlResults c
          - where c.controlType = ?
          - and c.assayName = 'EGFR Assay'
          - and c.runDate BETWEEN ? AND DATE_ADD(?, INTERVAL 1 DAY)
          - order by c.runDate asc
          - limit 10
          string {controlType}
          string {startDate}
          string {endDate}

  ######## START OF ACCESSIONED DASH AJAX #######################
    step Ajax Get Test Counts By Date
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      accessLevel 2
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select DATE_FORMAT(e.eventDate, '%m/%d/%Y') as 'xValue', t.name, COUNT(t.name) as 'Count'
          - from tests t
          - inner join reqTests rt on t.id = rt.testId
          - inner join events e on rt.eventId = e.eventId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - group by xValue, t.name
          - order by t.name
          string {startDate}
          string {endDate}

    step Ajax Load Accessioned Count By Payor and Client
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      accessLevel 2
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select COUNT(rf.Id) as 'count'
          - from requestForms rf
          - inner join events e on rf.eventId = e.eventId
          - inner join entities en on rf.organizationId = en.entityId
          - inner join patientBilling pb on rf.patientId = pb.patientId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - AND en.entityId LIKE ?
          - AND pb.paymentOption LIKE ?
          string {startDate}
          string {endDate}
          string %{client}%
          string %{payor}%

    step Ajax Load Accessioned Count By Payor and Client Limited
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      accessLevel 2
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select COUNT(rf.Id) as 'count'
          - from requestForms rf
          - inner join events e on rf.eventId = e.eventId
          - inner join entities en on rf.organizationId = en.entityId
          - inner join patientBilling pb on rf.patientId = pb.patientId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - AND en.entityId LIKE ?
          - AND pb.paymentOption LIKE ?
          - AND en.entityId IN (select entityId from entityRelations where memberId = (select entityId from entities where userId = ?))
          string {startDate}
          string {endDate}
          string %{client}%
          string %{payor}%
          string {_userId}

    step Ajax Get Accessioned By Payor and Client Detailed Table
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      accessLevel 2
      class uniflow.AjaxQuery
      table
        id= detailedAccessionedTable
        caption Detailed Table of Accessioned from {startDate} to {endDate}
        sqlPreparedQuery~ select rf.Id as 'RequestId',
          - CONCAT(en2.firstName, ' ', en2.lastName) as 'Patient',
          - rf.sampleType as 'Sample Type',
          - rf.testType as 'Test Type',
          - DATE_FORMAT(rf.collectionDate, '%m/%d/%Y') as 'Collection Date',
          - DATE_FORMAT(e.eventDate, '%m/%d/%Y') as 'Date Accessioned',
          - CONCAT(en1.firstName, ' ', en1.lastName) as 'Physician',
          - en.firstName as 'Client',
          - pb.paymentOption as 'Payor'
          - from requestForms rf
          - inner join events e on rf.eventId = e.eventId
          - inner join entities en on rf.organizationId = en.entityId
          - inner join entities en1 on rf.physicianId = en1.entityId
          - inner join entities en2 on rf.patientId = en2.entityId
          - inner join patientBilling pb on rf.patientId = pb.patientId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - AND en.entityId LIKE ?
          - AND pb.paymentOption LIKE ?
          - ORDER BY e.eventDate
          string {startDate}
          string {endDate}
          string %{client}%
          string %{payor}%

    step Ajax Get Accessioned By Payor and Client Detailed Table Limited
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      accessLevel 2
      class uniflow.AjaxQuery
      table
        id= detailedAccessionedTable
        caption Detailed Table of Accessioned from {startDate} to {endDate}
        sqlPreparedQuery~ select rf.Id as 'RequestId',
          - CONCAT(en2.firstName, ' ', en2.lastName) as 'Patient',
          - rf.sampleType as 'Sample Type',
          - rf.testType as 'Test Type',
          - DATE_FORMAT(e.eventDate, '%m/%d/%Y') as 'Date Accessioned',
          - CONCAT(en1.firstName, ' ', en1.lastName) as 'Physician',
          - en.firstName as 'Client',
          - pb.paymentOption as 'Payor'
          - from requestForms rf
          - inner join events e on rf.eventId = e.eventId
          - inner join entities en on rf.organizationId = en.entityId
          - inner join entities en1 on rf.physicianId = en1.entityId
          - inner join entities en2 on rf.patientId = en2.entityId
          - inner join patientBilling pb on rf.patientId = pb.patientId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - AND en.entityId LIKE ?
          - AND pb.paymentOption LIKE ?
          - AND en.entityId IN (select entityId from entityRelations where memberId = (select entityId from entities where userId = ?))
          - ORDER BY e.eventDate
          string {startDate}
          string {endDate}
          string %{client}%
          string %{payor}%
          string {_userId}

    step Ajax Get Total Accessioned By Client
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      accessLevel 2
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select COUNT(rf.Id) as 'count', en.firstName as 'xValue'
          - from requestForms rf
          - inner join events e on rf.eventId = e.eventId
          - inner join entities en on rf.organizationId = en.entityId
          - inner join patientBilling pb on rf.patientId = pb.patientId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - AND en.entityId LIKE ?
          - AND pb.paymentOption LIKE ?
          - GROUP BY en.firstName
          string {startDate}
          string {endDate}
          string %{client}%
          string %{payor}%

    step Ajax Get Total Accessioned By Client Limited
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      accessLevel 2
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select COUNT(rf.Id) as 'count', en.firstName as 'xValue'
          - from requestForms rf
          - inner join events e on rf.eventId = e.eventId
          - inner join entities en on rf.organizationId = en.entityId
          - inner join patientBilling pb on rf.patientId = pb.patientId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - AND en.entityId LIKE ?
          - AND pb.paymentOption LIKE ?
          - AND en.entityId IN (select entityId from entityRelations where memberId = (select entityId from entities where userId = ?))
          - GROUP BY en.firstName
          string {startDate}
          string {endDate}
          string %{client}%
          string %{payor}%
          string {_userId}

    step Ajax Get Total Accessioned By Provider
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      accessLevel 2
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select COUNT(rf.Id) as 'count',
          - CONCAT(en.firstName, ' ', en.middleName, ' ', en.lastName) as 'xValue'
          - from requestForms rf
          - inner join events e on rf.eventId = e.eventId
          - inner join entities en on rf.physicianId = en.entityId
          - inner join patientBilling pb on rf.patientId = pb.patientId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - AND rf.physicianId LIKE ?
          - GROUP BY xValue
          string {startDate}
          string {endDate}
          string %{client}%

    step Ajax Get Total Accessioned By Provider Limited
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      accessLevel 2
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select COUNT(rf.Id) as 'count',
          - CONCAT(en.firstName, ' ', en.middleName, ' ', en.lastName) as 'xValue'
          - from requestForms rf
          - inner join events e on rf.eventId = e.eventId
          - inner join entities en on rf.physicianId = en.entityId
          - inner join patientBilling pb on rf.patientId = pb.patientId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - AND rf.physicianId LIKE ?
          - AND rf.organizationId LIKE ?
          - AND rf.organizationId IN (select entityId from entityRelations where memberId = (select entityId from entities where userId = ?))
          - GROUP BY xValue
          string {startDate}
          string {endDate}
          string %{client}%
          string %{payor}%
          string {_userId}

    step Ajax Load Accessioned By Provider Table
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      accessLevel 2
      class uniflow.AjaxQuery
      table
        id= providerTableTable
        sqlPreparedQuery~ select rf.Id as 'RequestId',
          - rf.sampleType as 'Sample Type', rf.testType as 'Test Type',
          - CONCAT(en.firstName, ' ', en.middleName, ' ', en.lastName) as 'Provider',
          - DATE_FORMAT(rf.collectionDate, '%m/%d/%Y') as 'Collection Date',
          - DATE_FORMAT(e.eventDate, '%m/%d/%Y') as 'Accessioned Date',
          - pb.paymentOption as 'Payor'
          - from requestForms rf
          - inner join events e on rf.eventId = e.eventId
          - inner join entities en on rf.physicianId = en.entityId
          - inner join patientBilling pb on rf.patientId = pb.patientId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - AND rf.physicianId LIKE ?
          - order by e.eventDate
          string {startDate}
          string {endDate}
          string %{client}%

    step Ajax Load Accessioned By Provider Table Limited
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      accessLevel 2
      class uniflow.AjaxQuery
      table
        id= providerTableTable
        sqlPreparedQuery~ select rf.Id as 'RequestId',
          - rf.sampleType as 'Sample Type', rf.testType as 'Test Type',
          - CONCAT(en.firstName, ' ', en.middleName, ' ', en.lastName) as 'Provider',
          - DATE_FORMAT(e.eventDate, '%m/%d/%Y') as 'Accessioned Date',
          - pb.paymentOption as 'Payor'
          - from requestForms rf
          - inner join events e on rf.eventId = e.eventId
          - inner join entities en on rf.physicianId = en.entityId
          - inner join patientBilling pb on rf.patientId = pb.patientId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - AND rf.physicianId LIKE ?
          - AND rf.organizationId LIKE ?
          - AND rf.organizationId IN (select entityId from entityRelations where memberId = (select entityId from entities where userId = ?))
          - order by e.eventDate
          string {startDate}
          string {endDate}
          string %{client}%
          string %{payor}%
          string {_userId}

    step Ajax Get Total Accessioned By Payor
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      accessLevel 2
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select COUNT(rf.Id) as 'count', pb.paymentOption as 'xValue'
          - from requestForms rf
          - inner join events e on rf.eventId = e.eventId
          - inner join patientBilling pb on rf.patientId = pb.patientId
          - inner join entities en on rf.organizationId = en.entityId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - AND pb.paymentOption LIKE ?
          - AND en.entityId LIKE ?
          - GROUP BY pb.paymentOption
          string {startDate}
          string {endDate}
          string %{payor}%
          string %{client}%

    step Ajax Get Total Accessioned By Payor Limited
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      accessLevel 2
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select COUNT(rf.Id) as 'count', pb.paymentOption as 'xValue'
          - from requestForms rf
          - inner join events e on rf.eventId = e.eventId
          - inner join patientBilling pb on rf.patientId = pb.patientId
          - inner join entities en on rf.organizationId = en.entityId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - AND pb.paymentOption LIKE ?
          - AND en.entityId LIKE ?
          - AND en.entityId IN (select entityId from entityRelations where memberId = (select entityId from entities where userId = ?))
          - GROUP BY pb.paymentOption
          string {startDate}
          string {endDate}
          string %{payor}%
          string %{client}%
          string {_userId}

    step Ajax Get Accessioned With Payor and Client
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      accessLevel 2
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select COUNT(rf.Id) as 'count', en.firstName as 'client', pb.paymentOption as 'payor'
          - from requestForms rf
          - inner join events e on rf.eventId = e.eventId
          - inner join entities en on rf.organizationId = en.entityId
          - inner join patientBilling pb on rf.patientId = pb.patientId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - AND en.entityId LIKE ?
          - AND pb.paymentOption LIKE ?
          - group by en.firstName, pb.paymentOption
          - order by en.firstName, pb.paymentOption
          string {startDate}
          string {endDate}
          string %{client}%
          string %{payor}%

    step Ajax Get Accessioned By Payor and Client Table
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      accessLevel 2
      class uniflow.AjaxQuery
      table
        id= accessionedTable
        caption ACCESSIONED BY PAYOR AND CLIENT FROM {startDate} TO {endDate}
        sqlPreparedQuery~ select COUNT(rf.Id) as '# Accessioned', en.firstName as 'Client', pb.paymentOption as 'Payment Option'
          - from requestForms rf
          - inner join events e on rf.eventId = e.eventId
          - inner join entities en on rf.organizationId = en.entityId
          - inner join patientBilling pb on rf.patientId = pb.patientId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - AND en.entityId LIKE ?
          - AND pb.paymentOption LIKE ?
          - group by en.firstName, pb.paymentOption
          - order by en.firstName, pb.paymentOption
          string {startDate}
          string {endDate}
          string %{client}%
          string %{payor}%

    step Ajax Get Accessioned By Payor and Client Table Limited
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      accessLevel 2
      class uniflow.AjaxQuery
      table
        id= accessionedTable
        caption ACCESSIONED BY PAYOR AND CLIENT FROM {startDate} TO {endDate}
        sqlPreparedQuery~ select COUNT(rf.Id) as '# Accessioned', en.firstName as 'Client', pb.paymentOption as 'Payment Option'
          - from requestForms rf
          - inner join events e on rf.eventId = e.eventId
          - inner join entities en on rf.organizationId = en.entityId
          - inner join patientBilling pb on rf.patientId = pb.patientId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - AND en.entityId LIKE ?
          - AND pb.paymentOption LIKE ?
          - AND en.entityId IN (select entityId from entityRelations where memberId = (select entityId from entities where userId = ?))
          - group by en.firstName, pb.paymentOption
          - order by en.firstName, pb.paymentOption
          string {startDate}
          string {endDate}
          string %{client}%
          string %{payor}%
          string {_userId}

    step Ajax Get Distinct Organization for Accesioned
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      accessLevel 2
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select DISTINCT en.firstName as 'clientName'
          - from requestForms rf
          - inner join events e on rf.eventId = e.eventId
          - inner join entities en on rf.organizationId = en.entityId
          - inner join patientBilling pb on rf.patientId = pb.patientId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - AND en.entityId LIKE ?
          - AND pb.paymentOption LIKE ?
          - order by en.firstName
          string {startDate}
          string {endDate}
          string %{client}%
          string %{payor}%

    step Ajax Get Distinct Payment Option for Accessioned
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      accessLevel 2
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select DISTINCT pb.paymentOption as 'payorType'
          - from requestForms rf
          - inner join events e on rf.eventId = e.eventId
          - inner join entities en on rf.organizationId = en.entityId
          - inner join patientBilling pb on rf.patientId = pb.patientId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - AND en.entityId LIKE ?
          - AND pb.paymentOption LIKE ?
          - order by pb.paymentOption
          string {startDate}
          string {endDate}
          string %{client}%
          string %{payor}%

    step Ajax Load Providers By Client
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      accessLevel 2
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select CONCAT(en.firstName, ' ', en.lastName) as 'provider', er.memberId as 'entityId'
          -  from entityRelations er
          -  inner join entities en on er.memberId = en.entityId
          -  where er.entityId = ?
          -  and er.role = 'Physician'
          string {client}

    step Ajax Load Yearly Accessioned By Client
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      accessLevel 2
      class uniflow.AjaxQuery
      table
        caption Monthly Accessioned Totals By Client For {year}
        sqlPreparedQuery~ select distinct en.firstName as 'Client',
          - COUNT(DISTINCT rf1.Id) as 'January',
          - COUNT(DISTINCT rf2.Id) as 'February',
          - COUNT(DISTINCT rf3.Id) as 'March',
          - COUNT(DISTINCT rf4.Id) as 'April',
          - COUNT(DISTINCT rf5.Id) as 'May',
          - COUNT(DISTINCT rf6.Id) as 'June',
          - COUNT(DISTINCT rf7.Id) as 'July',
          - COUNT(DISTINCT rf8.Id) as 'August',
          - COUNT(DISTINCT rf9.Id) AS 'September',
          - COUNT(DISTINCT rf10.Id) as 'October',
          - COUNT(DISTINCT rf11.Id) as 'November',
          - COUNT(DISTINCT rf12.Id) as 'December'
          - from entities en
          - left join
          -  ( select rf.organizationId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'January' AND YEAR(e.eventDate) = ?) rf1 on en.entityId = rf1.organizationId
          - left join
          -  ( select rf.organizationId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'February' AND YEAR(e.eventDate) = ?) rf2 on en.entityId = rf2.organizationId
          - left join
          -  ( select rf.organizationId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'March' AND YEAR(e.eventDate) = ?) rf3 on en.entityId = rf3.organizationId
          - left join
          -  ( select rf.organizationId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'April' AND YEAR(e.eventDate) = ?) rf4 on en.entityId = rf4.organizationId
          - left join
          -  ( select rf.organizationId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'May' AND YEAR(e.eventDate) = ?) rf5 on en.entityId = rf5.organizationId
          - left join
          -  ( select rf.organizationId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'June' AND YEAR(e.eventDate) = ?) rf6 on en.entityId = rf6.organizationId
          - left join
          -  ( select rf.organizationId, rf.Id, e.eventDate
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'July' AND YEAR(e.eventDate) = ?) rf7 on en.entityId = rf7.organizationId
          - left join
          -  ( select rf.organizationId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'August' AND YEAR(e.eventDate) = ?) rf8 on en.entityId = rf8.organizationId
          - left join
          -  ( select rf.organizationId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'September' AND YEAR(e.eventDate) = ?) rf9 on en.entityId = rf9.organizationId
          - left join
          -  ( select rf.organizationId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'October' AND YEAR(e.eventDate) = ?) rf10 on en.entityId = rf10.organizationId
          - left join
          -  ( select rf.organizationId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'November' AND YEAR(e.eventDate) = ?) rf11 on en.entityId = rf11.organizationId
          - left join
          -  ( select rf.organizationId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'December' AND YEAR(e.eventDate) = ?) rf12 on en.entityId = rf12.organizationId
          - where en.entityType = 'Organization'
          - GROUP BY en.entityId
          - ORDER BY en.firstName
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}

    step Ajax Load Yearly Accessioned By Provider
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      accessLevel 2
      class uniflow.AjaxQuery
      table
        caption Monthly Accessioned Totals By Provider For {year}
        sqlPreparedQuery~ select distinct CONCAT(en.firstName, ' ', en.middleName, ' ', en.lastName) as 'Provider',
          - COUNT(DISTINCT rf1.Id) as 'January',
          - COUNT(DISTINCT rf2.Id) as 'February',
          - COUNT(DISTINCT rf3.Id) as 'March',
          - COUNT(DISTINCT rf4.Id) as 'April',
          - COUNT(DISTINCT rf5.Id) as 'May',
          - COUNT(DISTINCT rf6.Id) as 'June',
          - COUNT(DISTINCT rf7.Id) as 'July',
          - COUNT(DISTINCT rf8.Id) as 'August',
          - COUNT(DISTINCT rf9.Id) AS 'September',
          - COUNT(DISTINCT rf10.Id) as 'October',
          - COUNT(DISTINCT rf11.Id) as 'November',
          - COUNT(DISTINCT rf12.Id) as 'December'
          - from entities en
          - left join
          -  ( select rf.physicianId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'January' AND YEAR(e.eventDate) = ?) rf1 on en.entityId = rf1.physicianId
          - left join
          -  ( select rf.physicianId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'February' AND YEAR(e.eventDate) = ?) rf2 on en.entityId = rf2.physicianId
          - left join
          -  ( select rf.physicianId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'March' AND YEAR(e.eventDate) = ?) rf3 on en.entityId = rf3.physicianId
          - left join
          -  ( select rf.physicianId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'April' AND YEAR(e.eventDate) = ?) rf4 on en.entityId = rf4.physicianId
          - left join
          -  ( select rf.physicianId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'May' AND YEAR(e.eventDate) = ?) rf5 on en.entityId = rf5.physicianId
          - left join
          -  ( select rf.physicianId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'June' AND YEAR(e.eventDate) = ?) rf6 on en.entityId = rf6.physicianId
          - left join
          -  ( select rf.physicianId, rf.Id, e.eventDate
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'July' AND YEAR(e.eventDate) = ?) rf7 on en.entityId = rf7.physicianId
          - left join
          -  ( select rf.physicianId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'August' AND YEAR(e.eventDate) = ?) rf8 on en.entityId = rf8.physicianId
          - left join
          -  ( select rf.physicianId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'September' AND YEAR(e.eventDate) = ?) rf9 on en.entityId = rf9.physicianId
          - left join
          -  ( select rf.physicianId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'October' AND YEAR(e.eventDate) = ?) rf10 on en.entityId = rf10.physicianId
          - left join
          -  ( select rf.physicianId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'November' AND YEAR(e.eventDate) = ?) rf11 on en.entityId = rf11.physicianId
          - left join
          -  ( select rf.physicianId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'December' AND YEAR(e.eventDate) = ?) rf12 on en.entityId = rf12.physicianId
          - where en.entityType = 'Physician'
          - GROUP BY en.entityId
          - ORDER BY Provider
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}

    step Ajax Load Yearly Accessioned By Payor
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      accessLevel 2
      class uniflow.AjaxQuery
      table
        caption Monthly Accessioned By Payor For {year}
        sqlQuery~
          - select distinct pb.paymentOption as 'PaymentOption',
          - COUNT(DISTINCT rf1.Id) as 'January',
          - COUNT(DISTINCT rf2.Id) as 'February',
          - COUNT(DISTINCT rf3.Id) as 'March',
          - COUNT(DISTINCT rf4.Id) as 'April',
          - COUNT(DISTINCT rf5.Id) as 'May',
          - COUNT(DISTINCT rf6.Id) as 'June',
          - COUNT(DISTINCT rf7.Id) as 'July',
          - COUNT(DISTINCT rf8.Id) as 'August',
          - COUNT(DISTINCT rf9.Id) AS 'September',
          - COUNT(DISTINCT rf10.Id) as 'October',
          - COUNT(DISTINCT rf11.Id) as 'November',
          - COUNT(DISTINCT rf12.Id) as 'December'
          - from patientBilling pb
          - left join
          -  ( select rf.patientId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'January' AND YEAR(e.eventDate) = ?) rf1 on pb.patientId = rf1.patientId
          - left join
          -  ( select rf.patientId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'February' AND YEAR(e.eventDate) = ?) rf2 on pb.patientId = rf2.patientId
          - left join
          -  ( select rf.patientId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'March' AND YEAR(e.eventDate) = ?) rf3 on pb.patientId = rf3.patientId
          - left join
          -  ( select rf.patientId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'April' AND YEAR(e.eventDate) = ?) rf4 on pb.patientId = rf4.patientId
          - left join
          -  ( select rf.patientId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'May' AND YEAR(e.eventDate) = ?) rf5 on pb.patientId = rf5.patientId
          - left join
          - ( select rf.patientId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'June' AND YEAR(e.eventDate) = ?) rf6 on pb.patientId = rf6.patientId
          - left join
          -  ( select rf.patientId, rf.Id, e.eventDate
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'July' AND YEAR(e.eventDate) = ?) rf7 on pb.patientId = rf7.patientId
          - left join
          -  ( select rf.patientId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -   where MONTHNAME(e.eventDate) = 'August' AND YEAR(e.eventDate) = ?) rf8 on pb.patientId = rf8.patientId
          - left join
          -  ( select rf.patientId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'September' AND YEAR(e.eventDate) = ?) rf9 on pb.patientId = rf9.patientId
          - left join
          -  ( select rf.patientId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'October' AND YEAR(e.eventDate) = ?) rf10 on pb.patientId = rf10.patientId
          - left join
          - ( select rf.patientId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'November' AND YEAR(e.eventDate) = ?) rf11 on pb.patientId = rf11.`patientId`
          - left join
          -  ( select rf.patientId, rf.Id
          -    from requestForms rf
          -    inner join events e on rf.eventId = e.eventId
          -    where MONTHNAME(e.eventDate) = 'December' AND YEAR(e.eventDate) = ?) rf12 on pb.patientId = rf12.patientId
          - WHERE pb.paymentOption <> ''
          - GROUP BY pb.paymentOption
          - ORDER BY pb.paymentOption
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}
          string {year}

########## START OF TAT DASH #################################################
    step Ajax Load TAT Table
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxQuery
      table
        id= tatDetailsTable
        sqlPreparedQuery~ select rf.Id as 'RequestId',
          - en.firstName as 'Client',
          -  rs.sampleType as 'Sample Type'
          - ,CONCAT((5 * (DATEDIFF(e2.eventDate, e.eventDate) DIV 7) + MID('0123444401233334012222340111123400012345001234550', 7 * WEEKDAY(e.eventDate) + WEEKDAY(e2.eventDate) + 1, 1)), ' Day(s)') as 'Time Elapsed'
          - ,  DATE_FORMAT(e.eventDate, '%m/%d/%Y') as 'Accession Date',
          -  DATE_FORMAT(e2.eventDate, '%m/%d/%Y') as 'Report Date'
          - from requestForms rf
          - inner join requestSpecimens rs on rf.Id = rs.reqId
          - inner join reportDetails rd on rf.Id = rd.requestId
          - inner join entities en on rf.organizationId = en.entityId
          - inner join events e on rf.eventId = e.eventId
          - inner join events e2 on rd.signedEventId = e2.eventId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - and DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          string {startDate}
          string {endDate}

    step Ajax Get TAT By Date
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select DATE_FORMAT(e.eventDate, '%m/%d/%Y') as 'xValue',
          - ROUND(AVG((5 * (DATEDIFF(e2.eventDate, e.eventDate) DIV 7) + MID('0123444401233334012222340111123400012345001234550', 7 * WEEKDAY(e.eventDate) + WEEKDAY(e2.eventDate) + 1, 1))),2) as 'Count'
          - from requestForms rf
          - inner join reportDetails rd on rf.Id = rd.requestId
          - inner join events e on rf.eventId = e.eventId
          - inner join events e2 on rd.signedEventId = e2.eventId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - and DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - group by xValue
          string {startDate}
          string {endDate}

    step Ajax Get Average TAT
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select
          - ROUND(AVG((5 * (DATEDIFF(e2.eventDate, e.eventDate) DIV 7) + MID('0123444401233334012222340111123400012345001234550', 7 * WEEKDAY(e.eventDate) + WEEKDAY(e2.eventDate) + 1, 1))),2) as 'tat'
          - from requestForms rf
          - inner join reportDetails rd on rf.Id = rd.requestId
          - inner join events e on rf.eventId = e.eventId
          - inner join events e2 on rd.signedEventId = e2.eventId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - and DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          string {startDate}
          string {endDate}

      #### START OF TEST DASHBOARD #####
    step Ajax Load Test Counts Per Day Table
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxQuery
      table
        id= testTablePerDayTable
        sqlPreparedQuery~ select DATE_FORMAT(e.eventDate, '%m/%d/%Y') as 'Date', t.name as 'Test', COUNT(t.name) as 'Count'
          - from tests t
          - inner join reqTests rt on t.id = rt.testId
          - inner join events e on rt.eventId = e.eventId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - AND t.name LIKE (SELECT CASE WHEN ? = 'ALL' THEN '%' ELSE ? END)
          - group by Date, t.name
          - order by Date, t.name
          string {startDate}
          string {endDate}
          string {test}
          string {test}

    step Ajax Load Test Counts Table
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxQuery
      table
        id= testTableTable
        sqlPreparedQuery~ select t.name as 'Test', COUNT(t.name) as 'Count'
          - from tests t
          - inner join reqTests rt on t.id = rt.testId
          - inner join events e on rt.eventId = e.eventId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - AND t.name LIKE (SELECT CASE WHEN ? = 'ALL' THEN '%' ELSE ? END)
          - group by t.name
          - order by t.name
          string {startDate}
          string {endDate}
          string {test}
          string {test}

    step Ajax Get Total Tests Requested
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select COUNT(t.name) as 'Count'
          - from tests t
          - inner join reqTests rt on t.id = rt.testId
          - inner join events e on rt.eventId = e.eventId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - AND t.name LIKE (SELECT CASE WHEN ? = 'ALL' THEN '%' ELSE ? END)
          string {startDate}
          string {endDate}
          string {test}
          string {test}

    step Ajax Get Total Tests Completed
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select COUNT(t.name) as 'Count'
          - from tests t
          - inner join reqTests rt on t.id = rt.testId
          - inner join requestForms rf on rt.reqId = rf.Id
          - inner join reportDetails rd on rf.Id = rd.requestId
          - inner join events e on rd.signedEventId = e.eventId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - AND t.name LIKE (SELECT CASE WHEN ? = 'ALL' THEN '%' ELSE ? END)
          string {startDate}
          string {endDate}
          string {test}
          string {test}

    step Ajax Get Test Counts Over Time
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxJSONObjects
      table
        sqlPreparedQuery~ select t.name as 'xValue', COUNT(t.name) as 'Count'
          - from tests t
          - inner join reqTests rt on t.id = rt.testId
          - inner join events e on rt.eventId = e.eventId
          - where e.eventDate BETWEEN STR_TO_DATE(?, '%m/%d/%Y')
          - AND DATE_ADD(STR_TO_DATE(?, '%m/%d/%Y'), INTERVAL 1 DAY)
          - AND t.name LIKE (SELECT CASE WHEN ? = 'ALL' THEN '%' ELSE ? END)
          - group by t.name
          - order by t.name
          string {startDate}
          string {endDate}
          string {test}
          string {test}

    step Ajax Get Completed Tests By Month
      ContentSecurityPolicy default-src 'none'; frame-ancestors 'none'
      class uniflow.AjaxQuery
      table
        id= testsCompletedTable
        caption Completed Tests Per Month
        sqlPreparedQuery~ select distinct t.name as 'Test',
          - IFNULL(t1.Count, '0') as 'January',
          - IFNULL(t2.Count, '0') as 'February',
          - IFNULL(t3.Count, '0') as 'March',
          - IFNULL(t4.Count, '0') as 'April',
          - IFNULL(t5.Count, '0') as 'May',
          - IFNULL(t6.Count, '0') as 'June',
          - IFNULL(t7.Count, '0') as 'July',
          - IFNULL(t8.Count, '0') as 'August',
          - IFNULL(t9.Count, '0') AS 'September',
          - IFNULL(t10.Count, '0') as 'October',
          - IFNULL(t11.Count, '0') as 'November',
          - IFNULL(t12.Count, '0') as 'December'
          - from tests t
          - left join
          -  (  select t.name, COUNT(t.Id) as 'Count'
          -     from tests t
          -     inner join reqTests rt on t.id = rt.testId
          -     inner join requestForms rf on rt.reqId = rf.Id
          -     inner join reportDetails rd on rf.Id = rd.requestId
          -     inner join events e on rd.signedEventId = e.eventId
          -     where MONTHNAME(e.eventDate) = 'January' AND YEAR(e.eventDate) = ? group by t.name) t1 on t.name = t1.name
          - left join
          -  ( select t.name, COUNT(t.Id) as 'Count'
          -     from tests t
          -     inner join reqTests rt on t.id = rt.testId
          -     inner join requestForms rf on rt.reqId = rf.Id
          -     inner join reportDetails rd on rf.Id = rd.requestId
          -     inner join events e on rd.signedEventId = e.eventId
          -     where MONTHNAME(e.eventDate) = 'February' AND YEAR(e.eventDate) = ? group by t.name) t2 on t.name = t2.name
          - left join
          -  ( select t.name, COUNT(t.Id) as 'Count'
          -     from tests t
          -     inner join reqTests rt on t.id = rt.testId
          -     inner join requestForms rf on rt.reqId = rf.Id
          -     inner join reportDetails rd on rf.Id = rd.requestId
          -     inner join events e on rd.signedEventId = e.eventId
          -     where MONTHNAME(e.eventDate) = 'March' AND YEAR(e.eventDate) = ? group by t.name) t3 on t.name = t3.name
          - left join
          -  ( select t.name, COUNT(t.Id) as 'Count'
          -     from tests t
          -     inner join reqTests rt on t.id = rt.testId
          -     inner join requestForms rf on rt.reqId = rf.Id
          -     inner join reportDetails rd on rf.Id = rd.requestId
          -     inner join events e on rd.signedEventId = e.eventId
          -     where MONTHNAME(e.eventDate) = 'April' AND YEAR(e.eventDate) = ? group by t.name) t4 on t.name = t4.name
          - left join
          -  ( select t.name, COUNT(t.Id) as 'Count'
          -     from tests t
          -     inner join reqTests rt on t.id = rt.testId
          -     inner join requestForms rf on rt.reqId = rf.Id
          -     inner join reportDetails rd on rf.Id = rd.requestId
          -     inner join events e on rd.signedEventId = e.eventId
          -     where MONTHNAME(e.eventDate) = 'May' AND YEAR(e.eventDate) = ? group by t.name) t5 on t.name = t5.name
          - left join
          -  ( select t.name, COUNT(t.Id) as 'Count'
          -     from tests t
          -     inner join reqTests rt on t.id = rt.testId
          -     inner join requestForms rf on rt.reqId = rf.Id
          -     inner join reportDetails rd on rf.Id = rd.requestId
          -     inner join events e on rd.signedEventId = e.eventId
          -     where MONTHNAME(e.eventDate) = 'June' AND YEAR(e.eventDate) = ? group by t.name) t6 on t.name = t6.name
          - left join
          -  ( select t.name, COUNT(t.Id) as 'Count'
          -     from tests t
          -     inner join reqTests rt on t.id = rt.testId
          -     inner join requestForms rf on rt.reqId = rf.Id
          -     inner join reportDetails rd on rf.Id = rd.requestId
          -     inner join events e on rd.signedEventId = e.eventId
          -     where MONTHNAME(e.eventDate) = 'July' AND YEAR(e.eventDate) = ? group by t.name) t7 on t.name = t7.name
          - left join
          -  ( select t.name, COUNT(t.Id) as 'Count'
          -     from tests t
          -     inner join reqTests rt on t.id = rt.testId
          -     inner join requestForms rf on rt.reqId = rf.Id
          -     inner join reportDetails rd on rf.Id = rd.requestId
          -     inner join events e on rd.signedEventId = e.eventId
          -     where MONTHNAME(e.eventDate) = 'August' AND YEAR(e.eventDate) = ? group by t.name) t8 on t.name = t8.name
          - left join
          -  ( select t.name, COUNT(t.Id) as 'Count'
          -     from tests t
          -     inner join reqTests rt on t.id = rt.testId
          -     inner join requestForms rf on rt.reqId = rf.Id
          -     inner join reportDetails rd on rf.Id = rd.requestId
          -     inner join events e on rd.signedEventId = e.eventId
          -     where MONTHNAME(e.eventDate) = 'September' AND YEAR(e.eventDate) = ? group by t.name) t9 on t.name = t9.name
          - left join
          -  ( select t.name, COUNT(t.Id) as 'Count'
          -     from tests t
          -     inner join reqTests rt on t.id = rt.testId
          -     inner join requestForms rf on rt.reqId = rf.Id
          -     inner join reportDetails rd on rf.Id = rd.requestId
          -     inner join events e on rd.signedEventId = e.eventId
          -     where MONTHNAME(e.eventDate) = 'October' AND YEAR(e.eventDate) = ? group by t.name) t10 on t.name = t10.name
          - left join
          -  ( select t.name, COUNT(t.Id) as 'Count'
          -     from tests t
          -     inner join reqTests rt on t.id = rt.testId
          -     inner join requestForms rf on rt.reqId = rf.Id
          -     inner join reportDetails rd on rf.Id = rd.requestId
          -     inner join events e on rd.signedEventId = e.eventId
          -     where MONTHNAME(e.eventDate) = 'November' AND YEAR(e.eventDate) = ? group by t.name) t11 on t.name = t11.name
          - left join
          -  ( select t.name, COUNT(t.Id) as 'Count'
          -     from tests t
          -     inner join reqTests rt on t.id = rt.testId
          -     inner join requestForms rf on rt.reqId = rf.Id
          -     inner join reportDetails rd on rf.Id = rd.requestId
          -     inner join events e on rd.signedEventId = e.eventId
          -     where MONTHNAME(e.eventDate) = 'December' AND YEAR(e.eventDate) = ? group by t.name) t12 on t.name = t12.name
          - GROUP BY t.name
          - ORDER BY t.name
          string {start}
          string {start}
          string {start}
          string {start}
          string {start}
          string {start}
          string {start}
          string {start}
          string {start}
          string {start}
          string {start}
          string {start}

    step Ajax Patients Search Server Dashboards
      accessLevel 2
      class uniflow.AjaxQuery
      table
        sqlPreparedQuery~ select
          - case when (length(?) > 0 and p.firstName like ?) then 10 else 0 end +
          - case when (length(?) > 0 and p.firstName = ?) then 10 else 0 end +
          - case when (length(?) > 0 and p.lastName like ?) then 13 else 0 end +
          - case when (length(?) > 0 and p.lastName = ?) then 13 else 0 end +
          - case when (length(?) > 0 and pa.ssn = ?) then 50 else 0 end +
          - case when (length(?) > 0 and pa.mrn = ?) then 20 else 0 end +
          - case when (length(?) > 0 and pa.dob = ?) then 20 else 0 end +
          - case when (length(?) > 0 and pa.gender = ?) then 20 else 0 end
          - as 'Hidden',
          - p.entityId as 'Patient Id',
          - concat(p.firstName,' ',p.lastName) as 'Name',
          - pa.gender as 'Gender',
          - pa.dob as 'DOB',
          - case when
          - (
          -   SELECT up.authorizedStep
          -   FROM userPrivileges up
          -   WHERE up.userId = ?
          -     AND up.authorizedStep = 'canViewFullSSN'
          -     and up.status = 'active'
          -   union all
          -   SELECT 'NoAccess'
          -   FROM dual limit 1
          - ) = 'canViewFullSSN' THEN pa.ssn
          -   ELSE CASE WHEN pa.ssn = '' THEN ''
          -   ELSE concat('###-##-',right(pa.ssn,4)) END
          - END as 'SSN',
          - pa.mrn as 'MRN'
          - from entities p
          - inner join patients pa on pa.patientId = p.entityId
          - where p.entityType='Patient' and status = 'active' and (
          - (length(?) > 0 and p.lastName like ?)
          - OR  (length(?) > 0 and p.firstName like ?)
          - or (length(?) > 0 and pa.ssn = ?)
          - or (length(?) > 0 and pa.dob = ?)
          - or (length(?) > 0 and pa.mrn = ?)
          - or (length(?) > 0 and pa.gender = ?)
          - )
          - order by Hidden desc
          string {firstName}
          string %{firstName}%
          string {firstName}
          string {firstName}
          string {lastName}
          string %{lastName}%
          string {lastName}
          string {lastName}
          string {SSN}
          string {SSN}
          string {MRN}
          string {MRN}
          string {DOB}
          string {DOB}
          string {Gender}
          string {Gender}
          string {_userId}
          string {lastName}
          string %{lastName}%
          string {firstName}
          string %{firstName}%
          string {SSN}
          string {SSN}
          string {DOB}
          string {DOB}
          string {MRN}
          string {MRN}
          string {Gender}
          string {Gender}

    step Ajax Patients Sample Search Server Dashboards
      accessLevel 2
      class uniflow.AjaxQuery
      table
        sqlPreparedQuery~ select
          - case when (length(?) > 0 and p.firstName like ?) then 10 else 0 end +
          - case when (length(?) > 0 and p.firstName = ?) then 10 else 0 end +
          - case when (length(?) > 0 and p.lastName like ?) then 13 else 0 end +
          - case when (length(?) > 0 and p.lastName = ?) then 13 else 0 end +
          - case when (length(?) > 0 and pa.mrn = ?) then 20 else 0 end +
          - case when (length(?) > 0 and pa.dob = ?) then 20 else 0 end +
          - case when (length(?) > 0 and pa.gender = ?) then 20 else 0 end
          - as 'Hidden'
          - , rs.specimenId as 'Sample Id'
          - , p.entityId as 'Patient Id'
          - , concat(p.firstName,' ',p.lastName) as 'Name'
          - , pa.gender as 'Gender'
          - , pa.dob as 'DOB'
          - , case when
          - (
          -   SELECT up.authorizedStep
          -   FROM userPrivileges up
          -   WHERE up.userId = ?
          -     AND up.authorizedStep = 'canViewFullSSN'
          -     AND up.status = 'active'
          -   union all
          -   SELECT 'NoAccess'
          -   FROM dual limit 1
          - ) = 'canViewFullSSN' THEN pa.ssn
          -   ELSE CASE WHEN pa.ssn = '' THEN ''
          -   ELSE concat('###-##-',right(pa.ssn,4)) END
          - END as 'SSN'
          - ,pa.mrn as 'MRN'
          - from entities p
          - inner join patients pa on pa.patientId = p.entityId
          - left join requestForms rf on pa.patientId = rf.patientId
          - left join requestSpecimens rs on rf.Id = rs.reqId
          - where p.entityType='Patient' and p.status = 'active' and (
          - (length(?) > 0 and p.lastName like ?)
          - OR  (length(?) > 0 and p.firstName like ?)
          - or (length(?) > 0 and pa.dob = ?)
          - or (length(?) > 0 and pa.mrn = ?)
          - or (length(?) > 0 and pa.gender = ?)
          - )
          - order by Hidden desc
          string {firstName}
          string %{firstName}%
          string {firstName}
          string {firstName}
          string {lastName}
          string %{lastName}%
          string {lastName}
          string {lastName}
          string {MRN}
          string {MRN}
          string {DOB}
          string {DOB}
          string {Gender}
          string {Gender}
          string {_userId}
          string {lastName}
          string %{lastName}%
          string {firstName}
          string %{firstName}%
          string {DOB}
          string {DOB}
          string {MRN}
          string {MRN}
          string {Gender}
          string {Gender}