config
  includes

############# Order Entry Hidden Values #############

    includeable orderCard
      hidden text1

    includeable orderEntry_hiddenValues
      hidden dateFormat
        id= dateFormat
        value= {_dateShortFormat}

      hidden workflow
        id= workflow
        value= {workflow}

      hidden instance
        id= instance
        value= {instance}

      hidden formType
        id= formType
        value= {formType}

      hidden requestId
        id= requestId
        value= {requestId}


    includeable orderEntry_head

      script
        src= js/processFormSettingsConfigs.js

      configurePreparedQuery~
        - SELECT CASE ?
        -           WHEN '' THEN ?
        -           ELSE ?
        -        END AS "requestId"
        - UNION
        - SELECT 'New'
        string {_recId}
        string {requestId}
        string {_recId}

      configurePreparedQuery~
        - SELECT CASE ?
        -           WHEN '' THEN case ? when 'null' then ? else ? end
        -           ELSE ?
        -        END AS "instance"
        - UNION
        - SELECT 'New'
        string {instance}
        string {_includeParm:instance}
        string {includeInstance}
        string {_includeParm:instance}
        string {instance}

      configurePreparedQuery~
        - SELECT 'Accessioning' AS "formType"

      configurePreparedQuery~
        - SELECT
        -   type as "workflow",
        -   patientId,
        -   physicianId,
        -   physicianSiteId,
        -   requestId
        - FROM requestForms
        - WHERE requestId = ?
        - UNION
        - SELECT ?, '', '', '', ''
        string {_:requestId}
        string {_:workflow}

      configurePreparedQuery~ select id AS 'formDefinitionId'
        - FROM formDefinition
        - WHERE formType = ?
        -   AND instance = ?
        -   AND workflow = ?
        string {_:formType}
        string {_:instance}
        string {_:workflow}

      formQuery~ today
        formatDate~
        value= {_currentDate}

      hidden includeInstance
        value= {_includeParm:instance}

      hidden dateFormat
        id= dateFormat
        value= {_dateShortFormat}

      hidden workflow
        id= workflow
        value= {_:workflow}

      hidden instance
        id= instance
        value= {_:instance}

      hidden formType
        id= formType
        value= {_:formType}


############# Order Information Section #############
    includeable orderEntry_orderInformation

      script
        src= js/orderEntry/orderInfo.js

      # formInputSettings used for JS
      configurePreparedQuery~
        - SELECT
        -   CASE ?
        -     WHEN 'New' THEN 'true'
        -     ELSE 'false'
        -   END AS "isNewRequisition"
        string {_:instance}


      # Giant query... Used for all the configureIfs below
      configurePreparedQuery~ CALL sp_getFormInputSettings('orderInformation', ?, ?)
        string {_:formType}
        int {_:formDefinitionId}

      configurePreparedQuery~ SELECT {_:inputSettings}

      configurePreparedQuery~
        - SELECT
        -   isNull(rf.receivedDate) AS 'hasStoredReceivedDate'
        - FROM requestForms rf
        - WHERE rf.requestId = ?
        - UNION
        - SELECT 1
        string {_:requestId}

      # Retrieving requestForms values from DB or setting it to default values
      formPreparedQuery~
        - SELECT
        - rf.physicianSiteId AS 'physicianSiteId',
        - os.name AS 'physicianSiteName',
        - rf.physicianId,
        - CONCAT(p.first_name, ' ', p.last_name) AS 'physicianName',
        - IFNULL(DATE(rf.receivedDate), ?) AS 'orderInfoReceivedDate',
        - CASE WHEN rf.priority = 0 THEN '' ELSE rf.priority END AS 'priority',
        - rf.externalSystem,
        - rf.externalRequestId,
        - rf.departmentId,
        - rf.locationId,
        - os1.name AS 'departmentName',
        - os2.name AS 'locationName',
        - rf.encounterNumber,
        - rf.externalOrderId
        - FROM requestForms rf
        - LEFT JOIN organizationSites os
        -   ON os.siteId = rf.physicianSiteId
        -   AND os.isSystem IS NULL
        - LEFT JOIN physicians p
        -   ON p.physicianId = rf.physicianId
        - LEFT JOIN organizationSites os1
        -   ON os1.siteId = rf.departmentId
        -   AND os1.isSystem IS NOT NULL
        - LEFT JOIN organizationSites os2
        -   ON os2.siteId = rf.locationId
        -   AND os2.isSystem IS NOT NULL
        - WHERE rf.requestId = ?
        - UNION ALL
        - SELECT
        - ?,
        - '',
        - ?,
        - '',
        - ? AS 'orderInfoReceivedDate',
        - '',
        - '',
        - ?,
        - '',
        - '',
        - '',
        - '',
        - '',
        - ''
        - FROM dual
        - LIMIT 1
        string {_currentDate}
        string {_:requestId}
        string {_:defaultValue_physicianSiteId}
        string {_:defaultValue_physicianId}
        string {_currentDate}
        string {_:defaultValue_externalRequestId}


      formQuery~ orderInfoReceivedDate
        convertDateTime~ false
          configureIf~ {_:hasStoredReceivedDate}
            advanced~
            equals~ 0
        formatDate~
        value= {_:orderInfoReceivedDate}


      # Actual GUI form starts here

      vertical2
        vertical
          container requestId
            class= orderInfo_{_:inputName_requestId}
            screenLabel~ !!! {_:screenLabel_requestId}
            # This value is obtained from Form0
            value= {_:requestId}
            placeholder= {_:placeHolder_requestId}
            data-parsley-required= {_:required_requestId}
            required~ {_:required_requestId}
            readonly= true
              configureIf~ {_:readOnly_requestId}
            acceptQueue~ any
              configureIf~ {instance}
                advanced~
                not~
                  equals~ QC
            acceptQueue~ Order Review
              configureIf~ {instance}
                advanced~
                equals~ QC

          text externalRequestId
            class= orderInfo_{_:inputName_externalRequestId}
            screenLabel~ !!! {_:screenLabel_externalRequestId}
            value= {_:externalRequestId}
            placeholder= {_:placeHolder_externalRequestId}
            required~ {_:required_externalRequestId}
            data-parsley-required= {_:required_externalRequestId}
            readonly= true
              configureIf~ {_:readOnly_externalRequestId}

          text externalOrderId
            class= orderInfo_{_:inputName_externalOrderId}
            screenLabel~ !!! {_:screenLabel_externalOrderId}
            value= {_:externalOrderId}
            placeholder= {_:placeHolder_externalOrderId}
            required~ {_:required_externalOrderId}
            data-parsley-required= {_:required_externalOrderId}
            readonly= true
              configureIf~ {_:readOnly_externalOrderId}

          text encounterNumber
            class= orderInfo_{_:inputName_encounterNumber}
            screenLabel~ !!! {_:screenLabel_encounterNumber}
            value= {_:encounterNumber}
            placeholder= {_:placeHolder_encounterNumber}
            required~ {_:required_encounterNumber}
            data-parsley-required= {_:required_encounterNumber}
            readonly= true
              configureIf~ {_:readOnly_encounterNumber}


          select physicianSiteId
            class= orderInfo_{_:inputName_physicianSiteId}
            required~ {_:required_physicianSiteId}
            data-parsley-required= {_:required_physicianSiteId}
            # disabled= true
            #   configureIf~ {_:readOnly_physicianSiteId}
            placeholder= {_:placeHolder_physicianSiteId}
            screenLabel~ !!! {_:screenLabel_physicianSiteId}
            option {_:physicianSiteName}
              value= {_:physicianSiteId}
            sqlPreparedQuery~ SELECT
              - os.name,
              - ps.siteId
              - FROM physicianSites ps
              - INNER JOIN organizationSites os
              -   ON ps.siteId = os.siteId
              - WHERE ps.siteId <> ?
              - AND ps.active = 1
              - ORDER BY os.name
              string {_:physicianSiteId}

          select physicianId
            class= orderInfo_{_:inputName_physicianId}
            required~ {_:required_physicianId}
            data-parsley-required= {_:required_physicianId}
            placeholder= {_:placeHolder_physicianId}
            screenLabel~ !!! {_:screenLabel_physicianId}
            # disabled= true
            #   configureIf~ {_:readOnly_physicianId}
            option {_:physicianName}
              value= {_:physicianId}
            sqlPreparedQuery~ SELECT
              - CONCAT(p.first_name, ' ', p.last_name) AS 'name',
              - p.physicianId
              - FROM physicians p
              - INNER JOIN physicianSites ps
              -   ON p.physicianId = ps.physicianId
              -   AND p.physicianId <> ?
              -   AND ps.active = 1
              - WHERE ps.siteId = ?
              string {_:physicianId}
              string {_:physicianSiteId}

          date receivedDate
            convert~ false
            class= datePickerNow orderInfo_{_:inputName_orderInfoReceivedDate}
              configureIf~ {_:readOnly_orderInfoReceivedDate}
                advanced~
                equals~ false
            class= orderInfo_{_:inputName_orderInfoReceivedDate}
              configureIf~ {_:readOnly_orderInfoReceivedDate}
                advanced~
                equals~ true
            required~ {_:required_orderInfoReceivedDate}
            data-parsley-required= {_:required_orderInfoReceivedDate}
            readonly= true
              configureIf~ {_:readOnly_orderInfoReceivedDate}
            screenLabel~ !!! {_:screenLabel_orderInfoReceivedDate}
            value= {_:orderInfoReceivedDate}
            placeholder= {_:placeHolder_orderInfoReceivedDate}

            #### THIS NEEDS TO BE A VALIDATION NOT TIED TO THE AMERICAN DATE FORMAT, BUT BASED ON APP DATE SETTINGS
            # validate~ SELECT 1 FROM dual WHERE STR_TO_DATE(?,'%m/%d/%Y') <= CURRENT_DATE()
            #   string {_thisInput}
            #   errorMessage~ Date must be in the past or present

          select priority
            class= orderInfo_{_:inputName_priority}
            required~ {_:required_priority}
            data-parsley-required= {_:required_priority}
            # disabled=
            #   configureIf~ {_:readOnly_priority}
            placeholder= {_:placeHolder_priority}
            screenLabel~ !!! {_:screenLabel_priority}
            setName~ {_:defaultValue_priority}
            value= {_:priority}


          select externalSystem
            class= orderInfo_{_:inputName_externalSystem}
            required~ {_:required_externalSystem}
            data-parsley-required= {_:required_externalSystem}
            # disabled= true
            #   configureIf~ {_:readOnly_externalSystem}
            placeholder= {_:placeHolder_externalSystem}
            screenLabel~ !!! {_:screenLabel_externalSystem}
            setName~ {_:defaultValue_externalSystem}
            value= {_:externalSystem}

          select department
            class= orderInfo_{_:inputName_department}
            required~ {_:required_department}
            data-parsley-required= {_:required_department}
            disabled= true
              configureIf~ {_:readOnly_department}
            placeholder= {_:placeHolder_department}
            screenLabel~ !!! {_:screenLabel_department}
            option {_:departmentName}
              value= {_:departmentId}
            sqlPreparedQuery~
              - SELECT
              -   name,
              -   siteId
              - FROM organizationSites
              - WHERE organizationType = 'Department'
              -   AND isSystem IS NOT NULL
              - ORDER BY name

          select location
            class= orderInfo_{_:inputName_location}
            required~ {_:required_location}
            data-parsley-required= {_:required_location}
            disabled= true
              configureIf~ {_:readOnly_location}
            placeholder= {_:placeHolder_location}
            screenLabel~ !!! {_:screenLabel_location}
            option {_:locationName}
              value= {_:locationId}

          textArea orderComment
            class= orderInfo_{_:inputName_orderComment}
            required~ {_:required_orderComment}
            data-parsley-required= {_:required_orderComment}
            readonly= true
              configureIf~ {_:readOnly_orderComment}
            placeholder= {_:placeHolder_orderComment}
            screenLabel~ !!! {_:screenLabel_orderComment}
            setName~ {_:defaultValue_orderComment}

        fieldset
          id= orderEntryCommentHistory
          legend !!! {_:screenLabel_orderComment} History

          table
            id= orderEntryCommentHistoryTable
            caption
            sqlPreparedQuery~
              - SELECT
              -   cn.note AS ?,
              -   u.name AS "Entered By",
              -   e.eventDate As "Entered On"
              - FROM containerNotes cn
              - INNER JOIN events e
              - ON cn.eventId = e.eventId
              - INNER JOIN userInfo u
              - ON e.userId = u.userId
              - WHERE cn.containerId = ?
              - AND cn.containerId <> ''
              string {_:screenLabel_orderComment}
              string {_:requestId}
            columnSpecs~ orderEntry_CommentHistory
              column 3
                inputType datetime
                  format~ {_dateLongFormat}
                  readonly=








############# Order Information SQL #############
    includeable orderEntry_orderInformation_SQL

      ifCondition {instance}
        advanced~
        equals~ New

        setFormQueryResult
          sqlQuery CALL sp_getNextSequence('requestId','requestId')

        sqlPreparedStatement
          - INSERT INTO containers
          - (
          -   containerId,
          -   containerType,
          -   eventId
          - )
          - VALUES
          - (
          -   ?,
          -   'requestId',
          -   ?
          - )
          string {_:requestId}
          long {_eventId}

        sqlPreparedStatement
          - INSERT INTO containerHistory
          - (
          -   containerId,
          -   eventId
          - )
          - VALUES
          - (
          -   ?,
          -   ?
          - )
          string {_:requestId}
          long {_eventId}

      ## ADD DEPT AND LOCATION INSERTS HERE

        sqlPreparedStatement
          - INSERT INTO requestForms
          - (requestId,
          - physicianId,
          - physicianSiteId,
          - priority,
          - receivedDate,
          - locationId,
          - departmentId,
          - eventId,
          - externalRequestId,
          - externalSystem,
          - externalOrderId,
          - encounterNumber,
          - type,
          - consent,
          - clinicalTrial,
          - workersComp,
          - patientSignature,
          - physicianSignature)
          - VALUES
          - (
          -   ?,
          -   ?,
          -   ?,
          -   (CASE WHEN ? = '' THEN 0 ELSE ? END),
          -   ?,
          -   ?,
          -   ?,
          -   ?,
          -   ?,
          -   ?,
          -   ?,
          -   ?,
          -   ?,
          -   0,
          -   0,
          -   0,
          -   0,
          -   0
          - )
          string {_:requestId}
          string {physicianId}
          string {physicianSiteId}
          string {priority}
          string {priority}
          string {receivedDate}
            blankIsNull~ true
          string {location}
            blankIsNull~ true
          string {department}
            blankIsNull~ true
          long {_eventId}
          string {externalRequestId}
          string {externalSystem}
          string {externalOrderId}
          string {encounterNumber}
          string {workflow}


        else
          setFormQueryResult
            sqlPreparedQuery SELECT ? as 'requestId'
              string {requestId}

          ifCondition {instance}
            advanced~
            not~
              equals~ View
            sqlPreparedStatement
              - UPDATE requestForms
              - SET physicianId = ?,
              - physicianSiteId = ?,
              - priority = CASE ? WHEN '' THEN 0 ELSE ? END,
              - receivedDate = CASE ? WHEN '' THEN CURDATE() ELSE ? END,
              - locationId = ?,
              - departmentId = ?,
              - externalRequestId = ?,
              - externalSystem = ?,
              - externalOrderId = ?,
              - encounterNumber = ?,
              - type = ?,
              - eventId = ?
              - WHERE requestId = ?
              string {physicianId}
              string {physicianSiteId}
              string {priority}
              string {priority}
              string {receivedDate}
              string {receivedDate}
              string {location}
                blankIsNull~ true
              string {department}
                blankIsNull~ true
              string {externalRequestId}
              string {externalSystem}
              string {externalOrderId}
              string {encounterNumber}
              string {workflow}
              long {_eventId}
              string {_:requestId}

      ifCondition {orderComment}
        advanced~
        not~
          isBlank~
        sqlPreparedStatement
          - INSERT INTO containerNotes (containerId, noteType, note, eventId)
          - VALUES (?, 'Order Entry Comment', ?, ?)
          string {_:requestId}
          string {orderComment}
          long {_eventId}




### Patient Information Section ###
    includeable orderEntry_patientInformation
      script
        src= js/orderEntry/patientInformation.js

      ## Get Config Settings
      configurePreparedQuery~ CALL sp_getFormInputSettings('patientInformation', ?, ?)
        string {_:formType}
        int {_:formDefinitionId}

      configurePreparedQuery~ SELECT {_:inputSettings}

      ## Get SSN Permissions
      formPreparedQuery~
        - SELECT up.authorizedStep AS "viewSSN"
        - FROM userPrivileges up
        - WHERE up.userId = ?
        -   AND up.authorizedStep = 'canViewFullSSN'
        -   AND up.status = 'active'
        - UNION
        - SELECT 'noViewFull'
        string {_userId}

      ## Get SSN
      formPreparedQuery~
        - SELECT
        -   CASE ?
        -     WHEN 'canViewFullSSN' THEN p.govtId
        -     ELSE CASE
        -           WHEN p.govtId = '' THEN ''
        -           ELSE concat( REPEAT('#', CHAR_LENGTH(p.govtId) - 4),SUBSTRING(p.govtId, -4))
        -          END
        -   END AS "govtId"
        - FROM requestForms rf
        - INNER JOIN patients p
        -   ON p.patientId = rf.patientId
        - WHERE rf.requestId = ?
        - UNION ALL
        - SELECT ''
        string {_:viewSSN}
        string {_:requestId}

      ## Get Previously Saved Patient Information
      formPreparedQuery~
        - SELECT
        -   p.patientId, p.sqId, p.firstName, p.lastName, p.middleName,
        -   p.userId, p.status, p.address1 AS "addressLine1", p.address2 AS "addressLine2", p.city,
        -   p.state, p.postalCode, p.country, p.email,
        -   p.phone1CountryCode, p.phone1,
        -   p.phone2CountryCode, p.phone2,
        -   p.phone3CountryCode, p.phone3,
        -   p.dob, p.geneticGender, p.genderId, p.ethnicity, r.mrn,
        -   p.govtId AS "govtIdValue",
        -   p.familyId
        - FROM patients p
        - INNER JOIN requestForms r
        -   ON p.patientId = r.patientId
        - WHERE r.requestId = ?
        - UNION ALL
        - SELECT '' , '' , '' , '' , '',
        -   '', '', '', '', '',
        -   '', '', '', '',
        -   '', '',
        -   '', '',
        -   '', '',
        -   '' , '' , '' , '' , '' ,
        -   '',
        -   ''
        string {_:requestId}


      formPreparedQuery~
        - SELECT
        -   CONCAT(', p.lastName as "',?,'",p.firstName AS "',?,'",p.dob AS "',?,'" , CASE WHEN \'',?,'\' LIKE \'%true%\' THEN CASE \'',?,'\' WHEN \'canViewFullSSN\' THEN p.govtId ELSE CASE WHEN p.govtId = \'\' THEN \'\' ELSE concat(\'###-##-\',right(p.govtId,4)) END END ELSE \'\' END AS "',?,'",',
        -     'CASE WHEN \'',?,'\' LIKE \'%true%\' THEN p.geneticGender ELSE \'\' END AS "',?,'",',
        -     'GROUP_CONCAT(DISTINCT IF(ps.mrn = \'\', null, ps.mrn) SEPARATOR '', '') AS "',?, '",p.familyId AS "Family ID"'
        -   ) AS "patientSearchSelectColumns"
        string {_:screenLabel_lastName}
        string {_:screenLabel_firstName}
        string {_:screenLabel_dob}
        string {_:showField_govtId}
        string {_:viewSSN}
        string {_:screenLabel_govtId}
        string {_:show_geneticGender}
        string {_:screenLabel_geneticGender}
        string {_:screenLabel_mrn}



      hidden patientSearchSelectColumns
        value= {_:patientSearchSelectColumns}
        id= patientSearchSelectColumns

      hidden ethnicityList
        id= ethnicityList
        value= {_:ethnicity}

      hidden govtIdValue
        id= govtIdValue
        class= clearPatient
        value= {_:govtIdValue}

      hidden newPatientId
        id= newPatientId
        class= clearPatient

      ## Patient Search
      div
        id= patientSearch
        h3 Patient Search

        simpleTable
          thead
            tr
              th !!! {_:screenLabel_lastName}
              th !!! {_:screenLabel_firstName}
              th !!! {_:screenLabel_dob}
              th !!! {_:screenLabel_govtId}
                configureIf~ {_:showField_govtId}
                  advanced~
                  equals~ true
              th !!! {_:screenLabel_geneticGender}
                configureIf~ {_:showField_geneticGender}
                  advanced~
                  equals~ true
              th !!! {_:screenLabel_mrn}
              th !!! Patient ID
              th !!! Family ID
          tbody
            tr
              style= display: none;
              td Patient Id
                colspan= 3
                text searchPatientId
                  class= clearPatient
            tr
              td
                text patientLastName
                  id= patientLastName
                  class= clearPatient
                  size= 16
              td
                text patientFirstName
                  id= patientFirstName
                  class= clearPatient
                  size= 16
              td
                date patientDOB
                  id= patientDOB
                  class= datePickerDOB clearPatient
                  size= 10

              td
                configureIf~ {_:showField_govtId}
                  advanced~
                  equals~ true
                text patientGovtId
                  id= patientGovtId
                  class= clearPatient
                  size= 15
              td
                configureIf~ {_:showField_geneticGender}
                  advanced~
                  equals~ true
                select patientGender
                  id= patientGeneticGender
                  setName~ {_:defaultValue_geneticGender}
                  required~ false
              td
                text patientMRN
                  id= patientMRN
                  class= clearPatient
                  size= 15

              td
                text txtSearchPatientId
                  id= txtSearchPatientId
                  class= clearPatient
                  size= 8

              td
                text txtSearchFamilyId
                  id= txtSearchFamilyId
                  class= clearPatient
                  size= 12

        br

        button Search
          id= searchButton

        br
        br

        div
          id= patientsCandidates

      ## Patient Information
      div
        id= patientIdentification
        h3 Patient Identification

        div
          id= patientNameDiv

          vertical

            text patientId
              value= {_:patientId}
              id= patientInfo_patientId
              readonly=
              screenLabel~ Patient ID:
              class= clearPatient

          hr

          vertical2

            vertical

              text firstName
                size= 30
                id= firstName
                class= clearPatient patientInfo_{_:inputName_firstName}
                data-parsley-required= {_:required_firstName}
                required~ {_:required_firstName}
                readonly=
                  configureIf~ {_:readOnly_firstName}
                    advanced~
                    equals~ true
                screenLabel~ !!! {_:screenLabel_firstName}
                placeholder= {_:placeHolder_firstName}
                value= {_:firstName}

              text middleName
                size= 30
                id= middleName
                class= clearPatient patientInfo_{_:inputName_middleName}
                data-parsley-required= {_:required_middleName}
                required~ {_:required_middleName}
                readonly=
                  configureIf~ {_:readOnly_middleName}
                    advanced~
                    equals~ true
                screenLabel~ !!! {screenLabel_middleName}
                placeholder= {placeHolder_middleName}
                value= {_:middleName}

              text lastName
                size= 30
                id= lastName
                class= clearPatient patientInfo_{_:inputName_lastName}
                data-parsley-required= {_:required_lastName}
                required~ {_:required_lastName}
                readonly=
                  configureIf~ {_:readOnly_lastName}
                    advanced~
                    equals~ true
                screenLabel~ !!! {_:screenLabel_lastName}
                placeholder= {_:placeHolder_lastName}
                value= {_:lastName}

            vertical

              date dob
                convert~ false
                size= 15
                id= dob
                class= clearPatient datePickerDOB patientInfo_{_:inputName_dob}
                  configureIf~ {_:readOnly_dob}
                    advanced~
                    equals~ false
                class= clearPatient patientInfo_{_:inputName_dob}
                  configureIf~ {_:readOnly_dob}
                    advanced~
                    equals~ true

                title= mm/dd/yyyy
                data-parsley-required= {_:required_dob}
                required~ {_:required_dob}
                readonly=
                  configureIf~ {_:readOnly_dob}
                    advanced~
                    equals~ true
                screenLabel~ !!! {_:screenLabel_dob}
                placeholder= {_:placeHolder_dob}
                value= {_:dob}
                # validate~ select 1 from dual where (? = '') OR (? <= ?)
                #   string {_thisInput}
                #   string {_thisInput}
                #   string {_currentDate}
                #   errorMessage~ DOB should be in the past.

              text mrn
                size= 15
                id= mrn
                class= clearPatient  patientInfo_{_:inputName_mrn}
                data-parsley-required= {_:required_mrn}
                required~ {_:required_mrn}
                readonly=
                  configureIf~ {_:readOnly_mrn}
                    advanced~
                    equals~ true
                screenLabel~ !!! {_:screenLabel_mrn}
                placeholder= {_:placeHolder_mrn}
                value= {_:mrn}

              text familyId
                size= 15
                id= familyId
                class= clearPatient  patientInfo_{_:inputName_familyId}
                data-parsley-required= {_:required_familyId}
                data-parsley-type= alphanum
                required~ {_:required_familyId}
                origValue= 
                readonly=
                  configureIf~ {_:readOnly_familyId}
                    advanced~
                    equals~ true
                screenLabel~ !!! {_:screenLabel_familyId}
                value= {_:familyId}

                div 
                  id= famIdUserInfo
                  class= userInfoMsg
                  span Please update the Family ID for other members of the family.

              text govtId
                size= 15
                id= govtId
                class= patientDemographic clearPatient  patientInfo_{_:inputName_govtId}
                required~ {_:required_govtId}
                data-parsley-required= {_:required_govtId}
                readonly= true
                  configureIf~ {_:readOnly_govtId}
                    advanced~
                    equals~ true
                screenLabel~ !!! {_:screenLabel_govtId}
                placeholder= {_:placeHolder_govtId}
                value= {_:govtId}

            vertical

              select geneticGender
                id= geneticGender
                class= patientDemographic clearPatient patientInfo_{_:inputName_geneticGender}
                required~ {_:required_geneticGender}
                data-parsley-required= {_:required_geneticGender}
                screenLabel~ !!! {_:screenLabel_geneticGender}
                value= {_:geneticGender}
                option
                setName~ {_:defaultValue_geneticGender}

              select genderId
                id= genderId
                class= patientDemographic clearPatient patientInfo_{_:inputName_genderId}
                required~ {_:required_genderId}
                data-parsley-required= {_:required_genderId}
                screenLabel~ !!! {_:screenLabel_genderId}
                value= {_resultSet:genderId}
                option
                setName~ {_:defaultValue_genderId}


            div
              configureIf~ {_:instance}
                advanced~
                not~
                  equals~ View
              vertical
                select ethnicity
                  id= ethnicity
                  class= patientDemographic clearPatient patientInfo_{_:inputName_ethnicity}
                  multiple=
                  required~ {_:required_ethnicity}
                  data-parsley-required= {_:required_ethnicity}
                  screenLabel~ !!! {_:screenLabel_ethnicity}
                  option
                  setName~ {_:defaultValue_ethnicity}

            div
              configureIf~ {_:instance}
                advanced~
                equals~ View
              vertical
                text ethnicity
                  configureIf~ {_:instance}
                    advanced~
                    equals~ View
                  screenLabel~ !!! {_:screenLabel_ethnicity}
                  readonly=
                  size= 50
                  value= {_:ethnicity}


        div
          id= patientContact
          h3 Patient Contact Information

          vertical2

            vertical

              text addressLine1
                id= addressLine1
                size= 50
                class= patientAddress clearPatient patientInfo_{_:inputName_addressLine1}
                required~ {_:required_addressLine1}
                data-parsley-required= {_:required_addressLine1}
                readonly=
                  configureIf~ {_:readOnly_addressLine1}
                    advanced~
                    equals~ true
                screenLabel~ !!! {_:screenLabel_addressLine1}
                placeholder= {_:placeHolder_addressLine1}
                value= {_resultSet:addressLine1}


              text addressLine2
                id= addressLine2
                size= 50
                class= patientAddress clearPatient patientInfo_{_:inputName_addressLine2}
                required~ {_:required_addressLine2}
                data-parsley-required= {_:required_addressLine2}
                readonly=
                  configureIf~ {_:readOnly_addressLine2}
                    advanced~
                    equals~ true
                screenLabel~ !!! {_:screenLabel_addressLine2}
                placeholder= {_:placeHolder_addressLine2}
                value= {_resultSet:addressLine2}

              text city
                id= city
                class= patientAddress clearPatient patientInfo_{_:inputName_city}
                data-parsley-required= {_:required_city}
                required~ {_:required_city}
                readonly=
                  configureIf~ {_:readOnly_city}
                    advanced~
                    equals~ true
                screenLabel~ !!! {_:screenLabel_city}
                placeholder= {_:placeHolder_city}
                value= {_resultSet:city}

              text state
                id= state
                class= patientAddress clearPatient patientInfo_{_:inputName_state}
                data-parsley-required= {_:required_state}
                required~ {_:required_state}
                readonly=
                  configureIf~ {_:readOnly_state}
                    advanced~
                    equals~ true
                screenLabel~ !!! {_:screenLabel_state}
                placeholder= {_:placeHolder_state}
                value= {_resultSet:state}

              text postalCode
                id= postalCode
                size= 8
                class= patientAddress clearPatient patientInfo_{_:inputName_postalCode}
                data-parsley-required= {_:required_postalCode}
                required~ {_:required_postalCode}
                readonly=
                  configureIf~ {_:readOnly_postalCode}
                    advanced~
                    equals~ true
                screenLabel~ !!! {_:screenLabel_postalCode}
                placeholder= {_:placeHolder_postalCode}
                value= {_resultSet:postalCode}

              text country
                id= country
                class= patientAddress clearPatient patientInfo_{_:inputName_Country}
                data-parsley-required= {_:required_Country}
                required~ {_:required_Country}
                readonly=
                  configureIf~ {_:readOnly_Country}
                    advanced~
                    equals~ true
                screenLabel~ !!! {_:screenLabel_Country}
                placeholder= {_:placeHolder_Country}
                value= {_resultSet:country}

            div

              rowGroups
                rowGroup
                  number homePhoneCountryCode
                    id= homePhoneCountryCode
                    class= patientHomePhoneNumber clearPatient patientInfo_{_:inputName_homePhoneCountryCode}
                    data-parsley-required= {_:required_homePhoneCountryCode}
                    required~ {_:required_homePhoneCountryCode}
                    readonly=
                      configureIf~ {_:readOnly_homePhoneCountryCode}
                        advanced~
                        equals~ true
                    screenLabel~ !!! {_:screenLabel_homePhoneCountryCode}
                    placeholder= {_:placeHolder_homePhoneCountryCode}
                    size= 5
                    value= {_resultSet:phone1CountryCode}

                  text homePhoneNumber
                    id= homePhone
                    class= patientHomePhoneNumber clearPatient patientInfo_{_:inputName_homePhone}
                    data-parsley-required= {_:required_homePhone}
                    required~ {_:required_homePhone}
                    readonly=
                      configureIf~ {_:readOnly_homePhone}
                        advanced~
                        equals~ true
                    screenLabel~ !!! {_:screenLabel_homePhone}
                    placeholder= {_:placeHolder_homePhone}
                    value= {_resultSet:phone1}

                rowGroup
                  number workPhoneCountryCode
                    id= workPhoneCountryCode
                    class= patientWorkPhoneNumber clearPatient patientInfo_{_:inputName_workPhoneCountryCode}
                    data-parsley-required= {_:required_workPhoneCountryCode}
                    required~ {_:required_workPhoneCountryCode}
                    readonly=
                      configureIf~ {_:readOnly_workPhoneCountryCode}
                        advanced~
                        equals~ true
                    screenLabel~ !!! {_:screenLabel_workPhoneCountryCode}
                    placeholder= {_:placeHolder_workPhoneCountryCode}
                    size= 5
                    value= {_resultSet:phone2CountryCode}

                  text workPhoneNumber
                    id= workPhone
                    class= patientWorkPhoneNumber clearPatient patientInfo_{_:inputName_workPhone}
                    data-parsley-required= {_:required_workPhone}
                    required~ {_:required_workPhone}
                    readonly=
                      configureIf~ {_:readOnly_workPhone}
                        advanced~
                        equals~ true
                    screenLabel~ !!! {_:screenLabel_workPhone}
                    placeholder= {_:placeHolder_workPhone}
                    value= {_resultSet:phone2}

                rowGroup
                  number mobilePhoneCountryCode
                    id= mobilePhoneCountryCode
                    class= patientMobilePhoneNumber clearPatient patientInfo_{_:inputName_mobilePhoneCountryCode}
                    data-parsley-required= {_:required_mobilePhoneCountryCode}
                    required~ {_:required_mobilePhoneCountryCode}
                    readonly=
                      configureIf~ {_:readOnly_mobilePhoneCountryCode}
                        advanced~
                        equals~ true
                    screenLabel~ !!! {_:screenLabel_mobilePhoneCountryCode}
                    placeholder= {_:placeHolder_mobilePhoneCountryCode}
                    size= 5
                    value= {_resultSet:phone3CountryCode}

                  text mobilePhoneNumber
                    id= mobilePhone
                    class= patientMobilePhoneNumber clearPatient patientInfo_{_:inputName_mobilePhone}
                    data-parsley-required= {_:required_mobilePhone}
                    required~ {_:required_mobilePhone}
                    readonly=
                      configureIf~ {_:readOnly_mobilePhone}
                        advanced~
                        equals~ true
                    screenLabel~ !!! {_:screenLabel_mobilePhone}
                    placeholder= {_:placeHolder_mobilePhone}
                    value= {_resultSet:phone3}

              div
                br
                br
                vertical

                  text email
                    id= email
                    size= 50
                    class= patientEmail clearPatient patientInfo_{_:inputName_email}
                    data-parsley-required= {_:required_email}
                    required~ {_:required_email}
                    readonly=
                      configureIf~ {_:readOnly_email}
                        advanced~
                        equals~ true
                    screenLabel~ !!! {_:screenLabel_email}
                    placeholder= {_:placeHolder_email}
                    value= {_resultSet:email}


        vertical
          button Clear Patient Information
            id= clearPatient


### patient Information SQL ###
    includeable orderEntry_patientInformation_SQL


      ### set government id
      ifCondition {govtIdValue}
        advanced~
        isBlank~
        setFormQueryResult
          sqlPreparedQuery SELECT ? as 'governmentIdentification'
            string {govtId}

      ifCondition {govtIdValue}
        advanced~
        not~
          isBlank~
        and~ {govtId}
          not~
            isBlank~
        and~ {govtIdValue}
          not~
            equals~ {govtId}

        setFormQueryResult
          sqlPreparedQuery SELECT ? as 'governmentIdentification'
            string {govtId}

      ifCondition {govtIdValue}
        advanced~
        not~
          isBlank~
        and~ {govtId}
          not~
            isBlank~
        and~ {govtIdValue}
          equals~ {govtId}

        setFormQueryResult
          sqlPreparedQuery SELECT ? as 'governmentIdentification'
            string {govtIdValue}

      ifCondition {govtIdValue}
        advanced~
        not~
          isBlank~
        and~ {govtId}
          isBlank~

        setFormQueryResult
          sqlPreparedQuery SELECT ? AS 'governmentIdentification'
            string {govtId}

      # ### Set siteId ###
      # setFormQueryResult
      #   sqlPreparedQuery SELECT rf.physicianSiteId as 'siteId'
      #     - FROM requestForms rf
      #     - WHERE rf.requestId = ?
      #     string {_:requestId}

      ### manage patient ethnicities
      setFormQueryResult ethnicityString
        value=

      forEachSelectedOption ethnicity
        setFormQueryResult
          sqlPreparedQuery SELECT CONCAT(?,
            -                             CASE ?
            -                               WHEN '' THEN  ''
            -                               ELSE ','
            -                             END,
            -                             ?) AS "ethnicityString"
            string {_:ethnicityString}
            string {_:ethnicityString}
            string {_:ethnicity}


      ### CREATE NEW PATIENT
      ifCondition {patientId}
        advanced~
        isBlank~
        and~ {lastName}
          not~
            isBlank~

        setFormQueryResult
          sqlQuery CALL sp_getNextSequence('patientId','patientId')


        sqlPreparedStatement
          - INSERT INTO patients
          - (
          - patientID, sqId, firstName, middleName, lastName, familyId,
          - status, address1, address2, city, state,
          - postalCode, country, email, phone1CountryCode, phone1,
          - phone2CountryCode, phone2,  phone3CountryCode, phone3, dob,
          - govtId, geneticGender, genderId, ethnicity, eventId
          - )
          - Values
          - (
          -   ?, ?, ?, ?, ?, ?,
          -   ?, ?, ?, ?, ?,
          -   ?, ?, ?, ?, ?,
          -   ?, ?, ?, ?, CASE ? WHEN '' THEN NULL ELSE ? END,
          -   ?, ?, ?, ?, ?
          - )
          string {_:patientId}
          string sqId{_getNextSequence:sqId}
          string {firstName}
          string {middleName}
          string {lastName}
          string {familyId}
          string active
          string {addressLine1}
          string {addressLine2}
          string {city}
          string {state}
          string {postalCode}
          string {country}
          string {email}
          string {homePhoneCountryCode}
          string {homePhoneNumber}
          string {workPhoneCountryCode}
          string {workPhoneNumber}
          string {mobilePhoneCountryCode}
          string {mobilePhoneNumber}
          string {dob}
          string {dob}
          string {_:governmentIdentification}
          string {geneticGender}
          string {genderId}
          string {_:ethnicityString}
          long {_eventId}


        sqlPreparedStatement
          - INSERT INTO patientSources
          - (
          - patientID, sqId, mrn, master, siteId,
          - firstName, middleName, lastName, familyId, status, address1,
          - address2, city, state, postalCode, country,
          - email, phone1CountryCode, phone1, phone2CountryCode, phone2,
          - phone3CountryCode, phone3, dob, govtId, geneticGender,
          - genderId, ethnicity, eventId
          - )
          - Select
          -   ?, p.sqId, ?, ?, ?,
          -   ?, ?, ?, ?, ?, ?,
          -   ?, ?, ?, ?, ?,
          -   ?, ?, ?, ?, ?,
          -   ?, ?, CASE ? WHEN '' THEN NULL ELSE ? END, ?, ?,
          -   ?, ?, ?
          - FROM patients p
          - WHERE patientID = ?
          string {_:patientId}
          string {mrn}
          int 1
          string {physicianSiteId}
          string {firstName}
          string {middleName}
          string {lastName}
          string {familyId}
          string active
          string {addressLine1}
          string {addressLine2}
          string {city}
          string {state}
          string {postalCode}
          string {country}
          string {email}
          string {homePhoneCountryCode}
          string {homePhoneNumber}
          string {workPhoneCountryCode}
          string {workPhoneNumber}
          string {mobilePhoneCountryCode}
          string {mobilePhoneNumber}
          string {dob}
          string {dob}
          string {_:governmentIdentification}
          string {geneticGender}
          string {genderId}
          string {_:ethnicityString}
          long {_eventId}
          string {_:patientId}



        else
          setFormQueryResult patientId
            value= {patientId}

          ifCondition
            advanced~
            sqlPreparedQuery~ SELECT 1
              - FROM patients
              - WHERE patientId = ?
              - AND (firstName <> ?
              - OR middleName <> ?
              - OR lastName <> ?
              - OR familyId <> ?
              - OR address1 <> ?
              - OR address2 <> ?
              - OR city <> ?
              - OR state <> ?
              - OR postalCode <> ?
              - OR country <> ?
              - OR email <> ?
              - OR phone1CountryCode <> ?
              - OR phone1 <> ?
              - OR phone2CountryCode <> ?
              - OR phone2 <> ?
              - OR phone3CountryCode <> ?
              - OR phone3 <> ?
              - OR IFNULL(dob,'') <> CASE ? WHEN '' THEN NULL ELSE ? END
              - OR govtId <> ?
              - OR geneticGender <> ?
              - OR genderId <> ?
              - OR ethnicity <> ?)

              string {_:patientId}
              string {firstName}
              string {middleName}
              string {lastName}
              string {familyId}
              string {addressLine1}
              string {addressLine2}
              string {city}
              string {state}
              string {postalCode}
              string {country}
              string {email}
              string {homePhoneCountryCode}
              string {homePhoneNumber}
              string {workPhoneCountryCode}
              string {workPhoneNumber}
              string {mobilePhoneCountryCode}
              string {mobilePhoneNumber}
              string {dob}
              string {dob}
              string {_:governmentIdentification}
              string {geneticGender}
              string {genderId}
              string {_:ethnicityString}

            sqlPreparedStatement
              - UPDATE patients
              - set firstName = ?, middleName = ?, lastName = ?, familyId = ?, address1 = ?, address2 = ?,
              - city = ?, state = ?, postalCode = ?, country = ?, email = ?,
              - phone1CountryCode = ?, phone1 = ?, phone2CountryCode = ?, phone2 = ?, phone3CountryCode = ?,
              - phone3 = ?, dob = CASE ? WHEN '' THEN NULL ELSE ? END, govtId = ?, geneticGender = ?, genderId = ?,
              - ethnicity = ?, eventId = ?
              - WHERE patientID = ?
              string {firstName}
              string {middleName}
              string {lastName}
              string {familyId}
              string {addressLine1}
              string {addressLine2}
              string {city}
              string {state}
              string {postalCode}
              string {country}
              string {email}
              string {homePhoneCountryCode}
              string {homePhoneNumber}
              string {workPhoneCountryCode}
              string {workPhoneNumber}
              string {mobilePhoneCountryCode}
              string {mobilePhoneNumber}
              string {dob}
              string {dob}
              string {_:governmentIdentification}
              string {geneticGender}
              string {genderId}
              string {_:ethnicityString}
              long {_eventId}
              string {_:patientId}

            sqlPreparedStatement
              - INSERT INTO patientSources
              - (
              - patientID, sqId, mrn, master, siteId,
              - firstName, middleName, lastName, familyId, status, address1,
              - address2, city, state, postalCode, country,
              - email, phone1CountryCode, phone1, phone2CountryCode, phone2,
              - phone3CountryCode, phone3, dob, govtId, geneticGender,
              - genderId, ethnicity, eventId
              - )
              - Select
              -   ?, p.sqId, ?, ?, ?,
              -   ?, ?, ?, ?, ?, ?,
              -   ?, ?, ?, ?, ?,
              -   ?, ?, ?, ?, ?,
              -   ?, ?, CASE ? WHEN '' THEN NULL ELSE ? END, ?, ?,
              -   ?, ?, ?
              - FROM patients p
              - WHERE patientID = ?
              string {_:patientId}
              string {mrn}
              int 1
              string {physicianSiteId}
              string {firstName}
              string {middleName}
              string {lastName}
              string {familyId}
              string active
              string {addressLine1}
              string {addressLine2}
              string {city}
              string {state}
              string {postalCode}
              string {country}
              string {email}
              string {homePhoneCountryCode}
              string {homePhoneNumber}
              string {workPhoneCountryCode}
              string {workPhoneNumber}
              string {mobilePhoneCountryCode}
              string {mobilePhoneNumber}
              string {dob}
              string {dob}
              string {_:governmentIdentification}
              string {geneticGender}
              string {genderId}
              string {_:ethnicityString}
              long {_eventId}
              string {_:patientId}

            sqlPreparedStatement
              - UPDATE patientSources
              -  SET status = 'inactive', master = 0
              - WHERE eventId <> ? AND patientId = ?
              long {_eventId}
              string {_:patientId}

          ifCondition
            advanced~
            not~
              sqlPreparedQuery~ SELECT 1
                - FROM patientSources
                - WHERE eventId = ?
                long {_eventId}

            ifCondition
              advanced~
              sqlPreparedQuery~  SELECT 1
                - FROM requestForms
                - WHERE requestId = ?
                - AND mrn <> ?
                string {_:requestId}
                string {mrn}

              sqlPreparedStatement
                - INSERT INTO patientSources
                - (
                - patientID, sqId, mrn, master, siteId,
                - firstName, middleName, lastName, familyId, status, address1,
                - address2, city, state, postalCode, country,
                - email, phone1CountryCode, phone1, phone2CountryCode, phone2,
                - phone3CountryCode, phone3, dob, govtId, geneticGender,
                - genderId, ethnicity, eventId
                - )
                - Values
                - (
                -   ?, ?, ?, ?, ?,
                -   ?, ?, ?, ?, ?, ?,
                -   ?, ?, ?, ?, ?,
                -   ?, ?, ?, ?, ?,
                -   ?, ?, CASE ? WHEN '' THEN NULL ELSE ? END, ?, ?,
                -   ?, ?, ?
                - )
                string {_:patientId}
                string {sqid}
                string {mrn}
                int 1
                string {physicianSiteId}
                string {firstName}
                string {middleName}
                string {lastName}
                string {familyId}
                string active
                string {addressLine1}
                string {addressLine2}
                string {city}
                string {state}
                string {postalCode}
                string {country}
                string {email}
                string {homePhoneCountryCode}
                string {homePhoneNumber}
                string {workPhoneCountryCode}
                string {workPhoneNumber}
                string {mobilePhoneCountryCode}
                string {mobilePhoneNumber}
                string {dob}
                string {dob}
                string {_:governmentIdentification}
                string {geneticGender}
                string {genderId}
                string {_:ethnicityString}
                long {_eventId}


      sqlPreparedStatement
        - UPDATE requestForms
        - SET patientId = ?,
        -     mrn = ?
        - WHERE requestId = ?
        string {_:patientId}
        string {mrn}
        string {_:requestId}

      ### MANAGE PATIENT ETHINICITIES
      ifCondition {_:patientId}
        advanced~
        not~
          isBlank~
        sqlPreparedStatement
          - DELETE FROM patientEthnicities
          - WHERE patientId = ?
          string {_:patientId}

        forEachSelectedOption ethnicity

          sqlPreparedStatement
            - INSERT INTO patientEthnicities
            - (
            -   patientId,
            -   ethnicityName,
            -   eventId
            - )
            - Values
            - (
            -   ?,?,?
            - )
            string {_:patientId}
            string {_:ethnicity}
            long {_eventId}





### Clinical Information ###
    includeable orderEntry_clinicalInformation
      script
        src= js/orderEntry/clinicalInformation.js

      configurePreparedQuery~
        - CALL sp_getFormInputSettings('clinicalInformation', 'Accessioning', ?)
        int {_:formDefinitionId}

      configurePreparedQuery~
        - SELECT {_:inputSettings}

      formPreparedQuery~
        - SELECT ageAtInitialPresentation, geneticCounselor, clinicalNotes, clinicalHistory,
        -         dateOfLastPSA, lastPSA, percentFreePSA, dateOfLastDRE, lastDREResults,
        -         biopsyHistoryNumber, biopsyHistoryOther, histopathologyFindings,
        -         lastMenstrualCycle, pregnant, pregnantComments, lastPregnancy,
        -         miscarriages, miscarriagesComments, hysterectomy, hysterectomyComments, thyroidIssues, thyroidIssuesComments,
        -         babyIdentifyingNumber, birthWeight, birthTime, placeOfBirth, locationOfSampling, referringDoctor, repeatSample, privatePublicPatient, prePostTransfusion,
        -         ambiguousGenitalia, ambiguousGenitaliaComments, clinicalHistoryOfMother, motherFullName, dateOfFirstMilk, timeOfFirstMilk,
        -         feedingHistory, familyHistoryCF, familyHistoryCFComments, meconiumIleus, meconiumIleusComments,
        -         donorOrRecipient, transfusionHistory, bloodType, transfusionTransplantHistory
        - FROM clinicalInformation
        - WHERE requestId = ?
        - UNION ALL
        - SELECT ?, ?, ?, ?,
        -         ?, ?, ?, ?, ?,
        -         ?, ?, ?,
        -         ?, ?, '', ?,
        -         ?, '', ?, '', ?, '',
        -         ?, ?, ?, ?, ?, ?, ?, '', '',
        -         ?, '', ?, ?, ?, ?,
        -         ?, ?, '', ?, '',
        -         '', ?, '', ?
        string {_:requestId}
        string {_:defaultValue_ageAtInitialPresentation}
        string {_:defaultValue_geneticCounselor}
        string {_:defaultValue_clinicalNotes}
        string {_:defaultValue_clinicalHistory}
        string {_:defaultValue_dateOfLastPSA}
        string {_:defaultValue_lastPSA}
        string {_:defaultValue_percentFreePSA}
        string {_:defaultValue_dateOfLastDRE}
        string {_:defaultValue_lastDREResults}
        string {_:defaultValue_biopsyHistoryNumber}
        string {_:defaultValue_biopsyHistoryOther}
        string {_:defaultValue_histopathologyFindings}
        string {_:defaultValue_lastMenstrualCycle}
        string {_:defaultValue_pregnant}
        string {_:defaultValue_lastPregnancy}
        string {_:defaultValue_miscarriages}
        string {_:defaultValue_hysterectomy}
        string {_:defaultValue_thyroidIssues}
        string {_:defaultValue_babyIdentifyingNumber}
        string {_:defaultValue_birthWeight}
        string {_:defaultValue_birthTime}
        string {_:defaultValue_placeOfBirth}
        string {_:defaultValue_locationOfSampling}
        string {_:defaultValue_referringDoctor}
        string {_:defaultValue_repeatSample}
        string {_:defaultValue_ambiguousGenitalia}
        string {_:defaultValue_clinicalHistoryOfMother}
        string {_:defaultValue_motherFullName}
        string {_:defaultValue_dateOfFirstMilk}
        string {_:defaultValue_timeOfFirstMilk}
        string {_:defaultValue_feedingHistory}
        string {_:defaultValue_familyHistoryCF}
        string {_:defaultValue_meconiumIleus}
        string {_:defaultValue_transfusionHistory}
        string {_:defaultValue_transfusionTransplantHistory}


      formPreparedQuery~
        - SELECT
        -   concat( last_name, ', ', first_name) AS "geneticCounselorName"
        - FROM physicians
        - WHERE physicianId = ?
        - UNION ALL
        - SELECT ''
        string {_:geneticCounselor}

      #Date formatting
      formQuery~ dateOfLastPSA
        convertDateTime~ false
        formatDate~
        value= {_:dateOfLastPSA}
      formQuery~ dateOfLastDRE
        convertDateTime~ false
        formatDate~
        value= {_:dateOfLastDRE}
      formQuery~ lastMenstrualCycle
        convertDateTime~ false
        formatDate~
        value= {_:lastMenstrualCycle}
      formQuery~ lastPregnancy
        convertDateTime~ false
        formatDate~
        value= {_:lastPregnancy}
      formQuery~ dateOfFirstMilk
        convertDateTime~ false
        formatDate~
        value= {_:dateOfFirstMilk}

      hidden currentMedicationsSelectHidden
        class= hideOnReadOnly
        id= currentMedicationsSelect
        value= {_:readOnly_currentMedications}
      hidden problematicMedicationsSelectHidden
        class= hideOnReadOnly
        id= problematicMedicationsSelect
        value= {_:readOnly_problematicMedications}
      hidden drugAllergiesSelectHidden
        class= hideOnReadOnly
        id= drugAllergiesSelect
        value= {_:readOnly_drugAllergies}

      div
        id= clinicalInformationBasic
        vertical2
          vertical
            number ageAtInitialPresentation
              id= ageAtInitialPresentation
              data-parsley-required= {_:required_ageAtInitialPresentation}
              required~ {_:required_ageAtInitialPresentation}
              readonly=
                configureIf~ {_:readOnly_ageAtInitialPresentation}
                  advanced~
                  equals~ true
              screenLabel~ !!! {_:screenLabel_ageAtInitialPresentation}
              placeholder= {_:placeHolder_ageAtInitialPresentation}
              value= {_:ageAtInitialPresentation}
            select geneticCounselor
              id= geneticCounselor
              data-parsley-required= {_:required_geneticCounselor}
              required~ {_:required_geneticCounselor}
              disabled= true
                configureIf~ {_:readOnly_geneticCounselor}
                  advanced~
                  equals~ true
              screenLabel~ !!! {_:screenLabel_geneticCounselor}
              placeholder= {_:placeHolder_geneticCounselor}
              option {_:geneticCounselorName}
                value= {_:geneticCounselor}
              sqlPreparedQuery~ SELECT concat(last_name, ', ', first_name), physicianId FROM physicians WHERE providerType = 'Genetic Counselor'

          vertical
            textArea clinicalNotes
              id= clinicalNotes
              data-parsley-required= {_:required_clinicalNotes}
              required~ {_:required_clinicalNotes}
              readonly=
                configureIf~ {_:readOnly_clinicalNotes}
                  advanced~
                  equals~ true
              screenLabel~ !!! {_:screenLabel_clinicalNotes}
              placeholder= {_:placeHolder_clinicalNotes}
              value= {_:clinicalNotes}
            textArea clinicalHistory
              id= clinicalHistory
              data-parsley-required= {_:required_clinicalHistory}
              required~ {_:required_clinicalHistory}
              readonly=
                configureIf~ {_:readOnly_clinicalHistory}
                  advanced~
                  equals~ true
              screenLabel~ !!! {_:screenLabel_clinicalHistory}
              placeholder= {_:placeHolder_clinicalHistory}
              value= {_:clinicalHistory}

        div
          div
            id= currentMedications
            class= drugSelection
              configureIf~ {_:required_currentMedications}
                advanced~
                equals~ false
            class= drugSelection required
              configureIf~ {_:required_currentMedications}
                advanced~
                equals~ true

            vertical
              span !!!{_:screenLabel_currentMedications}
              div
                class= currentMedicationsSelect
                select currentMedications
                  id= currentMedicationsSelect
                  class= drugCombobox
                  disabled= true
                    configureIf~ {_:readOnly_currentMedications}
                  screenLabel~
                  option
                  sqlPreparedQuery~
                    - SELECT DISTINCT name, id
                    - FROM drugs
                    - WHERE disabled = 0
              table
                id= currentMedicationsTable
                class= clinicalInformation_drugTable stdTable
                sqlPreparedQuery~
                  - SELECT DISTINCT
                  -   '' AS "Remove"
                  -   , d.name AS "Current Medication"
                  -   , d.Id AS "Hidden"
                  - FROM clinicalInformationDrugs cid
                  -   INNER JOIN drugs d on cid.drugId = d.Id
                  -     AND d.disabled = 0
                  - WHERE cid.requestId = ?
                  -   AND cid.type = 'currentMedications'
                  - UNION
                  - (SELECT '','',''
                  - FROM dual
                  - WHERE NOT EXISTS (SELECT 1 FROM clinicalInformationDrugs WHERE requestId = ? and type = 'currentMedications')
                  - LIMIT 1)
                  string {_:requestId}
                  string {_:requestId}
                columnSpecs~ currentMedicationsTable
                  allowChangedRecordIds
                  column 1
                    inputType checkbox
                      class= clinicalinfo_removeCurrentMedication
                  column 2
                    inputType text
                      readonly=
                      class= drugName
                  column 3
                    inputType text
                      readonly=
                      class= hideColumn drugId

          div
            id= problematicMedications
            class= drugSelection
              configureIf~ {_:required_problematicMedications}
                advanced~
                equals~ false
            class= drugSelection required
              configureIf~ {_:required_problematicMedications}
                advanced~
                equals~ true

            vertical
              span !!!{_:screenLabel_problematicMedications}
              div
                class= problematicMedicationsSelect
                select problematicMedications
                  id= problematicMedicationsSelect
                  class= drugCombobox
                  disabled= true
                    configureIf~ {_:readOnly_problematicMedications}
                  screenLabel~
                  option
                  sqlPreparedQuery~
                    - SELECT DISTINCT name, id
                    - FROM drugs
                    - WHERE disabled = 0
              table
                id= problematicMedicationsTable
                class= clinicalInformation_drugTable stdTable
                sqlPreparedQuery~
                  - SELECT DISTINCT
                  -   '' AS "Remove"
                  -   , d.name AS "Problem Medication"
                  -   , d.Id AS "Hidden"
                  - FROM clinicalInformationDrugs cid
                  -   INNER JOIN drugs d on cid.drugId = d.Id
                  -     AND d.disabled = 0
                  - WHERE cid.requestId = ?
                  -   AND cid.type = 'problematicMedications'
                  - UNION
                  - (SELECT '','',''
                  - FROM dual
                  - WHERE NOT EXISTS (SELECT 1 FROM clinicalInformationDrugs WHERE requestId = ? and type = 'problematicMedications')
                  - LIMIT 1)
                  string {_:requestId}
                  string {_:requestId}
                columnSpecs~ problematicMedicationsTable
                  allowChangedRecordIds
                  column 1
                    inputType checkbox
                      class= clinicalinfo_removeProblematicMedication
                  column 2
                    inputType text
                      readonly=
                      class= drugName
                  column 3
                    inputType text
                      readonly=
                      class= hideColumn drugId

          div
            id= drugAllergies
            class= drugSelection
              configureIf~ {_:required_drugAllergies}
                advanced~
                equals~ false
            class= drugSelection required
              configureIf~ {_:required_drugAllergies}
                advanced~
                equals~ true
            vertical
              span !!!{_:screenLabel_drugAllergies}
              div
                class= drugAllergiesSelect
                select drugAllergies
                  id= drugAllergiesSelect
                  class= drugCombobox
                  disabled= true
                    configureIf~ {_:readOnly_drugAllergies}
                  screenLabel~
                  option
                  sqlPreparedQuery~
                    - SELECT DISTINCT name, id
                    - FROM drugs
                    - WHERE disabled = 0
              table
                id= drugAllergiesTable
                class= clinicalInformation_drugTable stdTable
                sqlPreparedQuery~
                  - SELECT DISTINCT
                  -   '' AS "Remove"
                  -   , d.name AS "Drug Allergy"
                  -   , d.Id AS "Hidden"
                  - FROM clinicalInformationDrugs cid
                  -   INNER JOIN drugs d on cid.drugId = d.Id
                  -     AND d.disabled = 0
                  - WHERE cid.requestId = ?
                  -   AND cid.type = 'drugAllergies'
                  - UNION
                  - (SELECT '','',''
                  - FROM dual
                  - WHERE NOT EXISTS (SELECT 1 FROM clinicalInformationDrugs WHERE requestId = ? and type = 'drugAllergies')
                  - LIMIT 1)
                  string {_:requestId}
                  string {_:requestId}
                columnSpecs~ drugAllergiesTable
                  allowChangedRecordIds
                  column 1
                    inputType checkbox
                      class= clinicalinfo_removeDrugAllergy
                  column 2
                    inputType text
                      readonly=
                      class= drugName
                  column 3
                    inputType text
                      readonly=
                      class= hideColumn drugId

      div
        id= PSA
        fieldSet
          legend PSA Information
          vertical
            date dateOfLastPSA
              convert~ false
              id= dateOfLastPSA
              class= datePickerNow
                configureIf~ {_:readOnly_dateOfLastPSA}
                  advanced~
                  equals~ false
              data-parsley-required= {_:required_dateOfLastPSA}
              required~ {_:required_dateOfLastPSA}
              readonly=
                configureIf~ {_:readOnly_dateOfLastPSA}
                  advanced~
                  equals~ true
              screenLabel~ !!! {_:screenLabel_dateOfLastPSA}
              placeholder= {_:placeHolder_dateOfLastPSA}
              value= {_:dateOfLastPSA}
            text lastPSA
              id= lastPSA
              data-parsley-required= {_:required_lastPSA}
              required~ {_:required_lastPSA}
              readonly=
                configureIf~ {_:readOnly_lastPSA}
                  advanced~
                  equals~ true
              screenLabel~ !!! {_:screenLabel_lastPSA}
              placeholder= {_:placeHolder_lastPSA}
              value= {_:lastPSA}
            text percentFreePSA
              id= percentFreePSA
              data-parsley-required= {_:required_percentFreePSA}
              required~ {_:required_percentFreePSA}
              readonly=
                configureIf~ {_:readOnly_percentFreePSA}
                  advanced~
                  equals~ true
              screenLabel~ !!! {_:screenLabel_percentFreePSA}
              placeholder= {_:placeHolder_percentFreePSA}
              value= {_:percentFreePSA}

      div
        id= DRE
        fieldSet
          legend DRE Information
          vertical
            date dateOfLastDRE
              convert~ false
              id= dateOfLastDRE
              class= datePickerNow
                configureIf~ {_:readOnly_dateOfLastDRE}
                  advanced~
                  equals~ false
              data-parsley-required= {_:required_dateOfLastDRE}
              required~ {_:required_dateOfLastDRE}
              readonly=
                configureIf~ {_:readOnly_dateOfLastDRE}
                  advanced~
                  equals~ true
              screenLabel~ !!! {_:screenLabel_dateOfLastDRE}
              placeholder= {_:placeHolder_dateOfLastDRE}
              value= {_:dateOfLastDRE}
            textArea lastDREResults
              id= lastDREResults
              data-parsley-required= {_:required_lastDREResults}
              required~ {_:required_lastDREResults}
              readonly=
                configureIf~ {_:readOnly_lastDREResults}
                  advanced~
                  equals~ true
              screenLabel~ !!! {_:screenLabel_lastDREResults}
              placeholder= {_:placeHolder_lastDREResults}
              value= {_:lastDREResults}

      div
        id= biopsy
        fieldSet
          legend Biopsy Information
          vertical
            text biopsyHistoryNumber
              id= biopsyHistoryNumber
              data-parsley-required= {_:required_biopsyHistoryNumber}
              required~ {_:required_biopsyHistoryNumber}
              readonly=
                configureIf~ {_:readOnly_biopsyHistoryNumber}
                  advanced~
                  equals~ true
              screenLabel~ !!! {_:screenLabel_biopsyHistoryNumber}
              placeholder= {_:placeHolder_biopsyHistoryNumber}
              value= {_:biopsyHistoryNumber}
            textArea biopsyHistoryOther
              id= biopsyHistoryOther
              data-parsley-required= {_:required_biopsyHistoryOther}
              required~ {_:required_biopsyHistoryOther}
              readonly=
                configureIf~ {_:readOnly_biopsyHistoryOther}
                  advanced~
                  equals~ true
              screenLabel~ !!! {_:screenLabel_biopsyHistoryOther}
              placeholder= {_:placeHolder_biopsyHistoryOther}
              value= {_:biopsyHistoryOther}
            textArea histopathologyFindings
              id= histopathologyFindings
              data-parsley-required= {_:required_histopathologyFindings}
              required~ {_:required_histopathologyFindings}
              readonly=
                configureIf~ {_:readOnly_histopathologyFindings}
                  advanced~
                  equals~ true
              screenLabel~ !!! {_:screenLabel_histopathologyFindings}
              placeholder= {_:placeHolder_histopathologyFindings}
              value= {_:histopathologyFindings}

      div
        id= womensHealth
        fieldSet
          legend Women's Health
          rowGroups
            rowGroup !!! {_:screenLabel_lastMenstrualCycle}
              vertical
                date lastMenstrualCycle
                  convert~ false
                  id= lastMenstrualCycle
                  class= datePickerNow
                    configureIf~ {_:readOnly_lastMenstrualCycle}
                      advanced~
                      equals~ false
                  data-parsley-required= {_:required_lastMenstrualCycle}
                  required~ {_:required_lastMenstrualCycle}
                  readonly=
                    configureIf~ {_:readOnly_lastMenstrualCycle}
                      advanced~
                      equals~ true
                  screenLabel~
                  placeholder= {_:placeHolder_lastMenstrualCycle}
                  value= {_:lastMenstrualCycle}
            rowGroup !!! {_:screenLabel_pregnant}
              vertical2
                checkbox pregnant
                  asBit~
                  id= pregnant
                  class= pregnant clincialCheckbox
                  data-parsley-required= {_:required_pregnant}
                  required~ {_:required_pregnant}
                  screenLabel~
                  placeholder= {_:placeHolder_pregnant}
                  value= {_:pregnant}
                  disabled= true
                    configureIf~ {_:readOnly_pregnant}
                  validate~ SELECT 1
                    - FROM DUAL
                    - WHERE ? = 'false' OR ? = 1
                    string {_:required_pregnant}
                    string {_thisInput}
                    errorMessage~ {_:screenLabel_pregnant} must be checked.
                textArea pregnantComments
                  id= pregnantComments
                  class= pregnant hiddenOnLoad commentField
                  screenLabel~
                  value= {_:pregnantComments}
            rowGroup !!! {_:screenLabel_lastPregnancy}
              vertical
                date lastPregnancy
                  convert~ false
                  id= lastPregnancy
                  class= datePickerNow
                    configureIf~ {_:readOnly_lastPregnancy}
                      advanced~
                      equals~ false
                  data-parsley-required= {_:required_lastPregnancy}
                  required~ {_:required_lastPregnancy}
                  readonly=
                    configureIf~ {_:readOnly_lastPregnancy}
                      advanced~
                      equals~ true
                  screenLabel~
                  placeholder= {_:placeHolder_lastPregnancy}
                  value= {_:lastPregnancy}
            rowGroup !!! {_:screenLabel_hysterectomy}
              vertical2
                checkbox hysterectomy
                  asBit~
                  id= hysterectomy
                  class= hysterectomy clincialCheckbox
                  data-parsley-required= {_:required_hysterectomy}
                  required~ {_:required_hysterectomy}
                  screenLabel~
                  placeholder= {_:placeHolder_hysterectomy}
                  value= {_:hysterectomy}
                  disabled= true
                    configureIf~ {_:readOnly_hysterectomy}
                  validate~ SELECT 1
                    - FROM DUAL
                    - WHERE ? = 'false' OR ? = 1
                    string {_:required_hysterectomy}
                    string {_thisInput}
                    errorMessage~ {_:screenLabel_hysterectomy} must be checked.
                textArea hysterectomyComments
                  id= hysterectomyComments
                  class= hysterectomy hiddenOnLoad commentField
                  value= {_:hysterectomyComments}
                  screenLabel~
            rowGroup !!! {_:screenLabel_miscarriages}
              vertical2
                checkbox miscarriages
                  asBit~
                  id= miscarriages
                  class= miscarriages clincialCheckbox
                  data-parsley-required= {_:required_miscarriages}
                  required~ {_:required_miscarriages}
                  screenLabel~
                  placeholder= {_:placeHolder_miscarriages}
                  value= {_:miscarriages}
                  disabled= true
                    configureIf~ {_:readOnly_miscarriages}
                  validate~ SELECT 1
                    - FROM DUAL
                    - WHERE ? = 'false' OR ? = 1
                    string {_:required_miscarriages}
                    string {_thisInput}
                    errorMessage~ {_:screenLabel_miscarriages} must be checked.
                textArea miscarriagesComments
                  id= miscarriagesComments
                  class= miscarriages hiddenOnLoad commentField
                  value= {_:miscarriagesComments}
                  screenLabel~
            rowGroup !!! {_:screenLabel_thyroidIssues}
              vertical2
                checkbox thyroidIssues
                  asBit~
                  id= thyroidIssues
                  class= thyroidIssues clincialCheckbox
                  data-parsley-required= {_:required_thyroidIssues}
                  required~ {_:required_thyroidIssues}
                  screenLabel~
                  placeholder= {_:placeHolder_thyroidIssues}
                  value= {_:thyroidIssues}
                  disabled= true
                    configureIf~ {_:readOnly_thyroidIssues}
                  validate~ SELECT 1
                    - FROM DUAL
                    - WHERE ? = 'false' OR ? = 1
                    string {_:required_thyroidIssues}
                    string {_thisInput}
                    errorMessage~ {_:screenLabel_thyroidIssues} must be checked.
                textArea thyroidIssuesComments
                  id= thyroidIssuesComments
                  class= thyroidIssues hiddenOnLoad commentField
                  value= {_:thyroidIssuesComments}
                  screenLabel~


      div
        id= newbornScreening
        fieldSet
          legend Newborn Screening
          div
            class= newborn
            vertical
              text birthWeight
                id= birthWeight
                data-parsley-required= {_:required_birthWeight}
                required~ {_:required_birthWeight}
                readonly=
                  configureIf~ {_:readOnly_birthWeight}
                    advanced~
                    equals~ true
                screenLabel~ !!! {_:screenLabel_birthWeight}
                placeholder= {_:placeHolder_birthWeight}
                value= {_:birthWeight}
              text placeOfBirth
                id= placeOfBirth
                data-parsley-required= {_:required_placeOfBirth}
                required~ {_:required_placeOfBirth}
                readonly=
                  configureIf~ {_:readOnly_placeOfBirth}
                    advanced~
                    equals~ true
                screenLabel~ !!! {_:screenLabel_placeOfBirth}
                placeholder= {_:placeHolder_placeOfBirth}
                value= {_:placeOfBirth}
              text birthTime
                id= birthTime
                class= timePicker
                data-parsley-required= {_:required_birthTime}
                required~ {_:required_birthTime}
                readonly=
                  configureIf~ {_:readOnly_birthTime}
                    advanced~
                    equals~ true
                screenLabel~ !!! {_:screenLabel_birthTime}
                value= {_:birthTime}
                size= 7
              text locationOfSampling
                id= locationOfSampling
                data-parsley-required= {_:required_locationOfSampling}
                required~ {_:required_locationOfSampling}
                readonly=
                  configureIf~ {_:readOnly_locationOfSampling}
                    advanced~
                    equals~ true
                screenLabel~ !!! {_:screenLabel_locationOfSampling}
                placeholder= {_:placeHolder_locationOfSampling}
                value= {_:locationOfSampling}
              text babyIdentifyingNumber
                id= babyIdentifyingNumber
                data-parsley-required= {_:required_babyIdentifyingNumber}
                required~ {_:required_babyIdentifyingNumber}
                readonly=
                  configureIf~ {_:readOnly_babyIdentifyingNumber}
                    advanced~
                    equals~ true
                screenLabel~ !!! {_:screenLabel_babyIdentifyingNumber}
                placeholder= {_:placeHolder_babyIdentifyingNumber}
                value= {_:babyIdentifyingNumber}
              select privatePublicPatient
                id= privatePublicPatient
                data-parsley-required= {_:required_privatePublicPatient}
                required~ {_:required_privatePublicPatient}
                readonly=
                  configureIf~ {_:readOnly_privatePublicPatient}
                    advanced~
                    equals~ true
                screenLabel~ !!! {_:screenLabel_privatePublicPatient}
                placeholder= {_:placeHolder_privatePublicPatient}
                setName~ {_:defaultValue_privatePublicPatient}
                value= {_:privatePublicPatient}
              text referringDoctor
                id= referringDoctor
                data-parsley-required= {_:required_referringDoctor}
                required~ {_:required_referringDoctor}
                readonly=
                  configureIf~ {_:readOnly_referringDoctor}
                    advanced~
                    equals~ true
                screenLabel~ !!! {_:screenLabel_referringDoctor}
                placeholder= {_:placeHolder_referringDoctor}
                value= {_:referringDoctor}
              checkbox repeatSample
                asBit~
                id= repeatSample
                data-parsley-required= {_:required_repeatSample}
                required~ {_:required_repeatSample}
                screenLabel~ !!! {_:screenLabel_repeatSample}
                placeholder= {_:placeHolder_repeatSample}
                value= {_:repeatSample}
                disabled= true
                  configureIf~ {_:readOnly_repeatSample}
                validate~ SELECT 1
                  - FROM DUAL
                  - WHERE ? = 'false' OR ? = 1
                  string {_:required_repeatSample}
                  string {_thisInput}
                  errorMessage~ {_:screenLabel_repeatSample} must be checked.
              select prePostTransfusion
                id= prePostTransfusion
                data-parsley-required= {_:required_prePostTransfusion}
                required~ {_:required_prePostTransfusion}
                disabled= true
                  configureIf~ {_:readOnly_prePostTransfusion}
                    advanced~
                    equals~ true
                screenLabel~ !!! {_:screenLabel_prePostTransfusion}
                placeholder= {_:placeHolder_prePostTransfusion}
                setName~ {_:defaultValue_prePostTransfusion}
                value= {_:prePostTransfusion}
            rowGroups
              rowGroup !!!  {_:screenLabel_familyHistoryCF}

                checkbox familyHistoryCF
                  asBit~
                  id= familyHistoryCF
                  class= familyHistoryCF clincialCheckbox
                  data-parsley-required= {_:required_familyHistoryCF}
                  required~ {_:required_familyHistoryCF}
                  screenLabel~
                  placeholder= {_:placeHolder_familyHistoryCF}
                  value= {_:familyHistoryCF}
                  disabled= true
                    configureIf~ {_:readOnly_familyHistoryCF}
                  validate~ SELECT 1
                    - FROM DUAL
                    - WHERE ? = 'false' OR ? = 1
                    string {_:required_familyHistoryCF}
                    string {_thisInput}
                    errorMessage~ {_:screenLabel_familyHistoryCF} must be checked.
                textArea familyHistoryCFComments
                  id= familyHistoryCFComments
                  class= familyHistoryCF commentField hiddenOnLoad
                  value= {_:familyHistoryCFComments}
                  screenLabel~

              rowGroup !!! {_:screenLabel_meconiumIleus}
                checkbox meconiumIleus
                  asBit~
                  id= meconiumIleus
                  class= meconiumIleus clincialCheckbox
                  data-parsley-required= {_:required_meconiumIleus}
                  required~ {_:required_meconiumIleus}
                  screenLabel~
                  placeholder= {_:placeHolder_meconiumIleus}
                  value= {_:meconiumIleus}
                  disabled= true
                    configureIf~ {_:readOnly_meconiumIleus}
                  validate~ SELECT 1
                    - FROM DUAL
                    - WHERE ? = 'false' OR ? = 1
                    string {_:required_meconiumIleus}
                    string {_thisInput}
                    errorMessage~ {_:screenLabel_meconiumIleus} must be checked.
                textArea meconiumIleusComments
                  id= meconiumIleusComments
                  class= meconiumIleus commentField hiddenOnLoad
                  value= {_:meconiumIleusComments}
                  screenLabel~

              rowGroup !!! {_:screenLabel_ambiguousGenitalia}
                checkbox ambiguousGenitalia
                  asBit~
                  id= ambiguousGenitalia
                  class= ambiguousGenitalia clincialCheckbox
                  data-parsley-required= {_:required_ambiguousGenitalia}
                  required~ {_:required_ambiguousGenitalia}
                  screenLabel~
                  placeholder= {_:placeHolder_ambiguousGenitalia}
                  value= {_:ambiguousGenitalia}
                  disabled= true
                    configureIf~ {_:readOnly_ambiguousGenitalia}
                  validate~ SELECT 1
                    - FROM DUAL
                    - WHERE ? = 'false' OR ? = 1
                    string {_:required_ambiguousGenitalia}
                    string {_thisInput}
                    errorMessage~ {_:screenLabel_ambiguousGenitalia} must be checked.
                textArea ambiguousGenitaliaComments
                  id= ambiguousGenitaliaComments
                  class= ambiguousGenitalia commentField hiddenOnLoad
                  value= {_:ambiguousGenitaliaComments}
                  screenLabel~

          div
            class= newborn
            fieldSet
              legend Mother's Demographics
              vertical
                text motherFullName
                  id= motherFullName
                  data-parsley-required= {_:required_motherFullName}
                  required~ {_:required_motherFullName}
                  readonly=
                    configureIf~ {_:readOnly_motherFullName}
                      advanced~
                      equals~ true
                  screenLabel~ !!! {_:screenLabel_motherFullName}
                  placeholder= {_:placeHolder_motherFullName}
                  value= {_:motherFullName}
                date dateOfFirstMilk
                  convert~ false
                  id= dateOfFirstMilk
                  class= datePickerNow
                    configureIf~ {_:readOnly_dateOfFirstMilk}
                      advanced~
                      equals~ false
                  data-parsley-required= {_:required_dateOfFirstMilk}
                  required~ {_:required_dateOfFirstMilk}
                  readonly=
                    configureIf~ {_:readOnly_dateOfFirstMilk}
                      advanced~
                      equals~ true
                  screenLabel~ !!! {_:screenLabel_dateOfFirstMilk}
                  placeholder= {_:placeHolder_dateOfFirstMilk}
                  value= {_:dateOfFirstMilk}
                text timeOfFirstMilk
                  id= timeOfFirstMilk
                  class= timePicker
                  data-parsley-required= {_:required_timeOfFirstMilk}
                  required~ {_:required_timeOfFirstMilk}
                  readonly=
                    configureIf~ {_:readOnly_timeOfFirstMilk}
                      advanced~
                      equals~ true
                  screenLabel~ !!! {_:screenLabel_timeOfFirstMilk}
                  placeholder= {_:placeHolder_timeOfFirstMilk}
                  value= {_:timeOfFirstMilk}
                  size= 7
                textArea feedingHistory
                  id= feedingHistory
                  data-parsley-required= {_:required_feedingHistory}
                  required~ {_:required_feedingHistory}
                  readonly=
                    configureIf~ {_:readOnly_feedingHistory}
                      advanced~
                      equals~ true
                  screenLabel~ !!! {_:screenLabel_feedingHistory}
                  placeholder= {_:placeHolder_feedingHistory}
                  value= {_:feedingHistory}
                textArea clinicalHistoryOfMother
                  id= clinicalHistoryOfMother
                  data-parsley-required= {_:required_clinicalHistoryOfMother}
                  required~ {_:required_clinicalHistoryOfMother}
                  readonly=
                    configureIf~ {_:readOnly_clinicalHistoryOfMother}
                      advanced~
                      equals~ true
                  screenLabel~ !!! {_:screenLabel_clinicalHistoryOfMother}
                  placeholder= {_:placeHolder_clinicalHistoryOfMother}
                  value= {_:clinicalHistoryOfMother}


      div
        id= tissueDonors
        fieldSet
          legend Tissue Donor Information
          vertical
            select donorOrRecipient
              id= donorOrRecipient
              data-parsley-required= {_:required_donorOrRecipient}
              required~ {_:required_donorOrRecipient}
              disabled= true
                configureIf~ {_:readOnly_donorOrRecipient}
                  advanced~
                  equals~ true
              screenLabel~ !!! {_:screenLabel_donorOrRecipient}
              placeholder= {_:placeHolder_donorOrRecipient}
              setName~ {_:defaultValue_donorOrRecipient}
              value= {_:donorOrRecipient}
            textArea transfusionHistory
              id= transfusionHistory
              data-parsley-required= {_:required_transfusionHistory}
              required~ {_:required_transfusionHistory}
              readonly=
                configureIf~ {_:readOnly_transfusionHistory}
                  advanced~
                  equals~ true
              screenLabel~ !!! {_:screenLabel_transfusionHistory}
              placeholder= {_:placeHolder_transfusionHistory}
              value= {_:transfusionHistory}
            select bloodType
              id= bloodType
              data-parsley-required= {_:required_bloodType}
              required~ {_:required_bloodType}
              disabled= true
                configureIf~ {_:readOnly_bloodType}
                  advanced~
                  equals~ true
              screenLabel~ !!! {_:screenLabel_bloodType}
              placeholder= {_:placeHolder_bloodType}
              setName~ {_:defaultValue_bloodType}
              value= {_:bloodType}

      div
        id= hivInformation
        fieldSet
          legend HIV Information
          vertical
            textArea transfusionTransplantHistory
              id= transfusionTransplantHistory
              data-parsley-required= {_:required_transfusionTransplantHistory}
              required~ {_:required_transfusionTransplantHistory}
              readonly=
                configureIf~ {_:readOnly_transfusionTransplantHistory}
                  advanced~
                  equals~ true
              screenLabel~ !!! {_:screenLabel_transfusionTransplantHistory}
              placeholder= {_:placeHolder_transfusionTransplantHistory}
              value= {_:transfusionTransplantHistory}



### Clinincal Information SQL ###
    includeable orderEntry_clinicalInformation_SQL

      ifCondition
        advanced~
        not~
          sqlPreparedQuery~ SELECT 1
            - FROM clinicalInformation
            - WHERE requestId = ?
            string {_:requestId}

        sqlPreparedStatement~
          - INSERT INTO clinicalInformation (
          -   requestId, ageAtInitialPresentation, geneticCounselor, clinicalNotes, clinicalHistory,
          -   dateOfLastPSA, lastPSA, percentFreePSA,
          -   dateOfLastDRE, lastDREResults,
          -   biopsyHistoryNumber, biopsyHistoryOther, histopathologyFindings,
          -   lastMenstrualCycle, pregnant, pregnantComments, lastPregnancy, miscarriages, miscarriagesComments, hysterectomy, hysterectomyComments, thyroidIssues, thyroidIssuesComments,
          -   babyIdentifyingNumber, birthWeight, birthTime, placeOfBirth, locationOfSampling, referringDoctor, repeatSample, privatePublicPatient, prePostTransfusion,
          -   ambiguousGenitalia, ambiguousGenitaliaComments, clinicalHistoryOfMother, motherFullName, dateOfFirstMilk, timeOfFirstMilk, feedingHistory, familyHistoryCF, familyHistoryCFComments, meconiumIleus, meconiumIleusComments,
          -   donorOrRecipient, transfusionHistory, bloodType,
          -   transfusionTransplantHistory, eventId)
          - VALUES (
          -   ?, ?, ?, ?, ?,
          -   (CASE ? WHEN '' THEN NULL ELSE ? END), ?, ?,
          -   (CASE ? WHEN '' THEN NULL ELSE ? END), ?,
          -   ?, ?, ?,
          -   (CASE ? WHEN '' THEN NULL ELSE ? END), ?, ?, (CASE ? WHEN '' THEN NULL ELSE ? END), ?, ?, ?, ?, ?, ?,
          -   ?, ?, ?, ?, ?, ?, ?, ?, ?,
          -   ?, ?, ?, ?, (CASE ? WHEN '' THEN NULL ELSE ? END), ?, ?, ?, ?, ?, ?,
          -   ?, ?, ?,
          -   ?, ?)
          string {_:requestId}
          string {ageAtInitialPresentation}
          string {geneticCounselor}
          string {clinicalNotes}
          string {clinicalHistory}
          string {dateOfLastPSA}
          string {dateOfLastPSA}
          string {lastPSA}
          string {percentFreePSA}
          string {dateOfLastDRE}
          string {dateOfLastDRE}
          string {lastDREResults}
          string {biopsyHistoryNumber}
          string {biopsyHistoryOther}
          string {histopathologyFindings}
          string {lastMenstrualCycle}
          string {lastMenstrualCycle}
          string {pregnant}
          string {pregnantComments}
          string {lastPregnancy}
          string {lastPregnancy}
          string {miscarriages}
          string {miscarriagesComments}
          string {hysterectomy}
          string {hysterectomyComments}
          string {thyroidIssues}
          string {thyroidIssuesComments}
          string {babyIdentifyingNumber}
          string {birthWeight}
          string {birthTime}
          string {placeOfBirth}
          string {locationOfSampling}
          string {referringDoctor}
          string {repeatSample}
          string {privatePublicPatient}
          string {prePostTransfusion}
          string {ambiguousGenitalia}
          string {ambiguousGenitaliaComments}
          string {clinicalHistoryOfMother}
          string {motherFullName}
          string {dateOfFirstMilk}
          string {dateOfFirstMilk}
          string {timeOfFirstMilk}
          string {feedingHistory}
          string {familyHistoryCF}
          string {familyHistoryCFComments}
          string {meconiumIleus}
          string {meconiumIleusComments}
          string {donorOrRecipient}
          string {transfusionHistory}
          string {bloodType}
          string {transfusionTransplantHistory}
          long {_eventId}

        forRows currentMedicationsTable
          sqlPreparedStatement~
            - INSERT INTO clinicalInformationDrugs (requestId, type, drugId, eventId)
            - SELECT ?, 'currentMedications', ?, ?
            - FROM dual WHERE ? <> 'true' and ? <> ''
            string {_:requestId}
            string {_columnInput_currentMedicationsTable:3}
            long {_eventId}
            string {_columnInput_currentMedicationsTable:1}
            string {_columnInput_currentMedicationsTable:3}

        forRows problematicMedicationsTable
          sqlPreparedStatement~
            - INSERT INTO clinicalInformationDrugs (requestId, type, drugId, eventId)
            - SELECT ?, 'problematicMedications', ?, ?
            - FROM dual WHERE ? <> 'true' and ? <> ''
            string {_:requestId}
            string {_columnInput_problematicMedicationsTable:3}
            long {_eventId}
            string {_columnInput_problematicMedicationsTable:1}
            string {_columnInput_problematicMedicationsTable:3}

        forRows drugAllergiesTable
          sqlPreparedStatement~
            - INSERT INTO clinicalInformationDrugs (requestId, type, drugId, eventId)
            - SELECT ?, 'drugAllergies', ?, ?
            - FROM dual WHERE ? <> 'true' and ? <> ''
            string {_:requestId}
            string {_columnInput_drugAllergiesTable:3}
            long {_eventId}
            string {_columnInput_drugAllergiesTable:1}
            string {_columnInput_drugAllergiesTable:3}

        else

          sqlPreparedStatement~
            - UPDATE clinicalInformation SET
            -   ageAtInitialPresentation = ?, geneticCounselor = ?, clinicalNotes = ?, clinicalHistory = ?,
            -   dateOfLastPSA = (CASE ? WHEN '' THEN NULL ELSE ? END), lastPSA = ?, percentFreePSA = ?,
            -   dateOfLastDRE = (CASE ? WHEN '' THEN NULL ELSE ? END), lastDREResults = ?,
            -   biopsyHistoryNumber = ?, biopsyHistoryOther = ?, histopathologyFindings = ?,
            -   lastMenstrualCycle = (CASE ? WHEN '' THEN NULL ELSE ? END), pregnant = ?, pregnantComments = ?, lastPregnancy = (CASE ? WHEN '' THEN NULL ELSE ? END), miscarriages = ?, miscarriagesComments = ?, hysterectomy = ?, hysterectomyComments = ?, thyroidIssues = ?, thyroidIssuesComments = ?,
            -   babyIdentifyingNumber = ?, birthWeight = ?, birthTime = ?, placeOfBirth = ?, locationOfSampling = ?, referringDoctor = ?, repeatSample = ?, privatePublicPatient = ?, prePostTransfusion = ?,
            -   ambiguousGenitalia = ?, ambiguousGenitaliaComments = ?, clinicalHistoryOfMother = ?, motherFullName = ?, dateOfFirstMilk = (CASE ? WHEN '' THEN NULL ELSE ? END), timeOfFirstMilk = ?, feedingHistory = ?, familyHistoryCF = ?, familyHistoryCFComments = ?, meconiumIleus = ?, meconiumIleusComments = ?,
            -   donorOrRecipient = ?, transfusionHistory = ?, bloodType = ?,
            -   transfusionTransplantHistory = ?
            - WHERE requestId = ?
            string {ageAtInitialPresentation}
            string {geneticCounselor}
            string {clinicalNotes}
            string {clinicalHistory}
            string {dateOfLastPSA}
            string {dateOfLastPSA}
            string {lastPSA}
            string {percentFreePSA}
            string {dateOfLastDRE}
            string {dateOfLastDRE}
            string {lastDREResults}
            string {biopsyHistoryNumber}
            string {biopsyHistoryOther}
            string {histopathologyFindings}
            string {lastMenstrualCycle}
            string {lastMenstrualCycle}
            string {pregnant}
            string {pregnantComments}
            string {lastPregnancy}
            string {lastPregnancy}
            string {miscarriages}
            string {miscarriagesComments}
            string {hysterectomy}
            string {hysterectomyComments}
            string {thyroidIssues}
            string {thyroidIssuesComments}
            string {babyIdentifyingNumber}
            string {birthWeight}
            string {birthTime}
            string {placeOfBirth}
            string {locationOfSampling}
            string {referringDoctor}
            string {repeatSample}
            string {privatePublicPatient}
            string {prePostTransfusion}
            string {ambiguousGenitalia}
            string {ambiguousGenitaliaComments}
            string {clinicalHistoryOfMother}
            string {motherFullName}
            string {dateOfFirstMilk}
            string {dateOfFirstMilk}
            string {timeOfFirstMilk}
            string {feedingHistory}
            string {familyHistoryCF}
            string {familyHistoryCFComments}
            string {meconiumIleus}
            string {meconiumIleusComments}
            string {donorOrRecipient}
            string {transfusionHistory}
            string {bloodType}
            string {transfusionTransplantHistory}
            string {_:requestId}


          forRows currentMedicationsTable
            sqlPreparedStatement~
              - INSERT IGNORE INTO clinicalInformationDrugs (requestId, type, drugId, eventId)
              - SELECT ?, 'currentMedications', ?, ?
              - FROM dual WHERE ? <> 'true' and ? <> ''
              string {_:requestId}
              string {_columnInput_currentMedicationsTable:3}
              long {_eventId}
              string {_columnInput_currentMedicationsTable:1}
              string {_columnInput_currentMedicationsTable:3}
            sqlPreparedStatement~
              - DELETE FROM clinicalInformationDrugs
              - WHERE requestId = ?
              -   AND type = 'currentMedications'
              -   AND drugId = ?
              -   AND 'true' = ?
              string {_:requestId}
              string {_columnInput_currentMedicationsTable:3}
              string {_columnInput_currentMedicationsTable:1}

          forRows problematicMedicationsTable
            sqlPreparedStatement~
              - INSERT IGNORE INTO clinicalInformationDrugs (requestId, type, drugId, eventId)
              - SELECT ?, 'problematicMedications', ?, ?
              - FROM dual WHERE ? <> 'true' and ? <> ''
              string {_:requestId}
              string {_columnInput_problematicMedicationsTable:3}
              long {_eventId}
              string {_columnInput_problematicMedicationsTable:1}
              string {_columnInput_problematicMedicationsTable:3}
            sqlPreparedStatement~
              - DELETE FROM clinicalInformationDrugs
              - WHERE requestId = ?
              -   AND type = 'problematicMedications'
              -   AND drugId = ?
              -   AND 'true' = ?
              string {_:requestId}
              string {_columnInput_problematicMedicationsTable:3}
              string {_columnInput_problematicMedicationsTable:1}

          forRows drugAllergiesTable
            sqlPreparedStatement~
              - INSERT IGNORE INTO clinicalInformationDrugs (requestId, type, drugId, eventId)
              - SELECT ?, 'drugAllergies', ?, ?
              - FROM dual WHERE ? <> 'true' and ? <> ''
              string {_:requestId}
              string {_columnInput_drugAllergiesTable:3}
              long {_eventId}
              string {_columnInput_drugAllergiesTable:1}
              string {_columnInput_drugAllergiesTable:3}
            sqlPreparedStatement~
              - DELETE FROM clinicalInformationDrugs
              - WHERE requestId = ?
              -   AND type = 'drugAllergies'
              -   AND drugId = ?
              -   AND 'true' = ?
              string {_:requestId}
              string {_columnInput_drugAllergiesTable:3}
              string {_columnInput_drugAllergiesTable:1}


### Probands ###
    includeable orderEntry_proband

      script
        src= js/orderEntry/proband.js


      configurePreparedQuery~
        - SELECT
        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'lastName', fis.screenLabel, NULL) SEPARATOR '<br />') AS 'screenLabel_lastName',

        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'firstName', fis.showField, NULL) SEPARATOR '') AS 'show_firstName',
        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'firstName', fis.screenLabel, NULL) SEPARATOR '<br />') AS 'screenLabel_firstName',

        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'dob', fis.showField, NULL) SEPARATOR '') AS 'show_dob',
        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'dob', fis.screenLabel, NULL) SEPARATOR '<br />') AS 'screenLabel_dob',

        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'mrn', fis.showField, NULL) SEPARATOR '') AS 'show_mrn',
        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'mrn', fis.screenLabel, NULL) SEPARATOR '<br />') AS 'screenLabel_mrn',

        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'geneticGender', fis.showField, NULL) SEPARATOR '') AS 'show_geneticGender',
        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'geneticGender', fis.screenLabel, NULL) SEPARATOR '<br />') AS 'screenLabel_geneticGender',
        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'geneticGender', fis.defaultValue, NULL) SEPARATOR '<br />') AS 'defaultValue_geneticGender'

        - FROM formInputSettings fis
        - INNER JOIN formDefinition fd
        -   ON fd.id = fis.formDefinitionId
        - INNER JOIN formConfigurableParts fp
        -   ON fp.id = fis.formConfigurablePartsId
        - WHERE
        -   fd.formType = 'Accessioning'
        -   AND fd.instance = ?
        -   AND fd.workflow = ?
        string {_:instance}
        string {_:workflow}



      configurePreparedQuery~
        - SELECT
        -   CONCAT('pa.lastName AS "', ?, '" ',
        -           CASE
        -             WHEN ? LIKE '%true%' THEN concat(', pa.firstName AS "', ?, '"')
        -             ELSE ''
        -             END,
        -           CASE
        -             WHEN ? LIKE '%true%' THEN concat(', pa.dob AS "', ?, '"')
        -             ELSE ''
        -             END,
        -           CASE
        -             WHEN ? LIKE '%true%' THEN concat(', GROUP_CONCAT(DISTINCT IF(rf.mrn = '''', null, rf.mrn) SEPARATOR '' , '') AS "', ?, '"')
        -             ELSE ''
        -             END,
        -           CASE
        -             WHEN ? LIKE '%true%' THEN concat(', pa.geneticGender AS "', ?, '"')
        -             ELSE ''
        -             END
        -   ) AS "probandSelectColumns"
        string {_:screenLabel_lastName}
        string {_:show_firstName}
        string {_:screenLabel_firstName}
        string {_:show_dob}
        string {_:screenLabel_dob}
        string {_:show_mrn}
        string {_:screenLabel_mrn}
        string {_:show_geneticGender}
        string {_:screenLabel_geneticGender}

        #'''

      configurePreparedQuery~
        - SELECT
        -   CONCAT(
        -           CASE
        -             WHEN ? LIKE '%true%' THEN 'firstName'
        -             ELSE ''
        -             END, '|',
        -           CASE
        -             WHEN ? LIKE '%true%' THEN 'dob'
        -             ELSE ''
        -             END, '|',
        -           CASE
        -             WHEN ? LIKE '%true%' THEN 'mrn'
        -             ELSE ''
        -             END, '|',
        -           CASE
        -             WHEN ? LIKE '%true%' THEN 'geneticGender'
        -             ELSE ''
        -             END
        -   ) AS "probandVariableColumnOrder"
        string {_:show_firstName}
        string {_:show_dob}
        string {_:show_mrn}
        string {_:show_geneticGender}

      configurePreparedQuery~
        - SELECT
        -   CONCAT(''''',',
        -     CASE
        -       WHEN ? LIKE '%true%' THEN ''''','  ELSE '' END,
        -     CASE
        -       WHEN ? LIKE '%true%' THEN ''''',' ELSE '' END,
        -     CASE
        -       WHEN ? LIKE '%true%' THEN ''''',' ELSE '' END,
        -     CASE
        -       WHEN ? LIKE '%true%' THEN ''''',' ELSE '' END
        -   ) AS "probandSelectColumnsUnion"
        string {_:show_firstName}
        string {_:show_dob}
        string {_:show_mrn}
        string {_:show_geneticGender}

      #''' added ticks to restore syntax highlighting

      hidden probandSelectColumns
        value= {_:probandSelectColumns}
        id= probandSelectColumns

      hidden probandVariableColumnOrder
        value= {_:probandVariableColumnOrder}
        id= probandVariableColumnOrder

      hidden show_firstName
        id= show_firstName
        value= {_:show_firstName}
      hidden show_dob
        id= show_dob
        value= {_:show_dob}
      hidden show_mrn
        id= show_mrn
        value= {_:show_mrn}
      hidden show_geneticGender
        id= show_geneticGender
        value= {_:show_geneticGender}


      ## Proband Search
      div
        id= probandSearchSection
        h3 Proband Search

        simpleTable
          thead
            tr
              th Test
              th !!! {_:screenLabel_lastName}
              th !!! {_:screenLabel_firstName}
                configureIf~ {_:show_firstName}
                  advanced~
                  equals~ true
              th !!! {_:screenLabel_dob}
                configureIf~ {_:show_dob}
                  advanced~
                  equals~ true
              th !!! {_:screenLabel_mrn}
                configureIf~ {_:show_mrn}
                  advanced~
                  equals~ true
              th !!! {_:screenLabel_geneticGender}
                configureIf~ {_:show_geneticGender}
                  advanced~
                  equals~ true
              th Patient Id
          tbody
            tr
              td
                select probandTests
                  id= probandTests
                  class= clearProband probandTestsAvailable
                  option
                  ## if panels table exists and panels are removed the corresponding test options will be removed here by javascript
                  sqlPreparedQuery~ SELECT
                    -   t.name, t.testCode
                    - FROM reqPanels rp
                    - INNER JOIN testPanels tp
                    - ON rp.panelCode = tp.panelCode
                    - INNER JOIN tests t
                    - ON tp.testCode = t.testCode
                    - WHERE rp.requestId = ?
                    string {_:requestId}
              td
                text probandLastName
                  id= probandLastName
                  class= clearProband
              td
                configureIf~ {_:show_firstName}
                  advanced~
                  equals~ true
                text probandFirstName
                  id= probandFirstName
                  class= clearProband
              td
                configureIf~ {_:show_dob}
                  advanced~
                  equals~ true
                date probandDOB
                  convert~ false
                  id= probandDOB
                  class= datePickerDOB clearProband
              td
                configureIf~ {_:show_mrn}
                  advanced~
                  equals~ true
                text probandMRN
                  id= probandMRN
                  class= clearProband
              td
                configureIf~ {_:show_geneticGender}
                  advanced~
                  equals~ true
                select probandGeneticGender
                  id= probandGeneticGender
                  setName~ {_:defaultValue_geneticGender}
                  required~ false
                  class= clearProband
              td
                text probandPatientId
                  id= probandPatientId
                  class= clearProband


        br

        vertical2

          button Search
            id= searchProbandButton

          button Clear Search
            id= clearProbandSearch

        br

        div
          id= probandCandidates
          style= max-height:150px;overflow:scroll;
        div
          id= noResultsMessage
          h4 Your search criteria returned no results.


      h3 Proband

      button Make Patient Proband
        id= makePatientProband

      table
        id= proband
        sqlPreparedQuery~
          - SELECT
          -   '' AS "Delete",
          -   pl.relationship AS "Relationship",
          -   pl.id,
          -   t.name AS "Test",
          -   pr.id,
          -   {_:probandSelectColumns},
          -   pa.patientId AS "Patient Id"
          - FROM probandLinks pl
          - INNER JOIN proband pr
          - ON pl.probandId = pr.Id
          - INNER JOIN patients pa
          - ON pr.patientId = pa.patientId
          - INNER JOIN requestForms rf
          - ON pa.patientId = rf.patientId
          - INNER JOIN tests t
          - ON pr.testCode = t.testCode
          - WHERE pl.patientId = ?
          - GROUP BY pl.id
          - UNION
          - SELECT '','','','','', {_:probandSelectColumnsUnion} ''
          - FROM dual
          - WHERE NOT EXISTS (SELECT 1 FROM probandLinks WHERE patientId = ?)
          string {_:patientId}
          string {_:patientId}
        columnSpecs~ proband
          allowChangedRecordIds
          column 1
            configureIf~ {_:instance}
              advanced~
              not~
                equals~ View
            inputType checkbox
              class= proband_deleteProbandLink
          column 2
            configureIf~ {_:instance}
              advanced~
              not~
                equals~ View
            inputType select
              setName~ Proband Relationship
              title= Proband Relationship
              required~ false
              class= proband_relationship proband_clear
          column 3
            inputType text
              class= proband_clear hideColumn
          column 4
            configureIf~ {_:instance}
              advanced~
              not~
                equals~ View
            inputType select
              class= proband_tests proband_clear probandTestsAvailable
              ## if panels table exists and panels are removed the corresponding test options will be removed here by javascript
              sqlPreparedQuery~ SELECT
                -   t.name, t.testCode
                - FROM reqPanels rp
                - INNER JOIN testPanels tp
                - ON rp.panelCode = tp.panelCode
                - INNER JOIN tests t
                - ON tp.testCode = t.testCode
                - WHERE rp.requestId = ?
                string {_:requestId}
              validate~ SELECT 1
                - FROM dual
                - WHERE (? <> '' AND ? = 'self')
                -  OR ? <> 'self'
                string {_thisInput}
                string {_columnInput:2}
                string {_columnInput:2}
                errorMessage~ Please specify the test for this proband.
          column 5
            inputType text
              class= proband_clear proband_id hideColumn






### Probands SQL ###
    includeable orderEntry_proband_SQL
      forRows proband
        ifCondition {_columnInput_proband:1}
          advanced~
          equals~ false
          ifCondition {_columnInput_proband:2}
            advanced~
            not~
              isBlank~
            ifCondition {_columnInput_proband:5}
              advanced~
              isBlank~
              sqlPreparedStatement~
                - INSERT INTO proband (patientId, testCode, eventId)
                - VALUES (?,?,?)
                string {_:patientId}
                string {_columnInput_proband:4}
                long {_eventId}

              setFormQueryResult
                sqlQuery~ SELECT LAST_INSERT_ID() AS "probandId"

            ifCondition {_columnInput_proband:5}
              advanced~
              not~
                isBlank~

              setFormQueryResult probandId
                value= {_columnInput_proband:5}


            ifCondition {_columnInput_proband:3}
              advanced~
              isBlank~
              sqlPreparedStatement~
                - INSERT INTO probandLinks (probandId, patientId, relationship, eventId)
                - VALUES (?,?,?,?)
                string {_:probandId}
                string {_:patientId}
                string {_columnInput_proband:2}
                long {_eventId}

              else
                sqlPreparedStatement~
                  - UPDATE probandLinks
                  - SET relationship = ?,
                  -     eventId = ?
                  - WHERE id = ?
                  string {_columnInput_proband:2}
                  long {_eventId}
                  int {_columnInput_proband:3}

          # DELETE PROBAND LINK
          else
            sqlPreparedStatement~
              - DELETE FROM probandLinks
              - WHERE id = ?
              int {_columnInput_proband:3}

            ifCondition~ {_columnInput_proband:2}
              advanced~
              equals~ self

              sqlPreparedStatement~
                - DELETE FROM probandLinks
                - WHERE probandId = ?
                int {_columnInput_proband:5}

              sqlPreparedStatement~
                - DELETE FROM proband
                - WHERE id = ?
                int {_columnInput_proband:5}





### File Upload ###
    includeable orderEntry_fileUpload
      script
        src= js/orderEntry/fileUpload.js


      configurePreparedQuery~
        - CALL sp_getFormInputSettings('fileUpload', 'Accessioning', ?)
        int {_:formDefinitionId}

      configurePreparedQuery~
        - SELECT {_:inputSettings}

      div
        id= fileUpload_fileUpload
        simpleTable
          tbody
            tr
              id= fileUpload_requisitionForm
              td !!! {_:screenLabel_fileUpload_requisitionForm}
                class= label
              td
                files fileUpload_requisitionForm
                  destinationFolderName~ ../private/orderEntryFiles/{_eventId}
                  # data-parsley-required= {_:required_fileUpload_requisitionForm}
                  required~ {_:required_fileUpload_requisitionForm}
                  multiple=
                  containerId~ {_eventId}
                  fileType~ Requisition Form
                  screenLabel~

            tr
              id= fileUpload_specimenProcurement

              td !!! {_:screenLabel_fileUpload_specimenProcurement}
                class= label
              td
                files fileUpload_specimenProcurement
                  destinationFolderName~ ../private/orderEntryFiles/{_eventId}
                  # data-parsley-required= {_:required_fileUpload_specimenProcurement}
                  required~ {_:required_fileUpload_specimenProcurement}
                  multiple=
                  containerId~ {_eventId}
                  fileType~ Specimen Procurement
                  screenLabel~

            tr
              id= fileUpload_insuranceInformation
              td !!! {_:screenLabel_fileUpload_insuranceInformation}
                class= label
              td
                files fileUpload_insuranceInformation
                  destinationFolderName~ ../private/orderEntryFiles/{_eventId}
                  # data-parsley-required= {_:required_fileUpload_insuranceInformation}
                  required~ {_:required_fileUpload_insuranceInformation}
                  multiple=
                  containerId~ {_eventId}
                  fileType~ Insurance Information
                  screenLabel~

            tr
              id= fileUpload_emrSummarySheet
              td !!! {_:screenLabel_fileUpload_emrSummarySheet}
                class= label
              td
                files fileUpload_emrSummarySheet
                  destinationFolderName~ ../private/orderEntryFiles/{_eventId}
                  # data-parsley-required= {_:required_fileUpload_emrSummarySheet}
                  required~ {_:required_fileUpload_emrSummarySheet}
                  multiple=
                  containerId~ {_eventId}
                  fileType~ EMR Summary Sheet
                  screenLabel~

            tr
              id= fileUpload_clinicalReport
              td !!! {_:screenLabel_fileUpload_clinicalReport}
                class= label
              td
                files fileUpload_clinicalReport
                  destinationFolderName~ ../private/orderEntryFiles/{_eventId}
                  # data-parsley-required= {_:required_fileUpload_clinicalReport}
                  required~ {_:required_fileUpload_clinicalReport}
                  multiple=
                  containerId~ {_eventId}
                  fileType~ Clinical Report
                  screenLabel~

            tr
              id= fileUpload_other
              td !!! {_:screenLabel_fileUpload_other}
                class= label
              td

                files fileUpload_other
                  destinationFolderName~ ../private/orderEntryFiles/{_eventId}
                  # data-parsley-required= {_:required_fileUpload_other}
                  required~ {_:required_fileUpload_other}
                  multiple=
                  containerId~ {_eventId}
                  fileType~ Other
                  screenLabel~

      div
        id= fileUpload_previousFiles
        h3 Previously Uploaded Files
        configureIf~ {_:instance}
          advanced~
          not~
            equals~ New
        table
          id= fileUpload_previousFilesTable
          sqlPreparedQuery~
            - SELECT '' AS "Remove"
            -   , CONCAT('<a class="existingFiles" href="/uniflow?stepName=DownloadOrderEntryFile&recId=', ?, '/',cf.fileName,'">', cf.fileName,'</a>') AS "File Name"
            -   , cf.fileType AS "Type"
            -   , DATE(e.eventDate) AS "Date"
            -   , cf.containerId AS "Hidden"
            -   , cf.Id AS "Hidden"
            - FROM containerFiles cf
            -   INNER JOIN events e ON cf.eventId = e.eventId
            - WHERE containerId = ?
            - AND cf.Id NOT IN (SELECT cp.value FROM containerProperties cp WHERE cp.property = 'fileDeleted')
            string {_:requestId}
            string {_:requestId}
          columnSpecs~ filesUploaded
            allowChangedRecordIds
            column 1
              inputType checkbox
            column 5
              inputType hidden
                readonly=
                class= hide hideColumn
            column 6
              inputType hidden
                readonly=
                class= hide hideColumn

    includeable orderEntry_fileUpload_SQL
      jython
        import os
        import shutil

        if os.path.exists('{_configPath}private/orderEntryFiles/{_eventId}') :
          filelist = os.listdir('{_configPath}private/orderEntryFiles/{_eventId}')

          if os.path.exists('{_configPath}private/orderEntryFiles/{_:requestId}') != True :
            os.mkdir('{_configPath}private/orderEntryFiles/{_:requestId}')

          for x in filelist:
            src = '{_configPath}private/orderEntryFiles/{_eventId}/' + x
            dest = '{_configPath}private/orderEntryFiles/{_:requestId}/' + x

            shutil.move(src, dest)
          
          filelist = os.listdir('{_configPath}private/orderEntryFiles/{_eventId}')
          if len(filelist) == 0:
            os.rmdir('{_configPath}private/orderEntryFiles/{_eventId}')



      # exec mv {_configPath}private/orderEntryFiles/{_eventId} {_configPath}private/orderEntryFiles/{_:requestId}

      sqlPreparedStatement
        - UPDATE containerFiles
        - SET containerId = ?,
        -     location = ?
        - WHERE containerId = ?
        - AND eventId = ?
        string {_:requestId}
        string ../private/orderEntryFiles/{_:requestId}/
        long {_eventId}
        long {_eventId}

      ifCondition {instance}
        advanced~
        not~
          equals~ New
        forRows filesUploaded
          ifCondition {_columnInput_filesUploaded:1}
            advanced~
            equals~ true
            sqlPreparedStatement~
              - INSERT INTO containerProperties (containerId, property, value, eventId)
              - VALUES (?, ?, ?, ?)
              string {_columnInput_filesUploaded:5}
              string fileDeleted
              string {_columnInput_filesUploaded:6}
              long {_eventId}

### Test Selection and Specimen Information ###

    includeable orderEntry_panels

      script
        src= js/orderEntry/testSelection.js

      configurePreparedQuery~
        - SELECT
        -   CASE ?
        -     WHEN 'Edit' THEN 'false'
        -     WHEN 'View' THEN 'false'
        -     WHEN 'QC' THEN CASE WHEN ? = 'Specimen Receiving'  THEN 'false' ELSE 'true' END
        -     ELSE 'true'
        -   END AS "allowChangePanel"
        string {_:instance}
        string {_step}

      configurePreparedQuery~
        - SELECT
        -   CASE
        ### leave in this order so that QC will not stop list in specimen receiving
        -     WHEN ? = 'Specimen Receiving' THEN 'true'
        -     WHEN ? = 'QC' THEN fis.showField
        -     ELSE 'false'
        -   END as "receiveSamples"
        - FROM formConfigurableParts fcp
        - INNER JOIN formInputSettings fis
        - ON fcp.id = fis.formConfigurablePartsId
        - INNER JOIN formDefinition fd ON fis.formDefinitionId = fd.Id
        - WHERE fcp.formType = 'Receiving'
        - AND fcp.inputName = 'receiveAtOrderReview'
        - AND fd.workflow = ?
        string {_step}
        string {_:instance}
        string {_:workflow}

      hidden allowChangePanel
        value= {_:allowChangePanel}


      fieldSet
        legend Panel Selection

        table
          id= panels
          class= required
          caption Panels
          sqlPreparedQuery~
            - SELECT
            -   CASE ISNULL(rp.panelCode)
            -     WHEN 1 THEN 'false'
            -     ELSE 'true'
            -   END AS "Select",
            -   p.name AS "Panel Name",
            -   p.panelCode AS "Panel Code",
            -   GROUP_CONCAT(t.name ORDER BY t.name SEPARATOR ', ') AS "Test(s) in Panel",
            -   GROUP_CONCAT(concat(t.testCode, '^',t.abbreviation)  SEPARATOR '|') AS "testCodes"
            - FROM panels p
            - INNER JOIN testPanels tp
            - ON p.panelCode = tp.panelCode
            - INNER JOIN tests t
            - ON tp.testCode = t.testCode
            - AND t.disabled = 0
            - LEFT JOIN reqPanels rp
            - ON p.panelCode = rp.panelCode
            -   AND rp.requestId = ?
            - WHERE p.type = ?
            - AND p.disabled = 0
            - GROUP BY p.panelCode
            - ORDER BY p.name
            string {_includeParm:request}
            string {_includeParm:workflow}
          columnSpecs~ panels
            allowChangedRecordIds
            column 1
              inputType checkbox
                class= panels_selectPanel
                data-parsley-multiple= panelSelectValidate
                data-parsley-mincheck= 1
                data-parsley-required= true
                data-parsley-error-message= Please select at least 1 panel.
                data-parsley-errors-container= #needOnePanelMessage
                disabled= true
                  configureIf~ {_:allowChangePanel}
                    advanced~
                    equals~ false
            column 3
              inputType text
                readonly=
                class= hideColumn panels_panelCode
            column 5
              inputType text
                readonly=
                class=  hideColumn panels_testCodesInPanel

        br

        div
          id= needOnePanelMessage

        br

        button clearSelectedPanels
          value= Clear Panel Selection
          id= panels_clear
          configureIf~ {_:allowChangePanel}
            advanced~
            equals~ true

        br
  
        fieldSet
          legend Test(s) needing assignment:
          configureIf~ {_:receiveSamples}
            advanced~
            equals~ true
          div
            id= specimenInfo_TestsToBeAssigned
          div
            id= noPanelsSelectedMessage
            h3 No panels have been selected for this order yet.
          div
            id= allTestsHaveBeenAssignedMessage
            h3 All tests have been assigned

        br

    includeable orderEntry_panels_SQL
      ### PROCESS PANEL SELECTION
      ifCondition~ {allowChangePanel}
        advanced~
        equals~ true
        forRows panels
          ifCondition {_columnInput_panels:1}
            advanced~
            equals~ true
            sqlPreparedStatement~
              - INSERT IGNORE INTO reqPanels (requestId, panelCode, eventId)
              - VALUES (?, ?, ?)
              string {_:requestId}
              string {_columnInput_panels:3}
              long {_eventId}
            else
              sqlPreparedStatement~
                - DELETE FROM reqPanels
                - WHERE requestId = ?
                - AND panelCode = ?
                string {_:requestId}
                string {_columnInput_panels:3}


      validateSql~ SELECT 1
        - FROM dual
        - WHERE EXISTS ( SELECT 1
        -         FROM reqPanels
        -         WHERE requestId = ?
        -         AND ? <> 'New'
        -         AND (? = 'Approved' OR ? = 'null'))
        - OR ? = 'New'
        string {_:requestId}
        string {instance}
        string {action}
        string {action}
        string {instance}
        errorMessage You must select at least one panel per order.

    includeable orderEntry_createReports

      ### CREATE REPORTS
      forEach SELECT DISTINCT rdv.id AS "reportDefinitionVersionId"
        - FROM reportDefinitionPanels rdp
        - INNER JOIN reportDefinitionVersion rdv
        -   ON rdp.reportDefinitionVersionId = rdv.id
        - INNER JOIN reqPanels rp
        -   ON rdp.panelCode = rp.panelCode
        - WHERE rdv.active = 1
        -   AND rp.requestId = ?
        string {_:requestId}


        ifCondition
          advanced~
          not~
            sqlPreparedQuery~ SELECT 1
              - FROM reportDetails rd
              - INNER JOIN requestForms rf ON rd.requestFormsId = rf.id
              - WHERE rf.requestId = ?
              - AND rd.reportDefinitionVersionId = ?
              string {_:requestId}
              string {_:reportDefinitionVersionId}

          setFormQueryResult
            sqlQuery~ CALL sp_getNextSequence('reportId','reportId')

          setFormQueryResult
            sqlPreparedQuery~ SELECT id AS "requestFormsId" FROM requestForms WHERE requestId = ?
              string {_:requestId}

          sqlPreparedStatement  CALL sp_createContainer(?, 'reportId', null, null, null, null, null, ?, null, null, null, 0)
            string {_:reportId}
            long {_eventId}

          sqlPreparedStatement
            - INSERT INTO reportDetails (reportId, requestFormsId, reportDefinitionVersionId, eventId, reportType, status, statusEventId)
            - VALUES (?, ?, ?, ?, ?, ?, ?)
            string {_:reportId}
            int {_:requestFormsId}
            int {_:reportDefinitionVersionId}
            long {_eventId}
            string new
            string created
            long {_eventId}

          setFormQueryResult
            sqlQuery~ SELECT LAST_INSERT_ID() AS 'reportDetailsId'

          ifCondition
            advanced~
            not~
              sqlPreparedQuery~ SELECT 1
                - FROM queues
                - WHERE step = 'Report Data Pending'
                - AND containerId = ?
                string {_:reportId}

            sqlPreparedStatement
              - INSERT INTO queues (containerId, step, eventId)
              - VALUES (?, 'Report Data Pending', ?)
              string {_:reportId}
              long {_eventId}


          forEach SELECT rs.id AS "requestSpecimensId", sm.id AS "specimenMethodsId"
            - FROM reportDefinitionPanels rdp
            - INNER JOIN specimenMethods sm
            -    ON rdp.panelCode = sm.panelCode
            - INNER JOIN requestSpecimens rs
            -   ON sm.requestSpecimensId = rs.id
            -   AND rs.requestId = sm.requestId
            - WHERE rdp.reportDefinitionVersionId = ?
            -   AND sm.requestId = ?
            int {_:reportDefinitionVersionId}
            string {_:requestId}

            sqlPreparedStatement
              - INSERT INTO reportSpecimens (reportDetailsId, requestSpecimensId, specimenMethodsId, eventId)
              - VALUES (?, ?, ?, ?)
              int {_:reportDetailsId}
              int {_:requestSpecimensId}
              int {_:specimenMethodsId}
              long {_eventId}







    includeable orderEntry_specimenInfo

      script
        src= js/orderEntry/specimenInfo.js


      configurePreparedQuery~ select id as "receivingFormDefinitionId"
        - from formDefinition
        - where workflow = ?
        - and formType = 'Accessioning'
        - and instance = 'Receiving'
        string {_includeParm:workflow}

      configurePreparedQuery~
        - CALL sp_getFormInputSettings('specimenInfo', 'Accessioning', ?)
        int {_:formDefinitionId}

      configurePreparedQuery~
        - SELECT {_:inputSettings}

      configurePreparedQuery~
        - SELECT
        -   CASE ?
        -     WHEN '' THEN 1
        -     ELSE ?
        -   END AS "specimenOrderMax"
        string {_:defaultValue_specimenOrderMax}
        string {_:defaultValue_specimenOrderMax}

      formPreparedQuery~
        - SELECT COUNT(id) as "exisitngSamples"
        - FROM requestSpecimens
        - WHERE requestId = ?
        string {_:requestId}


      configurePreparedQuery~
        - CALL sp_getFormInputSettings('specimenInfo', 'Receiving', ?)
        int {_:receivingFormDefinitionId}
      configurePreparedQuery~
        - SELECT {_:inputSettings}


      configurePreparedQuery~
        - SELECT
        -   CASE ?
        -     WHEN 'QC' THEN ?
        -     WHEN 'View' THEN ?
        -     WHEN 'Edit' THEN ?
        -     WHEN 'Receiving' THEN 'true'
        -     ELSE 'false'
        -   END AS "receiveAtQC"
        string {_:instance}
        string {_:showField_receiveAtOrderReview}
        string {_:showField_receiveAtOrderReview}
        string {_:showField_receiveAtOrderReview}

      configurePreparedQuery~
        - SELECT
        -   CASE ?
        -     WHEN 'Specimen Receiving' THEN 'true'
        -     ELSE ?
        -   END AS "receiveAtQC"
        string {_step}
        string {_:receiveAtQC}

      configurePreparedQuery~
        - SELECT 'true' AS "isReceiving"
        - FROM dual
        - WHERE ? = 'Specimen Receiving'
        - OR (? = 'QC' AND ? = 'true')
        - UNION
        - SELECT 'false'
        string {_step}
        string {_:instance}
        string {_:receiveAtQC}

      hidden receiveAtQC
        id= receiveAtQC
        value= {_:receiveAtQC}

      hidden printBarcodesButton
        id= printBarcodesButton
        value= {_:showField_printBarcodesButton}

      hidden isReceiving
        value= {_:isReceiving}
        id= isReceiving

      printerControls
        configureIf~ {_:showField_printBarcodesButton}
          advanced~
          equals~ true
        defaultPrinter~
        defaultDocument~
        variables~

      fieldSet
        configureIf~ {_:addNewTest}
          advanced~
          equals~ true
        legend Previously Received Specimen
        id= specimenInfo_previouslyReceivedAddTest

        include orderEntry_specimensTablesAddTest
          parameter~ received
            value= NO
          parameter~ tableId
            value= specimenInfoTable_RecievedAddTest
          parameter~ columnSpecsName
            value= specimenInfoInputTableReceived
          parameter~ requestId
            value= {_includeParm:request}

      fieldSet
        configureIf~ {_:addNewTest}
          advanced~
          not~
            equals~ true
        legend Previously Received Specimen
        id= specimenInfo_previouslyReceived


        include orderEntry_specimensTables
          parameter~ received
            value= YES
          parameter~ tableId
            value= specimenInfoTable_Recieved
          parameter~ columnSpecsName
            value= specimenInfoInputTableReceived
          parameter~ requestId
            value= {_includeParm:request}


      fieldSet
        legend Enter New Specimen Information
        id= specimenInfo_EnterSamples

        include orderEntry_specimensTables
          parameter~ received
            value= NO
          parameter~ tableId
            value= specimenInfoTable
          parameter~ columnSpecsName
            value= specimenInfoInputTable
          parameter~ requestId
            value= {_includeParm:request}

    includeable orderEntry_specimensTables

      table
        id= {_includeParm:tableId}
        sqlPreparedQuery~
          - SELECT * FROM (
          - SELECT
          -   CONCAT(IFNULL(pa.firstName, ''), ' ', IFNULL(pa.lastName, '')) AS "Patient Name",
          -   IFNULL(rf.mrn, '') AS "MRN",
          -   IFNULL(DATE(pa.dob), '') AS "DOB",
          -   rs.expectedBarcode as ?,
          -   rs.externalIdentifier as ?,
          -   rs.specimenSource as ?,
          -   rs.specimenType as ?,
          -   rs.sampleContainerCategory as ?,
          -   CASE rs.collectionDate WHEN '' THEN ? ELSE rs.collectionDate END as ?,
          -   rs.collectionTime as ?,
          -   rs.specimenId as ?,
          -   IFNULL(rs.receivedDate, '') as ?,
          -   CASE WHEN rs.receivedDate <> '' AND rs.receivedTime <> '' THEN rs.receivedTime ELSE '' END as ?,
          -   CASE ?
          -     WHEN 'YES' THEN CONCAT(sm.panelCode, '|', sm.panelName)
          -     ELSE ''
          -   END as "Panel(s)",
          -   CASE ?
          -     WHEN 'YES' THEN CONCAT(sm.testCode, '|',sm.testName)
          -     ELSE ''
          -   END as ?,
          -   CASE ?
          -     WHEN 'YES' THEN CONCAT(sm.methodCode, '|',sm.methodName)
          -     ELSE ''
          -   END as ?,
          -   rs.specimenQuantity AS ?,
          -   rs.specimenQuantityUnits AS ?,
          -   CASE ?
          -     WHEN 'YES' THEN rs.specimenCondition
          -     ELSE ''
          -   END as ?,
          -   cn.note AS ?,
          -   rs.id as "reqSpecimensId",
          -   CASE ?
          -     WHEN 'YES' THEN sm.id
          -     ELSE ''
          -   END as "specimenAddTestReference",
          -   0 as "AddTest",
          -   IFNULL(pa.firstName, '') AS "Patient First Name",
          -   IFNULL(pa.lastName, '') AS "Patient Last Name",
          -   rf.requestId AS "Request Id"
          - FROM requestSpecimens rs
          -   INNER JOIN requestForms rf
          -     ON rs.requestId = rf.requestId
          -   LEFT JOIN patients pa
          -     ON pa.patientId = rf.patientId
          -   LEFT JOIN containerNotes cn
          -     ON rs.specimenId = cn.containerId
          -     AND cn.noteType = 'Specimen Receiving Comment'
          -   LEFT JOIN
          -     (SELECT sm.requestSpecimensId, sm.id, sm.panelCode, sm.testCode, sm.methodCode,
          -             p.abbreviation as "panelName",
          -             t.abbreviation as "testName",
          -             m.name as "methodName"
          -      FROM specimenMethods sm
          -      LEFT JOIN panels p
          -       ON sm.panelCode = p.panelCode
          -      LEFT JOIN tests t
          -       ON sm.testCode = t.testCode
          -      LEFT JOIN methods m
          -       ON sm.methodCode = m.methodCode) sm
          -     ON rs.id = sm.requestSpecimensId
          - WHERE   rs.requestId = ?
          -   AND CASE ?
          -         WHEN 'YES' THEN ifnull(rs.specimenId,'') <> ''
          -         ELSE ifnull(rs.specimenId,'') = ''
          -       END
          -   AND CASE ?
          -         WHEN 'YES' THEN rs.status <> 'ORDER ENTERED'
          -         ELSE rs.status = 'ORDER ENTERED'
          -       END
          -   ORDER BY rs.id) s
          - UNION ALL
          - SELECT CONCAT(IFNULL(pa.firstName, ''), ' ', IFNULL(pa.lastName, '')) AS "Patient Name",IFNULL(rf.mrn, ''),IFNULL(DATE(pa.dob), '') AS "DOB",'','','','','','','','','','','','','','','', '', '', '0', '', '0', IFNULL(pa.firstName, '') AS "Patient First Name", IFNULL(pa.lastName, '') AS "Patient Last Name", rf.requestId AS "Request Id"
          -   FROM  numbers,requestForms rf
          -   LEFT JOIN patients pa
          -     ON pa.patientId = rf.patientId
          -   WHERE no <= CASE ?
          -                 WHEN 'YES' THEN 0
          -                 ELSE ? - ?
          -               END
          -   AND rf.requestId = ?
          string {_:screenLabel_expectedBarcode}
          string {_:screenLabel_externalIdentifier}
          string {_:screenLabel_specimenSource}
          string {_:screenLabel_specimenType}
          string {_:screenLabel_containerType}
          string {_:today}
          string {_:screenLabel_collectionDate}
          string {_:screenLabel_collectionTime}
          string {_:screenLabel_specimenId}
          string {_:screenLabel_receivedDate}
          string {_:screenLabel_receivedTime}
          string {_includeParm:received}
          string {_includeParm:received}
          string {_:screenLabel_tests}
          string {_includeParm:received}
          string {_:screenLabel_method}
          string {_:screenLabel_specimenQuantity}
          string {_:screenLabel_specimenUnits}
          string {_includeParm:received}
          string {_:screenLabel_specimenCondition}
          string {_:screenLabel_specimenComments}
          string {_includeParm:received}
          string {_includeParm:requestId}
          string {_includeParm:received}
          string {_includeParm:received}
          string {_includeParm:received}
          long {_:specimenOrderMax}
          long {_:exisitngSamples}
          string {_includeParm:requestId}

        columnSpecs~ {_includeParm:columnSpecsName}
          allowChangedRecordIds
          column 1
            inputType text
              readonly=
              class= hiddenColumn
          column 2
            inputType text
              readonly=
              class= hiddenColumn
          column 3
            inputType text
              readonly=
              class= hiddenColumn
          column 4
            inputType text
              class= specimenInfo_expectedBarcode specimenEntry
              #required~ {_:required_expectedBarcode}
              data-parsley-required= {_:required_expectedBarcode}
              readonly= true
                configureIf~ {_:readOnly_expectedBarcode}
                  advanced~
                  equals~ true

          column 5
            inputType text
              class= specimenInfo_externalIdentifier specimenEntry
              #required~ {_:required_externalIdentifier}
              data-parsley-required= {_:required_externalIdentifier}
              readonly= true
                configureIf~ {_:readOnly_externalIdentifier}
                  advanced~
                  equals~ true

          column 6
            inputType select
              setName~ {_:defaultValue_specimenSource}
              class= specimenInfo_specimenSource specimenEntry
              required~ false
              data-parsley-required= {_:required_specimenSource}
              disabled= true
                configureIf~ {_:readOnly_specimenSource}
                  advanced~
                  equals~ true

          column 7
            inputType select
              setName~ {_:defaultValue_specimenType}
              class= specimenInfo_specimenType specimenEntry
              required~ false
              data-parsley-required= {_:required_specimenType}
              disabled= true
                configureIf~ {_:readOnly_specimenType}
                  advanced~
                  equals~ true

          column 8
            inputType select
              setName~ {_:defaultValue_containerType}
              class= specimenInfo_containerType specimenEntry
              required~ false
              data-parsley-required= {_:required_containerType}
              disabled= true
                configureIf~ {_:readOnly_containerType}
                  advanced~
                  equals~ true

          column 9
            inputType date
              convert~ false
              format~ {_dateShortFormat}
              class= specimenInfo_collectionDate specimenEntry
                configureIf~ {_:readOnly_collectionDate}
                  advanced~
                  equals~ true
              class= datePicker specimenInfo_collectionDate specimenEntry
                configureIf~ {_:readOnly_collectionDate}
                  advanced~
                  equals~ false
              size= 11
              #required~ {_:required_collectionDate}
              data-parsley-required= {_:required_collectionDate}
              readonly= true
                configureIf~ {_:readOnly_collectionDate}
                  advanced~
                  equals~ true

          column 10
            inputType time
              format~ HH:mm
              class= specimenInfo_collectionTime specimenEntry
                configureIf~ {_:readOnly_collectionTime}
                  advanced~
                  equals~ true
              class= timePicker specimenInfo_collectionTime specimenEntry
                configureIf~ {_:readOnly_collectionTime}
                  advanced~
                  equals~ false
              size= 6
              #required~ {_:required_collectionTime}
              data-parsley-required= {_:required_collectionTime}
              readonly= true
                configureIf~ {_:readOnly_collectionTime}
                  advanced~
                  equals~ true

          column 11
            configureIf~ {_includeParm:received}
              advanced~
              equals~ NO
              and~ {_:instance}
                not~
                  equals~ View
            inputType container
              class= specimenInfo_specimenId sampleReceiving barcodeBackground
              required~ false
              validate~ SELECT 1
                - FROM DUAL
                - WHERE ((? <> '' OR ? <> '' OR ? <> '' OR ? <> '' OR ? <> '') AND (? <> '' OR ? <> ''))
                - OR (? = '' AND ? = '' AND ? = '' AND ? = '' AND ? = '')
                - OR {isReceiving} = 'false'
                string {_columnInput:4}
                string {_columnInput:5}
                string {_columnInput:7}
                string {_columnInput:9}
                string {_columnInput:10}
                string {_thisInput}
                string {_columnInput:21}
                string {_columnInput:4}
                string {_columnInput:5}
                string {_columnInput:7}
                string {_columnInput:9}
                string {_columnInput:10}
                errorMessage~ Specimen receipt is required.
                configureIf~ {_:required_specimenId}
                  advanced~
                  equals~ true
              containerType~ specimenId
              new~ true

          column 11
            configureIf~ {_includeParm:received}
              advanced~
              equals~ YES
              and~ {_:instance}
                not~
                  equals~ View
            inputType container
              class= specimenInfo_specimenId sampleReceiving barcodeBackground
              required~ false
              addContent~
              readonly= true
              containerType~ specimenId
              recordContainerHistory~ false
              acceptQueue~ any

          column 12
            configureIf~ {_:instance}
              advanced~
              equals~ View
            inputType date
              convert~ false
              format~ {_dateShortFormat}
              readonly= true

          column 12
            configureIf~ {_:instance}
              advanced~
              not~
                equals~ View
            inputType date
              convert~ false
              format~ {_dateShortFormat}
              class= datePicker specimenInfo_receivedDate sampleReceiving
                configureIf~ {_:readOnly_receivedDate}
                  advanced~
                  equals~ false
              class= specimenInfo_receivedDate sampleReceiving
                configureIf~ {_:readOnly_receivedDate}
                  advanced~
                  equals~ true
              validate~ SELECT 1
                - FROM dual
                - WHERE (? <> '' and ? <> '')
                - OR ? = ''
                string {_thisInput}
                string {_columnInput:11}
                string {_columnInput:11}
                errorMessage~ The received date cannot be blank when receiving a specimen.
                configureIf~ {_:required_receivedDate}
                  advanced~
                  equals~ true
              readonly= true
                configureIf~ {_:readOnly_receivedDate}
                  advanced~
                  equals~ true

          column 13
            configureIf~ {_:instance}
              advanced~
              equals~ View
            inputType time
              format~ HH:mm
              readonly= true
          column 13
            configureIf~ {_:instance}
              advanced~
              not~
                equals~ View
            inputType time
              format~ HH:mm
              class= timePicker specimenInfo_receivedTime sampleReceiving
              validate~ SELECT 1
                - FROM dual
                - WHERE (? <> '' and ? <> '')
                - OR ? = ''
                string {_thisInput}
                string {_columnInput:11}
                string {_columnInput:11}
                errorMessage~ The received time cannot be blank when receiving a specimen.
                configureIf~ {_:required_receivedTime}
                  advanced~
                  equals~ true
              size= 6
              readonly= true
                configureIf~ {_:readOnly_receivedTime}
                  advanced~
                  equals~ true
          column 14
            configureIf~ {_includeParm:received}
              advanced~
              equals~ NO
              and~ {_:instance}
                not~
                  equals~ View
            inputType select
              class= specimenInfo_panelSelection sampleReceiving
              sqlPreparedQuery~
                - SELECT p.abbreviation, p.panelCode
                - FROM reqPanels rp
                - INNER JOIN panels p
                - ON rp.panelCode = p.panelCode
                - WHERE rp.requestId = ?
                string {requestId}
              required~ false

          column 14
            configureIf~ {_includeParm:received}
              advanced~
              equals~ YES
            inputType text
              class= lockReceived specimenInfo_panelSelection sampleReceiving

          column 15
            configureIf~ {_includeParm:received}
              advanced~
              equals~ NO
              and ~ {_:instance}
                not~
                  equals~ View
            inputType select
              class= specimenInfo_testSelection sampleReceiving
              # setName~ preTestOptions
              required~ false

          column 15
            configureIf~ {_includeParm:received}
              advanced~
              equals~ YES
            inputType text
              class= lockReceived specimenInfo_testSelection sampleReceiving

          column 16
            configureIf~ {_includeParm:received}
              advanced~
              equals~ NO
              and~ {_:instance}
                not~
                  equals~ View
            inputType select
              class= specimenInfo_testMethod sampleReceiving

          column 16
            configureIf~ {_includeParm:received}
              advanced~
              equals~ YES
            inputType text
              class= lockReceived specimenInfo_testMethod sampleReceiving


          column 17
            configureIf~ {_:instance}
              advanced~
              not~
                equals~ View
            inputType text
              class= specimenInfo_specimenQuantity sampleReceiving
              data-parsley-validation-threshold= 1
              data-parsley-trigger= change
              data-parsley-type= number
              validate~ SELECT 1
                - FROM dual
                - WHERE (? <> '' and ? <> '' and ? = 0)
                - OR ? = ''
                - OR ? = 1
                string {_thisInput}
                string {_columnInput:11}
                long {_columnInput:23}
                string {_columnInput:11}
                long {_columnInput:23}
                errorMessage~ You must enter the specimen quantity if a specimen is being received.
                configureIf~ {_:required_specimenQuantity}
                  advanced~
                  equals~ true
              readonly= true
                configureIf~ {_:readOnly_specimenQuantity}
                  advanced~
                  equals~ true

          column 18
            configureIf~ {_:instance}
              advanced~
              not~
                equals~ View
            inputType select
              class= specimenInfo_specimenUnits sampleReceiving
              setName~ {_:defaultValue_specimenUnits}
              required~ false
              validate~ SELECT 1
                - FROM dual
                - WHERE (? <> '' and ? <> '')
                - OR ? = ''
                string {_thisInput}
                string {_columnInput:17}
                string {_columnInput:17}
                errorMessage~ You must enter units if specifying specimen quantity.
                configureIf~ {_:required_specimenUnits}
                  advanced~
                  equals~ true
              readonly= true
                configureIf~ {_:readOnly_specimenUnits}
                  advanced~
                  equals~ true

          column 19
            configureIf~ {_includeParm:received}
              advanced~
              equals~ NO
              and~ {_:instance}
                not~
                  equals~ View
            inputType select
              class= specimenInfo_specimenCondition sampleReceiving
              setName~ {_:defaultValue_specimenCondition}
              required~ false
              validate~ SELECT 1
                - FROM dual
                - WHERE (? <> '' and ? <> '')
                - OR ? = ''
                string {_thisInput}
                string {_columnInput:11}
                string {_columnInput:11}
                errorMessage~ You must enter the specimen condition if a specimen is being received.
                configureIf~ {_:required_specimenCondition}
                  advanced~
                  equals~ true
              readonly= true
                configureIf~ {_:readOnly_specimenCondition}
                  advanced~
                  equals~ true

          column 19
            configureIf~ {_includeParm:received}
              advanced~
              equals~ YES
              and~ {_:instance}
                not~
                  equals~ View
            inputType text
              class= specimenInfo_specimenCondition sampleReceiving
              required~ false
              readonly= true

          column 20
            configureIf~ {_includeParm:received}
              advanced~
              equals~ NO
              and~ {_:instance}
                not~
                  equals~ View
            inputType textArea
              class= specimenInfo_specimenComments sampleReceiving
              validate~ SELECT 1
                - FROM dual
                - WHERE (? <> '' and ? <> 'Acceptable')
                - OR ? = 'Acceptable'
                - OR ? = ''
                string {_thisInput}
                string {_columnInput:19}
                string {_columnInput:19}
                string {_columnInput:11}
                errorMessage~ You must enter a comment if the specimen condition is unacceptable.
                configureIf~ {_:required_specimenComments}
                  advanced~
                  equals~ true
              readonly= true
                configureIf~ {_:readOnly_specimenComments}
                  advanced~
                  equals~ true

          column 21
            inputType text
              class= hideColumn specimenInfo_requestSpecimensId
          column 22
            inputType text
              class= specimenInfo_specimenIdReference hideColumn
          column 23
            inputType text
              class= specimenInfo_IsAddTest hideColumn
          column 24
            inputType text
              readonly=
              class= hideColumn
          column 25
            inputType text
              readonly=
              class= hideColumn
          column 26
            inputType text
              readonly=
              class= hideColumn


    includeable orderEntry_specimensTablesAddTest

      table
        id= {_includeParm:tableId}
        sqlPreparedQuery~
          - SELECT * FROM (
          - SELECT
          -   CONCAT(IFNULL(pa.firstName, ''), ' ', IFNULL(pa.lastName, '')) AS "Patient Name",
          -   IFNULL(rf.mrn, '') AS "MRN",
          -   IFNULL(DATE(pa.dob), '') AS "DOB",
          -   rs.expectedBarcode AS ?,
          -   rs.externalIdentifier AS ?,
          -   rs.specimenSource AS ?,
          -   rs.specimenType AS ?,
          -   rs.sampleContainerCategory AS ?,
          -   CASE rs.collectionDate WHEN '' THEN ? ELSE rs.collectionDate END AS ?,
          -   rs.collectionTime AS ?,
          -   rs.specimenId AS ?,
          -   rs.receivedDate AS ?,
          -   rs.receivedTime AS ?,
          -   '' AS "Panel(s)",
          -   '' AS ?,
          -   '' AS ?,
          -   rs.specimenQuantity AS ?,
          -   rs.specimenQuantityUnits AS ?,
          -   rs.specimenCondition AS ?,
          -   cn.note AS ?,
          -   rs.id AS "reqSpecimensId",
          -   '' AS "specimenAddTestReference",
          -   0 AS "AddTest"
          - FROM requestSpecimens rs
          -   INNER JOIN requestForms rf
          -     ON rs.requestId = rf.requestId
          -   LEFT JOIN patients pa
          -     ON pa.patientId = rf.patientId
          -   LEFT JOIN containerNotes cn
          -     ON rs.specimenId = cn.containerId
          -     AND cn.noteType = 'Specimen Receiving Comment'
          -   LEFT JOIN
          -     (SELECT sm.requestSpecimensId, sm.id, sm.panelCode, sm.testCode, sm.methodCode,
          -             p.abbreviation as "panelName",
          -             t.abbreviation as "testName",
          -             m.name as "methodName"
          -      FROM specimenMethods sm
          -      LEFT JOIN panels p
          -       ON sm.panelCode = p.panelCode
          -      LEFT JOIN tests t
          -       ON sm.testCode = t.testCode
          -      LEFT JOIN methods m
          -       ON sm.methodCode = m.methodCode) sm
          -     ON rs.id = sm.requestSpecimensId
          - WHERE   rs.requestId = ?
          -   AND rs.specimenId = ?
          -   AND CASE ?
          -         WHEN 'NO' THEN ifnull(rs.specimenId,'') <> ''
          -         ELSE ifnull(rs.specimenId,'') = ''
          -       END
          -   AND CASE ?
          -         WHEN 'NO' THEN rs.status <> 'ORDER ENTERED'
          -         ELSE rs.status = 'ORDER ENTERED'
          -       END
          -   ORDER BY rs.id) s
          string {_:screenLabel_expectedBarcode}
          string {_:screenLabel_externalIdentifier}
          string {_:screenLabel_specimenSource}
          string {_:screenLabel_specimenType}
          string {_:screenLabel_containerType}
          string {_:today}
          string {_:screenLabel_collectionDate}
          string {_:screenLabel_collectionTime}
          string {_:screenLabel_specimenId}
          string {_:screenLabel_receivedDate}
          string {_:screenLabel_receivedTime}
          string {_:screenLabel_tests}
          string {_:screenLabel_method}
          string {_:screenLabel_specimenQuantity}
          string {_:screenLabel_specimenUnits}
          string {_:screenLabel_specimenCondition}
          string {_:screenLabel_specimenComments}
          string {_includeParm:requestId}
          string {_:addNewTestSpecimen}
          string {_includeParm:received}
          string {_includeParm:received}
        columnSpecs~ {_includeParm:columnSpecsName}
          allowChangedRecordIds
          column 1
            inputType text
              class= hideColumn
          column 2
            inputType text
              class= hideColumn
          column 3
            inputType text
              class= hideColumn
          column 4
            inputType text
              class= sampleReceiving
              readonly=

          column 5
            inputType text
              class= sampleReceiving
              readonly=

          column 6
            inputType text
              class= sampleReceiving
              readonly=

          column 7
            inputType text
              class= sampleReceiving
              readonly=

          column 8
            inputType text
              class= sampleReceiving
              readonly=

          column 9
            inputType date
              format~ {_dateShortFormat}
              class= specimenInfo_collectionDate specimenEntry
              readonly=

          column 10
            inputType time
              format~ HH:mm
              class= sampleReceiving
              size= 6
              readonly=

          column 11
            inputType container
              class= specimenInfo_specimenId sampleReceiving barcodeBackground
              required~ false
              addContent~
              readonly=
              containerType~ specimenId
              recordContainerHistory~ false
              acceptQueue~ any

          column 12
            inputType date
              format~ {_dateShortFormat}
              class= sampleReceiving
              readonly=

          column 13
            inputType time
              class= sampleReceiving
              size= 6
              readonly=

          column 14
            inputType select
              class= specimenInfo_panelSelection sampleReceiving hideReceiveDetails
              sqlPreparedQuery~
                - SELECT p.abbreviation, p.panelCode
                - FROM reqPanels rp
                - INNER JOIN panels p
                - ON rp.panelCode = p.panelCode
                - WHERE rp.requestId = ?
                string {requestId}
              required~ false

          column 15
            inputType select
              class= specimenInfo_testSelection sampleReceiving hideReceiveDetails
              # setName~ preTestOptions
              required~ false

          column 16
            inputType select
              class= specimenInfo_testMethod sampleReceiving hideReceiveDetails

          column 17
            inputType text
              class= sampleReceiving hideReceiveDetails
              readonly=

          column 18
            inputType text
              class= sampleReceiving hideReceiveDetails
              readonly=

          column 19
            inputType text
              class= sampleReceiving hideReceiveDetails
              readonly=

          column 20
            inputType textArea
              class= sampleReceiving
              readonly=

          column 21
            inputType text
              class= hideColumn
          column 22
            inputType text
              class= hideColumn
          column 23
            inputType text
              class= hideColumn



    includeable orderEntry_receivedSpecimens_SQL
      ## Process information updates for previously received specimen.
      ## Changes to specimenId are not allowed.
      ## Changes to receiving condition or receiving comments are not allowed.
      #

      ifCondition {receiveAtQC}
        advanced~
        equals~ true
        or~ {_:instance}
          equals~ Edit


        forRows specimenInfoInputTableReceived

          jython
            switchboard.log('>>>> UPDATE SPECIMEN INFO FOR RECEIVED SPECIMEN: {_columnInput_specimenInfoInputTableReceived:11}')

          ifCondition {_columnInput_specimenInfoInputTableReceived:23}
            advanced~
            equals~ 0

            sqlPreparedStatement
              - UPDATE   requestSpecimens
              -   SET    patientId = ?,
              -             expectedBarcode = ?,
              -             externalIdentifier = ?,
              -             specimenType = ?,
              -             specimenSource = ?,
              -             collectionDate = CASE ? WHEN '' THEN NULL ELSE ? END,
              -             collectionTime = CASE ? WHEN '' THEN NULL ELSE ? END,
              -             receivedDate = CASE ? WHEN '' THEN NULL ELSE ? END,
              -             receivedTime = CASE ? WHEN '' THEN NULL ELSE ? END,
              -             specimenQuantity = ?,
              -             specimenQuantityUnits = ?,
              -             sampleContainerCategory = ?,
              -             eventId = ?
              - WHERE id = ?
              - AND requestId = ?
              - AND (
              -       patientId <> ?
              -       OR expectedBarcode <> ?
              -       OR externalIdentifier <> ?
              -       OR specimenType <> ?
              -       OR specimenSource <> ?
              -       OR ifnull(collectionDate, '') <> ?
              -       OR ifnull(collectionTime, '') <> ?
              -       OR ifnull(receivedDate, '') <> ?
              -       OR ifnull(receivedTime, '') <> ?
              -       OR ifnull(specimenQuantity,'') <> ifnull(?,'')
              -       OR ifnull(specimenQuantityUnits,'') <> ifnull(?,'')
              -       OR sampleContainerCategory <> ?
              -     )
              string {_:patientId}
              string {_columnInput_specimenInfoInputTableReceived:4}
              string {_columnInput_specimenInfoInputTableReceived:5}
              string {_columnInput_specimenInfoInputTableReceived:7}
              string {_columnInput_specimenInfoInputTableReceived:6}
              string {_columnInput_specimenInfoInputTableReceived:9}
              string {_columnInput_specimenInfoInputTableReceived:9}
              string {_columnInput_specimenInfoInputTableReceived:10}
              string {_columnInput_specimenInfoInputTableReceived:10}
              string {_columnInput_specimenInfoInputTableReceived:12}
              string {_columnInput_specimenInfoInputTableReceived:12}
              string {_columnInput_specimenInfoInputTableReceived:13}
              string {_columnInput_specimenInfoInputTableReceived:13}
              string {_columnInput_specimenInfoInputTableReceived:17}
                blankIsNull~
              string {_columnInput_specimenInfoInputTableReceived:18}
                blankIsNull~
              string {_columnInput_specimenInfoInputTableReceived:8}
              long {_eventId}
              int {_columnInput_specimenInfoInputTableReceived:21}
              string {_:requestId}
              string {_:patientId}
              string {_columnInput_specimenInfoInputTableReceived:4}
              string {_columnInput_specimenInfoInputTableReceived:5}
              string {_columnInput_specimenInfoInputTableReceived:7}
              string {_columnInput_specimenInfoInputTableReceived:6}
              string {_columnInput_specimenInfoInputTableReceived:9}
              string {_columnInput_specimenInfoInputTableReceived:10}
              string {_columnInput_specimenInfoInputTableReceived:12}
              string {_columnInput_specimenInfoInputTableReceived:13}
              string {_columnInput_specimenInfoInputTableReceived:17}
                blankIsNull~
              string {_columnInput_specimenInfoInputTableReceived:18}
                blankIsNull~
              string {_columnInput_specimenInfoInputTableReceived:8}

            sqlPreparedStatement
              - UPDATE containerProperties
              -   SET value = ?, eventId = ?
              - WHERE property = 'Sample Quantity'
              - AND containerId = ?
              string {_columnInput_specimenInfoInputTableReceived:17}
                blankIsNull~
              long {_eventId}
              string {_columnInput_specimenInfoInputTableReceived:11}

            sqlPreparedStatement
              - UPDATE containerProperties
              -   SET value = ?, eventId = ?
              - WHERE property = 'Sample Quantity Units'
              - AND containerId = ?
              string {_columnInput_specimenInfoInputTableReceived:18}
                blankIsNull~
              long {_eventId}
              string {_columnInput_specimenInfoInputTableReceived:11}

            sqlPreparedStatement
              - INSERT INTO contents (containerId, attribute, contentType, content, eventId)
              - SELECT
              -   ?, 'self', 'requestId', ?, ?
              - WHERE NOT EXISTS
              -   ( SELECT containerId from contents WHERE containerId = ? AND attribute = 'self' AND contentType = 'requestId' AND content  = ?)
              string {_columnInput_specimenInfoInputTableReceived:11}
              string {_:requestId}
              long {_eventId}
              string {_columnInput_specimenInfoInputTableReceived:11}
              string {_:requestId}

          jython
            switchboard.log('>>>> END SPECIMEN UPDATE SPECIMEN: {_columnInput_specimenInfoInputTableReceived:11}')

    # includeable orderEntry_orderedSpecimensSendTo_STRATA
    #   # Send Specimen Receiving Info to STRATA

    #   forRows specimenInfoInputTableReceived

    #     jython
    #       specimenId = '{_columnInput_specimenInfoInputTableReceived:6}'
    #       if specimenId == '':
    #         specimenId = '{_columnInput_specimenInfoInputTableReceived:16}'

    #     ifCondition {_j:specimenId}
    #       advancded~
    #       not~
    #         isBlank~
    #       include sendMessage_SpecimenEvent_STRATA
    #         parameter~ requestId
    #           value= {_:requestId}
    #         parameter~ specimenId
    #           value= {_j:specimenId}
    #         parameter~ problem
    #           value= false
    #         parameter~ disposition
    #           value= In-Process
    #         parameter~ status
    #           value= active
    #         parameter~ stepLevelComments
    #           value=
    #         parameter~ panelCode
    #           value= {_columnInput_specimenInfoInputTableReceived:8}

    #       include parseResponse_SpecimenEvent_STRATA


    #   forRows specimenInfoInputTable
    #     jython
    #       specimenId = '{_columnInput_specimenInfoInputTable:6}'
    #       if specimenId == '':
    #         specimenId = '{_columnInput_specimenInfoInputTable:16}'

    #     ifCondition '{_j:specimenId}' != ''
    #       include sendMessage_SpecimenEvent_STRATA
    #         parameter~ requestId
    #           value= {_:requestId}
    #         parameter~ specimenId
    #           value= {_j:specimenId}
    #         parameter~ problem
    #           value= false
    #         parameter~ disposition
    #           value= In-Process
    #         parameter~ status
    #           value= active
    #         parameter~ stepLevelComments
    #           value=
    #         parameter~ panelCode
    #           value= {_columnInput_specimenInfoInputTable:8}
    #       include parseResponse_SpecimenEvent_STRATA



    includeable orderEntry_orderedSpecimens_SQL
      ## Processing for new sample order entry and receiving (can be done seprately)
      ## Receiving information only gets tracked when a specimenId is provided.
      ## Once a specimenId is provided it is considered received.
      forRows specimenInfoInputTable

        ## Processing for exisitng sample entires, not yet received
        ## Checks if requestSpecimens id exisits
        ifCondition {_columnInput_specimenInfoInputTable:21}
          advanced~
          not~
            equals~ 0


          ## Check if primary sample row or add test row.
          ifCondition {_columnInput_specimenInfoInputTable:23}
            advanced~
            equals~ 0

            ## Check if specimen id is entered/ specimen has NOT been received
            ## Update specimen information for entered samples, not yet received.
            ifCondition {_columnInput_specimenInfoInputTable:11}
              advanced~
              isBlank~

              ifCondition {_step}
                advanced~
                not~
                  equals~ Specimen Receiving

                sqlPreparedStatement
                  - UPDATE   requestSpecimens
                  -   SET       patientId = ?,
                  -             expectedBarcode = ?,
                  -             externalIdentifier = ?,
                  -             specimenType = ?,
                  -             specimenSource = ?,
                  -             collectionDate = CASE ? WHEN '' THEN NULL ELSE ? END,
                  -             collectionTime = CASE ? WHEN '' THEN NULL ELSE ? END,
                  -             receivedDate = CASE ? WHEN '' THEN NULL ELSE ? END,
                  -             receivedTime = CASE ? WHEN '' THEN NULL ELSE ? END,
                  -             sampleContainerCategory = ?,
                  -             eventId = ?
                  - WHERE id = ?
                  - AND requestId = ?
                  - AND (
                  -       patientId <> ?
                  -       OR expectedBarcode <> ?
                  -       OR externalIdentifier <> ?
                  -       OR specimenType <> ?
                  -       OR specimenSource <> ?
                  -       OR ifnull(collectionDate, '') <> ?
                  -       OR ifnull(collectionTime, '') <> ?
                  -       OR ifnull(receivedTime, '') <> ?
                  -       OR sampleContainerCategory <> ?
                  -     )
                  string {_:patientId}
                  string {_columnInput_specimenInfoInputTable:4}
                  string {_columnInput_specimenInfoInputTable:5}
                  string {_columnInput_specimenInfoInputTable:7}
                  string {_columnInput_specimenInfoInputTable:6}
                  string {_columnInput_specimenInfoInputTable:9}
                  string {_columnInput_specimenInfoInputTable:9}
                  string {_columnInput_specimenInfoInputTable:10}
                  string {_columnInput_specimenInfoInputTable:10}
                  string {_columnInput_specimenInfoInputTable:12}
                  string {_columnInput_specimenInfoInputTable:12}
                  string {_columnInput_specimenInfoInputTable:13}
                  string {_columnInput_specimenInfoInputTable:13}
                  string {_columnInput_specimenInfoInputTable:8}
                  long {_eventId}
                  int {_columnInput_specimenInfoInputTable:21}
                  string {_:requestId}
                  string {_:patientId}
                  string {_columnInput_specimenInfoInputTable:4}
                  string {_columnInput_specimenInfoInputTable:5}
                  string {_columnInput_specimenInfoInputTable:7}
                  string {_columnInput_specimenInfoInputTable:6}
                  string {_columnInput_specimenInfoInputTable:9}
                  string {_columnInput_specimenInfoInputTable:10}
                  string {_columnInput_specimenInfoInputTable:13}
                  string {_columnInput_specimenInfoInputTable:8}


            ### update specimen information for samples being received.
            ifCondition {_columnInput_specimenInfoInputTable:11}
              advanced~
              not~
                isBlank~

              sqlPreparedStatement
                - UPDATE   requestSpecimens
                -   SET       patientId = ?,
                -             expectedBarcode = ?,
                -             externalIdentifier = ?,
                -             specimenType = ?,
                -             specimenSource = ?,
                -             collectionDate = CASE ? WHEN '' THEN NULL ELSE ? END,
                -             collectionTime = CASE ? WHEN '' THEN NULL ELSE ? END,
                -             specimenId = ?,
                -             receivedDate = CASE ? WHEN '' THEN NULL ELSE ? END,
                -             receivedTime = CASE ? WHEN '' THEN NULL ELSE ? END,
                -             specimenQuantity = ?,
                -             specimenQuantityUnits = ?,
                -             specimenCondition = ?,
                -             sampleContainerCategory = ?,
                -             eventId = ?
                - WHERE id = ?
                - AND requestId = ?
                - AND (
                -       patientId <> ?
                -       OR expectedBarcode <> ?
                -       OR externalIdentifier <> ?
                -       OR specimenType <> ?
                -       OR specimenSource <> ?
                -       OR ifnull(collectionDate, '') <> ?
                -       OR ifnull(collectionTime, '') <> ?
                -       OR ifnull(specimenId,'') <> ?
                -       OR ifnull(receivedDate, '') <> ?
                -       OR ifnull(receivedTime, '') <> ?
                -       OR ifnull(specimenQuantity,'') <> ifnull(?,'')
                -       OR ifnull(specimenQuantityUnits,'') <> ifnull(?,'')
                -       OR specimenCondition <> ?
                -       OR sampleContainerCategory <> ?
                -     )
                string {_:patientId}
                string {_columnInput_specimenInfoInputTable:4}
                string {_columnInput_specimenInfoInputTable:5}
                string {_columnInput_specimenInfoInputTable:7}
                string {_columnInput_specimenInfoInputTable:6}
                string {_columnInput_specimenInfoInputTable:9}
                string {_columnInput_specimenInfoInputTable:9}
                string {_columnInput_specimenInfoInputTable:10}
                string {_columnInput_specimenInfoInputTable:10}
                string {_columnInput_specimenInfoInputTable:11}
                string {_columnInput_specimenInfoInputTable:12}
                string {_columnInput_specimenInfoInputTable:12}
                string {_columnInput_specimenInfoInputTable:13}
                string {_columnInput_specimenInfoInputTable:13}
                string {_columnInput_specimenInfoInputTable:17}
                  blankIsNull~
                string {_columnInput_specimenInfoInputTable:18}
                string {_columnInput_specimenInfoInputTable:19}
                string {_columnInput_specimenInfoInputTable:8}
                long {_eventId}
                int {_columnInput_specimenInfoInputTable:21}
                string {_:requestId}
                string {_:patientId}
                string {_columnInput_specimenInfoInputTable:4}
                string {_columnInput_specimenInfoInputTable:5}
                string {_columnInput_specimenInfoInputTable:7}
                string {_columnInput_specimenInfoInputTable:6}
                string {_columnInput_specimenInfoInputTable:9}
                string {_columnInput_specimenInfoInputTable:10}
                string {_columnInput_specimenInfoInputTable:11}
                string {_columnInput_specimenInfoInputTable:12}
                string {_columnInput_specimenInfoInputTable:13}
                string {_columnInput_specimenInfoInputTable:17}
                  blankIsNull~
                string {_columnInput_specimenInfoInputTable:18}
                string {_columnInput_specimenInfoInputTable:19}
                string {_columnInput_specimenInfoInputTable:8}

              sqlPreparedStatement
                - INSERT INTO containerProperties (containerId, property, value, eventId)
                - VALUES (?,'Sample Quantity', ?, ?)
                string {_columnInput_specimenInfoInputTable:11}
                string {_columnInput_specimenInfoInputTable:17}
                long {_eventId}

              sqlPreparedStatement
                - INSERT INTO containerProperties (containerId, property, value, eventId)
                - VALUES (?,'Sample Quantity Units', ?, ?)
                string {_columnInput_specimenInfoInputTable:11}
                string {_columnInput_specimenInfoInputTable:18}
                long {_eventId}

              ## Received specimens contents records
              sqlPreparedStatement
                - INSERT INTO contents (containerId, attribute, contentType, content, eventId)
                - VALUES
                -   (?, 'self', 'requestId', ?, ?),
                -   (?, 'self', 'specimenId', ?, ?)
                string {_columnInput_specimenInfoInputTable:11}
                string {_:requestId}
                long {_eventId}
                string {_columnInput_specimenInfoInputTable:11}
                string {_columnInput_specimenInfoInputTable:11}
                long {_eventId}

              ## Update status
              sqlPreparedStatement
                - UPDATE requestSpecimens
                - SET status = 'RECEIVED'
                - WHERE id = ?
                int {_columnInput_specimenInfoInputTable:21}

              ifCondition {_columnInput_specimenInfoInputTable:20}
                advanced~
                not~
                  isBlank~
                sqlPreparedStatement
                  - INSERT INTO containerNotes (containerId, noteType, note, eventId)
                  - VALUES (?, 'Specimen Receiving Comment', ?, ?)
                  string {_columnInput_specimenInfoInputTable:11}
                  string {_columnInput_specimenInfoInputTable:20}
                  long {_eventId}

              ifCondition {_columnInput_specimenInfoInputTable:21}
                advanced~
                not~
                  isBlank~
                and~ {_columnInput_specimenInfoInputTable:22}
                  not~
                    equal~ 0

                sqlPreparedStatement
                  - INSERT INTO specimenMethods (requestId, requestSpecimensId, panelCode, testCode, methodCode, runCount, eventId)
                  - VALUES(?, ?, ?, ?, ?, ?, ?)
                  string {_:requestId}
                  int {_columnInput_specimenInfoInputTable:21}
                  string {_columnInput_specimenInfoInputTable:14}
                  string {_columnInput_specimenInfoInputTable:15}
                    blankIsNull~
                  string {_columnInput_specimenInfoInputTable:16}
                    blankIsNull~
                  int 1
                  long {_eventId}

                setFormQueryResult
                  sqlQuery~ SELECT LAST_INSERT_ID() AS "specimenMethodsId"


                include createNewRun
                  parameter~ specimenMethodsId
                    value= {_:specimenMethodsId}
                  parameter~ processContainerId
                    value= {_columnInput_specimenInfoInputTable:11}
                  parameter~ runType
                    value= workflow
                  parameter~ processRunWorkflowParentRunId
                    value=
                  parameter~ currentParentId
                    value=
                  parameter~ currentParentPosition
                    value=
                  ## OUT PARAMETER: runId

                ### Manage received specimen notes
                ifCondition {_columnInput_specimenInfoInputTable:20}
                  advanced~
                  not~
                    isBlank~

                  sqlPreparedStatement
                    - INSERT INTO containerNotes (containerId, noteType, note, eventId)
                    - VALUES (?, 'Specimen Receiving Comment', ?, ?)
                    string {_:runId}
                    string {_columnInput_specimenInfoInputTable:20}
                    long {_eventId}


                include routeContainer
                  parameter~ processContainerId
                    value= {_:runId}
                  parameter~ result
                    value= {_columnInput_specimenInfoInputTable:19}
                  parameter~ deleteFromStep
                    value=
                  parameter~ defaultNextStep
                    value= Create Batch
                  parameter~ routingType
                    value= run
                  parameter~ routingDirection
                    value= OUT
                  parameter~ endOfWorkflow
                    value= No
                  parameter~ sourceStep
                    value= {_step}

          ## RECORD SAMPLE TESTS AND METHODS for Sample Additional tests
          ## First test for sample is recorded when received specimen record is
          ifCondition
            advanced~
            sqlPreparedQuery~ SELECT 1
              - FROM dual
              - WHERE (? <> ''
              - OR ? <> '')
              - AND ? <> ''
              string {_columnInput_specimenInfoInputTable:22}
              string {_columnInput_specimenInfoInputTable:11}
              string {_columnInput_specimenInfoInputTable:14}


            sqlPreparedStatement
              - INSERT INTO specimenMethods (requestId, requestSpecimensId, panelCode, testCode, methodCode, runCount, eventId)
              - VALUES(?, ?, ?, ?, ?, ?, ?)
              string {_:requestId}
              int {_columnInput_specimenInfoInputTable:21}
              string {_columnInput_specimenInfoInputTable:14}
              string {_columnInput_specimenInfoInputTable:15}
                blankIsNull~
              string {_columnInput_specimenInfoInputTable:16}
                blankIsNull~
              int 1
              long {_eventId}

            setFormQueryResult
              sqlQuery~ SELECT LAST_INSERT_ID() AS "specimenMethodsId"

            setFormQueryResult
              sqlPreparedQuery~ SELECT
                - CASE ?
                -   WHEN '' THEN ?
                -   ELSE ?
                -  END AS "processContainerId"
                string {_columnInput_specimenInfoInputTable:11}
                string {_columnInput_specimenInfoInputTable:22}
                string {_columnInput_specimenInfoInputTable:11}

            include createNewRun
              parameter~ specimenMethodsId
                value= {_:specimenMethodsId}
              parameter~ processContainerId
                value= {_:processContainerId}
              parameter~ runType
                value= workflow
              parameter~ processRunWorkflowParentRunId
                value=
              parameter~ currentParentId
                value=
              parameter~ currentParentPosition
                value=
              ## OUT PARAMETER: runId

            ### Manage received specimen notes
            ifCondition {_columnInput_specimenInfoInputTable:20}
              advanced~
              not~
                isBlank~

              sqlPreparedStatement
                - INSERT INTO containerNotes (containerId, noteType, note, eventId)
                - VALUES (?, 'Specimen Receiving Comment', ?, ?)
                string {_:runId}
                string {_columnInput_specimenInfoInputTable:20}
                long {_eventId}



            include routeContainer
              parameter~ processContainerId
                value= {_:runId}
              parameter~ result
                value= {_columnInput_specimenInfoInputTable:19}
              parameter~ deleteFromStep
                value=
              parameter~ defaultNextStep
                value= Create Batch
              parameter~ routingType
                value= run
              parameter~ routingDirection
                value= OUT
              parameter~ endOfWorkflow
                value= No
              parameter~ sourceStep
                value= {_step}


          else


            ## Primary specimen row
            ## Initial record of specimen information
            ## TODO
            ifCondition
              advanced~
              sqlPreparedQuery~ SELECT 1
                - FROM dual
                - WHERE ? = '0'
                - AND (? <> ''
                - OR ? <> ''
                - OR ? <> ''
                - OR ? <> ''
                - OR ? <> '')
                string {_columnInput_specimenInfoInputTable:23}
                string {_columnInput_specimenInfoInputTable:4}
                string {_columnInput_specimenInfoInputTable:5}
                string {_columnInput_specimenInfoInputTable:7}
                string {_columnInput_specimenInfoInputTable:10}
                string {_columnInput_specimenInfoInputTable:11}

              sqlPreparedStatement
                - INSERT INTO requestSpecimens (
                -               requestId,
                -               patientId,
                -               expectedBarcode,
                -               externalIdentifier,
                -               specimenType,
                -               sampleContainerCategory,
                -               specimenSource,
                -               collectionDate,
                -               collectionTime,
                -               specimenId,
                -               receivedDate,
                -               receivedTime,
                -               specimenQuantity,
                -               specimenQuantityUnits,
                -               specimenCondition,
                -               status,
                -               eventId
                -   )
                - VALUES (?,?,?,?,?,?,?,
                -         case ? when '' then NULL else ? end,
                -         case ? when '' then NULL else ? end,
                -         case ? when '' then NULL else ? end,
                -         case ? when '' then NULL else ? end,
                -         case ? when '' then NULL else ? end,
                -         ?, ?, ?, 'ORDER ENTERED', ?)
                string {_:requestId}
                string {_:patientId}
                string {_columnInput_specimenInfoInputTable:4}
                string {_columnInput_specimenInfoInputTable:5}
                string {_columnInput_specimenInfoInputTable:7}
                string {_columnInput_specimenInfoInputTable:8}
                string {_columnInput_specimenInfoInputTable:6}
                string {_columnInput_specimenInfoInputTable:9}
                string {_columnInput_specimenInfoInputTable:9}
                string {_columnInput_specimenInfoInputTable:10}
                string {_columnInput_specimenInfoInputTable:10}
                string {_columnInput_specimenInfoInputTable:11}
                string {_columnInput_specimenInfoInputTable:11}
                string {_columnInput_specimenInfoInputTable:12}
                string {_columnInput_specimenInfoInputTable:12}
                string {_columnInput_specimenInfoInputTable:13}
                string {_columnInput_specimenInfoInputTable:13}
                string {_columnInput_specimenInfoInputTable:17}
                  blankIsNull~
                string {_columnInput_specimenInfoInputTable:18}
                  blankIsNull~
                string {_columnInput_specimenInfoInputTable:19}
                long {_eventId}


              ## get created requestSpecimens id
              setFormQueryResult
                sqlQuery~ SELECT LAST_INSERT_ID() AS "lastSpecimenId"

              ## sample is also being recived.
              ifCondition {_columnInput_specimenInfoInputTable:11}
                advanced~
                not~
                  isBlank~

                ## create received sample content record.
                sqlPreparedStatement
                  - INSERT INTO contents (containerId, attribute, contentType, content, eventId)
                  - VALUES
                  -   (?, 'self', 'requestId', ?, ?),
                  -   (?, 'self', 'specimenId', ?, ?)
                  string {_columnInput_specimenInfoInputTable:11}
                  string {_:requestId}
                  long {_eventId}
                  string {_columnInput_specimenInfoInputTable:11}
                  string {_columnInput_specimenInfoInputTable:11}
                  long {_eventId}

                sqlPreparedStatement
                  - INSERT INTO containerProperties (containerId, property, value, eventId)
                  - VALUES (?,'Sample Quantity', ?, ?)
                  string {_columnInput_specimenInfoInputTable:11}
                  string {_columnInput_specimenInfoInputTable:17}
                  long {_eventId}

                sqlPreparedStatement
                  - INSERT INTO containerProperties (containerId, property, value, eventId)
                  - VALUES (?,'Sample Quantity Units', ?, ?)
                  string {_columnInput_specimenInfoInputTable:11}
                  string {_columnInput_specimenInfoInputTable:18}
                  long {_eventId}

                ## update to correct specimen status
                sqlPreparedStatement
                  - UPDATE requestSpecimens
                  - SET status = 'RECEIVED'
                  - WHERE id = ?
                  int {_:lastSpecimenId}

                ifCondition {_columnInput_specimenInfoInputTable:20}
                  advanced~
                  not~
                    isBlank~
                  sqlPreparedStatement
                    - INSERT INTO containerNotes (containerId, noteType, note, eventId)
                    - VALUES (?, 'Specimen Receiving Comment', ?, ?)
                    string {_columnInput_specimenInfoInputTable:11}
                    string {_columnInput_specimenInfoInputTable:20}
                    long {_eventId}

            ifCondition
              advanced~
              sqlPreparedQuery~ SELECT 1
                - FROM dual
                - WHERE (? <> ''
                - OR ? <> '')
                - AND ? <> ''
                string {_columnInput_specimenInfoInputTable:11}
                string {_columnInput_specimenInfoInputTable:22}
                string {_columnInput_specimenInfoInputTable:14}


              setFormQueryResult
                sqlPreparedQuery~ SELECT id as "requestSpecimensId"
                  - FROM requestSpecimens
                  - WHERE specimenId = CASE ? WHEN '' THEN ? ELSE ? END
                  - AND requestId = ?
                  string {_columnInput_specimenInfoInputTable:11}
                  string {_columnInput_specimenInfoInputTable:22}
                  string {_columnInput_specimenInfoInputTable:11}
                  string {_:requestId}


              sqlPreparedStatement
                - INSERT INTO specimenMethods (requestId, requestSpecimensId, panelCode, testCode, methodCode, runCount, eventId)
                - VALUES(?, ?, ?, ?, ?, ?, ?)
                string {_:requestId}
                int {_:requestSpecimensId}
                string {_columnInput_specimenInfoInputTable:14}
                string {_columnInput_specimenInfoInputTable:15}
                  blankIsNull~
                string {_columnInput_specimenInfoInputTable:16}
                  blankIsNull~
                int 1
                long {_eventId}

              setFormQueryResult
                sqlQuery~ SELECT LAST_INSERT_ID() AS "specimenMethodsId"

              setFormQueryResult
                sqlPreparedQuery~ SELECT
                  - CASE ?
                  -   WHEN '' THEN ?
                  -   ELSE ?
                  - END AS "processContainerId"
                  string {_columnInput_specimenInfoInputTable:11}
                  string {_columnInput_specimenInfoInputTable:22}
                  string {_columnInput_specimenInfoInputTable:11}

              include createNewRun
                parameter~ specimenMethodsId
                  value= {_:specimenMethodsId}
                parameter~ processContainerId
                  value= {_:processContainerId}
                parameter~ runType
                  value= workflow
                parameter~ processRunWorkflowParentRunId
                  value=
                parameter~ currentParentId
                  value=
                parameter~ currentParentPosition
                  value=
                ## OUT PARAMETER: runId

              ### Manage received specimen notes
              ifCondition {_columnInput_specimenInfoInputTable:20}
                advanced~
                not~
                  isBlank~

                sqlPreparedStatement
                  - INSERT INTO containerNotes (containerId, noteType, note, eventId)
                  - VALUES (?, 'Specimen Receiving Comment', ?, ?)
                  string {_:runId}
                  string {_columnInput_specimenInfoInputTable:20}
                  long {_eventId}


              include routeContainer
                parameter~ processContainerId
                  value= {_:runId}
                parameter~ result
                  value= {_columnInput_specimenInfoInputTable:19}
                parameter~ deleteFromStep
                  value=
                parameter~ defaultNextStep
                  value= Create Batch
                parameter~ routingType
                  value= run
                parameter~ routingDirection
                  value= OUT
                parameter~ endOfWorkflow
                  value= No
                parameter~ sourceStep
                  value= {_step}


      forRows specimenInfoInputTableReceived
        ifCondition
          advanced~
          sqlPreparedQuery~ SELECT 1
            - FROM requestForms
            - WHERE requestId = ?
            -   AND addTest = 1
            -   AND ? <> ''
            string {_:requestId}
            string {_columnInput_specimenInfoInputTableReceived:11}

          setFormQueryResult
            sqlPreparedQuery~ SELECT id as "requestSpecimensId"
              - FROM requestSpecimens
              - WHERE specimenId = CASE ? WHEN '' THEN ? ELSE ? END
              - AND requestId = ?
              string {_columnInput_specimenInfoInputTableReceived:11}
              string {_columnInput_specimenInfoInputTableReceived:22}
              string {_columnInput_specimenInfoInputTableReceived:11}
              string {_:requestId}

          ifCondition {isReceiving}
            advanced~
            equals~ true

            sqlPreparedStatement
              - INSERT INTO specimenMethods (requestId, requestSpecimensId, panelCode, testCode, methodCode, runCount, eventId)
              - VALUES(?, ?, ?, ?, ?, ?, ?)
              string {_:requestId}
              int {_:requestSpecimensId}
              string {_columnInput_specimenInfoInputTableReceived:14}
              string {_columnInput_specimenInfoInputTableReceived:15}
                blankIsNull~
              string {_columnInput_specimenInfoInputTableReceived:16}
                blankIsNull~
              int 1
              long {_eventId}

            setFormQueryResult
              sqlQuery~ SELECT LAST_INSERT_ID() AS "specimenMethodsId"

            setFormQueryResult
              sqlPreparedQuery~ SELECT
                - CASE ?
                -   WHEN '' THEN ?
                -   ELSE ?
                - END AS "processContainerId"
                string {_columnInput_specimenInfoInputTableReceived:11}
                string {_columnInput_specimenInfoInputTableReceived:22}
                string {_columnInput_specimenInfoInputTableReceived:11}

            include createNewRun
              parameter~ specimenMethodsId
                value= {_:specimenMethodsId}
              parameter~ processContainerId
                value= {_:processContainerId}
              parameter~ runType
                value= workflow
              parameter~ processRunWorkflowParentRunId
                value=
              parameter~ currentParentId
                value=
              parameter~ currentParentPosition
                value=
            ## OUT PARAMETER: runId

          # ifCondition {_columnInput_specimenInfoInputTableReceived:14}
          #   advanced~
          #   not~
          #     isBlank~

          #   sqlPreparedStatement
          #     - INSERT INTO containerNotes (containerId, noteType, note, eventId)
          #     - VALUES (?, 'Specimen Receiving Comment', ?, ?)
          #     string {_:runId}
          #     string {_columnInput_specimenInfoInputTableReceived:14}
          #     long {_eventId}


            include routeContainer
              parameter~ processContainerId
                value= {_:runId}
              parameter~ result
                value= {_columnInput_specimenInfoInputTableReceived:19}
              parameter~ deleteFromStep
                value=
              parameter~ defaultNextStep
                value= Create Batch
              parameter~ routingType
                value= run
              parameter~ routingDirection
                value= OUT
              parameter~ endOfWorkflow
                value= No
              parameter~ sourceStep
                value= {_step}

        ## RECORD SAMPLE TESTS AND METHODS for Sample Additional tests
          ## First test for sample is recorded when received specimen record is
        ifCondition
          advanced~
          sqlPreparedQuery~ SELECT 1
            - FROM dual
            - WHERE ? <> ''
            - AND ? = ''
            - AND ? <> ''
            string {_columnInput_specimenInfoInputTableReceived:22}
            string {_columnInput_specimenInfoInputTableReceived:11}
            string {_columnInput_specimenInfoInputTableReceived:14}

          setFormQueryResult
            sqlPreparedQuery~ SELECT id as "requestSpecimensId"
              - FROM requestSpecimens
              - WHERE specimenId = ?
              - AND requestId = ?
              string {_columnInput_specimenInfoInputTableReceived:22}
              string {_:requestId}


          sqlPreparedStatement
            - INSERT INTO specimenMethods (requestId, requestSpecimensId, panelCode, testCode, methodCode, runCount, eventId)
            - VALUES(?, ?, ?, ?, ?, ?, ?)
            string {_:requestId}
            int {_:requestSpecimensId}
            string {_columnInput_specimenInfoInputTableReceived:14}
            string {_columnInput_specimenInfoInputTableReceived:15}
              blankIsNull~
            string {_columnInput_specimenInfoInputTableReceived:16}
              blankIsNull~
            int 1
            long {_eventId}

          setFormQueryResult
            sqlQuery~ SELECT LAST_INSERT_ID() AS "specimenMethodsId"

          setFormQueryResult
            sqlPreparedQuery~ SELECT ? AS "processContainerId"
              string {_columnInput_specimenInfoInputTableReceived:22}

          include createNewRun
            parameter~ specimenMethodsId
              value= {_:specimenMethodsId}
            parameter~ processContainerId
              value= {_:processContainerId}
            parameter~ runType
              value= workflow
            parameter~ processRunWorkflowParentRunId
              value=
            parameter~ currentParentId
              value=
            parameter~ currentParentPosition
              value=
            ## OUT PARAMETER: runId

          ### Manage received specimen notes
          ifCondition {_columnInput_specimenInfoInputTableReceived:20}
            advanced~
            not~
              isBlank~

            sqlPreparedStatement
              - INSERT INTO containerNotes (containerId, noteType, note, eventId)
              - VALUES (?, 'Specimen Receiving Comment', ?, ?)
              string {_:runId}
              string {_columnInput_specimenInfoInputTableReceived:20}
              long {_eventId}


          include routeContainer
            parameter~ processContainerId
              value= {_:runId}
            parameter~ result
              value= {_columnInput_specimenInfoInputTableReceived:19}
            parameter~ deleteFromStep
              value=
            parameter~ defaultNextStep
              value= Create Batch
            parameter~ routingType
              value= run
            parameter~ routingDirection
              value= OUT
            parameter~ endOfWorkflow
              value= No
            parameter~ sourceStep
              value= {_step}



### Report Distribution ###
    includeable orderEntry_reportDistribution
      script
        src= js/orderEntry/reportDistribution.js

      ## Get Additional Recipient Count
      configurePreparedQuery~
        - SELECT count(recipientId) AS "reportDistribution_additionalRecipientCount"
        - FROM reportDistribution
        - WHERE requestId = ?
        string {_:requestId}


      configurePreparedQuery~
        - SELECT
        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'firstName', fis.screenLabel, NULL) SEPARATOR '<br />') AS 'screenLabel_firstName',

        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'lastName', fis.screenLabel, NULL) SEPARATOR '<br />') AS 'screenLabel_lastName',

        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'physicianSiteId', fis.screenLabel, NULL) SEPARATOR '<br />') AS 'screenLabel_physicianSiteId'

        - FROM formInputSettings fis
        - INNER JOIN formDefinition fd
        -   ON fd.id = fis.formDefinitionId
        - INNER JOIN formConfigurableParts fp
        -   ON fp.id = fis.formConfigurablePartsId
        - WHERE
        -   fd.formType = 'Accessioning'
        -   AND fd.instance = ?
        -   AND fd.workflow = ?
        string {_:instance}
        string {_:workflow}


      hidden reportDistribution_additionalRecipients
        id= reportDistribution_additionalRecipients

      div
        id= reportDistribution_physicianReportDistributionDiv
        fieldset
          legend Report Distribution
          table
            sqlPreparedQuery~
              - SELECT
              -   concat(IFNULL(p.last_name,''), if(ifnull(p.first_name,'') = '', '',', '), ifnull(p.first_name,'')) AS "Recipient"
              -   , rdp.distributionMethod AS "Distribution Method"
              -   , rdp.specialHandling AS "Special Handling"
              - FROM reportDistributionPreferences rdp
              -   INNER JOIN requestForms rf ON rdp.recipientId = rf.physicianId
              -   INNER JOIN physicians p ON rdp.recipientId = p.physicianId
              - WHERE rf.requestId = ?
              string {_:requestId}

      div
        id= additionalRecipientSearch
        fieldset
          legend Recipient Search

          simpleTable
            thead
              tr
                th !!! {_:screenLabel_lastName}
                th !!! {_:screenLabel_firstName}
                th Recipient Type
                th Organization
                th !!! {_:screenLabel_physicianSiteId}
            tbody
              tr
                td
                  text reportDistribution_physicianLastNameSearch
                    id= reportDistribution_physicianLastNameSearch
                    class= reportDistribution_clearPhysician
                td
                  text reportDistribution_physicianFirstNameSearch
                    id= reportDistribution_physicianFirstNameSearch
                    class= reportDistribution_clearPhysician
                td
                  select reportDistribution_physicianTypeSearch
                    id= reportDistribution_physicianTypeSearch
                    class= reportDistribution_clearPhysician
                    option
                    sqlPreparedQuery~ SELECT DISTINCT providerType FROM physicians
                    required~ false
                td
                  text reportDistribution_organizationSearch
                    id= reportDistribution_organizationSearch
                    class= reportDistribution_clearPhysician
                td
                  text reportDistribution_siteSearch
                    id= reportDistribution_siteSearch
                    class= reportDistribution_clearPhysician

          #clears physician search inputs and hides physician search result table
          br
            button Search
              id= reportDistribution_searchPhysicianButton
          br
          div
            id= reportDistribution_physicianCandidates


      div
        id= additionalRecipients
        fieldset
          legend Additional Report Distribution
          table
            id= reportDistributionSelectionTable
            sqlPreparedQuery~
              - SELECT
              -   '' AS "Delete"
              -   , p.physicianId AS "Recipient"
              -   , rd.distributionMethod AS "Distribution Method"
              -   , rd.specialHandling AS "Special Handling"
              -   , rd.id AS "Hidden"
              - FROM reportDistribution rd
              -   INNER JOIN physicians p ON rd.recipientId = p.physicianId
              - WHERE rd.requestId = ?
              - UNION
              - SELECT '','','','', ''
              - FROM dual
              - WHERE NOT EXISTS (SELECT 1 FROM reportDistribution rd INNER JOIN physicians p ON rd.recipientId = p.physicianId
              - WHERE rd.requestId = ?)
              string {_:requestId}
              string {_:requestId}
            columnSpecs~ reportDistributionSelectionTable
              allowChangedRecordIds
              column 1
                inputType checkbox
                  class= reportDistributionSelectionTable_deleteCheckbox
              column 2
                inputType select
                  class= reportDistributionSelectionTable_recipient
                  sqlQuery~ SELECT concat(IFNULL(p.last_name,''), IF(IFNULL(p.first_name,'') = '', '',', '), IFNULL(p.first_name,'')), p.physicianId FROM physicians p
              column 3
                inputType select
                  setName~ reportDistributionMethods
                  required~ false
                  class= reportDistributionSelectionTable_reportDistributionMethods
              column 4
                inputType textArea
                  class= reportDistributionSelectionTable_specialHandling
              column 5
                inputType text
                  class= reportDistributionSelectionTable_hiddenId hideColumn

          vertical
            button addNewRecipient
              id= addNewRecipient
              value= Add New Recipient



### Report Distribution SQL ###
    includeable orderEntry_reportDistribution_SQL

      forRows reportDistributionSelectionTable

        ifCondition
          advanced~
          not~
            sqlPreparedQuery~ SELECT 1
              - FROM reportDistribution
              - WHERE requestId = ?
              string {_:requestId}

          sqlPreparedStatement
            - INSERT INTO reportDistribution (requestId, recipientId, distributionMethod, specialHandling, eventId)
            - SELECT ?, ?, ?, ?, ? FROM dual
            - WHERE ? <> ''
            -   AND ? <> ''
            -   AND ? <> 'true'
            string {_:requestId}
            string {_columnInput_reportDistributionSelectionTable:2}
            string {_columnInput_reportDistributionSelectionTable:3}
            string {_columnInput_reportDistributionSelectionTable:4}
            long {_eventId}
            string {_columnInput_reportDistributionSelectionTable:2}
            string {_columnInput_reportDistributionSelectionTable:3}
            string {_columnInput_reportDistributionSelectionTable:1}

          else
            sqlPreparedStatement
              - UPDATE reportDistribution
              - SET recipientId = ?,
              -   distributionMethod = ?,
              -   specialHandling = ?
              - WHERE id = ?
              string {_columnInput_reportDistributionSelectionTable:2}
              string {_columnInput_reportDistributionSelectionTable:3}
              string {_columnInput_reportDistributionSelectionTable:4}
              string {_columnInput_reportDistributionSelectionTable:5}

            sqlPreparedStatement
              - INSERT IGNORE INTO reportDistribution (requestId, recipientId, distributionMethod, specialHandling, eventId)
              - SELECT ?, ?, ?, ?, ? FROM dual
              - WHERE ? <> ''
              -   AND ? <> ''
              -   AND ? <> 'true'
              string {_:requestId}
              string {_columnInput_reportDistributionSelectionTable:2}
              string {_columnInput_reportDistributionSelectionTable:3}
              string {_columnInput_reportDistributionSelectionTable:4}
              long {_eventId}
              string {_columnInput_reportDistributionSelectionTable:2}
              string {_columnInput_reportDistributionSelectionTable:3}
              string {_columnInput_reportDistributionSelectionTable:1}

            sqlPreparedStatement
              - DELETE FROM reportDistribution
              - WHERE id = ?
              -   AND ? = 'true'
              string {_columnInput_reportDistributionSelectionTable:5}
              string {_columnInput_reportDistributionSelectionTable:1}




### Billing ###
    includeable orderEntry_billing
      script
        src= js/orderEntry/orderEntry_billing.js

      ## Get Config Settings
      configurePreparedQuery~
        - CALL sp_getFormInputSettings('billing', ?, ?)
        string {_:formType}
        int {_:formDefinitionId}

      configurePreparedQuery~
        - SELECT {_:inputSettings}

      ### patientBilling
      formPreparedQuery~
        - SELECT
        -   billTo,
        -   governmentPayment1,
        -   governmentPolicyNumber1,
        -   governmentPayment2,
        -   governmentPolicyNumber2,
        -   selfpay,
        -   privateInsurance,
        -   carrierId1,
        -   policyNumber1,
        -   groupNumber1,
        -   policyHolder1FirstName,
        -   policyHolder1LastName,
        -   policyHolder1Id,
        -   policyHolder1DOB,
        -   policyHolder1Relationship,
        -   carrierId2,
        -   policyNumber2,
        -   groupNumber2,
        -   policyHolder2FirstName,
        -   policyHolder2LastName,
        -   policyHolder2Id,
        -   policyHolder2DOB,
        -   policyHolder2Relationship
        - FROM patientBilling
        - WHERE patientId = ?
        - AND requestId = ?
        - UNION
        - SELECT
        -   billTo,
        -   governmentPayment1,
        -   governmentPolicyNumber1,
        -   governmentPayment2,
        -   governmentPolicyNumber2,
        -   selfpay,
        -   privateInsurance,
        -   carrierId1,
        -   policyNumber1,
        -   groupNumber1,
        -   policyHolder1FirstName,
        -   policyHolder1LastName,
        -   policyHolder1Id,
        -   policyHolder1DOB,
        -   policyHolder1Relationship,
        -   carrierId2,
        -   policyNumber2,
        -   groupNumber2,
        -   policyHolder2FirstName,
        -   policyHolder2LastName,
        -   policyHolder2Id,
        -   policyHolder2DOB,
        -   policyHolder2Relationship
        - FROM patientBillingDefault
        - WHERE patientId = ?
        - UNION
        - select '', '', '', '', '', '', '', '', '', '', ''
        -  , '', '', '', '', '', '', '', '', '', '', '', ''
        string {_:patientId}
        string {_:requestId}
        string {_:patientId}


      formPreparedQuery~
        - SELECT
        -   carrierName as "carrier1Name",
        -   address1 as "carrier1Address1",
        -   address2 as "carrier1Address2",
        -   concat(ifnull(city, 'no city provided') + ', ' +  ifnull(state, 'no state provided') + ' ' + ifnull(postalCode, 'no postal code provided')) as "carrier1CityStateZip",
        -   country as "carrier1Country",
        -   phoneNumber as "carrier1Phone"
        - FROM insuranceCarriers
        - WHERE id = ?
        - UNION
        - SELECT '', '', '', '', '', ''
        int {_:carrierId1}

      formPreparedQuery~
        - SELECT
        -   carrierName as "carrier2Name",
        -   address1 as "carrier2Address1",
        -   address2 as "carrier2Address2",
        -   concat(ifnull(city, 'no city provided') + ', ' +  ifnull(state, 'no state provided') + ' ' + ifnull(postalCode, 'no postal code provided')) as "carrier2CityStateZip",
        -   country as "carrier2Country",
        -   phoneNumber as "carrier2Phone"
        - FROM insuranceCarriers
        - WHERE id = ?
        - UNION
        - SELECT '', '', '', '', '', ''
        int {_:carrierId2}


      hidden selfPay
        id= selfPay
        value= {_:selfPay}
        screenLabel~

      hidden billingInfo
        id= billingInfo
        screenLabel~
        value= true

      #### Medical Codes section ####
      div
        id= diagnosticCodes
        h3 Diagnosis and Procedure Codes

        div
          id= codeSearch
          h3 Code Search

          simpleTable
            thead
              tr
                th Code
                th Keywords
            tbody
              tr
                td
                  text code
                    id= searchCode
                    class= clearCodeSearch searchCode
                    required~ false
                td
                  text keywords
                    placeholder= Keywords
                    id= codeKeywords
                    class= clearCodeSearch codeKeywords
                    required~ false
                td
                  button Search
                    id= searchCodeButton

          button Clear Code Search
            id= diagnosticCodes_clearSearchButton

          vertical
            div
              id= codeCandidates
              class= codeCandidates
          br
          br
          div
            h3 Linked Diagnostic Codes
            table
              id= diagnosticCodesSelectionTable
              sqlPreparedQuery~
                - SELECT
                -   '' AS "Delete"
                -   , ifnull(dc.diagnosticCode, '') AS "Code"
                -   , ifnull(dc.type, '') AS "Code Type"
                -   , ifnull(dc.description, '') AS "Description"
                -   , dc.id
                - FROM requestCodes rc
                - INNER JOIN diagnosticCodes dc
                -   ON rc.codeId = dc.Id
                - WHERE rc.requestId = ?
                string {_:requestId}
              columnSpecs~ diagnosticCodesSelectionTable
                allowChangedRecordIds
                column 1
                  inputType checkbox
                    class= diagnosticCodesSelectionTable_deleteCheckbox
                column 2
                  inputType text
                    class= diagnosticCodesSelectionTable_code
                    readonly= true
                column 3
                  inputType text
                    class= diagnosticCodesSelectionTable_codeType
                    readonly= true
                column 4
                  inputType textArea
                    class= diagnosticCodesSelectionTable_codeDescription
                    readonly= true
                column 5
                  inputType text
                    class= hiddenColumn
                    readonly= true
      br
      br


      div
        h3 Billing Information
        vertical
          select billTo
            screenLabel~ Bill To
            id= billTo
            class= required billingInfo_billTo
            data-parsley-required= true
            value= {_:billTo}
            option
            setName~ billTo
      br
      div
        id= billing
        h3 Payment Type
        rowGroups
          rowGroup
            checkbox governmentPayment1
              asBit~
              class= governmentPolicyNumber1 clearPatient governmentPayment1
              value= {_:governmentPayment1}
              screenLabel~
              span {_:screenLabel_governmentPolicyNumber1}
              disabled=
                configureIf~ {_:readOnly_governmentPolicyNumber1}
                  advanced~
                  equals~ true
            div
              id= governmentPolicyNumber1
              vertical
                text governmentPolicyNumber1
                  class= governmentPolicyNumber1 clearPatient governmentPolicyNumber1Value
                  value= {_:governmentPolicyNumber1}
                  validate~ SELECT 1
                    - FROM dual
                    - WHERE (? = 1
                    - AND ? <> '')
                    - OR ? = 0
                    int {governmentPayment1}
                    string {governmentPolicyNumber1}
                    int {governmentPayment1}
                    errorMessage~ !!! You must enter a policy number when selecting {_:screenLabel_governmentPolicyNumber1}
                    configureIf~ {_:required_governmentPolicyNumber1}
                      advanced~
                      equals~ true
                  readonly=
                    configureIf~ {_:readOnly_governmentPolicyNumber1}
                      advanced~
                      equals~ true
                  screenLabel~ Policy Number:
                  placeholder= {_:placeHolder_governmentPolicyNumber1}

          rowGroup
            checkbox governmentPayment2
              asBit~
              class= governmentPolicyNumber2 clearPatient governmentPayment2
              screenLabel~
              span {_:screenLabel_governmentPolicyNumber2}
              value= {_:governmentPayment2}
              disabled=
                configureIf~ {_:readOnly_governmentPolicyNumber2}
                  advanced~
                  equals~ true
            div
              id= governmentPolicyNumber2
              vertical
                text governmentPolicyNumber2
                  class= governmentPolicyNumber2 clearPatient governmentPolicyNumber2Value
                  value= {_:governmentPolicyNumber2}
                  validate~ SELECT 1
                    - FROM dual
                    - WHERE (? = 1
                    - AND ? <> '')
                    - OR ? = 0
                    int {governmentPayment2}
                    string {governmentPolicyNumber2}
                    int {governmentPayment2}
                    errorMessage~ !!! You must enter a policy number when selecting {_:screenLabel_governmentPolicyNumber2}
                    configureIf~ {_:required_governmentPolicyNumber2}
                      advanced~
                      equals~ true
                  readonly=
                    configureIf~ {_:readOnly_governmentPolicyNumber2}
                      advanced~
                      equals~ true
                  screenLabel~ Policy Number:
                  placeholder= {_:placeHolder_governmentPolicyNumber2}

          rowGroup
            checkbox selfpay
              asBit~
              id= paymentOption_Self
              class= selfPay
              screenLabel~
              span Self Pay
              value= {_:selfpay}

          rowGroup
            checkbox privateInsurance
              asBit~
              id= paymentOption_Insurance
              class= privateInsurance
              screenLabel~
              span Private Insurance
              value= {_:privateInsurance}

        ##### Private Insurance div #####
        div
          id= privateInsurance

          br
          div
            h3 Search Insurance Carriers
            rowGroups
              rowGroup
                select insuranceCarrier
                  id= insuranceCarrier
                  screenLabel~
                  placeholder= Search Insurance Carrier

                vertical2
                  button
                    id= insuranceRecord
                    screenLabel~
                    value= CREATE/EDIT CARRIERS

                  button
                    id= clearInsuranceRecord
                    screenLabel~
                    value= CLEAR INSRUANCE INFORMATION

          br
          vertical2
            div
              h2 Primary Insurance
              hidden carrierId1
                screenLabel~ ID
                value= {_:carrierId1}
                id= carrierIdP
                class= clearPatient clearInsurance
              vertical
                button asPrimary
                  screenLabel~
                  value= Set Primary Insurance
                  insuranceType= P
              br
              vertical
                text carrier1Name
                  screenLabel~ Insurance Carrier
                  value= {_:carrier1Name}
                  id= carrierNameP
                  class= clearPatient clearInsurance
                  readonly=
                  tabindex= 999999
                text carrier1Address1
                  screenLabel~ Address
                  id= carrierAddress1P
                  readonly=
                  tabindex= 999999
                  value= {_:carrier1Address1}
                  class= clearPatient clearInsurance
                text carrier1Address2
                  id= carrierAddress2P
                  value= {_:carrier1Address2}
                  screenLabel~
                  tabindex= 999999
                  class= clearPatient clearInsurance
                  readonly=
                text carrier1CityStateZip
                  id= carrierCityStateZipP
                  screenLabel~
                  value= {_:carrier1CityStateZip}
                  readonly=
                  tabindex= 999999
                  class= clearPatient clearInsurance
                text carrier1Country
                  id= carrierCountryP
                  value= {_:carrier1Country}
                  screenLabel~
                  readonly=
                  tabindex= 999999
                  class= clearPatient clearInsurance
                text carrier1Phone
                  id= carrierPhoneP
                  value= {_:carrier1Phone}
                  screenLabel~ Phone Number
                  readonly=
                  tabindex= 999999
                  class= clearPatient clearInsurance
                br
                text policyNumber1
                  screenLabel~ Policy Number
                  value= {_:policyNumber1}
                  class= clearPatient clearInsurance
                text groupNumber1
                  screenLabel~ Group Number
                  value= {_:groupNumber1}
                  class= clearPatient clearInsurance
                text policyHolder1FirstName
                  screenLabel~ Insured First Name
                  value= {_:policyHolder1FirstName}
                  class= clearPatient clearInsurance
                text policyHolder1LastName
                  screenLabel~ Insured Last Name
                  value= {_:policyHolder1LastName}
                  class= clearPatient clearInsurance
                text policyHolder1Id
                  id= policyHolderId_1
                  value= {_:policyHolder1Id}
                  class= clearPatient clearInsurance policyHolder1Id required
                    configureIf~ {_:required_policyHolder1Id}
                      advanced~
                      equals~ true
                  class= clearPatient clearInsurance policyHolder1Id
                    configureIf~ {_:required_policyHolder1Id}
                      advanced~
                      equals~ false
                  validate~ SELECT 1
                    - FROM dual
                    - WHERE (? <> ''
                    - AND ? <> '')
                    - OR ? = ''
                    string {carrierId1}
                    string {policyHolder1Id}
                    string {carrierId1}
                    errorMessage~ You must enter a policy holder id for this insurance.
                    configureIf~ {_:required_policyHolder1Id}
                      advanced~
                      equals~ true
                  readonly=
                    configureIf~ {_:readOnly_policyHolder1Id}
                      advanced~
                      equals~ true
                  screenLabel~ !!! {_:screenLabel_policyHolder1Id}
                  placeholder= {_:placeHolder_policyHolder1Id}
                date policyHolder1DOB
                  convert~ false
                  screenLabel~ Insured DOB
                  value= {_:policyHolder1DOB}
                  class= clearPatient datePickerDOB clearInsurance
                select policyHolder1Relationship
                  screenLabel~ Relationship to Patient
                  value= {_:policyHolder1Relationship}
                  option
                  setName~ relationship
                  required~ false
                  class= clearPatient clearInsurance

            div
              h2 Secondary Insurance
              hidden carrierId2
                screenLabel~ ID
                value= {_:carrierId2}
                id= carrierIdS
                class= clearPatient clearInsurance
              vertical
                button asSecondary
                  screenLabel~
                  value= Set Secondary Insurance
                  insuranceType= S
              br
              vertical
                text carrier2Name
                  screenLabel~ Insurance Carrier
                  value= {_:carrier2Name}
                  id= carrierNameS
                  class= clearPatient clearInsurance
                  readonly=
                  tabindex= 999999
                text carrier2Address1
                  screenLabel~ Address
                  id= carrierAddress1S
                  value= {_:carrier2Address1}
                  readonly=
                  tabindex= 999999
                  class= clearPatient clearInsurance
                text carrier2Address2
                  id= carrierAddress2S
                  value= {_:carrier2Address2}
                  screenLabel~
                  tabindex= 999999
                  class= clearPatient clearInsurance
                  readonly=
                text carrier2CityStateZip
                  id= carrierCityStateZipS
                  value= {_:carrier1CityStateZip}
                  screenLabel~
                  readonly=
                  tabindex= 999999
                  class= clearPatient clearInsurance
                text carrier2Country
                  id= carrierCountryS
                  value= {_:carrier2Country}
                  screenLabel~
                  readonly=
                  tabindex= 999999
                  class= clearPatient clearInsurance
                text carrier2Phone
                  id= carrierPhoneS
                  value= {_:carrier2Phone}
                  screenLabel~ Phone Number
                  readonly=
                  tabindex= 999999
                  class= clearPatient clearInsurance
                br
                text policyNumber2
                  screenLabel~ Policy Number
                  value= {_:policyNumber2}
                  class= clearPatient clearInsurance
                text groupNumber2
                  screenLabel~ Group Number
                  value= {_:groupNumber2}
                  class= clearPatient clearInsurance
                text policyHolder2FirstName
                  screenLabel~ Insured First Name
                  value= {_:policyHolder2FirstName}
                  class= clearPatient clearInsurance
                text policyHolder2LastName
                  screenLabel~ Insured Last Name
                  value= {_:policyHolder2LastName}
                  class= clearPatient clearInsurance
                text policyHolder2Id
                  id= policyHolderId_1
                  value= {_:policyHolder2Id}
                  class= clearPatient clearInsurance policyHolder2Id required
                    configureIf~ {_:required_policyHolder2Id}
                      advanced~
                      equals~ true
                  class= clearPatient clearInsurance policyHolder2Id
                    configureIf~ {_:required_policyHolder2Id}
                      advanced~
                      equals~ false
                  validate~ SELECT 1
                    - FROM dual
                    - WHERE (? <> ''
                    - AND ? <> '')
                    - OR ? = ''
                    string {carrierId2}
                    string {policyHolder2Id}
                    string {carrierId2}
                    errorMessage~ You must enter a policy holder id for this insurance.
                    configureIf~ {_:required_policyHolder2Id}
                      advanced~
                      equals~ true
                  readonly=
                    configureIf~ {_:readOnly_policyHolder2Id}
                      advanced~
                      equals~ true
                  screenLabel~ !!! {_:screenLabel_policyHolder2Id}
                  placeholder= {_:placeHolder_policyHolder2Id}
                date policyHolder2DOB
                  convert~ false
                  screenLabel~ Insured DOB
                  value= {_:policyHolder2DOB}
                  class= clearPatient datePickerDOB clearInsurance
                select policyHolder2Relationship
                  screenLabel~ Relationship to Patient
                  value= {_:policyHolder2Relationship}
                  option
                  setName~ relationship
                  required~ false
                  class= clearPatient clearInsurance



### Billing SQL ###
    includeable orderEntry_billing_SQL

      ifCondition {_:showField_billing}
        advanced~
        equals~ true

        ### Set Diagnostic Codes
        forRows diagnosticCodesSelectionTable
          sqlPreparedStatement
            - DELETE FROM requestCodes
            - WHERE requestId = ?
            -   AND ? = 'true'
            -   AND codeId = ?
            string {_:requestId}
            string {_columnInput_diagnosticCodesSelectionTable:1}
            string {_columnInput_diagnosticCodesSelectionTable:5}


          ifCondition
            advanced~
            sqlPreparedQuery~ SELECT 1
              -   FROM DUAL
              -   WHERE NOT EXISTS
              -   (
              -       SELECT 1
              -       FROM requestCodes rc
              -       WHERE rc.requestId = ?
              -         AND rc.codeId = ?
              -   )
              string {_:requestId}
              string {_columnInput_diagnosticCodesSelectionTable:5}

            sqlPreparedStatement
              - INSERT INTO requestCodes (requestId, codeId, eventId)
              - Select ?, ?, ? FROM Dual
              - WHERE  ? = 'false'
              string {_:requestId}
              string {_columnInput_diagnosticCodesSelectionTable:5}
              long {_eventId}
              string {_columnInput_diagnosticCodesSelectionTable:1}

        ### SET PATIENT BILLING DEFAULT
        ifCondition {_:patientId}
          advanced~
          not~
            isBlank~
          sqlPreparedStatement~
            - INSERT INTO patientBillingDefault (patientId, billTo,
            -   governmentPayment1, governmentPolicyNumber1,
            -   governmentPayment2, governmentPolicyNumber2,
            -   selfpay, privateInsurance,
            -   carrierId1, policyNumber1, groupNumber1,
            -   policyHolder1FirstName, policyHolder1LastName,
            -   policyHolder1Id, policyHolder1DOB, policyHolder1Relationship,
            -   carrierId2, policyNumber2, groupNumber2,
            -   policyHolder2FirstName, policyHolder2LastName,
            -   policyHolder2Id, policyHolder2DOB, policyHolder2Relationship,
            -   eventId)
            - VALUES (?,?, ?,?,?,?,?,?,
            -   case ? when '' then NULL else ? end,?,?,
            -   ?,?,?,
            -   case ? when '' then NULL else ? end,?,
            -   case ? when '' then NULL else ? end,?,?,?,?,?,
            -   case ? when '' then NULL else ? end,?,?)
            - ON DUPLICATE KEY UPDATE
            -   billTo = ?,
            -   governmentPayment1 =  ?,
            -   governmentPolicyNumber1 = ?,
            -   governmentPayment2 = ?,
            -   governmentPolicyNumber2 = ?,
            -   selfpay= ?,
            -   privateInsurance = ?,
            -   carrierId1 = case ? when '' then NULL else ? end,
            -   policyNumber1 = ?,
            -   groupNumber1 = ?,
            -   policyHolder1FirstName = ?,
            -   policyHolder1LastName = ?,
            -   policyHolder1Id = ?,
            -   policyHolder1DOB = case ? when '' then NULL else ? end,
            -   policyHolder1Relationship = ?,
            -   carrierId2 = case ? when '' then NULL else ? end,
            -   policyNumber2 = ?,
            -   groupNumber2 = ?,
            -   policyHolder2FirstName = ?,
            -   policyHolder2LastName = ?,
            -   policyHolder2Id = ?,
            -   policyHolder2DOB = case ? when '' then NULL else ? end,
            -   policyHolder2Relationship = ?,
            -   eventId = ?
            string {_:patientId}
            string {billTo}
            int {governmentPayment1}
            string {governmentPolicyNumber1}
            int {governmentPayment2}
            string {governmentPolicyNumber2}
            int {selfpay}
            int {privateInsurance}
            int {carrierId1}
            int {carrierId1}
            string {policyNumber1}
            string {groupNumber1}
            string {policyHolder1FirstName}
            string {policyHolder1LastName}
            string {policyHolder1Id}
            string {policyHolder1DOB}
            string {policyHolder1DOB}
            string {policyHolder1Relationship}
            int {carrierId2}
            int {carrierId2}
            string {policyNumber2}
            string {groupNumber2}
            string {policyHolder2FirstName}
            string {policyHolder2LastName}
            string {policyHolder2Id}
            string {policyHolder2DOB}
            string {policyHolder2DOB}
            string {policyHolder2Relationship}
            long {_eventId}
            string {billTo}
            int {governmentPayment1}
            string {governmentPolicyNumber1}
            int {governmentPayment2}
            string {governmentPolicyNumber2}
            int {selfpay}
            int {privateInsurance}
            int {carrierId1}
            int {carrierId1}
            string {policyNumber1}
            string {groupNumber1}
            string {policyHolder1FirstName}
            string {policyHolder1LastName}
            string {policyHolder1Id}
            string {policyHolder1DOB}
            string {policyHolder1DOB}
            string {policyHolder1Relationship}
            int {carrierId2}
            int {carrierId2}
            string {policyNumber2}
            string {groupNumber2}
            string {policyHolder2FirstName}
            string {policyHolder2LastName}
            string {policyHolder2Id}
            string {policyHolder2DOB}
            string {policyHolder2DOB}
            string {policyHolder2Relationship}
            long {_eventId}

          ifCondition
            advanced~
            sqlPreparedQuery~ SELECT 1
              -   FROM patientBilling
              -   WHERE patientId = ?
              -   AND requestId = ?
              string {_:patientId}
              string {_:requestId}

            sqlPreparedStatement~
              - UPDATE patientBilling
              -  SET billTo = ?,
              -   governmentPayment1 = ?,
              -   governmentPolicyNumber1 = ?,
              -   governmentPayment2 = ?,
              -   governmentPolicyNumber2 = ?,
              -   selfpay= ?,
              -   privateInsurance = ?,
              -   carrierId1 = case ? when '' then NULL else ? end,
              -   policyNumber1 = ?,
              -   groupNumber1 = ?,
              -   policyHolder1FirstName = ?,
              -   policyHolder1LastName = ?,
              -   policyHolder1Id = ?,
              -   policyHolder1DOB = case ? when '' then NULL else ? end,
              -   policyHolder1Relationship = ?,
              -   carrierId2 = case ? when '' then NULL else ? end,
              -   policyNumber2 = ?,
              -   groupNumber2 = ?,
              -   policyHolder2FirstName = ?,
              -   policyHolder2LastName = ?,
              -   policyHolder2Id = ?,
              -   policyHolder2DOB = case ? when '' then NULL else ? end,
              -   policyHolder2Relationship = ?,
              -   eventId = ?
              - WHERE patientId = ?
              - AND requestId = ?
              string {billTo}
              int {governmentPayment1}
              string {governmentPolicyNumber1}
              int {governmentPayment2}
              string {governmentPolicyNumber2}
              int {selfpay}
              int {privateInsurance}
              int {carrierId1}
              int {carrierId1}
              string {policyNumber1}
              string {groupNumber1}
              string {policyHolder1FirstName}
              string {policyHolder1LastName}
              string {policyHolder1Id}
              string {policyHolder1DOB}
              string {policyHolder1DOB}
              string {policyHolder1Relationship}
              int {carrierId2}
              int {carrierId2}
              string {policyNumber2}
              string {groupNumber2}
              string {policyHolder2FirstName}
              string {policyHolder2LastName}
              string {policyHolder2Id}
              string {policyHolder2DOB}
              string {policyHolder2DOB}
              string {policyHolder2Relationship}
              long {_eventId}
              string {_:patientId}
              string {_:requestId}


            else

              sqlPreparedStatement~
                - INSERT INTO patientBilling (patientId, requestId, billTo,
                -   governmentPayment1, governmentPolicyNumber1,
                -   governmentPayment2, governmentPolicyNumber2,
                -   selfpay, privateInsurance,
                -   carrierId1, policyNumber1, groupNumber1,
                -   policyHolder1FirstName, policyHolder1LastName,
                -   policyHolder1Id, policyHolder1DOB, policyHolder1Relationship,
                -   carrierId2, policyNumber2, groupNumber2,
                -   policyHolder2FirstName, policyHolder2LastName,
                -   policyHolder2Id, policyHolder2DOB, policyHolder2Relationship,
                -   eventId)
                - VALUES (?,?,?,?,?,?,?,?,?,
                -   case ? when '' then NULL else ? end,?,?,?,?,?,
                -   case ? when '' then NULL else ? end,?,
                -   case ? when '' then NULL else ? end,?,?,?,?,?,
                -   case ? when '' then NULL else ? end,?,?)
                string {_:patientId}
                string {_:requestId}
                string {billTo}
                int {governmentPayment1}
                string {governmentPolicyNumber1}
                int {governmentPayment2}
                string {governmentPolicyNumber2}
                int {selfpay}
                int {privateInsurance}
                int {carrierId1}
                int {carrierId1}
                string {policyNumber1}
                string {groupNumber1}
                string {policyHolder1FirstName}
                string {policyHolder1LastName}
                string {policyHolder1Id}
                string {policyHolder1DOB}
                string {policyHolder1DOB}
                string {policyHolder1Relationship}
                int {carrierId2}
                int {carrierId2}
                string {policyNumber2}
                string {groupNumber2}
                string {policyHolder2FirstName}
                string {policyHolder2LastName}
                string {policyHolder2Id}
                string {policyHolder2DOB}
                string {policyHolder2DOB}
                string {policyHolder2Relationship}
                long {_eventId}




### Authorization/Consent ###
    includeable orderEntry_consent

      script
        src= js/orderEntry/consentForm.js


      ## Get Config Settings
      configurePreparedQuery~ CALL sp_getFormInputSettings('consentForm', ?, ?)
        string {_:formType}
        int {_:formDefinitionId}

      configurePreparedQuery~ SELECT {_:inputSettings}

      # Retrieving requestForm values from DB or setting to default values.
      formPreparedQuery~
        - SELECT
        - rf.consent AS 'consent',
        - rf.patientSignature AS 'patientSignature',
        - rf.consentBy,
        - rf.consenteePatientRelationship,
        - IFNULL(DATE(rf.patientSignatureDate), '') AS 'patientSignatureDate',
        - rf.physicianSignature AS 'physicianSignature',
        - IFNULL(DATE(rf.physicianSignatureDate), '') AS 'physicianSignatureDate',
        - rf.physicianComment
        - FROM requestForms rf
        - WHERE rf.requestId = ?
        - UNION ALL
        - SELECT
        - ?,
        - ?,
        - ?,
        - '',
        - ?,
        - ?,
        - ?,
        - ?
        string {_:requestId}
        string {_:defaultValue_consent}
        string {_:defaultValue_patientSignature}
        string {_:defaultValue_consentBy}
        string {_:defaultValue_patientSignatureDate}
        string {_:defaultValue_physicianSignature}
        string {_:defaultValue_physicianSignatureDate}
        string {_:defaultValue_physicianComment}

      formQuery~ patientSignatureDate
        formatDate~
        value= {_:patientSignatureDate}

      formQuery~ physicianSignatureDate
        formatDate~
        value= {_:physicianSignatureDate}


      div
        id= patientConsent
        h3 PATIENT CONSENT
        vertical
          checkbox consent
            asBit~
            class= consentForm_{_:inputName_consent}
            screenLabel~ !!! {_:screenLabel_consent}
            required~ {_:required_consent}
            data-parsley-required= {_:required_consent}
            value= {_:consent}
            placeHolder= {_:placeHolder_consent}
            disabled= true
              configureIf~ {_:readOnly_consent}
            validate~ SELECT 1
              - FROM DUAL
              - WHERE ? = 'false' OR ? = 1
              string {_:required_consent}
              string {_thisInput}
              errorMessage~ {_:screenLabel_consent} must be checked


          checkbox patientSignature
            asBit~
            class= consentForm_{_:inputName_patientSignature}
            screenLabel~ !!! {_:screenLabel_patientSignature}
            value= {_:patientSignature}
            required~ {_:required_patientSignature}
            data-parsley-required= {_:required_patientSignature}
            disabled= true
              configureIf~ {_:readOnly_patientSignature}
            validate~ SELECT 1
              - FROM DUAL
              - WHERE ? = 'false' OR ? = 1
              string {_:required_patientSignature}
              string {_thisInput}
              errorMessage~ {_:screenLabel_patientSignature} must be checked


          text consentBy
            class= consentForm_{_:inputName_consentBy}
            screenLabel~ !!! {_:screenLabel_consentBy}
            required~ {_:required_consentBy}
            data-parsley-required= {_:required_consentBy}
            value= {_:consentBy}
            placeHolder= {_:placeHolder_consentBy}
            readOnly= true
              configureIf~ {_:readOnly_consentBy}


          select consenteePatientRelationship
            class= consentForm_{_:inputName_consenteePatientRelationship}
            screenLabel~ !!! {_:screenLabel_consenteePatientRelationship}
            required~ {_:required_consenteePatientRelationship}
            data-parsley-required= {_:required_consenteePatientRelationship}
            placeHolder= {_:placeHolder_consenteePatientRelationship}
            disabled= true
              configureIf~ {_:readOnly_consenteePatientRelationship}
            setName~ {_:defaultValue_consenteePatientRelationship}
            value= {_:consenteePatientRelationship}


          date patientSignatureDate
            convert~ false
            class= datePickerNow consentForm_{_:inputName_patientSignatureDate}
              configureIf~ {_:readOnly_patientSignatureDate}
                advanced~
                equals~ false
            class= consentForm_{_:inputName_patientSignatureDate}
              configureIf~ {_:readOnly_patientSignatureDate}
                advanced~
                equals~ true
            screenLabel~ !!! {_:screenLabel_patientSignatureDate}
            required~ {_:required_patientSignatureDate}
            data-parsley-required= {_:required_patientSignatureDate}
            value= {_:patientSignatureDate}
            placeHolder= {_:placeHolder_patientSignatureDate}
            readOnly= true
              configureIf~ {_:readOnly_patientSignatureDate}

      div
        h3 PHYSICIAN AUTHORIZATION
        id= physicianAuthorization
        vertical
          checkbox physicianSignature
            asBit~
            class= consentForm_{_:inputName_physicianSignature}
            screenLabel~ !!! {_:screenLabel_physicianSignature}
            value= {_:physicianSignature}
            required~ {_:required_physicianSignature}
            data-parsley-required= {_:required_physicianSignature}
            disabled= true
              configureIf~ {_:readOnly_physicianSignature}
            validate~ SELECT 1
              - FROM DUAL
              - WHERE ? = 'false' OR ? = 1
              string {_:required_physicianSignature}
              string {_thisInput}
              errorMessage~ {_:screenLabel_physicianSignature} must be checked

          date physicianSignatureDate
            convert~ false
            class= datePickerNow consentForm_{_:inputName_physicianSignatureDate}
              configureIf~ {_:readOnly_physicianSignatureDate}
                advanced~
                equals~ false
            class= consentForm_{_:inputName_physicianSignatureDate}
              configureIf~ {_:readOnly_physicianSignatureDate}
                advanced~
                equals~ true
            screenLabel~ !!! {_:screenLabel_physicianSignatureDate}
            value= {_:physicianSignatureDate}
            required~ {_:required_physicianSignatureDate}
            data-parsley-required= {_:required_physicianSignatureDate}
            placeHolder= {_:placeHolder_physicianSignatureDate}
            readOnly= true
              configureIf~ {_:readOnly_physicianSignatureDate}

          textArea physicianComment
            class= consentForm_{_:inputName_physicianComment}
            screenLabel~ !!! {_:screenLabel_physicianComment}
            value= {_:physicianComment}
            required~ {_:required_physicianComment}
            data-parsley-required= {_:required_physicianComment}
            placeHolder= {_:placeHolder_physicianComment}
            readOnly= true
              configureIf~ {_:readOnly_physicianComment}



### Authorization/Consent SQL###
    includeable orderEntry_consent_SQL

      ifCondition~ {_:showField_consentForm}
        advanced~
        equals~ true

        ifCondition {instance}
          advanced~
          not~
            equals~ View

          sqlPreparedStatement
            - UPDATE requestForms
            - SET
            - consent = ?,
            - patientSignature = ?,
            - patientSignatureDate = CASE ? WHEN '' THEN NULL ELSE ? END,
            - physicianSignature = ?,
            - physicianSignatureDate = CASE ? WHEN '' THEN NULL ELSE ? END,
            - physicianComment = ?,
            - eventId = ?,
            - consentBy = ?,
            - consenteePatientRelationship = ?
            - WHERE requestId = ?
            int {consent}
            int {patientSignature}
            string {patientSignatureDate}
            string {patientSignatureDate}
            int {physicianSignature}
            string {physicianSignatureDate}
            string {physicianSignatureDate}
            string {physicianComment}
            long {_eventId}
            string {consentBy}
            string {consenteePatientRelationship}
            string {_:requestId}



### Form 0 Order Search ###
    includeable orderEntry_orderSearchByPatient
      script
        src= js/orderEntry/orderSearch.js

      configurePreparedQuery~
        - SELECT
        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'requestId', fis.screenLabel, NULL) SEPARATOR '<br />') AS 'screenLabel_requestId',
        -
        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'externalRequestId', fis.showField, NULL)) AS 'show_externalRequestId',
        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'externalRequestId', fis.screenLabel, NULL) SEPARATOR '<br />') AS 'screenLabel_externalRequestId',
        -
        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'mrn', fis.showField, NULL)) AS 'show_mrn',
        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'mrn', fis.screenLabel, NULL) SEPARATOR '<br />') AS 'screenLabel_mrn',

        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'dob', fis.showField, NULL)) AS 'show_dob',
        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'dob', fis.screenLabel, NULL) SEPARATOR '<br />') AS 'screenLabel_dob',

        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'firstName', fis.showField, NULL)) AS 'show_firstName',
        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'firstName', fis.screenLabel, NULL) SEPARATOR '<br />') AS 'screenLabel_firstName',

        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'lastName', fis.screenLabel, NULL) SEPARATOR '<br />') AS 'screenLabel_lastName',

        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'geneticGender', fis.showField, NULL)) AS 'show_geneticGender',
        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'geneticGender', fis.screenLabel, NULL) SEPARATOR '<br />') AS 'screenLabel_geneticGender',

        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'govtId', fis.showField, NULL)) AS 'show_govtId',
        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'govtId', fis.screenLabel, NULL) SEPARATOR '<br />') AS 'screenLabel_govtId',

        -   GROUP_CONCAT(DISTINCT if(fp.inputName  = 'specimenId', fis.screenLabel, NULL) SEPARATOR '<br />') AS 'screenLabel_specimenId'

        - FROM formInputSettings fis
        - INNER JOIN formDefinition fd
        -   ON fd.id = fis.formDefinitionId
        - INNER JOIN formConfigurableParts fp
        -   ON fp.id = fis.formConfigurablePartsId
        - WHERE
        -   fd.formType = 'Accessioning'
        -   AND (fd.instance = ? or fd.instance = 'Receiving')
        string {_includeParm:instance}

      configurePreparedQuery~
        - SELECT
        -   CONCAT(' AS "',?,'"',
        -           ', p.lastName as "',?,'"',
        -           CASE ?
        -             WHEN 'false' THEN ''
        -             ELSE ', p.firstName AS "{_:screenLabel_firstName}"'
        -             END,
        -           CASE ?
        -             WHEN 'false' THEN ''
        -             ELSE ', p.dob AS "{_:screenLabel_dob}"'
        -             END,
        -           CASE ?
        -             WHEN 'false' THEN ''
        -             ELSE ', rf.mrn AS "{_:screenLabel_mrn}"'
        -             END,
        -           CASE ?
        -             WHEN 'false' THEN ''
        -             ELSE ', p.geneticGender AS "{_:screenLabel_geneticGender}"'
        -             END,
        -           CASE ?
        -             WHEN 'false' THEN ''
        -             ELSE ', rf.externalRequestId AS "{_:screenLabel_externalRequestId}"'
        -             END,
        -           ', GROUP_CONCAT(DISTINCT IFNULL(rs.specimenId,'''') SEPARATOR ''</br>'') AS "{_:screenLabel_specimenId}"',
        -           ', p.patientId as "Patient Id"',
        -           CASE ?
        -             WHEN 'false' THEN ''
        -             ELSE ', p.govtId AS "{_:screenLabel_govtId}"'
        -             END
        -   ) AS "selectColumns"
        string {_:screenLabel_requestId}
        string {_:screenLabel_lastName}
        string {_:show_firstName}
        string {_:show_dob}
        string {_:show_mrn}
        string {_:show_geneticGender}
        string {_:show_externalRequestId}
        string {_:show_govtId}

        #'''

      div
        class= hideDiv
        text dateFormat
          id= dateFormat
          value= {_dateShortFormat}

        textArea selectColumns
          value= {_:selectColumns}
          id= selectColumns

      vertical2
        text _recId
          screenLabel~ !!! {_:screenLabel_requestId}
          validate~ SELECT 1
            - FROM requestForms
            - WHERE requestId = ?
            string {_recId}
            errorMessage~ This order does not exist in the system.
          validate~ SELECT 1
            - FROM dual
            - WHERE NOT EXISTS (SELECT 1
            -                   FROM queues
            -                   WHERE containerId = ?
            -                   AND step = 'Order Review')
            - OR ? = 'View Order'
            string {_recId}
            string {_step}
            errorMessage~ Order is still queued for Order Review. Please edit in Order Review.
        div
          id= moveSubmitHere

      hr

      fieldset
        legend Order Search

        table
          verticalMode~
          thead
            tr
              th !!! {_:screenLabel_lastName}
              th !!! {_:screenLabel_firstName}
                configureIf~ {_:show_firstName}
                  advanced~
                  equals~ true
              th !!! {_:screenLabel_dob}
                configureIf~ {_:show_dob}
                  advanced~
                  equals~ true
              th !!! {_:screenLabel_mrn}
                configureIf~ {_:show_mrn}
                  advanced~
                  equals~ true
              th !!! {_:screenLabel_geneticGender}
                configureIf~ {_:show_geneticGender}
                  advanced~
                  equals~ true
              th !!! {_:screenLabel_externalRequestId}
                configureIf~ {_:show_externalRequestId}
                  advanced~
                  equals~ true
              th !!! {_:screenLabel_specimenId}
              th Patient Id
              th !!! {_:screenLabel_govtId}
                configureIf~ {_:show_govtId}
                  advanced~
                  equals~ true
          tbody
            tr
              td
                text lastName
                  screenLabel~
                  class= clearSearch
                  id= lastName
              td
                configureIf~ {_:show_firstName}
                  advanced~
                  equals~ true
                text firstName
                  screenLabel~
                  class= clearSearch
                  id= firstName
              td
                configureIf~ {_:show_dob}
                  advanced~
                  equals~ true
                date dob
                  screenLabel~
                  class= clearSearch datePickerDOB
                  id= dob
              td
                configureIf~ {_:show_mrn}
                  advanced~
                  equals~ true
                text mrn
                  screenLabel~
                  class= clearSearch
                  id= mrn
              td
                configureIf~ {_:show_geneticGender}
                  advanced~
                  equals~ true
                text geneticGender
                  screenLabel~
                  class= clearSearch
                  id= geneticGender
              td
                configureIf~ {_:show_externalRequestId}
                  advanced~
                  equals~ true
                text externalRequestId
                  screenLabel~
                  class= clearSearch
                  id= externalRequestId
              td
                text specimenId
                  screenLabel~
                  class= clearSearch
                  id= specimenId
              td
                text patientId
                  screenLabel~
                  class= clearSearch
                  id= patientId
              td
                configureIf~ {_:show_govtId}
                  advanced~
                  equals~ true
                text govtId
                  screenLabel~
                  class= clearSearch
                  id= govtId

        br

        vertical2

          button Search
            id= searchOrders


          button Clear Search
            id= clearSearch


      fieldset
        legend Search Result
        id= searchHeader
        div
          id= orderSearchResults






