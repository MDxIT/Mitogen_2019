config
  includes

    includeable testPlateInclude
      rows 3
      cols 3
      inputType select




    includeable nicEditor
      script
        src= js/niceedit/nicEdit.js

    includeable combobox
      script
        - $(document).ready(function(){$('.combobox').combobox();});

    includeable hideScript
      script
        - $(document).ready(function(){
        -   $('th:contains("Hidden")').addClass('hide');
        -   $('.hide').parent().siblings('.label').addClass('hide');
        -   $('.inputTabelColHide').parent('td').addClass('hide');
        -   $('.hide').hide();
        - });

    includeable d3
      script
        src= js/d3/d3.min.js

    includeable jit
      script
        src= js/jit-yc.js

    includeable highcharts
      script
        scr= https://code.highcharts.com/highcharts.js
      script
        src= js/highcharts/highcharts-all.js
      script
        scr= https://code.highcharts.com/highcharts-more.js
      script
        scr= https://code.highcharts.com/highcharts-3d.js
      script
        src= js/highcharts/themes/grid-light.js
      script
        src= js/highcharts/modules/exporting.js
      script
        src= js/highcharts/uniflowcharts.js

    includeable jstabs
      script $(document).ready(function(){ $('#tabpanel > ul').tabs(); });

    includeable jsResourceValidations
      script
        - $(document).ready(function() {
        -  $('form').on('change', 'input.resources', function() {
        -   var resourceInput = this;
        -   if ($(this).hasClass('Reagent')) {
        -     checkResource($(this).val(),$(this).parent().siblings().children('.type').val(), 'Reagent QC', $(this).attr('name'), resourceInput);
        -   } else if ($(this).hasClass('Control')){
        -     checkCtlResource($(this).val(), $(this).parent().siblings().children('.type').val(), 'Control QC', $(this).attr('name'), resourceInput);
        -   } else if ($(this).hasClass('Consumable')){
        -     checkConsumableType($(this).val(),$(this).parent().siblings().children('.type').val(), $(this).attr('name'), resourceInput);
        -   } else if ($(this).hasClass('Instrument')){
        -     checkInstrument($(this).val(),$(this).parent().siblings().children('.type').val(), $(this).attr('name'),resourceInput );
        -   } else if ($(this).hasClass('qcReagent')){
        -     checkResource($(this).val(), $(this).parent().siblings().children('.type').val(), 'NEEDS QC', $(this).attr('name'), resourceInput);
        -   } else if ($(this).hasClass('qcControl')){
        -     checkCtlResource($(this).val(), $(this).parent().siblings().children('.type').val(), 'NEEDS QC', $(this).attr('name'), resourceInput);
        -   }
        -  });
        - });
        - function checkResource(containerId, type, qualification, name, resourceInput) {
        -      var aliquot;
        -      var dilution;
        -      var resourceInput = resourceInput;
        -     $.getJSON('/uniflow?callback=?&stepName=Ajax+Get+Reagent+Qualification&qualification='+ qualification+'&containerId=' + containerId,{},
        -    function(data,status)
        -    {
        -         if(data[0].qualification == qualification && data[0].type == type && data[0].expDate > data[0].todayDate)
        -         {
        -             $('[name^="'+name+'"]').parent().css("background-color", "PaleGreen");
        -         }
        -         if(data[0].qualification != qualification)
        -         {
        -              $('[name^='+name+']').parent().css("background-color", "Red");
        -              $('#qualError').empty();
        -              $('#qualError').append("<p>THIS REAGENT EITHER DOES NOT HAVE A QUALIFICATION OR THE QUALIFICATION IS EXPIRED!</p> " +
        -                 "<p> PLEASE LOOKUP THE REAGENT UNDER THE REAGENT MANAGEMENT STEPGROUP TO SEE DETAILS.</p>");
        -              $('#qualError').dialog({'width': '250','height': '250', 'position': {my: 'top', at: 'bottom', of: resourceInput}}).show();
        -         }
        -         if(data[0].type != type)
        -         {
        -             $('[name^='+name+']').parent().css("background-color", "Red");
        -             $('#typeError').empty();
        -             $('#typeError').append("<p>THE REAGENT SCANNED IS NOT " + type + ".</p><p> IT IS "+data[0].type+". </p><p>PLEASE SCAN IN THE CORRECT REAGENT TYPE</p>");
        -             $('#typeError').dialog({'width': '250','height': '250', 'position': {my: 'top', at: 'bottom', of: resourceInput}}).show();
        -         }
        -         if(data[0].expDate < data[0].todayDate)
        -         {
        -              $('[name^='+name+']').parent().css("background-color", "Red");
        -              $('#expError').empty();
        -              $('#expError').append("<p>THIS REAGENT HAS EXPIRED! PLEASE DISCARD OR SEE A MANAGER.</p>");
        -              $('#expError').dialog({'width': '250','height': '250', 'position': {my: 'top', at: 'bottom', of: resourceInput}}).show();
        -         }
        -    });
        - }
        - function checkCtlResource(containerId, type, qualification, name, resourceInput) {
        -      var aliquot;
        -      var dilution;
        -      var resourceInput = resourceInput;
        -     $.getJSON('/uniflow?callback=?&stepName=Ajax+Get+Control+Qualification&qualification='+ qualification+'&containerId=' + containerId,{},
        -    function(data,status)
        -    {
        -         if(data[0].qualification == qualification && data[0].type == type && data[0].expDate > data[0].todayDate)
        -         {
        -             $('[name^="'+name+'"]').parent().css("background-color", "PaleGreen");
        -         }
        -         if(data[0].qualification != qualification)
        -         {
        -              $('[name^='+name+']').parent().css("background-color", "Red");
        -              $('#qualError').empty();
        -              $('#qualError').append("<p>THIS CONTROL EITHER DOES NOT HAVE A QUALIFICATION OR THE QUALIFICATION IS EXPIRED!</p> " +
        -                 "<p> PLEASE LOOKUP THE CONTROL UNDER THE CONTROL MANAGEMENT STEPGROUP TO SEE DETAILS.</p>");
        -              $('#qualError').dialog({'width': '250','height': '250', 'position': {my: 'top', at: 'bottom', of: resourceInput}}).show();
        -         }
        -         if(data[0].type != type)
        -         {
        -             $('[name^='+name+']').parent().css("background-color", "Red");
        -             $('#typeError').empty();
        -             $('#typeError').append("<p>THE CONTROL SCANNED IS NOT " + type + ".</p><p> IT IS "+data[0].type+". </p><p>PLEASE SCAN IN THE CORRECT CONTROL TYPE</p>");
        -             $('#typeError').dialog({'width': '250','height': '250', 'position': {my: 'top', at: 'bottom', of: resourceInput}}).show();
        -         }
        -         if(data[0].expDate < data[0].todayDate)
        -         {
        -              $('[name^='+name+']').parent().css("background-color", "Red");
        -              $('#expError').empty();
        -              $('#expError').append("<p>THIS CONTROL HAS EXPIRED! PLEASE DISCARD OR SEE A MANAGER.</p>");
        -              $('#expError').dialog({'width': '250','height': '250', 'position': {my: 'top', at: 'bottom', of: resourceInput}}).show();
        -         }
        -    });
        - }
        - function checkInstrument(containerId, type, name, resourceInput)
        - {
        -      var resourceInput = resourceInput;
        -     $.getJSON('/uniflow?callback=?&stepName=Ajax+Get+Instrument+Qualification&containerId=' + containerId,{},
        -    function(data,status)
        -    {
        -        if(data[0].type == type && data[0].qualification == 'QUALIFIED')
        -        {
        -             $('[name^='+name+']').parent().css("background-color", "PaleGreen");
        -        }
        -        if(data[0].qualification != 'QUALIFIED')
        -         {
        -              $('[name^='+name+']').parent().css("background-color", "Red");
        -              $('#qualError').empty();
        -              $('#qualError').append("<p>THIS INSTRUMENT DOES NOT HAVE A QUALIFICATION OR IS EXPIRED!</p> " +
        -                 "<p> PLEASE LOOKUP THE INSTRUMENT UNDER THE INSTRUMENT MANAGEMENT STEPGROUP TO SEE DETAILS.</p>");
        -               $('#qualError').dialog({'width': '250','height': '250', 'position': {my: 'top', at: 'bottom', of: resourceInput}}).show();
        -         }
        -        if(data[0].type != type)
        -         {
        -             $('[name^='+name+']').parent().css("background-color", "Red");
        -             $('#typeError').empty();
        -             $('#typeError').append("<p>THE INSTRUMENT SCANNED IS NOT " + type + ".</p>"
        -               + "<p> IT IS "+ data[0].type+".</p><p> PLEASE SCAN IN THE CORRECT INSTRUMENT.</p>");
        -             $('#typeError').dialog({'width': '250','height': '250', 'position': {my: 'top', at: 'bottom', of: resourceInput}}).show();
        -         }
        -        if(data[0].status != 'In Service')
        -         {
        -             $('[name^='+name+']').parent().css("background-color", "Red");
        -             $('#expError').empty();
        -             $('#expError').append("<p>THE INSTRUMENT SCANNED IS NOT IN SERVICE.</p><p> IT IS CURRENTLY SET TO " + data[0].status + ".</p>");
        -             $('#expError').dialog({'width': '250','height': '250', 'position': {my: 'top', at: 'bottom', of: resourceInput}}).show();
        -         }
        -    });
        - }
        - function checkConsumableType (containerId, type, name, resourceInput)
        - {
        -      var resourceInput = resourceInput;
        -     $.getJSON('/uniflow?callback=?&stepName=Ajax+Get+Consumable+Type&containerId=' + containerId,{},
        -    function(data,status)
        -    {
        -        if(data[0].type == type)
        -        {
        -             $('[name^='+name+']').parent().css("background-color", "PaleGreen");
        -        }
        -        if(data[0].type != type)
        -         {
        -             $('[name^='+name+']').parent().css("background-color", "Red");
        -             $('#typeError').empty();
        -             $('#typeError').append("<p>THE CONSUMABLE SCANNED IS NOT " + type + ".</p><p> IT IS " + data[0].type + ".</p><p> PLEASE SCAN IN THE CORRECT CONSUMABLE.</p>");
        -             $('#typeError').dialog({'width': '250','height': '250', 'position': {my: 'top', at: 'bottom', of: resourceInput}}).show();
        -         }
        -         if(data[0].expDate < data[0].todayDate)
        -         {
        -              $('[name^='+name+']').parent().css("background-color", "Red");
        -              $('#expError').empty();
        -              $('#expError').append("<p>THIS CONSUMABLE HAS EXPIRED! PLEASE DISCARD OR SEE A MANAGER.</p>");
        -              $('#expError').dialog({'width': '250','height': '250', 'position': {my: 'top', at: 'bottom', of: resourceInput}}).show();
        -         }
        -
        -     });
        - }


    includeable resourceTable
      script
        - $(document).ready(function() {
        -  $('#accordion').accordion({
        -     collapsible: true,
        -     heightStyle: 'content'
        -   });
        -   $('#resources').hide();
        -   $('#typeError').hide();
        -   $('#qualError').hide();
        -   $('#expError').hide();
        -
        -      var headers = $('#accordion h3.ui-accordion-header');
        -      $('.ui-accordion-header-icon', headers).removeClass('ui-icon-triangle-1-e').addClass('ui-icon-triangle-1-s');
        -      headers.next().slideDown();
        -      var qcHeader1 = $('#accordion h3.qcReagents');
        -      var qcHeader2 = $('#accordion h3.qcControls');
        -      qcHeader1.next().slideUp();
        -      qcHeader2.next().slideUp();
        -
        -   var reagentTable = $("#reagentResources tbody");
        -   var controlsTable = $("#controlResources tbody");
        -   var instrumentTable = $("#instrumentResources tbody");
        -   var consumableTable = $("#consumableResources tbody");
        -   var qcReagentsTable = $("#qcReagents tbody");
        -   var qcControlsTable = $("#qcControls tbody");
        -   var noneCount = 0;
        -
        -   if (reagentTable.children().length == 0) {
        -     $('.reagents').hide();
        -     noneCount += 1;
        -   }
        -   if (controlsTable.children().length == 0) {
        -     $('.controls').hide();
        -     noneCount += 1;
        -   }
        -   if (instrumentTable.children().length == 0) {
        -     $('.instruments').hide();
        -     noneCount += 1;
        -   }
        -   if (consumableTable.children().length == 0) {
        -     $('.consumables').hide();
        -     noneCount += 1;
        -   }
        -   if (qcReagentsTable.children().length == 0) {
        -     $('.qcReagents').hide();
        -     noneCount += 1;
        -   }
        -   if (qcControlsTable.children().length == 0) {
        -     $('.qcControls').hide();
        -     noneCount += 1;
        -   }
        -   if (noneCount == 6) {
        -     $('#noResourcesMessage').show();
        -     $('#confirmResources').hide();
        -   }
        - });
        - function setResourceList() {
        -  $('#resources').hide();
        -  $('#resourceList').empty();
        -  $('#reagentResources > tbody  > tr').each(function() {
        -       var resource = $(this).find('.resource').val();
        -       var type = $(this).find('.type').val();
        -       if (resource != '') {$('#resourceList').append('<span>'+resource+' - '+type+'</span></br>');}
        -   });
        -  $('#consumableResources > tbody  > tr').each(function() {
        -       var resource = $(this).find('.resource').val();
        -       var type = $(this).find('.type').val();
        -       if (resource != '') {$('#resourceList').append('<span>'+resource+' - '+type+'</span></br>');}
        -   });
        -  $('#qcResources > tbody  > tr').each(function() {
        -       var resource = $(this).find('.resource').val();
        -       var type = $(this).find('.type').val();
        -       if (resource != '') {$('#resourceList').append('<span>'+resource+' - '+type+'</span></br>');}
        -   });
        -  $('#instrumentResources > tbody  > tr').each(function() {
        -       var resource = $(this).find('.resource').val();
        -       var type = $(this).find('.type').val();
        -       if (resource != '') {$('#resourceList').append('<span>'+resource+' - '+type+'</span></br>');}
        -   });
        -  $('#controls > tbody  > tr').each(function() {
        -       var resource = $(this).find('.resource').val();
        -       var type = $(this).find('.type').val();
        -       if (resource != '') {$('#resourceList').append('<span>'+resource+' - '+type+'</span></br>');}
        -   });
        -  $('#qcControls > tbody  > tr').each(function() {
        -       var resource = $(this).find('.resource').val();
        -       var type = $(this).find('.type').val();
        -       if (resource != '') {$('#resourceList').append('<span>'+resource+' - '+type+'</span></br>');}
        -   });
        -   $('#resourceList').show();
        - }

      vertical
        div
          class= resourceButton
          span Resources
          onclick= $('#resources').toggle(); $('#resourceList').hide();
        div
          id= resourceList
          style= display:none;border-radius:5px;padding:10px;background-color:#C1FDC1; color:#000000;
        div
          id= typeError
          title= Resource Type Error
          style= display:none;
        div
          id= qualError
          title= Qualification Error
          style= display:none;
        div
          id= expError
          title= Expiration Date Error
          style= display:none;
        div
          id= resources
          style= margin-bottom:25px; padding-bottom:15px;  border-bottom:1px solid #eee;
          div
            id= accordion
            h3 REAGENTS
              class= reagents
            div
              class= reagents
              vertical
                table
                  class= reagents
                  id= reagentResources
                  caption REAGENTS
                  sqlQuery~ select u.inventoryItem as 'Reagent', '' as 'Barcode',
                    - u.amount as 'Amount', u.units as 'Units'
                    - from inventoryUsage u
                    - inner join inventoryItems i on u.inventoryItem = i.inventoryItem
                    - where u.step = '{_step}' and (i.inventoryType = 'Received Reagent' or i.inventoryType = 'Prepared Reagent')
                  columnSpecs~ reagents
                    allowChangedRecordIds
                    column 1
                      inputType text
                        class= type text
                        size= 50
                        readonly=
                        style= border:none; background:transparent;
                        tabIndex= 3
                    column 2
                      inputType resource
                        class= resource Reagent resources
                        required~ false
                        qualifyResource~ Reagent QC
                        tabIndex= 1
                        validate~ ! select reagentType from reagents where reagentId = '{_columnInput:2}'
                          - and reagentType <> '{_columnInput:1}'
                          - and '{_columnInput:2}' <> ''
                          errorMessage~ This reagent does not match the Reagent Type! Check again.
                        sqlPreparedStatement~ update inventoryItems
                          - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                          - where inventoryItem = ?
                          - and ? <> ''
                          float {_columnInput:3}
                          string {_columnInput:1}
                          string {_columnInput:2}
                        sqlPreparedStatement~ update reagents
                          - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                          - where reagentId = ?
                          - and ? <> ''
                          float {_columnInput:3}
                          string {_columnInput:2}
                          string {_columnInput:2}
                        sqlPreparedStatement~ update reagents
                          - set openDate = curDate()
                          - where reagentId = ?
                          - and openDate IS NULL
                          - and ? <> ''
                          string {_columnInput:2}
                          string {_columnInput:2}
                    column 3
                      inputType text
                        class= text amount
                        tabIndex= 2
            h3 CONTROLS
              class= controls
            div
              class= controls
              vertical
                table
                  id= controlResources
                  class= resource controls
                  caption Controls
                  sqlQuery~ select u.inventoryItem as 'Control', '' as 'Barcode',
                    - u.amount as 'Amount', u.units as 'Units'
                    - from inventoryUsage u
                    - inner join inventoryItems i on u.inventoryItem = i.inventoryItem
                    - where u.step = '{_step}'
                    - and (i.inventoryType = 'Received Control' or i.inventoryType = 'Prepared Control')
                  columnSpecs~ controls
                    allowChangedRecordIds
                    column 1
                      inputType text
                        class= type text
                        size= 50
                        readonly=
                        style= border:none; background:transparent;
                        tabIndex= 3
                    column 2
                      inputType resource
                        class= resource Control resources
                        required~ false
                        qualifyResource~ Control QC
                        tabIndex= 1
                        validate~ ! select controlType from controls where controlId = '{_columnInput:2}'
                          - and controlType <> '{_columnInput:1}'
                          - and '{_columnInput:2}' <> ''
                          errorMessage~ This control does not match the Control Type! Check again.
                        sqlPreparedStatement~ update inventoryItems
                          - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                          - where inventoryItem = ?
                          - and ? <> ''
                          float {_columnInput:3}
                          string {_columnInput:1}
                          string {_columnInput:2}
                        sqlPreparedStatement~ update controls
                          - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                          - where controlId = ?
                          - and ? <> ''
                          float {_columnInput:3}
                          string {_columnInput:2}
                          string {_columnInput:2}
                        sqlPreparedStatement~ update controls
                          - set openDate = curDate()
                          - where controlId = ?
                          - and openDate IS NULL
                          - and ? <> ''
                          string {_columnInput:2}
                          string {_columnInput:2}
                    column 3
                      inputType text
                        class= text amount
                        tabIndex= 2
            h3 CONSUMABLES
              class= consumables
            div
              class= consumables
              vertical
                table
                  class= consumables
                  id= consumableResources
                  caption CONSUMABLES
                  sqlQuery~ select u.inventoryItem as 'Consumable', '' as 'Barcode',
                    - u.amount as 'Amount', u.units as 'Units'
                    - from inventoryUsage u
                    - inner join inventoryItems i on u.inventoryItem = i.inventoryItem
                    - where u.step = '{_step}' and i.inventoryType = 'Consumable'
                  columnSpecs~ consumables
                    allowChangedRecordIds
                    column 1
                      inputType text
                        class= type text
                        size= 50
                        readonly=
                        style= border:none; background:transparent;
                        tabIndex= 3
                    column 2
                      inputType resource
                        class= resource Consumable resources
                        required~ false
                        tabIndex= 1
                        sqlPreparedStatement~ update inventoryItems
                          - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                          - where inventoryItem = ?
                          - and ? <> ''
                          float {_columnInput:3}
                          string {_columnInput:1}
                          string {_columnInput:2}
                        sqlPreparedStatement~ update consumables
                          - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                          - where consumableId = ?
                          - and ? <> ''
                          float {_columnInput:3}
                          string {_columnInput:2}
                          string {_columnInput:2}
                        validate~ ! select consumableType from consumables where consumableId = '{_columnInput:2}'
                          - and consumableType <> '{_columnInput:1}'
                          - and '{_columnInput:2}' <> ''
                          errorMessage~ This consumable does not match the Consumable Type! Check again.
                    column 3
                      inputType text
                        class= text amount
                        tabIndex= 2
            h3 INSTRUMENTS
              class= instruments
            div
              class= instruments
              vertical
                table
                  class= instruments
                  id= instrumentResources
                  caption INSTRUMENTS
                  sqlQuery~ select u.inventoryItem as 'Instrument', '' as 'Barcode'
                    - from inventoryUsage u
                    - where u.step = '{_step}'
                    - and u.inventoryItem IN (select DISTINCT instrumentType from instruments)
                  columnSpecs~ instruments
                    allowChangedRecordIds
                    column 1
                      inputType text
                        class= type text
                        size= 50
                        readonly=
                        style= border:none; background:transparent;
                        tabIndex= 3
                    column 2
                      inputType resource
                        class= resource Instrument resources
                        required~ false
                        tabIndex= 1
                        validate~ ! select qualification from qualifications
                          - where containerId = '{_columnInput:2}' and expirationDate <= curDate()
                          - and (step = '{_step}' or step = '*ALL*') and '{_columnInput:2}' <> ''
                          errorMessage~ THIS INSTRUMENT IS NOT VALID!
                        validate~ ! select status from instruments
                          - where instrumentId = '{_columnInput:2}' and status <> 'In Service' and '{_columnInput:2}' <> ''
                          errorMessage~ THIS INSTRUMENT IS NOT IN SERVICE.  YOU CAN PUT IT BACK IN SERVICE WITH THE CHANGE INSTRUMENT STATUS STEP.
                        validate~ ! select instrumentType from instruments where instrumentId = '{_columnInput:2}'
                          - and instrumentType <> '{_columnInput:1}'
                          - and '{_columnInput:2}' <> ''
                          errorMessage~ This instrument does not match the Instrument Type! Check again.

            h3 QC REAGENTS
              class= qcReagents
            div
              class= qcReagents QC
              vertical
                table
                  class= qcReagents
                  id= qcReagents
                  caption QC Reagents
                  sqlQuery~ select u.inventoryItem as 'Reagent', '' as 'Barcode',
                    - u.amount as 'Amount', u.units as 'Units'
                    - from inventoryUsage u
                    - inner join inventoryItems i on u.inventoryItem = i.inventoryItem
                    - where u.step = '{_step}'
                    - and (i.inventoryType = 'Received Reagent' or i.inventoryType = 'Prepared Reagent')
                  columnSpecs~ qcReagents
                    allowChangedRecordIds
                    column 1
                      inputType text
                        class= type text
                        size= 50
                        readonly=
                        style= border:none; background:transparent;
                        tabIndex= 3
                    column 2
                      inputType resource
                        class= resource qcReagent resources
                        required~ false
                        qualifyResource~ NEEDS QC
                        tabIndex= 1
                        validate~ ! select reagentType from reagents where reagentId = '{_columnInput:2}'
                          - and reagentType <> '{_columnInput:1}'
                          - and '{_columnInput:2}' <> ''
                          errorMessage~ This reagent does not match the Reagent Type! Check again.
                        sqlPreparedStatement~ update inventoryItems
                          - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                          - where inventoryItem = ?
                          - and ? <> ''
                          float {_columnInput:3}
                          string {_columnInput:1}
                          string {_columnInput:2}
                        sqlPreparedStatement~ update reagents
                          - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                          - where reagentId = ?
                          - and ? <> ''
                          float {_columnInput:3}
                          string {_columnInput:2}
                          string {_columnInput:2}
                        sqlPreparedStatement~ update reagents
                          - set openDate = curDate()
                          - where reagentId = ?
                          - and openDate IS NULL
                          - and ? <> ''
                          string {_columnInput:2}
                          string {_columnInput:2}
                    column 3
                      inputType text
                        class= text amount
                        tabIndex= 2
            h3 QC CONTROLS
              class= qcControls QC
            div
              class= qcControls
              vertical
                table
                  class= qcControls
                  id= qcControls
                  caption QC Controls
                  sqlQuery~ select u.inventoryItem as 'Control', '' as 'Barcode',
                    - u.amount as 'Amount', u.units as 'Units'
                    - from inventoryUsage u
                    - inner join inventoryItems i on u.inventoryItem = i.inventoryItem
                    - where u.step = '{_step}'
                    - and (i.inventoryType = 'Received Control' or i.inventoryType = 'Prepared Control')
                  columnSpecs~ qcControls
                    allowChangedRecordIds
                    column 1
                      inputType text
                        class= type text
                        size= 50
                        readonly=
                        style= border:none; background:transparent;
                        tabIndex= 3
                    column 2
                      inputType resource
                        class= resource qcControl resources
                        required~ false
                        qualifyResource~ NEEDS QC
                        tabIndex= 1
                        validate~ ! select controlType from controls where controlId = '{_columnInput:2}'
                          - and controlType <> '{_columnInput:1}'
                          - and '{_columnInput:2}' <> ''
                          errorMessage~ This control does not match the Control Type! Check again.
                        sqlPreparedStatement~ update inventoryItems
                          - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                          - where inventoryItem = ?
                          - and ? <> ''
                          float {_columnInput:3}
                          string {_columnInput:1}
                          string {_columnInput:2}
                        sqlPreparedStatement~ update controls
                          - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                          - where controlId = ?
                          - and ? <> ''
                          float {_columnInput:3}
                          string {_columnInput:2}
                          string {_columnInput:2}
                        sqlPreparedStatement~ update controls
                          - set openDate = curDate()
                          - where controlId = ?
                          - and openDate IS NULL
                          - and ? <> ''
                          string {_columnInput:2}
                          string {_columnInput:2}
                    column 3
                      inputType text
                        class= text amount
                        tabIndex= 2
          div
            id= noResourcesMessage
            style= border:1px solid #1C92C1; padding:5px; color:#1C92C1; display:none;
            vertical
              span <b>NO RESOURCES HAVE BEEN ASSIGNED TO THIS TASK.</b>
              span Please click <a href= "/uniflow?stepName=Setup+Inventory+Usage+By+Task&taskName={_step}" target= "_blank">HERE</a> to setup resources for this task.
          div
            style= margin-top:10px;
            vertical
              button
                id= confirmResources
                value= Confirm Resources
                onclick= setResourceList();

    includeable resourceTable2
      script
        - $(document).ready(function() {

        -   // Get rid of empty tables before accordion is created
        -   $('#reagentResources, #controls, #consumableResources, #instrumentResources').each(function(){
        -         if($(this).find('tbody tr').length == 0) {
        -           $(this).parent().prev().remove();
        -           $(this).parent().remove();
        -         }
        -       });

        -   $('#typeError').hide();
        -   $('#qualError').hide();
        -   $('#expError').hide();
        -   $('#dneError').hide();
        -   $('#requiredError').hide();
        - });

      script
        - function toggleAccordion(headerSelected) {
        -      $(headerSelected).toggleClass("ui-accordion-header-active ui-state-active ui-state-default ui-corner-bottom")
        -        .find("> .ui-icon").toggleClass("ui-icon-triangle-1-e ui-icon-triangle-1-s").end()
        -        .next().slideToggle();
        -    }
        -
      script
        - function checkResource(containerId, type, qualification, name) {
        -     if(containerId == '') {return 'true'};
        -      var aliquot;
        -      var dilution;
        -     $.getJSON('/uniflow?callback=?&stepName=Ajax+Get+Reagent+Qualification&qualification='+ qualification+'&containerId=' + containerId,{},
        -    function(data,status){
        -         var passed = 'true';
        -         if(data[0].containerId.trim() == ''){
        -              $('[name^='+name+']').parent().css("background-color", "Red");
        -              $('#dneError').empty();
        -              $('#dneError').append("<p>THIS BARCODE DOES NOT EXIST IN THE SYSTEM.</p>");
        -              $('#dneError').dialog().show();
        -              passed = 'false';
        -         } else {
        -           if(data[0].qualification == qualification && data[0].type == type && data[0].expDate > data[0].todayDate){
        -               $('[name^="'+name+'"]').parent().css("background-color", "PaleGreen");
        -           }
        -           if(data[0].qualification != qualification){
        -                $('[name^='+name+']').parent().css("background-color", "Red");
        -                $('#qualError').empty();
        -                $('#qualError').append("<p>THIS REAGENT EITHER DOES NOT HAVE A QUALIFICATION OR THE QUALIFICATION IS EXPIRED!</p> " +
        -                   "<p> PLEASE LOOKUP THE REAGENT UNDER THE REAGENT MANAGEMENT STEPGROUP TO SEE DETAILS.</p>");
        -                $('#qualError').dialog().show();
        -              passed = 'false';
        -           }
        -           if(data[0].type != type){
        -               $('[name^='+name+']').parent().css("background-color", "Red");
        -               $('#typeError').empty();
        -               $('#typeError').append("<p>THE REAGENT SCANNED IS NOT " + type + ".</p><p> IT IS "+data[0].type+". </p><p>PLEASE SCAN IN THE CORRECT REAGENT TYPE</p>");
        -               $('#typeError').dialog().show();
        -              passed = 'false';
        -           }
        -           if(data[0].expDate < data[0].todayDate){
        -                $('[name^='+name+']').parent().css("background-color", "Red");
        -                $('#expError').empty();
        -                $('#expError').append("<p>THIS REAGENT HAS EXPIRED! PLEASE DISCARD OR SEE A MANAGER.</p>");
        -                $('#expError').dialog().show();
        -              passed = 'false';
        -           }
        -       }
        -       return passed;
        -    });
        - }
      script
        - function checkCtlResource(containerId, type, qualification, name) {
        -     if(containerId == '') {return 'true'};
        -      var aliquot;
        -      var dilution;
        -     var ispassed = 'true';
        -     $.getJSON('/uniflow?callback=?&stepName=Ajax+Get+Control+Qualification&qualification='+ qualification+'&containerId=' + containerId,{},
        -    function(data,status){
        -       console.log(data)
        -         if(data[0].containerId.trim() == ''){
        -              $('[name^='+name+']').parent().css("background-color", "Red");
        -              $('#dneError').empty();
        -              $('#dneError').append("<p>THIS BARCODE DOES NOT EXIST IN THE SYSTEM.</p>");
        -              $('#dneError').dialog().show();
        -              ispassed = 'false';
        -         } else {
        -           if(data[0].qualification == qualification && data[0].type == type && data[0].expDate > data[0].todayDate){
        -               $('[name^="'+name+'"]').parent().css("background-color", "PaleGreen");
        -           }
        -           if(data[0].qualification != qualification){
        -                $('[name^='+name+']').parent().css("background-color", "Red");
        -                $('#qualError').empty();
        -                $('#qualError').append("<p>THIS CONTROL EITHER DOES NOT HAVE A QUALIFICATION OR THE QUALIFICATION IS EXPIRED!</p> " +
        -                   "<p> PLEASE LOOKUP THE CONTROL UNDER THE CONTROL MANAGEMENT STEPGROUP TO SEE DETAILS.</p>");
        -                $('#qualError').dialog().show();
        -                ispassed = 'false';
        -           }
        -           if(data[0].type != type){
        -               $('[name^='+name+']').parent().css("background-color", "Red");
        -               $('#typeError').empty();
        -               $('#typeError').append("<p>THE CONTROL SCANNED IS NOT " + type + ".</p><p> IT IS "+data[0].type+". </p><p>PLEASE SCAN IN THE CORRECT CONTROL TYPE</p>");
        -               $('#typeError').dialog().show();
        -                ispassed = 'false';
        -           }
        -           if(data[0].expDate < data[0].todayDate){
        -                $('[name^='+name+']').parent().css("background-color", "Red");
        -                $('#expError').empty();
        -                $('#expError').append("<p>THIS CONTROL HAS EXPIRED! PLEASE DISCARD OR SEE A MANAGER.</p>");
        -                $('#expError').dialog().show();
        -                ispassed = 'false';
        -           }
        -         }
        -       return ispassed;
        -    });
        - }
      script
        - function setResourceList() {
        -  $('#reagentResources > tbody  > tr').each(function() {
        -       var resource = $(this).find('.resource').val();
        -       var resourceName = $(this).find('.resource').attr('name');
        -       var type = $(this).find('.type').val();
        -       if (resource != '') {
        -         checkResource(resource,type, 'Reagent QC', resourceName);
        -       }
        -   });
        -  $('#consumableResources > tbody  > tr').each(function() {
        -       var resource = $(this).find('.resource').val();
        -       var type = $(this).find('.type').val();
        -       var resourceName = $(this).find('.resource').attr('name');
        -       if (resource != '') {
        -         checkConsumableType(resource,type, resourceName );
        -       }
        -   });
        -  $('#instrumentResources > tbody  > tr').each(function() {
        -       var resource = $(this).find('.resource').val();
        -       var resourceName = $(this).find('.resource').attr('name');
        -       var type = $(this).find('.type').val();
        -       if (resource != '') {
        -         checkInstrument(resource,type, resourceName );
        -       }
        -   });
        -  $('#controls > tbody  > tr').each(function() {
        -       var resource = $(this).find('.resource').val();
        -       var type = $(this).find('.type').val();
        -       var resourceName = $(this).find('.resource').attr('name');
        -       if (resource != '') {
        -         checkCtlResource(resource,type, 'Control QC', resourceName )
        -       }
        -   });
        - }
      script
        - function checkInstrument(containerId, type, name)
        - {
        -     if(containerId == '') {return 'true'};
        -     $.getJSON('/uniflow?callback=?&stepName=Ajax+Get+Instrument+Qualification&containerId=' + containerId,{},
        -    function(data,status)
        -    {
        -         var ispassed = 'true';
        -         if(data[0].containerId.trim() == ''){
        -              $('[name^='+name+']').parent().css("background-color", "Red");
        -              $('#dneError').empty();
        -              $('#dneError').append("<p>THIS BARCODE DOES NOT EXIST IN THE SYSTEM.</p>");
        -              $('#dneError').dialog().show();
        -              ispassed = 'false';
        -         } else {
        -          if(data[0].type == type && data[0].qualification == 'QUALIFIED'){
        -               $('[name^='+name+']').parent().css("background-color", "PaleGreen");
        -          }
        -          if(data[0].qualification != 'QUALIFIED'){
        -                $('[name^='+name+']').parent().css("background-color", "Red");
        -                $('#qualError').empty();
        -                $('#qualError').append("<p>THIS INSTRUMENT DOES NOT HAVE A QUALIFICATION OR IS EXPIRED!</p> " +
        -                   "<p> PLEASE LOOKUP THE INSTRUMENT UNDER THE INSTRUMENT MANAGEMENT STEPGROUP TO SEE DETAILS.</p>");
        -                 $('#qualError').dialog().show();
        -              ispassed = 'false';
        -           }
        -          if(data[0].type != type){
        -               $('[name^='+name+']').parent().css("background-color", "Red");
        -               $('#typeError').empty();
        -               $('#typeError').append("<p>THE INSTRUMENT SCANNED IS NOT " + type + ".</p>"
        -                 + "<p> IT IS "+ data[0].type+".</p><p> PLEASE SCAN IN THE CORRECT INSTRUMENT.</p>");
        -               $('#typeError').dialog().show();
        -              ispassed = 'false';
        -           }
        -          if(data[0].status != 'In Service'){
        -               $('[name^='+name+']').parent().css("background-color", "Red");
        -               $('#expError').empty();
        -               $('#expError').append("<p>THE INSTRUMENT SCANNED IS NOT IN SERVICE.</p><p> IT IS CURRENTLY SET TO " + data[0].status + ".</p>");
        -               $('#expError').dialog().show();
        -              ispassed = 'false';
        -           }
        -         }
        -      console.log('validation', ispassed)
        -      return ispassed;
        -    });
        - }
        -
      script
        - function checkConsumableType (containerId, type, name)
        - {
        -     var ispassed = 'true';
        -     if(containerId == '') {return ispassed}
        -     $.getJSON('/uniflow?callback=?&stepName=Ajax+Get+Consumable+Type&containerId=' + containerId,{},
        -    function(data,status){
        -         if(data[0].containerId.trim() == ''){
        -              $('[name^='+name+']').parent().css("background-color", "Red");
        -              $('#dneError').empty();
        -              $('#dneError').append("<p>THIS BARCODE DOES NOT EXIST IN THE SYSTEM.</p>");
        -              $('#dneError').dialog().show();
        -              ispassed = 'false';
        -         } else {
        -          if(data[0].type == type){
        -               $('[name^='+name+']').parent().css("background-color", "PaleGreen");
        -          }
        -          if(data[0].type != type){
        -               $('[name^='+name+']').parent().css("background-color", "Red");
        -               $('#typeError').empty();
        -               $('#typeError').append("<p>THE CONSUMABLE SCANNED IS NOT " + type + ".</p><p> IT IS " + data[0].type + ".</p><p> PLEASE SCAN IN THE CORRECT CONSUMABLE.</p>");
        -               $('#typeError').dialog().show();
        -              ispassed = 'false';
        -           }
        -         }
        -      return ispassed;
        -     });
        - }

      fieldset
        style= width:500px;
        legend Resources - Click to Toggle
          onclick= $('#resources').toggle();
        div
          id= resourceList
          style= display:none;border-radius:5px;padding:10px;background-color:#C1FDC1; color:#000000;
        div
          id= typeError
          title= Resource Type Error
          style= display:none;
        div
          id= qualError
          title= Qualification Error
          style= display:none;
        div
          id= expError
          title= Expiration Date Error
          style= display:none;
        div
          id= dneError
          title= Does Not Exist Error
          style= display:none;
        div
          id= requiredError
          title= Missing Resources Error
          style= display:none;
        div
          id= resources
          div
            class= ui-accordion ui-accordion-icons ui-widget ui-helper-reset
            id= accordion
            h3
              span
                class= ui-accordion-header-icon ui-icon ui-icon-triangle-1-s
              span REAGENTS
                style= margin-left: 15px;
              id= reagentsh3
              onclick= toggleAccordion($(this))
              class= ui-accordion-header ui-helper-reset ui-state-default ui-corner-top ui-corner-bottom
            div
              class= ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom

              table
                style= width:200px;
                id= reagentResources
                sqlQuery~ select u.inventoryItem as 'Reagent', '' as 'Barcode',
                  - u.amount as 'Amount', u.units as 'Units'
                  - from inventoryUsage u
                  - inner join inventoryItems i on u.inventoryItem = i.inventoryItem
                  - where u.step = '{_step}' and (i.inventoryType = 'Received Reagent' or i.inventoryType = 'Prepared Reagent')
                columnSpecs~ reagents
                  allowChangedRecordIds
                  column 1
                    inputType text
                      class= type text
                      readonly=
                      style= border:none; background:transparent;width:170px;
                      tabIndex= 3
                  column 2
                    inputType resource
                      class= resource
                      required~ false
                      qualifyResource~ Reagent QC
                      tabIndex= 1
                      validate~ ! select reagentType from reagents where reagentId = '{_columnInput:2}'
                        - and reagentType <> '{_columnInput:1}'
                        - and '{_columnInput:2}' <> ''
                        errorMessage~ This reagent does not match the Reagent Type! Check again.
                      sqlPreparedStatement~ update inventoryItems
                        - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                        - where inventoryItem = ?
                        - and ? <> ''
                        float {_columnInput:3}
                        string {_columnInput:1}
                        string {_columnInput:2}
                      sqlPreparedStatement~ update reagents
                        - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                        - where reagentId = ?
                        - and ? <> ''
                        float {_columnInput:3}
                        string {_columnInput:2}
                        string {_columnInput:2}
                      onchange= checkResource($(this).val(),$(this).parent().siblings().children('.type').val(), 'Reagent QC', $(this).attr('name'));
                      style= background-image: url(images/barcodebkg.jpg)
                  column 3
                    inputType text
                      class= text amount
                      tabIndex= 2
                      style= width:50px;
            h3
              span
                class= ui-accordion-header-icon ui-icon ui-icon-triangle-1-s
              span CONTROLS
                style= margin-left: 15px;
              id= controlsh3
              onclick= toggleAccordion($(this))
              class= ui-accordion-header ui-helper-reset ui-state-default ui-corner-top ui-corner-bottom
            div
              class= ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom
              table
                id= controls
                sqlQuery~ select u.inventoryItem as 'Control', '' as 'Barcode',
                  - u.amount as 'Amount', u.units as 'Units'
                  - from inventoryUsage u
                  - inner join inventoryItems i on u.inventoryItem = i.inventoryItem
                  - where u.step = '{_step}'
                  - and (i.inventoryType = 'Received Control' or i.inventoryType = 'Prepared Control')
                columnSpecs~ controls
                  allowChangedRecordIds
                  column 1
                    inputType text
                      class= type text controlNameForLot
                      readonly=
                      style= border:none; background:transparent;width:170px;
                      tabIndex= 3
                  column 2
                    inputType resource
                      class= resource controlForLot
                      required~ false
                      qualifyResource~ Control QC
                      tabIndex= 1
                      onchange= checkCtlResource($(this).val(), $(this).parent().siblings().children('.type').val(), 'Control QC', $(this).attr('name'));
                      validate~ ! select controlType from controls where controlId = '{_columnInput:2}'
                        - and controlType <> '{_columnInput:1}'
                        - and '{_columnInput:2}' <> ''
                        errorMessage~ This control does not match the Control Type! Check again.
                      sqlPreparedStatement~ update inventoryItems
                        - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                        - where inventoryItem = ?
                        - and ? <> ''
                        float {_columnInput:3}
                        string {_columnInput:1}
                        string {_columnInput:2}
                      sqlPreparedStatement~ update controls
                        - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                        - where controlId = ?
                        - and ? <> ''
                        float {_columnInput:3}
                        string {_columnInput:2}
                        string {_columnInput:2}
                      style= background-image: url(images/barcodebkg.jpg)
                  column 3
                    inputType text
                      class= text amount
                      tabIndex= 2
                      style= width:75px;
            h3
              span
                class= ui-accordion-header-icon ui-icon ui-icon-triangle-1-s
              span CONSUMABLES
                style= margin-left: 15px;
              id= consumablesh3
              onclick= toggleAccordion($(this))
              class= ui-accordion-header ui-helper-reset ui-state-default ui-corner-top ui-corner-bottom
            div
              class= ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom
              table
                id= consumableResources
                sqlQuery~ select u.inventoryItem as 'Consumable', '' as 'Barcode',
                  - u.amount as 'Amount', u.units as 'Units'
                  - from inventoryUsage u
                  - inner join inventoryItems i on u.inventoryItem = i.inventoryItem
                  - where u.step = '{_step}' and i.inventoryType = 'Consumable'
                columnSpecs~ consumables
                  allowChangedRecordIds
                  column 1
                    inputType text
                      class= type text
                      readonly=
                      style= border:none; background:transparent;width:170px;
                      tabIndex= 3
                  column 2
                    inputType resource
                      class= resource
                      required~ false
                      tabIndex= 1
                      sqlPreparedStatement~ update inventoryItems
                        - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                        - where inventoryItem = ?
                        - and ? <> ''
                        float {_columnInput:3}
                        string {_columnInput:1}
                        string {_columnInput:2}
                      sqlPreparedStatement~ update consumables
                        - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                        - where consumableId = ?
                        - and ? <> ''
                        float {_columnInput:3}
                        string {_columnInput:2}
                        string {_columnInput:2}
                      validate~ ! select consumableType from consumables where consumableId = '{_columnInput:2}'
                        - and consumableType <> '{_columnInput:1}'
                        - and '{_columnInput:2}' <> ''
                        errorMessage~ This consumable does not match the Consumable Type! Check again.
                      onchange= checkConsumableType($(this).val(),$(this).parent().siblings().children('.type').val(), $(this).attr('name'));
                      style= background-image: url(images/barcodebkg.jpg)
                  column 3
                    inputType text
                      class= text amount
                      tabIndex= 2
                      style= width:50px;
            h3
              span
                class= ui-accordion-header-icon ui-icon ui-icon-triangle-1-s
              span INSTRUMENTS
                style= margin-left: 15px;
              id= insturmentsh3
              onclick= toggleAccordion($(this))
              class= ui-accordion-header ui-helper-reset ui-state-default ui-corner-top ui-corner-bottom
            div
              class= ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom
              table
                id= instrumentResources
                sqlQuery~ select u.inventoryItem as 'Instrument', '' as 'Barcode'
                  - from inventoryUsage u
                  - where u.step = '{_step}'
                  - and u.inventoryItem IN (select DISTINCT instrumentType from instruments)
                columnSpecs~ instruments
                  allowChangedRecordIds
                  column 1
                    inputType text
                      class= type text
                      readonly=
                      style= border:none; background:transparent;
                      tabIndex= 3
                  column 2
                    inputType resource
                      class= resource
                      required~ false
                      tabIndex= 1
                      onchange= checkInstrument($(this).val(),$(this).parent().siblings().children('.type').val(), $(this).attr('name') );
                      validate~ ! select status from instruments
                        - where instrumentId = '{_columnInput:2}' and status <> 'In Service' and '{_columnInput:2}' <> ''
                        errorMessage~ THIS INSTRUMENT IS NOT IN SERVICE.  YOU CAN PUT IT BACK IN SERVICE WITH THE CHANGE INSTRUMENT STATUS STEP.
                      validate~ ! select instrumentType from instruments where instrumentId = '{_columnInput:2}'
                        - and instrumentType <> '{_columnInput:1}'
                        - and '{_columnInput:2}' <> ''
                        errorMessage~ This instrument does not match the Instrument Type! Check again.
                      style= background-image: url(images/barcodebkg.jpg)

    includeable resourceTableTabs
      script
        - $(document).ready(function() {
        -  $('#accordion').accordion({
        -     collapsible: true,
        -     heightStyle: 'content'
        -   });
        -   $('#tabs').tabs();
        -   $('#resources').hide();
        -   $('#typeError').hide();
        -   $('#qualError').hide();
        -   $('#expError').hide();
        - });
        - function checkResource(containerId, type, qualification, name) {
        -      var aliquot;
        -      var dilution;
        -     $.getJSON('/uniflow?callback=?&stepName=Ajax+Get+Reagent+Qualification&qualification='+ qualification+'&containerId=' + containerId,{},
        -    function(data,status)
        -    {
        -         if(data[0].qualification == qualification && data[0].type == type && data[0].expDate > data[0].todayDate)
        -         {
        -             $('[name^="'+name+'"]').parent().css("background-color", "PaleGreen");
        -         }
        -         if(data[0].qualification != qualification)
        -         {
        -              $('[name^='+name+']').parent().css("background-color", "Red");
        -              $('#qualError').empty();
        -              $('#qualError').append("<p>THIS REAGENT EITHER DOES NOT HAVE A QUALIFICATION OR THE QUALIFICATION IS EXPIRED!</p> " +
        -                 "<p> PLEASE LOOKUP THE REAGENT UNDER THE REAGENT MANAGEMENT STEPGROUP TO SEE DETAILS.</p>");
        -              $('#qualError').dialog().show();
        -         }
        -         if(data[0].type != type)
        -         {
        -             $('[name^='+name+']').parent().css("background-color", "Red");
        -             $('#typeError').empty();
        -             $('#typeError').append("<p>THE REAGENT SCANNED IS NOT " + type + ".</p><p> IT IS "+data[0].type+". </p><p>PLEASE SCAN IN THE CORRECT REAGENT TYPE</p>");
        -             $('#typeError').dialog().show();
        -         }
        -         if(data[0].expDate < data[0].todayDate)
        -         {
        -              $('[name^='+name+']').parent().css("background-color", "Red");
        -              $('#expError').empty();
        -              $('#expError').append("<p>THIS REAGENT HAS EXPIRED! PLEASE DISCARD OR SEE A MANAGER.</p>");
        -              $('#expError').dialog().show();
        -         }
        -    });
        - }
        - function checkCtlResource(containerId, type, qualification, name) {
        -      var aliquot;
        -      var dilution;
        -     $.getJSON('/uniflow?callback=?&stepName=Ajax+Get+Control+Qualification&qualification='+ qualification+'&containerId=' + containerId,{},
        -    function(data,status)
        -    {
        -         if(data[0].qualification == qualification && data[0].type == type && data[0].expDate > data[0].todayDate)
        -         {
        -             $('[name^="'+name+'"]').parent().css("background-color", "PaleGreen");
        -         }
        -         if(data[0].qualification != qualification)
        -         {
        -              $('[name^='+name+']').parent().css("background-color", "Red");
        -              $('#qualError').empty();
        -              $('#qualError').append("<p>THIS CONTROL EITHER DOES NOT HAVE A QUALIFICATION OR THE QUALIFICATION IS EXPIRED!</p> " +
        -                 "<p> PLEASE LOOKUP THE CONTROL UNDER THE CONTROL MANAGEMENT STEPGROUP TO SEE DETAILS.</p>");
        -              $('#qualError').dialog().show();
        -         }
        -         if(data[0].type != type)
        -         {
        -             $('[name^='+name+']').parent().css("background-color", "Red");
        -             $('#typeError').empty();
        -             $('#typeError').append("<p>THE CONTROL SCANNED IS NOT " + type + ".</p><p> IT IS "+data[0].type+". </p><p>PLEASE SCAN IN THE CORRECT CONTROL TYPE</p>");
        -             $('#typeError').dialog().show();
        -         }
        -         if(data[0].expDate < data[0].todayDate)
        -         {
        -              $('[name^='+name+']').parent().css("background-color", "Red");
        -              $('#expError').empty();
        -              $('#expError').append("<p>THIS CONTROL HAS EXPIRED! PLEASE DISCARD OR SEE A MANAGER.</p>");
        -              $('#expError').dialog().show();
        -         }
        -    });
        - }
        - function setResourceList() {
        -  $('#resources').hide();
        -  $('#resourceList').empty();
        -  $('#reagentResources > tbody  > tr').each(function() {
        -       var resource = $(this).find('.resource').val();
        -       var type = $(this).find('.type').val();
        -       if (resource != '') {$('#resourceList').append('<span>'+resource+' - '+type+'</span></br>');}
        -   });
        -  $('#consumableResources > tbody  > tr').each(function() {
        -       var resource = $(this).find('.resource').val();
        -       var type = $(this).find('.type').val();
        -       if (resource != '') {$('#resourceList').append('<span>'+resource+' - '+type+'</span></br>');}
        -   });
        -  $('#qcResources > tbody  > tr').each(function() {
        -       var resource = $(this).find('.resource').val();
        -       var type = $(this).find('.type').val();
        -       if (resource != '') {$('#resourceList').append('<span>'+resource+' - '+type+'</span></br>');}
        -   });
        -  $('#instrumentResources > tbody  > tr').each(function() {
        -       var resource = $(this).find('.resource').val();
        -       var type = $(this).find('.type').val();
        -       if (resource != '') {$('#resourceList').append('<span>'+resource+' - '+type+'</span></br>');}
        -   });
        -  $('#controls > tbody  > tr').each(function() {
        -       var resource = $(this).find('.resource').val();
        -       var type = $(this).find('.type').val();
        -       if (resource != '') {$('#resourceList').append('<span>'+resource+' - '+type+'</span></br>');}
        -   });
        -  $('#qcControls > tbody  > tr').each(function() {
        -       var resource = $(this).find('.resource').val();
        -       var type = $(this).find('.type').val();
        -       if (resource != '') {$('#resourceList').append('<span>'+resource+' - '+type+'</span></br>');}
        -   });
        -   $('#resourceList').show();
        - }
        - function checkInstrument(containerId, type, name)
        - {
        -     $.getJSON('/uniflow?callback=?&stepName=Ajax+Get+Instrument+Qualification&containerId=' + containerId,{},
        -    function(data,status)
        -    {
        -        if(data[0].type == type && data[0].qualification == 'QUALIFIED')
        -        {
        -             $('[name^='+name+']').parent().css("background-color", "PaleGreen");
        -        }
        -        if(data[0].qualification != 'QUALIFIED')
        -         {
        -              $('[name^='+name+']').parent().css("background-color", "Red");
        -              $('#qualError').empty();
        -              $('#qualError').append("<p>THIS INSTRUMENT DOES NOT HAVE A QUALIFICATION OR IS EXPIRED!</p> " +
        -                 "<p> PLEASE LOOKUP THE INSTRUMENT UNDER THE INSTRUMENT MANAGEMENT STEPGROUP TO SEE DETAILS.</p>");
        -               $('#qualError').dialog().show();
        -         }
        -        if(data[0].type != type)
        -         {
        -             $('[name^='+name+']').parent().css("background-color", "Red");
        -             $('#typeError').empty();
        -             $('#typeError').append("<p>THE INSTRUMENT SCANNED IS NOT " + type + ".</p>"
        -               + "<p> IT IS "+ data[0].type+".</p><p> PLEASE SCAN IN THE CORRECT INSTRUMENT.</p>");
        -             $('#typeError').dialog().show();
        -         }
        -        if(data[0].status != 'In Service')
        -         {
        -             $('[name^='+name+']').parent().css("background-color", "Red");
        -             $('#expError').empty();
        -             $('#expError').append("<p>THE INSTRUMENT SCANNED IS NOT IN SERVICE.</p><p> IT IS CURRENTLY SET TO " + data[0].status + ".</p>");
        -             $('#expError').dialog().show();
        -         }
        -    });
        - }
        -
        - function checkConsumableType (containerId, type, name)
        - {
        -     $.getJSON('/uniflow?callback=?&stepName=Ajax+Get+Consumable+Type&containerId=' + containerId,{},
        -    function(data,status)
        -    {
        -        if(data[0].type == type)
        -        {
        -             $('[name^='+name+']').parent().css("background-color", "PaleGreen");
        -        }
        -        if(data[0].type != type)
        -         {
        -             $('[name^='+name+']').parent().css("background-color", "Red");
        -             $('#typeError').empty();
        -             $('#typeError').append("<p>THE CONSUMABLE SCANNED IS NOT " + type + ".</p><p> IT IS " + data[0].type + ".</p><p> PLEASE SCAN IN THE CORRECT CONSUMABLE.</p>");
        -             $('#typeError').dialog().show();
        -         }
        -
        -     });
        - }
      vertical
        div
          class= resourceButton
          span Resources
          onclick= $('#resources').toggle();
        div
          id= resourceList
          style= display:none;border-radius:5px;padding:10px;background-color:#C1FDC1; color:#000000;
        div
          id= typeError
          title= Resource Type Error
          style= display:none;
        div
          id= qualError
          title= Qualification Error
          style= display:none;
        div
          id= expError
          title= Expiration Date Error
          style= display:none;
        div
          id= resources
          div
            id= tabs

            ul
              li
                a Reagents
                  href= #reagents
              li
                a Controls
                  href= #controls
              li
                a Consumables
                  href= #consumables
              li
                a Instruments
                  href= #instruments
              li
                a QC Reagents
                  href= #qcReagents
              li
                a QC Controls
                  href= #qcControls
            div
              id= reagents
              vertical
                table
                  id= reagentResources
                  caption REAGENTS
                  sqlQuery~ select u.inventoryItem as 'Reagent', '' as 'Barcode',
                    - u.amount as 'Amount', u.units as 'Units'
                    - from inventoryUsage u
                    - inner join inventoryItems i on u.inventoryItem = i.inventoryItem
                    - where u.step = '{_step}' and (i.inventoryType = 'Received Reagent' or i.inventoryType = 'Prepared Reagent')
                  columnSpecs~ reagents
                    allowChangedRecordIds
                    column 1
                      inputType text
                        class= type text
                        size= 50
                        readonly=
                        style= border:none; background:transparent;
                        tabIndex= 3
                    column 2
                      inputType resource
                        class= resource
                        required~ false
                        qualifyResource~ Reagent QC
                        tabIndex= 1
                        validate~ ! select reagentType from reagents where reagentId = '{_columnInput:2}'
                          - and reagentType <> '{_columnInput:1}'
                          - and '{_columnInput:2}' <> ''
                          errorMessage~ This reagent does not match the Reagent Type! Check again.
                        onchange= checkResource($(this).val(),$(this).parent().siblings().children('.type').val(), 'Reagent QC', $(this).attr('name'));
                        sqlPreparedStatement~ update inventoryItems
                          - set usageQuantity = (usageQuantity - ?)
                          - where inventoryItem = ?
                          - and ? <> ''
                          long {_columnInput:3}
                          string {_columnInput:1}
                          string {_columnInput:2}
                        sqlPreparedStatement~ update reagents
                          - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                          - where reagentId = ?
                          - and ? <> ''
                          float {_columnInput:3}
                          string {_columnInput:2}
                          string {_columnInput:2}
                        sqlPreparedStatement~ update reagents
                          - set openDate = curDate()
                          - where reagentId = ?
                          - and openDate IS NULL
                          - and ? <> ''
                          string {_columnInput:2}
                          string {_columnInput:2}
                    column 3
                      inputType text
                        class= text amount
                        tabIndex= 2

            div
              id= controls
              vertical
                table
                  id= controls
                  caption Controls
                  sqlQuery~ select u.inventoryItem as 'Control', '' as 'Barcode',
                    - u.amount as 'Amount', u.units as 'Units'
                    - from inventoryUsage u
                    - inner join inventoryItems i on u.inventoryItem = i.inventoryItem
                    - where u.step = '{_step}'
                    - and (i.inventoryType = 'Received Control' or i.inventoryType = 'Prepared Control')
                  columnSpecs~ controls
                    allowChangedRecordIds
                    column 1
                      inputType text
                        class= type text
                        size= 50
                        readonly=
                        style= border:none; background:transparent;
                        tabIndex= 3
                    column 2
                      inputType resource
                        class= resource
                        required~ false
                        qualifyResource~ Control QC
                        tabIndex= 1
                        onchange= checkCtlResource($(this).val(), $(this).parent().siblings().children('.type').val(), 'Control QC', $(this).attr('name'));
                        validate~ ! select controlType from controls where controlId = '{_columnInput:2}'
                          - and controlType <> '{_columnInput:1}'
                          - and '{_columnInput:2}' <> ''
                          errorMessage~ This control does not match the Control Type! Check again.
                        sqlPreparedStatement~ update inventoryItems
                          - set usageQuantity = (usageQuantity - ?)
                          - where inventoryItem = ?
                          - and ? <> ''
                          long {_columnInput:3}
                          string {_columnInput:1}
                          string {_columnInput:2}
                        sqlPreparedStatement~ update controls
                          - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                          - where controlId = ?
                          - and ? <> ''
                          float {_columnInput:3}
                          string {_columnInput:2}
                          string {_columnInput:2}
                        sqlPreparedStatement~ update controls
                          - set openDate = curDate()
                          - where controlId = ?
                          - and openDate IS NULL
                          - and ? <> ''
                          string {_columnInput:2}
                          string {_columnInput:2}
                    column 3
                      inputType text
                        class= text amount
                        tabIndex= 2
            div
              id= consumables
              vertical
                table
                  id= consumableResources
                  caption CONSUMABLES
                  sqlQuery~ select u.inventoryItem as 'Consumable', '' as 'Barcode',
                    - u.amount as 'Amount', u.units as 'Units'
                    - from inventoryUsage u
                    - inner join inventoryItems i on u.inventoryItem = i.inventoryItem
                    - where u.step = '{_step}' and i.inventoryType = 'Consumable'
                  columnSpecs~ consumables
                    allowChangedRecordIds
                    column 1
                      inputType text
                        class= type text
                        size= 50
                        readonly=
                        style= border:none; background:transparent;
                        tabIndex= 3
                    column 2
                      inputType resource
                        class= resource
                        required~ false
                        tabIndex= 1
                        sqlPreparedStatement~ update inventoryItems
                          - set usageQuantity = (usageQuantity - ?)
                          - where inventoryItem = ?
                          - and ? <> ''
                          long {_columnInput:3}
                          string {_columnInput:1}
                          string {_columnInput:2}
                        sqlPreparedStatement~ update consumables
                          - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                          - where consumableId = ?
                          - and ? <> ''
                          float {_columnInput:3}
                          string {_columnInput:2}
                          string {_columnInput:2}
                        validate~ ! select consumableType from consumables where consumableId = '{_columnInput:2}'
                          - and consumableType <> '{_columnInput:1}'
                          - and '{_columnInput:2}' <> ''
                          errorMessage~ This consumable does not match the Consumable Type! Check again.
                        onchange= checkConsumableType($(this).val(),$(this).parent().siblings().children('.type').val(), $(this).attr('name'));
                    column 3
                      inputType text
                        class= text amount
                        tabIndex= 2
            div
              id= instruments
              vertical
                table
                  id= instrumentResources
                  caption INSTRUMENTS
                  sqlQuery~ select u.inventoryItem as 'Instrument', '' as 'Barcode'
                    - from inventoryUsage u
                    - where u.step = '{_step}'
                    - and u.inventoryItem IN (select DISTINCT instrumentType from instruments)
                  columnSpecs~ instruments
                    allowChangedRecordIds
                    column 1
                      inputType text
                        class= type text
                        size= 50
                        readonly=
                        style= border:none; background:transparent;
                        tabIndex= 3
                    column 2
                      inputType resource
                        class= resource
                        required~ false
                        qualifyResource~ NEEDS QC
                        tabIndex= 1
                        onchange= checkInstrument($(this).val(),$(this).parent().siblings().children('.type').val(), $(this).attr('name') );
                        validate~ ! select qualification from qualifications
                          - where containerId = '{_columnInput:2}' and expirationDate <= curDate()
                          - and (step = '{_step}' or step = '*ALL*') and '{_columnInput:2}' <> ''
                          errorMessage~ THIS INSTRUMENT IS NOT VALID!
                        validate~ ! select status from instruments
                          - where instrumentId = '{_columnInput:2}' and status <> 'In Service' and '{_columnInput:2}' <> ''
                          errorMessage~ THIS INSTRUMENT IS NOT IN SERVICE.  YOU CAN PUT IT BACK IN SERVICE WITH THE CHANGE INSTRUMENT STATUS STEP.
                        validate~ ! select instrumentType from instruments where instrumentId = '{_columnInput:2}'
                          - and instrumentType <> '{_columnInput:1}'
                          - and '{_columnInput:2}' <> ''
                          errorMessage~ This instrument does not match the Instrument Type! Check again.
            div
              id= qcReagents
              vertical
                table
                  id= qcResources
                  caption QC Reagents
                  sqlQuery~ select u.inventoryItem as 'Reagent', '' as 'Barcode',
                    - u.amount as 'Amount', u.units as 'Units'
                    - from inventoryUsage u
                    - inner join inventoryItems i on u.inventoryItem = i.inventoryItem
                    - where u.step = '{_step}'
                    - and (i.inventoryType = 'Received Reagent' or i.inventoryType = 'Prepared Reagent')
                  columnSpecs~ qcReagents
                    allowChangedRecordIds
                    column 1
                      inputType text
                        class= type text
                        size= 50
                        readonly=
                        style= border:none; background:transparent;
                        tabIndex= 3
                    column 2
                      inputType resource
                        class= resource
                        required~ false
                        qualifyResource~ NEEDS QC
                        tabIndex= 1
                        onchange= checkResource($(this).val(), $(this).parent().siblings().children('.type').val(), 'NEEDS QC', $(this).attr('name'));
                        validate~ ! select reagentType from reagents where reagentId = '{_columnInput:2}'
                          - and reagentType <> '{_columnInput:1}'
                          - and '{_columnInput:2}' <> ''
                          errorMessage~ This reagent does not match the Reagent Type! Check again.
                        sqlPreparedStatement~ update inventoryItems
                          - set usageQuantity = (usageQuantity - ?)
                          - where inventoryItem = ?
                          - and ? <> ''
                          long {_columnInput:3}
                          string {_columnInput:1}
                          string {_columnInput:2}
                        sqlPreparedStatement~ update reagents
                          - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                          - where reagentId = ?
                          - and ? <> ''
                          float {_columnInput:3}
                          string {_columnInput:2}
                          string {_columnInput:2}
                        sqlPreparedStatement~ update reagents
                          - set openDate = curDate()
                          - where reagentId = ?
                          - and openDate IS NULL
                          - and ? <> ''
                          string {_columnInput:2}
                          string {_columnInput:2}
                    column 3
                      inputType text
                        class= text amount
                        tabIndex= 2
            div
              id= qcControls
              vertical
                table
                  id= qcResources2
                  caption QC Controls
                  sqlQuery~ select u.inventoryItem as 'Control', '' as 'Barcode',
                    - u.amount as 'Amount', u.units as 'Units'
                    - from inventoryUsage u
                    - inner join inventoryItems i on u.inventoryItem = i.inventoryItem
                    - where u.step = '{_step}'
                    - and (i.inventoryType = 'Received Control' or i.inventoryType = 'Prepared Control')
                  columnSpecs~ qcControls
                    allowChangedRecordIds
                    column 1
                      inputType text
                        class= type text
                        size= 50
                        readonly=
                        style= border:none; background:transparent;
                        tabIndex= 3
                    column 2
                      inputType resource
                        class= resource
                        required~ false
                        qualifyResource~ NEEDS QC
                        tabIndex= 1
                        onchange= checkCtlResource($(this).val(), $(this).parent().siblings().children('.type').val(), 'NEEDS QC', $(this).attr('name'));
                        validate~ ! select controlType from controls where controlId = '{_columnInput:2}'
                          - and controlType <> '{_columnInput:1}'
                          - and '{_columnInput:2}' <> ''
                          errorMessage~ This control does not match the Control Type! Check again.
                        sqlPreparedStatement~ update inventoryItems
                          - set usageQuantity = (usageqQuantity - ?)
                          - where inventoryItem = ?
                          - and ? <> ''
                          long {_columnInput:3}
                          string {_columnInput:1}
                          string {_columnInput:2}
                        sqlPreparedStatement~ update controls
                          - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                          - where controlId = ?
                          - and ? <> ''
                          float {_columnInput:3}
                          string {_columnInput:2}
                          string {_columnInput:2}
                        sqlPreparedStatement~ update controls
                          - set openDate = curDate()
                          - where controlId = ?
                          - and openDate IS NULL
                          - and ? <> ''
                          string {_columnInput:2}
                          string {_columnInput:2}
                    column 3
                      inputType text
                        class= text amount
                        tabIndex= 2
          div
            vertical
              button
                value= Confirm Resources
                onclick= setResourceList();


###################################################################################################
##################################Reporting 1#################################################################

    includeable reportSubmitQueries
      include reportSubmitInterpretationQueries
      include reportSubmitHTMLSaveQueries
      include reportInternalCommentSaveQuery
      include reportHiddenDemographicQueries

    includeable reportNextStep
      nextStep Create Report
        formNumber 0

    includeable reportPreviousComments
      fieldSet
        legend Previous Comments
          class= legend
        table
          sqlQuery~
            - select distinct
            -   ch.note as "Comment"
            -   , date_format(e.eventDate,'%m/%d/%Y') as "Comment Date"
            -   , e.userId as "Added By"
            - from events e
            - inner join containerNotes ch on e.eventId = ch.eventId
            - where ch.containerId in('{_recId}', '{_:requestId}')

    includeable reportMainFormQuery
      formQuery~ select DATE_FORMAT(now(), '%m/%d/%Y %r') as 'signDateTime'
        - , c.content as 'requestId'
        - , rd.panelCode as 'reportPanel'
        - , rd.reportType as 'reportType'
        - , ifNULL(rs.reportTitle, '') as 'reportHeader'
        - , rf.Id
        - , rf.testType
        - , 'Report Approved Electronically' as 'EsigNotice'
        - , DATE_FORMAT(now(), '%m/%d/%Y') as 'today'
        - , rh.htmlClientAddress
        - from contents c
        - inner join reportDetails rd on rd.reportId = c.containerId
        - inner join requestForms rf on rf.Id = c.content
        - left Join reportSettings rs on rd.panelCode = rs.panelCode
        - left join reportHTML rh on rf.Id = rh.reqId and rh.reportId = '{_recId}'
        - where c.containerId = '{_recId}' and c.contentType = 'requestId'

    includeable reportSignatureFormQuery
      formQuery~ select crs.medicalDirectorImage as 'signature'
        -              ,crs.medicalDirector as 'signatureName'
        -              ,CASE WHEN crs.medicalDirectorsignatureTitle1 = 'null' then '' else IFNULL(crs.medicalDirectorsignatureTitle1,'') end as 'signatureTitle1'
        -              ,CASE WHEN crs.medicalDirectorsignatureTitle2 = 'null' then '' else IFNULL(crs.medicalDirectorsignatureTitle2,'') end as 'signatureTitle2'
        -        from reportSignatures crs
        -        inner join reportSettings rs on rs.medicalDirectorId = crs.medicalDirectorId
        -        where rs.panelCode = '{_:reportPanel}' and crs.signaturePosition = 'signature1'
        -          and crs.signatureEnabled = 'Enabled'
        -        union all
        -        select crs.medicalDirectorImage as 'signature'
        -              ,crs.medicalDirector as 'signatureName'
        -              ,CASE WHEN crs.medicalDirectorsignatureTitle1 = 'null' then '' else IFNULL(crs.medicalDirectorsignatureTitle1,'') end as 'signatureTitle1'
        -              ,CASE WHEN crs.medicalDirectorsignatureTitle2 = 'null' then '' else IFNULL(crs.medicalDirectorsignatureTitle2,'') end as 'signatureTitle2'
        -        from reportSignatures crs
        -        inner join reportSettings rs on rs.medicalDirectorId = crs.medicalDirectorId
        -        where rs.panelCode = 'Default'  and crs.signaturePosition = 'signature1' and crs.signatureEnabled = 'Enabled'
        -        union all
        -        select '', '', '', '' from dual

    includeable reportBodyDemographicFormQueries
      formQuery~ select date_format(now(), '%m/%d/%Y') as 'reportDate'
        -             , pa.entityId as 'patientId'
        -             , pa.firstName as 'patientFirst'
        -             , pa.lastName as 'patientLast'
        -             , date_format(p.dob, '%m/%d/%Y') as 'dob'
        -             , p.gender
        -             , rs.specimenId
        -             , rs.sampleType
        -             , date_format(rs.collectionDate, '%m/%d/%Y') as 'collectionDate'
        -             , date_format(rs.receivedDate, '%m/%d/%Y') as 'receivedDate'
        -             , rf.organizationId
        -             , org.firstName as 'organizationFirst'
        -             , ea.address1 as 'organizationAddress1'
        -             , ea.city as 'organizationCity1'
        -             , ea.state as 'organizationState1'
        -             , ea.postalCode as 'organizationZip1'
        -             , rf.physicianId
        -             , ph.firstName as 'physicianFirst'
        -             , ph.lastName as 'physicianLast'
        -             , p.mrn
        - from contents c
        - inner join requestForms rf on rf.Id = c.content
        - left join requestSpecimens rs on rs.reqId = rf.Id and status not in ('cancelled', 'rejected')
        - left join entities pa  on rf.patientId = pa.entityId
        - left join patients p on pa.entityId = p.patientId
        - left join entities org on rf.organizationId = org.entityId
        - left join entityAddresses ea on ea.entityId = rf.organizationId and ea.type = 'Primary'
        - left join entities ph on rf.physicianId = ph.entityId
        - where c.containerId = '{_recId}' and c.contentType = 'requestId'


    includeable reportBodyDemographicFormQueriesOneToMany
      formQuery~ select date_format(now(), '%m/%d/%Y') as 'reportDate'
        -             , pa.entityId as 'patientId'
        -             , pa.firstName as 'patientFirst'
        -             , pa.lastName as 'patientLast'
        -             , date_format(p.dob, '%m/%d/%Y') as 'dob'
        -             , p.gender
        -             , rf.organizationId
        -             , org.firstName as 'organizationFirst'
        -             , ea.address1 as 'organizationAddress1'
        -             , ea.city as 'organizationCity1'
        -             , ea.state as 'organizationState1'
        -             , ea.postalCode as 'organizationZip1'
        -             , rf.physicianId
        -             , ph.firstName as 'physicianFirst'
        -             , ph.lastName as 'physicianLast'
        -             , p.mrn
        - from contents c
        - inner join requestForms rf on rf.Id = c.content
        - left join entities pa  on rf.patientId = pa.entityId
        - left join patients p on pa.entityId = p.patientId
        - left join entities org on rf.organizationId = org.entityId
        - left join entityAddresses ea on ea.entityId = rf.organizationId and ea.type = 'Primary'
        - left join entities ph on rf.physicianId = ph.entityId
        - where c.containerId = '{_recId}' and c.contentType = 'requestId'

    includeable reportBodyInterpretationFormQueries
      formQuery~ select value as 'interp1' from reportWording where reportId = '{_recId}' and field = 'interp1'
        -       union all
        -       select value from reportStaticWording where textType = '{_:reportPanel}' and staticArea = 'interp1'
        -       union all
        -       select value from reportStaticWording where textType = 'Default' and staticArea = 'interp1'
      formQuery~ select value as 'interp2' from reportWording where reportId = '{_recId}' and field = 'interp2'
        -       union all
        -       select value from reportStaticWording where textType = '{_:reportPanel}' and staticArea = 'interp2'
        -       union all
        -       select value from reportStaticWording where textType = 'Default' and staticArea = 'interp2'

    includeable reportBodyReferencesFormQueries
      formQuery~ select a.references
        - FROM (select value as 'references' from reportWording where reportId = '{_recId}' and field = 'referencesSave'
        -       union all
        -       select GROUP_CONCAT(DISTINCT rf.reference ORDER BY  rpf.orderNumber ASC SEPARATOR '<br>')
        -       From reportPanelReferences rpf
        -       inner join reportReferences rf on rf.referenceId = rpf.referenceId
        -       where rpf.panelCode = '{_:reportPanel}'
        -       union all
        -       select GROUP_CONCAT(DISTINCT rf.reference ORDER BY  rpf.orderNumber ASC SEPARATOR '<br>')
        -       From reportPanelReferences rpf
        -       inner join reportReferences rf on rf.referenceId = rpf.referenceId
        -       where rpf.panelCode = 'Default') a
        - where a.references is not NULL

    includeable reportBodyAmendedFormQueries
      formQuery~ select value as 'amended1' from reportWording where reportId = '{_recId}' and field = 'AmendedText'
        -       union all
        -       select '' from dual

    includeable reportBodyBoilerPlateFormQueries
      ### boiler plate
      formQuery~ select value as 'boilerPlateLabel' from reportWording where reportId = '{_recId}' and field = 'boilerPlateLabel'
        -       union all
        -       select value from reportStaticWording where textType = '{_:reportPanel}' and staticArea = 'boilerPlateLabel'
        -       union all
        -       select value from reportStaticWording where textType = 'Default' and staticArea = 'boilerPlateLabel'

      formQuery~ select value as 'p1' from reportWording where reportId = '{_recId}' and field = 'p1'
        -       union all
        -       select value from reportStaticWording where textType = '{_:reportPanel}' and staticArea = 'p1'
        -       union all
        -       select value from reportStaticWording where textType = 'Default' and staticArea = 'p1'

      formQuery~ select value as 'p2' from reportWording where reportId = '{_recId}' and field = 'p2'
        -       union all
        -       select value from reportStaticWording where textType = '{_:reportPanel}' and staticArea = 'p2'
        -       union all
        -       select value from reportStaticWording where textType = 'Default' and staticArea = 'p2'

      formQuery~ select value as 'p3' from reportWording where reportId = '{_recId}' and field = 'p3'
        -       union all
        -       select value from reportStaticWording where textType = '{_:reportPanel}' and staticArea = 'p3'
        -       union all
        -       select value from reportStaticWording where textType = 'Default' and staticArea = 'p3'

    includeable reportHiddenFields
      div
        style= display:none;
        htmlTextArea report_HTML
          allowHtml~
          id= report_HTML
        htmlTextArea report_HTML_Body
          allowHtml~
          id= report_HTML_Body
        htmlTextArea report_ClientAddress
          allowHtml~
          id= report_ClientAddress
        container requestId
          acceptQueue~ any
          id= requestId
          readonly=
          value= {_:requestId}
        container _recId
          acceptQueue~ Create Report
          id= reportId
          readonly=
          value= {_recId}
          if~ {Action}
            advanced~
            equals~ Create
            deleteQueue~ Sign Out Report
            insertQueue~ Sign Out Report
            deleteQueue~ Create Report
        text reportPanel
          id= reportPanel
          value= {_:reportPanel}
        textArea referencesSave
          value= {_:references}
          id= referencesSave
      div
        configureIf~
          advanced~
          sqlPreparedQuery~ select 1 from reportDetails where reportId = ? and (reportType = 'Amended' or reportType = 'Corrected')
            string {_recId}
        style= display:none;
        textArea amended1Save
          value= {_:amended1}
          id= amended1Save
          required~ true
          required= true

    includeable reportHiddenDemographicsTable
      div
        style= display:none;
        table
          sqlQuery~ select pa.entityId as 'patientId'
            -             , pa.firstName as 'patientFirst'
            -             , pa.lastName as 'patientLast'
            -             , date_format(p.dob, '%m/%d/%Y') as 'dob'
            -             , p.gender
            -             , rs.specimenId
            -             , rs.sampleType
            -             , date_format(rs.collectionDate, '%m/%d/%Y') as 'collectionDate'
            -             , date_format(rs.receivedDate, '%m/%d/%Y') as 'receivedDate'
            -             , rf.organizationId
            -             , org.firstName as 'organizationFirst'
            -             , ea.address1 as 'organizationAddress1'
            -             , ea.city as 'organizationCity1'
            -             , ea.state as 'organizationState1'
            -             , ea.postalCode as 'organizationZip1'
            -             , rf.physicianId
            -             , ph.firstName as 'physicianFirst'
            -             , ph.lastName as 'physicianLast'
            -             , p.mrn
            - from requestForms rf
            - left join requestSpecimens rs on rs.reqId = rf.Id
            - left join entities pa  on rf.patientId = pa.entityId
            - left join patients p on pa.entityId = p.patientId
            - left join entities org on rf.organizationId = org.entityId
            - left join entityAddresses ea on ea.entityId = rf.organizationId and ea.type = 'Primary'
            - left join entities ph on rf.physicianId = ph.entityId
            - where rf.id = '{_:requestId}'
          columnSpecs~ demographicSaveData
            allowChangedRecordIds
            column 1
              inputType text
                readonly=
            column 2
              inputType text
                readonly=
            column 3
              inputType text
                readonly=
            column 4
              inputType date
                readonly=
            column 5
              inputType text
                readonly=
            column 6
              inputType text
                readonly=
            column 7
              inputType text
                readonly=
            column 8
              inputType date
                readonly=
            column 9
              inputType date
                readonly=
            column 10
              inputType text
                readonly=
            column 11
              inputType text
                readonly=
            column 12
              inputType text
                readonly=
            column 13
              inputType text
                readonly=
            column 14
              inputType text
                readonly=
            column 15
              inputType text
                readonly=
            column 16
              inputType text
                readonly=
            column 17
              inputType text
                readonly=
            column 18
              inputType text
                readonly=
            column 19
              inputType text
                readonly=


    includeable reportMainLogoHeader
      formQuery~ select case
        - when reportType = '' then 'Final'
        - else reportType end as 'reportType'
        -   from reportDetails
        - where reportId = '{_recId}'
        - union all
        - select '' from dual
      formQuery~ select c.name, ca.address1, ca.city, ca.state, ca.postalCode from client c LEFT JOIN clientAddress ca on ca.clientId = c.clientId
      formQuery~ select htmlClientAddress from reportHTML where reportId = '{_recId}'
        - union all
        - select '' from dual
      div
        id= mainLogoHeader
        div
          class= reportLogoSection
          img
            src= images/logoUploads/reportLogo.png
        div
          id= headerOverlay
          h3 !!!{_:reportType}
        div !!!{_:htmlClientAddress}
          id= clientAddress
          class= clientAddress

    ### includeable reportBodyDemographics is a three section layout of the demographic information.
    includeable reportBodyDemographics
      div
        id= demographicSection
        div
          class= mainBodyLeftTop
          div
            class= demiHeader
            p PATIENT INFORMATION
          div
            class= demiContents
            p !!! Patient Name: <span>{_:patientLast}, {_:patientFirst}</span>
            p !!! Date of Birth: <span>{_:dob}</span>
            p !!! Gender: <span>{_:gender}</span>
            p !!! Patient Id: <span>{_:patientId}</span>
            p !!! MRN: <span>{_:mrn}</span>
        div
          class= mainBodyCenterTop
          div
            class= demiHeader
            p SAMPLE INFORMATION
          div
            class= demiContents
            p !!! Report Date: <span>{_:reportDate}</span>
            p !!! Specimen type: <span>{_:sampleType}</span>
            p !!! Specimen ID: <span>{_:specimenId}</span>
            p !!! Collection Date: <span>{_:collectionDate}</span>
            p !!! Received Date: <span>{_:receivedDate}</span>
        div
          class= mainBodyRightTop
          div
            class= demiHeader
            p ORDERING PHYSICIAN
          div
            class= demiContents2
            div
              p Ordered by:
            div
              class= demiContentRight
              p !!!{_:physicianFirst} {_:physicianLast}
              p !!!{_:organizationFirst}
              p !!!{_:organizationAddress1}
              p !!!{_:organizationCity1}, {_:organizationState1}, {_:organizationZip1}


    ### includeable reportBodyDemographics is a three section layout of the demographic information with a one to many relationship for specimen to accession.
    includeable reportBodyDemographicsOneToMany
      div
        id= demographicSection
        div
          class= mainBodyLeftTop2
          div
            class= demiHeader
            p PATIENT INFORMATION
          div
            class= demiContents
            p !!! Report Date: <span>{_:reportDate}</span>
            p !!! Patient Name: <span>{_:patientLast}, {_:patientFirst}</span>
            p !!! Date of Birth: <span>{_:dob}</span>
            p !!! Gender: <span>{_:gender}</span>
            p !!! Patient Id: <span>{_:patientId}</span>
            p !!! MRN: <span>{_:mrn}</span>
        div
          class= mainBodyRightTop2
          div
            class= demiHeader
            p ORDERING PHYSICIAN
          div
            class= demiContents2
            div
              p Ordered by:
            div
              class= demiContentRight
              p !!!{_:physicianFirst} {_:physicianLast}
              p !!!{_:organizationFirst}
              p !!!{_:organizationAddress1}
              p !!!{_:organizationCity1}, {_:organizationState1}, {_:organizationZip1}
        div
          class= demographicsSpecimenSection
          div
            class= demiHeader
            p SAMPLE INFORMATION
          div
            class= demiContents
            table
              class= demographicsSpecimenTable
              sqlQuery~ select  rs.sampleType as 'Specimen Type'
                -             , rs.specimenId as 'Specimen Id '
                -             , date_format(rs.collectionDate, '%m/%d/%Y') as 'Collection Date'
                -             , date_format(rs.receivedDate, '%m/%d/%Y') as 'Received Date'
                - from contents c
                - left join requestSpecimens rs on rs.reqId = c.content and status not in ('cancelled', 'rejected')
                - where c.containerId = '{_recId}' and c.contentType = 'requestId'



    includeable reportMainTitleHeader
      div
        class= reportHeader
        h2 !!!{_:reportHeader}

    ### includeable reportResultsHer2 is the section of the report that holds the results as diplayed in the actual report.
    includeable reportResultsHer2
      div
        id= resultsSection
        div
          class= demiHeader
          p RESULTS
        div
          class= resultsBody
          div
            id= fishResultsSection
            div
              configureIf~
                advanced~
                sqlPreparedQuery~ select 1
                  - from contents c
                  - inner join reportDetails rd on rd.reportId = c.containerId
                  - inner Join reportSettings rs on rd.panelCode = rs.panelCode
                  - where c.containerId = ?
                  -   and c.contentType = 'requestId'
                  -   and rs.hasImages = 'true'
                  string {_recId}
              id= imagesSection
              table
                id= imagesTable
                sqlQuery~ select concat('<div id="imageDiv">',group_concat('<figure class= "imageDiv"><img src="', location, '/', fileName, '" alt="" border=3 height=100 width=100 ></img><figcaption>',frd.slideId,'</figcaption></figure>' SEPARATOR ''),'</div>') as 'Image'
                  - from containerFiles c
                  - inner join fishReportData frd on frd.slideId = c.containerId
                  - where frd.requestId = '{_:requestId}'
                  -   and c.reportAdd = 'true'
                  -   and frd.reportId = '{_recId}'
                  - order by c.eventId
            div
              id= resultsTableSection
              table
                id= resultsTable
                class= resultsRows
                sqlQuery~ select slideId as 'Slide'
                  -            , column1to2Ratio as 'HER2/CEP17 ratio'
                  -            , column1Average as 'HER2 Average'
                  -            , column2Average as 'CEP17 Average'
                  -            , cellsCounted as 'Cells Counted'
                  -       from fishReportData
                  -       where requestId = '{_:requestId}'
                  -         and reportId = '{_recId}'

            div
              configureIf~
                advanced~
                sqlPreparedQuery~ select 1
                  - from contents c
                  - inner join reportDetails rd on rd.reportId = c.containerId
                  - inner Join reportSettings rs on rd.panelCode = rs.panelCode
                  - where c.containerId = ?
                  -   and c.contentType = 'requestId'
                  -   and rs.hasResultReferences = 'true'
                  string {_recId}
              id= referenceRangesSection
              table
                caption Reference Range
                id= referenceRangesTable
                class= resultsRows
                sqlQuery~ select 'X > 1.8' as 'Normal', '1.8 < X < 2.2' as 'Indeterminate', 'X > 2.2' as 'Amplified' from dual

    ### includeable reportResultsBCRABL is the section of the report that holds the results as diplayed in the actual report.
    includeable reportResultsBCRABL
      div
        id= resultsSection
        div
          class= demiHeader
          p RESULTS
        div
          class= resultsBody
          div
            id= fishResultsSection
            div
              configureIf~
                advanced~
                sqlPreparedQuery~ select 1
                  - from contents c
                  - inner join reportDetails rd on rd.reportId = c.containerId
                  - inner Join reportSettings rs on rd.panelCode = rs.panelCode
                  - where c.containerId = ?
                  -   and c.contentType = 'requestId'
                  -   and rs.hasImages = 'true'
                  string {_recId}

              id= imagesSection
              table
                id= imagesTable
                sqlQuery~ select concat('<div id="imageDiv">',group_concat('<figure class= "imageDiv"><img src="', location, '/', fileName, '" alt="" border=3 height=100 width=100 ></img><figcaption>',frd.slideId,'</figcaption></figure>' SEPARATOR ''),'</div>') as 'Image'
                  - from fishReportData frd
                  - inner join containerFiles c on frd.slideId = c.containerId and c.reportAdd = 'true'
                  - where frd.requestId = '{_:requestId}' and frd.techAnalyst <> 'Rejected at Senior Scientist Review'
                  -         and frd.reportId = '{_recId}'
            div
              id= resultsTableSectionBCRABL
              table
                id= resultsRowsBCRABL
                class= resultsRowsBCRABL
                sqlQuery~ select frd.slideId as 'Slide:'
                  -            , frd.overallResult as 'Overall Result:'
                  -            , frd.normalCount as 'Normal Count:'
                  -            , frd.abnormalCount as 'Abnormal Count:'
                  -            , frd.cellsCounted as 'Total Cells Counted:'
                  -            , frd.pattern as 'Pattern:'
                  -       from fishReportData frd
                  -       where requestId = '{_:requestId}' and frd.techAnalyst <> 'Rejected at Senior Scientist Review'
                  -         and reportId = '{_recId}'
                verticalMode~

            div
              id= referenceRangesSection
              configureIf~
                advanced~
                sqlPreparedQuery~ select 1
                  - from contents c
                  - inner join reportDetails rd on rd.reportId = c.containerId
                  - inner Join reportSettings rs on rd.panelCode = rs.panelCode
                  - where c.containerId = ?
                  -   and c.contentType = 'requestId'
                  -   and rs.hasResultReferences = 'true'
                  string {_recId}
              table
                caption Reference Range
                id= referenceRangesTable
                class= resultsRows
                sqlQuery~ select  frd.patternSet as 'Pattern and results'
                  -       from fishReportData frd
                  -       where requestId = '{_:requestId}' and frd.techAnalyst <> 'Rejected at Senior Scientist Review'
                  -         and reportId = '{_recId}'

    ### includeable reportResultsKaryo is the section of the report that holds the results as diplayed in the actual report for Karyo panelcode.
    includeable reportResultsKaryo
      div
        id= resultsSection
        div
          class= demiHeader
          p RESULTS
        div
          class= resultsBody
          div
            id= cytogeneticsResultsSection
            div
              configureIf~
                advanced~
                sqlPreparedQuery~ select 1
                  - from contents c
                  - inner join reportDetails rd on rd.reportId = c.containerId
                  - inner Join reportSettings rs on rd.panelCode = rs.panelCode
                  - where c.containerId = ?
                  -   and c.contentType = 'requestId'
                  -   and rs.hasImages = 'true'
                  string {_recId}
              id= imagesSection
              table
                id= imagesTable
                class= resultsRows
                sqlQuery~ select group_concat('<img src="', cf.location, '/', cf.fileName, '" alt="" border=3 height=100 width=100></img>' SEPARATOR '        ') as 'Image', concat(ka.slideId, '<br/> Overall Result: ', ka.rawData) as ''
                  - from karyotypeAnalysis ka
                  - inner join contents c on c.containerId = ka.slideId and c.contentType = 'Karyo Result' and c.content = ka.tech
                  - left join containerFiles cf on cf.containerId = ka.slideId and cf.reportAdd = 'true'
                  - where ka.reqId = '{_:requestId}' and ka.cellNum = 'overall'
                  - group by ka.slideId
                  - limit 25
            div
              id= resultsTableSection
              table
                class= resultsRows
                id= resultsTable
                sqlQuery~ select slideId as 'Slide', cellNum as 'Cell', rawData as 'Result'
                  - from karyotypeAnalysis ka
                  - inner join contents c on c.containerId = ka.slideId and c.contentType = 'Karyo Result' and c.content = ka.tech
                  - where ka.reqId = '{_:requestId}' and ka.cellNum <> 'overall'

    ### includeable reportResultsMCT is the section of the report that holds the results as diplayed in the actual report.
    includeable reportResultsMCT
      div
        id= resultsSection
        div
          class= demiHeader
          p RESULTS
        div
          class= resultsBody


    ### includeable reportResultsImmunogel is the section of the report that holds the results as diplayed in the actual report for IMMUNO-GEL panelcode.
    includeable reportResultsImmunoGel
      div
        id= resultsSection
        div
          class= demiHeader
          p RESULTS
        div
          class= resultsBody
          div
            id= immunogelResultsSection
            table
              class= resultsRows
              id= resultsTable
              sqlQuery~ select concat('<div id="imageDiv"><figure class= "imageDiv"><img src="', cf.location, '/', cf.fileName, '" alt="" border=3 height=100 width=100 ></img><figcaption>',igr.sampleId,'</figcaption></figure></div>') as 'Gel Image'
                -             , igr.result as 'Result'
                -       from immunologyGelResults igr
                -       left join containerFiles cf on cf.containerId = igr.sampleId and cf.reportAdd = 'true'
                -       where igr.requestId =  '{_:requestId}'
                -       limit 25

    includeable reportBodyInterpretationSection
      ##make sure to also call the report.js file
      div
        style= display:none;
        hidden currentStep
          id= currentStep
          value= {_step}

        textArea interp1
          value= {_:interp1}
          id= interpSave
        textArea interp2
          value= {_:interp2}
          id= interp2Save
      div
        class= interpretationSection
        h4 Interpretation:
          class= desc
        div
          id= fancyTextPanel1
          style= width:350px;
        div !!!{_:interp1}
          id= interp1
        div
          id= fancyTextPanel2
          style= width:350px;
        div !!!{_:interp2}
          id= interp2

    includeable reportBodyBoilerPlate
      div
        class= boilerPlate
        h4 !!!{_:boilerPlateLabel}
        div
          p !!!{_:p1}
          p !!!{_:p2}
          p !!!{_:p3}

    includeable reportBodyReferences
      div
        class= referencesSection
        h4 References:
          class= desc
        div
          id= fancyTextPanelReferences
          style= width:350px;
        div !!!{_:references}
          id= references


    includeable reportBodyElectronicSignatureImg
      div
        class= electronicSignature
        style= display:none;
        div
          class= signature
          h3 !!!{_:EsigNotice}
        img
          src= !!! images/signatures/{_:signature}
        div
          class= signatureLabel
          p !!!{_:signatureName}
          p !!!{_:signatureTitle1}
          p !!!{_:signatureTitle2}
          p !!!{_:signDateTime}
            id= nowSignDateTime
            class= nowSignDateTime

    includeable reportBodyAction
      vertical
        select Action
          required~ true
          required=
          id= action
          option
          option Create
          option Save

    ### To use the reportBodyElectonicSignatureSigning includeable you must also include the following execClassMethod code piece at the end of the form at the form level in order to validate the actual pasword entered.
      #execClassMethod uniflow.Switchboard.validatePassword
        #userIdField user
        #passwordField Password
        #minimumAccessLevel 6
    includeable reportBodyElectronicSignatureSigning
      vertical
        select Action
          required~ true
          required=
          id= action
          option
          option Approved
          option Save
          option Send to Create Report
          onchange= showEsigSection();
      fieldset
        style= display: none;
        id= esig
        legend Electronic Signature
          class= legend
        vertical
          text user
            id= userId
            screenLabel~ User Id
            validate~ select 1 from dual where '{user}' = '{_userId}' or '{Action}' <> 'Approved'
              errorMessage~ You must be the signed in user to sign out reports!
          password_input Password
            id= password


    includeable reportAmendedFreeTextSection
      div
        configureIf~
          advanced~
          sqlPreparedQuery~ select 1
            - from reportDetails
            - where reportId = ?
            -   and reportType = 'Amended'
            string {_recId}
        class= AmendedSection
        h4 Report Amendments :
          class= desc
        div
          id= fancyTextPanelAmended1
          style= width:350px;
        div !!!{_:amended1}
          id= amended1
      div
        configureIf~
          advanced~
          sqlPreparedQuery~ select 1
            - from reportDetails
            - where reportId = ?
            -   and reportType = 'Corrected'
            string {_recId}
        class= AmendedSection
        h4 Report Corrections :
          class= desc
        div
          id= fancyTextPanelAmended1
          style= width:350px;
        div !!!{_:amended1}
          id= amended1


    includeable reportAddendums
      div
        configureIf~
          advanced~
          sqlPreparedQuery~ select 1
            - from reportHTMLAddendums
            - where reportId = ?
            string {_recId}
        table
          id= addendumTable
          class= addendumTable
          sqlQuery~ select concat('<div class="addendumArea">',htmlAddendum, '</div>') as '' from reportHTMLAddendums rha
            - inner join events e on rha.eventId = e.eventId
            - where rha.reportId = '{_recId}'
            - order by e.eventDate desc
          verticalMode~


    includeable reportHiddenDemographicQueries
      sqlPreparedStatement delete from reportedDemographs where reportId = ? and panel = ? and ? = ? and eventId <> ?
        string {_recId}
        string {reportPanel}
        string {Action}
        string Create
        long {_eventId}
      ifCondition {Action}
        advanced~
        equals~ Create
        forRows demographicSaveData
          sqlPreparedStatement INSERT INTO reportedDemographs (reportId, panel, patientId, patientFirst, patientLast
            -           , dob, gender
            -           , specimenId, sampleType, collectionDate, receivedDate
            -           , organizationId, organizationFirst, organizationAddress1
            -           , organizationCity1, organizationState1, organizationZip1
            -           , physicianId, physicianFirst, physicianLast, mrn
            -           , eventId)
            - Values ( ?, ?, ?, ?, ?
            -       , ?, ?
            -       , ?, ?, ?, ?
            -       , ?, ?, ?
            -       , ?, ?, ?
            -       , ?, ?, ?, ?
            -       , ?)
            string {_recId}
            string {reportPanel}
            string {_columnInput_demographicSaveData:1}
            string {_columnInput_demographicSaveData:2}
            string {_columnInput_demographicSaveData:3}
            string {_columnInput_demographicSaveData:4}
            string {_columnInput_demographicSaveData:5}
            string {_columnInput_demographicSaveData:6}
            string {_columnInput_demographicSaveData:7}
            string {_columnInput_demographicSaveData:8}
            string {_columnInput_demographicSaveData:9}
            string {_columnInput_demographicSaveData:10}
            string {_columnInput_demographicSaveData:11}
            string {_columnInput_demographicSaveData:12}
            string {_columnInput_demographicSaveData:13}
            string {_columnInput_demographicSaveData:14}
            string {_columnInput_demographicSaveData:15}
            string {_columnInput_demographicSaveData:16}
            string {_columnInput_demographicSaveData:17}
            string {_columnInput_demographicSaveData:18}
            string {_columnInput_demographicSaveData:19}
            long {_eventId}

    includeable reportSubmitInterpretationQueries
      ifCondition
        advanced~
        sqlPreparedQuery~ select 1 from reportDetails where reportId = ? and reportType = 'Amended'
          string {_recId}
        sqlPreparedStatement INSERT INTO reportWording (reportId, field, value, eventId)
          - VALUES (?, ?, ?, ?)
          - ON DUPLICATE KEY UPDATE value = ?, eventId =  ?
          string {_recId}
          string amended1
          string {amended1Save}
          long {_eventId}
          string {amended1Save}
          long {_eventId}

      sqlPreparedStatement INSERT INTO reportWording (reportId, field, value, eventId)
        - VALUES(?, ?, ?, ?)
        - ON DUPLICATE KEY UPDATE value = ?, eventId =  ?
        string {_recId}
        string interp1
        string {interp1}
        long {_eventId}
        string {interp1}
        long {_eventId}

      sqlPreparedStatement INSERT INTO reportWording (reportId, field, value, eventId)
        - VALUES(?, ?, ?, ?)
        - ON DUPLICATE KEY UPDATE value = ?, eventId =  ?
        string {_recId}
        string interp2
        string {interp2}
        long {_eventId}
        string {interp2}
        long {_eventId}

      sqlPreparedStatement INSERT INTO reportWording (reportId, field, value, eventId)
        - VALUES(?, ?, ?, ?)
        - ON DUPLICATE KEY UPDATE value = ?, eventId =  ?
        string {_recId}
        string referencesSave
        string {referencesSave}
        long {_eventId}
        string {referencesSave}
        long {_eventId}

      sqlPreparedStatement INSERT INTO reportWording (reportId, field, value, eventId)
        - VALUES(?, ?, ?, ?)
        - ON DUPLICATE KEY UPDATE value = ?, eventId =  ?
        string {_recId}
        string result1
        string {result1}
        long {_eventId}
        string {result1}
        long {_eventId}

      sqlPreparedStatement INSERT INTO reportWording (reportId, field, value, eventId)
        - VALUES(?, ?, ?, ?)
        - ON DUPLICATE KEY UPDATE value = ?, eventId =  ?
        string {_recId}
        string result2
        string {result2}
        long {_eventId}
        string {result2}
        long {_eventId}

      sqlPreparedStatement INSERT INTO reportWording (reportId, field, value, eventId)
        - VALUES(?, ?, ?, ?)
        - ON DUPLICATE KEY UPDATE value = ?, eventId =  ?
        string {_recId}
        string result3
        string {result3}
        long {_eventId}
        string {result3}
        long {_eventId}

      sqlPreparedStatement INSERT INTO reportWording (reportId, field, value, eventId)
        - VALUES(?, ?, ?, ?)
        - ON DUPLICATE KEY UPDATE value = ?, eventId =  ?
        string {_recId}
        string result4
        string {result4}
        long {_eventId}
        string {result4}
        long {_eventId}

      sqlPreparedStatement INSERT INTO reportWording (reportId, field, value, eventId)
        - VALUES(?, ?, ?, ?)
        - ON DUPLICATE KEY UPDATE value = ?, eventId =  ?
        string {_recId}
        string result5
        string {result5}
        long {_eventId}
        string {result5}
        long {_eventId}

      sqlPreparedStatement INSERT INTO reportWording (reportId, field, value, eventId)
        - VALUES(?, ?, ?, ?)
        - ON DUPLICATE KEY UPDATE value = ?, eventId =  ?
        string {_recId}
        string result6
        string {result6}
        long {_eventId}
        string {result6}
        long {_eventId}

      sqlPreparedStatement INSERT INTO reportWording (reportId, field, value, eventId)
        - VALUES(?, ?, ?, ?)
        - ON DUPLICATE KEY UPDATE value = ?, eventId =  ?
        string {_recId}
        string result7
        string {result7}
        long {_eventId}
        string {result7}
        long {_eventId}

      sqlPreparedStatement INSERT INTO reportWording (reportId, field, value, eventId)
        - VALUES(?, ?, ?, ?)
        - ON DUPLICATE KEY UPDATE value = ?, eventId =  ?
        string {_recId}
        string result8
        string {result8}
        long {_eventId}
        string {result8}
        long {_eventId}


    includeable reportInternalCommentSaveQuery
      sqlPreparedStatement INSERT INTO containerNotes (containerId, noteType, note, eventId)
        - select ?, ?, ?, ? from dual where ? <> ''
        string {_recId}
        string Report Comment
        string {internalComments}
        long {_eventId}
        string {internalComments}


    includeable reportSubmitHTMLSaveQueries
      sqlPreparedStatement delete from reportHTML where reportId = ?
        string {_recId}

      sqlPreparedStatement insert into reportHTML (reportId, reqId, html, htmlBody, htmlClientAddress, eventId)
        - values (?,?,?,?,?,?)
        string {_recId}
        string {requestId}
        string {report_HTML}
        string {report_HTML_Body}
        string {report_ClientAddress}
        long {_eventId}

    includeable reportSubmitPDFCreation
      ifCondition
        advanced~
        sqlPreparedQuery~ select 1 from dual where exists (select 1 from reportHTML where reportId = ?)
          string {_recId}
        jython
          import os
          import shutil

          src = "{_configPath}private/reports/{_recId}.pdf"
          dest = "{_configPath}private/reports/archive/{_recId}_{_eventId}.pdf"
          if os.path.exists(src):
            shutil.move(src, dest)

        sqlPreparedStatement insert into containerFiles (containerId, fileType, fileName, location, eventId)
          - values (?,?,?,?,?)
          string {_recId}
          string _archiveReports
          string {_recId}_{_eventId}.pdf
          string {_configPath}private/reports/archive
          long {_eventId}

      setFormQueryResult
        sqlQuery select c.name as 'clientName', ca.address1, Concat(ca.city,', ', ca.state,' ',ca.postalCode) as 'cityStateZip', '' as 'npiNumber' from client c LEFT JOIN clientAddress ca on ca.clientId = c.clientId
      setFormQueryResult
        sqlQuery select reportType as 'reportType' from reportDetails where reportId = '{_recId}'
      setFormQueryResult
        sqlQuery select pa.entityId as 'patientId'
          -          , Concat(ifNULL(pa.lastName, ''),', ',ifNULL(pa.firstName, ''))  as 'patientName'
          -          , rhh.html as 'previousHTML'
          -          , rh.html as 'report_HTML'
          -          , REPLACE(REPLACE(REPLACE(COALESCE(rh.htmlClientAddress, ''), '\t', ''), '\r', ''), '\n', '') as 'addressBlock'
          - from requestForms rf
          - left join entities pa  on rf.patientId = pa.entityId
          - left join patients p on pa.entityId = p.patientId
          - left join reportHTML rh on rh.reqId = rf.Id and rh.reportId = '{_recId}'
          - left join reportHTMLHistory rhh on rhh.reqId = rf.Id and rhh.pdfGenerated = 'true' and rh.reportId = '{_recId}'
          - where rf.id = '{requestId}'
          - order by rhh.historyId desc

      jython
        with open('{_configPath}private/reports/tmpHTML_{_eventId}.html', 'w') as outfile:
          if '{reportType}' == 'Amended':
            outfile.write('''{_:report_HTML} {_:previousHTML}''')
          else:
            outfile.write('''{_:report_HTML}''')

      include htmlToPdf
      jython
        # Create pdf variables
        htmlPath = '{_configPath}private/reports/tmpHTML_{_eventId}.html'
        headerPath = "header= '{_configPath}..#'"
        footerPath= "footer= '{_configPath}..#'"
        pdfPath = '{_configPath}private/reports/{_recId}.pdf'

        # Optional replacements
        # replace = dict()
        # replace['reportType'] = 'Final' if '{_:reportType}' == '' else '{_:reportType}'
        # replace['clientName'] = '{_:clientName}'
        # replace['address1'] = '{_:address1}'
        # replace['cityStateZip'] = '{_:cityStateZip}'
        # replace['npiNumber'] = '{_:npiNumber}'
        # replace['patientName'] = '{_:patientName}'
        # replace['addressBlock'] = '{_:addressBlock}'

        # wkhtmlpdf options
        args = dict()
        args['page-size'] = 'letter'
        args['orientation'] = 'Portrait'
        args['margin-top'] = '10mm'
        args['margin-right'] = '10mm'
        args['margin-bottom'] = '10mm'
        args['margin-left'] = '10mm'
        args['header-spacing'] = '20'

        # Create pdf
        #call_htmltopdf(htmlPath, pdfPath, header='{_configPath}public/css/reportHeader.html', footer='{_configPath}public/css/reportFooter.html', replace=replace, args=args)
        call_htmltopdf(htmlPath, pdfPath, headerPath, footerPath, args=args)

      sqlPreparedStatement UPDATE reportHTML SET pdfGenerated = ?, eventId = ? WHERE reportId = ?
        string true
        long {_eventId}
        string {_recId}
      sqlPreparedStatement UPDATE reportDetails SET signedEventId = ? WHERE reportId = ?
        long {_eventId}
        string {_recId}

    includeable reportSubmitPDFCreationOld
      ifCondition
        advanced~
        sqlPreparedQuery~ select 1 from dual where exists (select * from reportHTML where reqId = ?)
          string {requestId}
        jython
          import os
          import shutil

          src = "{_configPath}private/reports/{_recId}.pdf"
          dest = "{_configPath}private/reports/archive/{_recId}_{_eventId}.pdf"
          if os.path.exists(src):
            shutil.move(src, dest)
        sqlPreparedStatement insert into containerFiles (containerId, fileType, fileName, location, eventId)
          - select ?, ?, ?, ?, ?  from dual
          string {_recId}
          string _archiveReports
          string {_recId}_{_eventId}.pdf
          string {_configPath}private/reports/archive
          long {_eventId}

      setFormQueryResult
        sqlQuery select c.name as 'clientName', ca.address1, Concat(ca.city,', ', ca.state,' ',ca.postalCode) as 'cityStateZip', '' as 'npiNumber' from client c LEFT JOIN clientAddress ca on ca.clientId = c.clientId
      setFormQueryResult
        sqlQuery select reportType as 'reportType' from reportDetails where reportId = '{_recId}'
      setFormQueryResult
        sqlQuery select pa.entityId as 'patientId'
          -           , Concat(ifNULL(pa.lastName, ''),', ',ifNULL(pa.firstName, ''))  as 'patientName'
          -           , rh.html as 'previousHTML'
          - from requestForms rf
          - left join entities pa  on rf.patientId = pa.entityId
          - left join patients p on pa.entityId = p.patientId
          - left join reportHTML rh on rh.reqId = rf.Id and rh.reportId = '{_recId}'
          - where rf.id = '{requestId}'

      jython
        with open('{_configPath}private/reports/tmpHTML_{_eventId}.html', 'w') as outfile:
          if '{reportType}' == 'Amended':
            outfile.write('''{report_HTML} {_:previousHTML}''')
          else:
            outfile.write('''{report_HTML}''')

      include htmlToPdf
      jython
        # Create pdf variables
        htmlPath = '{_configPath}private/reports/tmpHTML_{_eventId}.html'
        pdfPath = '{_configPath}private/reports/{_recId}.pdf'

        # Optional replacements
        replace = dict()
        replace['reportType'] = '{_:reportType}'
        replace['clientName'] = '{_:clientName}'
        replace['address1'] = '{_:address1}'
        replace['cityStateZip'] = '{_:cityStateZip}'
        replace['npiNumber'] = '{_:npiNumber}'
        replace['patientName'] = '{_:patientName}'

        # wkhtmlpdf options
        args = dict()
        args['page-size'] = 'Letter'
        args['orientation'] = 'Portrait'
        args['margin-top'] = '28mm'
        args['margin-right'] = '6mm'
        args['margin-bottom'] = '18mm'
        args['margin-left'] = '10mm'
        args['header-spacing'] = '25'

        # Create pdf
        call_htmltopdf(htmlPath, pdfPath, header='{_configPath}public/css/reportHeader.html', footer='{_configPath}public/css/reportFooter.html', replace=replace, args=args)


      sqlPreparedStatement  delete from reportHTML where reqId = ?
        string {requestId}

      sqlPreparedStatement  insert into reportHTML (reqId, html, htmlBody, eventId)
        - values (?,?,?,?)
        string {requestId}
        string {report_HTML}
        string {report_HTML_Body}
        long {_eventId}


      sqlPreparedStatement  update reportDetails
        - set signedEventId = ?
        - where reportId = ?
        long {_eventId}
        string {_recId}

      execClassMethod uniflow.Switchboard.validatePassword
        userIdField user
        passwordField Password
        minimumAccessLevel 6

###################################################################################################
###################################################################################################


############NGS###############

    includeable ngsCreateSampleSheet
      #sql delete from queues where step = '{_step}' and containerId = '{_recId}'
      #sql insert into queues (containerId, step, eventId) values ('{_recId}', 'Completed Sample Sheets', {_eventId})
      setFormQueryResult
        sqlQuery select Case when '{libraryBatchId}' = 'null' or '{libraryBatchId}' = '' then '{recId}' else '{libraryBatchId}' END as 'batchNum' from dual
      jython
        import com.uniconnect.uniflow as uniflow
        import csv

        #### Header Items
        header =  [
          - ["[Header]"],
          - ["FileVersion", "1"],
#           - ["IEMFileVersion", "4"],
#           - ["Investigator Name", "{investigatorName}"],
#           - ["Project Name", "{projectName}"],
#           - ["Date", "{headerDate}"],
#           - ["Workflow", "{workflow}"],
#           - ["Application", "{application}"],
#           - ["Assay", "{assay}"],
#           - ["Description", "{description}"],
#           - ["Chemistry", "{Chemistry}"]
          - ]

        #### Manifests
#         manifests = [["[Manifests]"],["A", "{manifestA}"]]

        #### Reads
#         reads = [["[Reads]"],["{read1}"],["{read2}"]]

        #### Settings
#         settings = [["[Settings]"],
#           - ["Adapter", "{adapter1}"],
#           - ["AdapterRead2", "{adapter2}"],
#           - ["QualityScoreTrim","{QualityScoreTrim}"]]

#         if '{workflow}' in ['Amplicon - DS', 'Generate FASTQ']:
#           settings.append(["StitchReads","{StitchReads}"])

#         elif '{workflow}' == 'Assembly':
#           settings.append(["Kmer","{Kmer}"])
#           settings.append(["ReverseComplement","{ReverseComplement}"])

#         elif '{workflow}' == 'Enrichment':
#           settings.append(["PicardHSmetrics","{PicardHSmetrics}"])
#           settings.append(["BaitManifestFileName","{BaitManifestFileName}"])
#           settings.append(["EnrichmentMaxRegionStatisticsCount","{EnrichmentMaxRegionStatisticsCount}"])
#           settings.append(["ExcludeRegionsManifestA","{ExcludeRegionsManifestA}"])
#           settings.append(["FlagPCRDuplicates","{FlagPCRDuplicates}"])
#           settings.append(["OutputGenomeVCF","{OutputGenomeVCF}"])
#           settings.append(["VariantCaller","{VariantCaller}"])
#           settings.append(["IndelRepeatFilterCutoff","{IndelRepeatFilterCutoff}"])
#           settings.append(["minimumCoverageDepth","{minimumCoverageDepth}"])
#           settings.append(["minQScore","{minQScore}"])
#           settings.append(["strandBiasFilter","{strandBiasFilter}"])
#           settings.append(["variantFrequencyEmitCutoff","{variantFrequencyEmitCutoff}"])
#           settings.append(["variantFrequencyFilterCutoff","{variantFrequencyFilterCutoff}"])
#           settings.append(["variantMinimumGQCutoff","{variantMinimumGQCutoff}"])
#           settings.append(["variantMinimumQualCutoff","{variantMinimumQualCutoff}"])

#         elif '{workflow}' == 'LibraryQC':
#           settings.append(["Aligner","{aligner}"])
#           settings.append(["FlagPCRDuplicates","{FlagPCRDuplicates}"])
#           settings.append(["ReverseComplement","{ReverseComplement}"])

#         elif '{workflow}' == 'Metagenomics':
#           settings.append(["TaxonomyFile","{TaxonomyFile}"])

#         elif '{workflow}' == 'PCR Amplicon':
#           settings.append(["FlagPCRDuplicates","{FlagPCRDuplicates}"])
#           settings.append(["OutputGenomeVCF","{OutputGenomeVCF}"])
#           settings.append(["VariantCaller","{VariantCaller}"])
#           settings.append(["FilterOutSingleStrandVariants","{FilterOutSingleStrandVariants}"])
#           settings.append(["IndelRepeatFilterCutoff","{IndelRepeatFilterCutoff}"])
#           settings.append(["minQScore","{minQScore}"])
#           settings.append(["variantFrequencyEmitCutoff","{variantFrequencyEmitCutoff}"])
#           settings.append(["variantFrequencyFilterCutoff","{variantFrequencyFilterCutoff}"])
#           settings.append(["variantMinimumGQCutoff","{variantMinimumGQCutoff}"])
#           settings.append(["variantMinimumQualCutoff","{variantMinimumQualCutoff}"])

#         elif '{workflow}' == 'Resequencing':
#           settings.append(["Aligner","{aligner}"])
#           settings.append(["FlagPCRDuplicates","{FlagPCRDuplicates}"])
#           settings.append(["ReverseComplement","{ReverseComplement}"])
#           settings.append(["VariantCaller","{VariantCaller}"])
#           settings.append(["FilterOutSingleStrandVariants","{FilterOutSingleStrandVariants}"])
#           settings.append(["IndelRepeatFilterCutoff","{IndelRepeatFilterCutoff}"])
#           settings.append(["minQScore","{minQScore}"])
#           settings.append(["variantFrequencyEmitCutoff","{variantFrequencyEmitCutoff}"])
#           settings.append(["variantFrequencyFilterCutoff","{variantFrequencyFilterCutoff}"])
#           settings.append(["variantMinimumGQCutoff","{variantMinimumGQCutoff}"])
#           settings.append(["variantMinimumQualCutoff","{variantMinimumQualCutoff}"])

#         elif '{workflow}' == 'TruSeq Amplicon':
#           settings.append(["CustomAmpliconAlignerMaxIndelSize","{CustomAmpliconAlignerMaxIndelSize}"])
#           settings.append(["OutputGenomeVCF","{OutputGenomeVCF}"])
#           settings.append(["StitchReads","{StitchReads}"])
#           settings.append(["VariantCaller","{VariantCaller}"])
#           settings.append(["IndelRepeatFilterCutoff","{IndelRepeatFilterCutoff}"])
#           settings.append(["minQScore","{minQScore}"])
#           settings.append(["variantFrequencyEmitCutoff","{variantFrequencyEmitCutoff}"])
#           settings.append(["variantFrequencyFilterCutoff","{variantFrequencyFilterCutoff}"])
#           settings.append(["variantMinimumGQCutoff","{variantMinimumGQCutoff}"])
#           settings.append(["variantMinimumQualCutoff","{variantMinimumQualCutoff}"])

        #### Data
#         dataHeader = ["Sample_ID","Sample_Name"]
        dataHeader = ["SampleID","Name"]

        if '{workflow}' != 'Default':
          if '{libraryBatchId}' != 'null' and '{libraryBatchId}':
            dataHeader.append("Plate")
            dataHeader.append("Well")
            dataHeader.append("I7_Index_ID")
            dataHeader.append("Index")
            dataHeader.append("I5_Index_ID")
            dataHeader.append("Index2")

          elif '{wetLabtype}' == 'Plate':
            dataHeader.append("Plate")
            dataHeader.append("Well")
            dataHeader.append("I7_Index_ID")
            dataHeader.append("Index")
            dataHeader.append("I5_Index_ID")
            dataHeader.append("Index2")

          else:
            dataHeader.append("I7_Index_ID")
            dataHeader.append("Index")
            dataHeader.append("I5_Index_ID")
            dataHeader.append("Index2")

        data = []
        sqlStmt = ""
        rangelimit = 1

        if '{workflow}' == 'Amplicon - DS':
          dataHeader.append("Sample Name")
          dataHeader.append("GenomeFolder")
          dataHeader.append("Manifest")
          if '{wetLabtype}' == 'Plate':
            sqlStmt = "select sampleId, Sample_Name, plateId, well, i7Index, i7IndexAdaptor, i5Index, i5IndexAdaptor, GroupSampleName, GenomeFolder, manifestA from testProcessingProperties where batchId = ? and eventId = ?"
            rangelimit = 13
          else:
            sqlStmt = "select sampleId, Sample_Name, i7Index, i7IndexAdaptor, i5Index, i5IndexAdaptor, GroupSampleName, GenomeFolder, manifestA from testProcessingProperties where batchId = ? and eventId = ?"
            rangelimit = 11

        elif '{workflow}' in ['Assembly', 'LibraryQC', 'Resequencing']:
          dataHeader.append("GenomeFolder")
          if '{wetLabtype}' == 'Plate':
            sqlStmt = "select sampleId, Sample_Name, plateId, well, i7Index, i7IndexAdaptor, i5Index, i5IndexAdaptor, GenomeFolder from testProcessingProperties where batchId = ? and eventId = ?"
            rangelimit = 10
          else:
            sqlStmt = "select sampleId, Sample_Name, i7Index, i7IndexAdaptor, i5Index, i5IndexAdaptor, GenomeFolder from testProcessingProperties where batchId = ? and eventId = ?"
            rangelimit = 8

        elif '{workflow}' in ['Enrichment', 'PCR Amplicon', 'Targeted RNA', 'TruSeq Amplicon']:
          dataHeader.append("GenomeFolder")
          dataHeader.append("Manifest")
          if '{wetLabtype}' == 'Plate':
            sqlStmt = "select sampleId, Sample_Name, plateId, well, i7Index, i7IndexAdaptor, i5Index, i5IndexAdaptor, GenomeFolder, manifestA from testProcessingProperties where batchId = ? and eventId = ?"
            rangelimit = 11
          else:
            sqlStmt = "select sampleId, Sample_Name, i7Index, i7IndexAdaptor, i5Index, i5IndexAdaptor, GenomeFolder, manifestA from testProcessingProperties where batchId = ? and eventId = ?"
            rangelimit = 9

        elif '{workflow}' == 'Small RNA':
          dataHeader.append("GenomeFolder")
          dataHeader.append("Contaminants")
          dataHeader.append("miRNA")
          dataHeader.append("RNA")
          if '{wetLabtype}' == 'Plate':
            sqlStmt = "select sampleId, Sample_Name, plateId, well, i7Index, i7IndexAdaptor, i5Index, i5IndexAdaptor, GenomeFolder, Contaminants, miRNA, RNA from testProcessingProperties where batchId = ? and eventId = ?"
            rangelimit = 13
          else:
            sqlStmt = "select sampleId, Sample_Name, i7Index, i7IndexAdaptor, i5Index, i5IndexAdaptor, GenomeFolder, Contaminants, miRNA, RNA from testProcessingProperties where batchId = ? and eventId = ?"
            rangelimit = 11

        elif '{workflow}' == 'Default':
          dataHeader.append("Species")
          dataHeader.append("Project")
          dataHeader.append("NucleicAcid")
          sqlStmt = "SELECT CONCAT(LPAD(@rownum := @rownum + 1, 3, 0),'_',tp.sampleId) AS 'sampleId',tp.Sample_Name,'Homo sapiens','{projectName}','DNA' FROM testProcessingProperties tp CROSS JOIN (SELECT @rownum := 0) r WHERE batchId = ? AND eventId = ? ORDER BY i5Index, i7Index"
          rangelimit = 6

        else:
          if '{wetLabtype}' == 'Plate':
            sqlStmt = "select sampleId, Sample_Name, plateId, well, i7Index, i7IndexAdaptor, i5Index, i5IndexAdaptor from testProcessingProperties where batchId = ? and eventId = ?"
            rangelimit = 9
          else:
            sqlStmt = "select sampleId, Sample_Name, i7Index, i7IndexAdaptor, i5Index, i5IndexAdaptor from testProcessingProperties where batchId = ? and eventId = ?"
            rangelimit = 7

        ps = switchboard.connection.prepareStatement(sqlStmt)
        ps.setString(1,'{_:batchNum}')
        ps.setInt(2,{_eventId})
        switchboard.resultSet = ps.executeQuery()
        while switchboard.resultSet.next():
          dataRow = [switchboard.resultSet.getString(i) for i in range(1,rangelimit)]
          data.append(dataRow)

        with open('{_configPath}private/samplesheets/{samplesheetName}.csv', 'w') as outfile:
          csvwriter = csv.writer(outfile)
          csvwriter.writerows(header)
          csvwriter.writerow([])
#           csvwriter.writerows(manifests)
#           csvwriter.writerow([])
#           csvwriter.writerows(reads)
#           csvwriter.writerow([])
#           csvwriter.writerows(settings)
#           csvwriter.writerow([])

          csvwriter.writerow(["[Data]"])
          csvwriter.writerow(dataHeader)
          csvwriter.writerows(data)

############END NGS###########


    includeable boxInsert
      sqlPreparedStatement INSERT INTO storedSpecimenInfo (specimenId, collectionDate, collectionTime, collectionType, collectionVolume, specimenType, receiveDate, shippingCondition, sampleCondition, comments, eventId)
        - (SELECT DISTINCT
        -       ?,
        -       collectionDate,
        -       collectionTime,
        -       collectionType,
        -       collectionVolume,
        -       sampleType,
        -       receiveDate,
        -       shippingCondition,
        -       CASE ISNULL(cp.eventId) WHEN 1 THEN 'not acceptable' WHEN 0 THEN 'acceptable' END,
        -       cp.value,
        -       ?
        -  FROM requestForms rf
        -  INNER JOIN contents c
        -  ON rf.specimenId = c.content
        -  AND c.containerId = ?
        -  AND c.contentType = 'specimenId'
        -  LEFT JOIN containerProperties cp
        -  ON rf.Id = cp.containerId
        -  AND 'contactCustomer'  = cp.property
        -  WHERE NOT EXISTS (SELECT 1 FROM storedSpecimenInfo WHERE specimenId = ?))
        string {_thisInput}
        long {_eventId}
        string {_thisInput}
        string {_thisInput}
      sqlPreparedStatement INSERT INTO storedSpecimenTests (specimenId, testType, testResult, testDate, eventId)
        - (SELECT DISTINCT ?, ?, rf.psaLevel, rf.psaDate, ?
        -  FROM requestForms rf
        -  INNER JOIN contents c
        -  ON rf.specimenId = c.content
        -  AND c.containerId = ?
        -  AND c.contentType = ?
        -  WHERE NOT EXISTS (SELECT 1 FROM storedSpecimenTests WHERE specimenId = ? AND testType = ?))
        string {_thisInput}
        string PSA
        long {_eventId}
        string {_thisInput}
        string specimenId
        string {_thisInput}
        string PSA
      sqlPreparedStatement INSERT INTO storedSpecimenTests (specimenId, testType, testResult, eventId)
        - (SELECT DISTINCT ?, ?, rf.dreReading, ?
        -  FROM requestForms rf
        -  INNER JOIN contents c
        -  ON rf.specimenId = c.content
        -  AND c.containerId = ?
        -  AND c.contentType = ?
        -  AND NOT EXISTS (SELECT 1 FROM storedSpecimenTests WHERE specimenId = ? AND testType = ?))
        string {_thisInput}
        string DRE
        long {_eventId}
        string {_thisInput}
        string specimenId
        string {_thisInput}
        string DRE
      sqlPreparedStatement INSERT INTO storedSpecimenTests (specimenId, testType, testResult, eventId)
        - (SELECT DISTINCT ?, ?, rf.biopsyType, ?
        -  FROM requestForms rf
        -  INNER JOIN contents c
        -  ON rf.specimenId = c.content
        -  AND c.containerId = ?
        -  AND c.contentType = ?
        -  AND NOT EXISTS (SELECT 1 FROM storedSpecimenTests WHERE specimenId = ? AND testType = ?))
        string {_thisInput}
        string Biopsy
        long {_eventId}
        string {_thisInput}
        string specimenId
        string {_thisInput}
        string Biopsy
      sqlPreparedStatement INSERT INTO storedSpecimenRelationships (specimenId, entityId, entityType, eventId)
        - (SELECT DISTINCT ?, rf.patientId, ?, ?
        -  FROM requestForms rf
        -  INNER JOIN contents c
        -  ON rf.specimenId = c.content
        -  AND c.containerId = ?
        -  AND c.contentType = ?
        -  AND NOT EXISTS (SELECT 1 FROM storedSpecimenRelationships WHERE specimenId = ? AND entityType = ?))
        string {_thisInput}
        string Patient
        long {_eventId}
        string {_thisInput}
        string specimenId
        string {_thisInput}
        string Patient
      sqlPreparedStatement INSERT INTO storedSpecimenRelationships (specimenId, entityId, entityType, eventId)
        - (SELECT DISTINCT ?, rf.physicianId, ?, ?
        -  FROM requestForms rf
        -  INNER JOIN contents c
        -  ON rf.specimenId = c.content
        -  AND c.containerId = ?
        -  AND c.contentType = ?
        -  AND NOT EXISTS (SELECT 1 FROM storedSpecimenRelationships WHERE specimenId = ? AND entityType = ?))
        string {_thisInput}
        string Physician
        long {_eventId}
        string {_thisInput}
        string specimenId
        string {_thisInput}
        string Physician
      sqlPreparedStatement INSERT INTO storedSpecimenRelationships (specimenId, entityId, entityType, eventId)
        - (SELECT DISTINCT ?, rf.assistantId, ?, ?
        -  FROM requestForms rf
        -  INNER JOIN contents c
        -  ON rf.specimenId = c.content
        -  AND c.containerId = ?
        -  AND c.contentType = ?
        -  AND NOT EXISTS (SELECT 1 FROM storedSpecimenRelationships WHERE specimenId = ? AND entityType = ?))
        string {_thisInput}
        string Assistant
        long {_eventId}
        string {_thisInput}
        string specimenId
        stirng {_thisInput}
        string Assistant
      sqlPreparedStatement INSERT INTO storedSpecimenRelationships (specimenId, entityId, entityType, eventId)
        - (SELECT DISTINCT ?, rf.practiceId, ?, ?
        -  FROM requestForms rf
        -  INNER JOIN contents c
        -  ON rf.specimenId = c.content
        -  AND c.containerId = ?
        -  AND c.contentType = ?
        -  AND NOT EXISTS (SELECT 1 FROM storedSpecimenRelationships WHERE specimenId = ? AND entityType = ?))
        string {_thisInput}
        string Practice
        long {_eventId}
        string {_thisInput}
        string specimenId
        string {_thisInput}
        string Practice

    includeable containerLocation
      formQuery select (select step from queues where containerId='{_recId}') 'step'
        - ,(select e.userId from containers c
        -   LEFT JOIN events e ON e.eventId=c.eventId
        -   where c.containerId='{_recId}') 'userId'
        - from dual

      span <b>{_recId}</b> currently located on <a
        - href="/uniflow?lastForm=Y&stepName={_resultSet:step}&recId={_recId}">{_resultSet:step}</a> step
        - last action was by {_resultSet:userId}

    includeable removeFilePath
      script
        - function loadPath(id,value) {
        - var myString = value;
        - var offset = myString.lastIndexOf('\\') + 1;
        - var str1 = myString.slice(offset);  // remove the unwanted part of the path
        - var fileString = str1.replace(/ /g,'_');  //replace all spaces with underscores to allow passing to ajax via browser address//
        - document.getElementById(id).value = fileString;
        - return fileString;
        - }


    includeable submitButton
      script
        - var ButtonId = "stepFormSubmitButton";
        - var ButtonWidth = 100;
        - var ButtonLocation = "left";
        - var SpaceBetweenButtonAndEdge = 900;
        - var SpaceBetweenButtonAndTop = 195;
        - TotalWidth = parseInt(ButtonWidth) + parseInt(SpaceBetweenButtonAndEdge);
        - ButtonLocation = ButtonLocation.toLowerCase();
        - ButtonLocation = ButtonLocation.substr(0,1);
        - var ButtonOnLeftEdge = (ButtonLocation=='l') ? true : false;
        - function AddButtonPlacementEvents(f)
        - {
        -   var cache = window.onload;
        -   if(typeof window.onload != 'function') { window.onload = f; }
        -   else { window.onload = function() { if(cache) { cache(); } f(); }; }
        -   cache = window.onresize;
        -   if(typeof window.onresize != 'function') { window.onresize = f; }
        -   else { window.onresize = function() { if(cache) { cache(); } f(); }; }
        - }
        - function WindowHasScrollbar() {
        - var ht = 0;
        - if(document.all) {
        -    if(document.documentElement) { ht = document.documentElement.clientHeight; }
        -   else { ht = document.body.clientHeight; }
        -   }
        - else { ht = window.innerHeight; }
        - if (document.body.offsetHeight > ht) { return true; }
        - else { return false; }
        - }
        -
        - function GlueButton(ledge) {
        - var did = document.getElementById(ButtonId);
        - did.style.top = SpaceBetweenButtonAndTop + "px";
        - did.style.width = ButtonWidth + "px";
        - did.style.left = ledge + "px";
        - did.style.display = "block";
        - did.style.zIndex = "9999";
        - did.style.position = "fixed";
        - }
        -
        - function PlaceTheButton() {
        - if(ButtonOnLeftEdge) {
        -    GlueButton(SpaceBetweenButtonAndEdge);
        -    return;
        -   }
        - if(document.documentElement && document.documentElement.clientWidth) { GlueButton(document.documentElement.clientWidth-TotalWidth); }
        - else {
        -   if(navigator.userAgent.indexOf('MSIE') > 0) { GlueButton(document.body.clientWidth-TotalWidth+19); }
        -  else {
        -      var scroll = WindowHasScrollbar() ? 0 : 15;
        -      if(typeof window.innerWidth == 'number') { GlueButton(window.innerWidth-TotalWidth-15+scroll); }
        -      else { GlueButton(document.body.clientWidth-TotalWidth+15); }
        -      }
        -   }
        - }
        -
        - AddButtonPlacementEvents(PlaceTheButton);

    includeable stepInstructions
      script
        - $(document).ready(function() {
        -   $('#fancyInstructionsDiv').hide();
        -   $(".instructionsTable thead").css("display", "none");
        -   var tbody = $(".instructionsTable tbody");
        -   var tbody2 = $(".fancyInstructionsTable tbody");
        -
        -   if (tbody.children().length == 0) {
        -     $('#instructionsDiv').hide();
        -   }
        -   if ($('#fancyInstructions').val() == 'true') {
        -     $('#instructionsDiv').hide();
        -     $('#fancyInstructionsDiv').show();
        -   }
        -   if (tbody2.children().length == 0) {
        -     $('#fancyInstructionsDiv').hide();
        -   }
        -
        - });
      div
        id= instructionsDiv
        fieldset
          class= fieldset
          style= max-width:900px;
          legend Instructions
            class= legend toggle
          div
            id= stepInstructionsTable
            table
              configureIf~ {_j:switchboard.formNumber == 0}
              class= instructionsTable
              sqlQuery~ SELECT
                - CASE WHEN attribute = 'all' THEN '- '
                - WHEN COALESCE(displayOrder, '') <> '' THEN CONCAT(displayOrder, '. ') ELSE '- ' END AS '',
                - instructions AS ''
                - FROM stepInstructions
                - WHERE step = '{_step}' AND (attribute = '0' OR attribute = 'all')
                - ORDER BY IF(LENGTH(displayOrder) = 1, CONCAT('0', displayOrder), displayOrder) ASC
            table
              configureIf~ {_j:switchboard.formNumber == 1}
              class= instructionsTable
              sqlQuery~ SELECT
                - CASE WHEN attribute = 'all' THEN '- '
                - WHEN COALESCE(displayOrder, '') <> '' THEN CONCAT(displayOrder, '. ') ELSE '- ' END AS '',
                - instructions AS ''
                - FROM stepInstructions
                - WHERE step = '{_step}' AND (attribute = '1' OR attribute = 'all')
                - ORDER BY IF(LENGTH(displayOrder) = 1, CONCAT('0', displayOrder), displayOrder) ASC
            table
              configureIf~ {_j:switchboard.formNumber == 2}
              class= instructionsTable
              sqlQuery~ SELECT
                - CASE WHEN attribute = 'all' THEN '- '
                - WHEN COALESCE(displayOrder, '') <> '' THEN CONCAT(displayOrder, '. ') ELSE '- ' END AS '',
                - instructions AS ''
                - FROM stepInstructions
                - WHERE step = '{_step}' AND (attribute = '2' OR attribute = 'all')
                - ORDER BY IF(LENGTH(displayOrder) = 1, CONCAT('0', displayOrder), displayOrder) ASC
            table
              configureIf~
                advanced~
                sqlPreparedQuery~ SELECT 1
                  - FROM stepInstructions
                  - WHERE step = ?
                  -   AND COALESCE(attribute, '') = '' LIMIT 1
                  string {_step}
              class= instructionsTable
              sqlQuery~ SELECT
                - CASE WHEN COALESCE(displayOrder, '') <> '' THEN CONCAT(displayOrder, '. ') ELSE '- ' END AS '',
                - instructions AS ''
                - FROM stepInstructions
                - WHERE step = '{_step}' AND COALESCE(attribute, '') = ''
                - ORDER BY IF(LENGTH(displayOrder) = 1, CONCAT('0', displayOrder), displayOrder) ASC
          div
            id= fancyInstructionsDiv
            table
              class= fancyInstructionsTable
              sqlQuery~
                - SELECT
                -   '' as 'Complete'
                -   , CASE WHEN displayOrder <> '' THEN CONCAT(displayOrder,'.  ') ELSE '-' END as ''
                -   , instructions as ''
                -   , '' as 'Comments'
                - from stepInstructions
                - where step = '{_step}'
              columnSpecs~ fancyInstructions
                allowChangedRecordIds
                column 1
                  inputType checkbox
                column 4
                  inputType textArea
      hr

    includeable userAccountInfo
      hidden accountId
        value= {_accountId}
        id= accountId
      hidden userAccessLevel
        value= {_accessLevel}
        id= userAccessLevel
      hidden fromStepName
        id= fromStepName
        value= {_step}

    includeable reportPreview
      div
        id= report
        style= border:0px solid blue;width: 100%;float:left; padding-top: 40px;
        div
          id= header
          style= border:0px solid blue;float:left; width:100%;align:center;
          div
            style= border:0px solid blue;width: 200px;float:left;
            img
              src= images/OncoDx.png
              style= width:200px; height:55px;
          div
            style= border:0px solid blue;width: 200px;margin-right:auto;margin-left:auto;
            span {_resultSet:title}
              style= font-size:12px;color:#2ECCFA
          div
            style= border:0px solid blue;width: 200px;float:right;vertical-align:top;margin-top:-45px;
            span <font size="1.5"> OncoDx Reference Lab, LLC<br/>
              - ##### Some St. Suite ####<br/>
              - Some City, State ZZZZZZ<br/>
              - Phone: 1-888-###-####<br/>
              - Fax: ###-###-####
              - Direct ###-###-#### <br/>
              - CLIA ID # ############ <br/>
              - CAP# #######</font>
        div
          id= patientInfo
          style= border:0px solid blue;width: 100%;float:left;

        div
          id= patientHistory
          style= border:0px solid blue;width: 100%;float:left;

        div
          id= testresults
          style= border:0px solid blue;width:100%;float:left;

        div
          style= border:0px solid blue;float:left;
          id= significance

        div
          id= dosageRecommendation
          style= border:0px solid blue;width:100%;float:left;

        div
          id= medicinesAffected
          style= border:0px solid blue;width:100%;float:left;

        div
          id= indication
          style= border:0px solid blue;width:100%;float:left;

        div
          id= description
          style= border:0px solid blue;width:100%;float:left;

        div
          id= intendedUse
          style= border:0px solid blue;width:100%;float:left;

        div
          id= additionalInformation
          style= border:0px solid blue;width:100%;float:left;

        div
          style= border:0px solid blue;width:100%;float:left;
          id= referencesForTestsRequested

        #div
        #  id= disclaimer
        #  style= border:0px solid blue;width:100%;float:left;
      br

    includeable googEditor
      script
        src= closure-library/closure/goog/base.js
      script
        -
        -     goog.require('goog.dom');
        -     goog.require('goog.editor.Command');
        -     goog.require('goog.editor.Field');
        -     goog.require('goog.editor.plugins.BasicTextFormatter');
        -     goog.require('goog.editor.plugins.EnterHandler');
        -     goog.require('goog.editor.plugins.HeaderFormatter');
        -     goog.require('goog.editor.plugins.LinkBubble');
        -     goog.require('goog.editor.plugins.LinkDialogPlugin');
        -     goog.require('goog.editor.plugins.ListTabHandler');
        -     goog.require('goog.editor.plugins.LoremIpsum');
        -     goog.require('goog.editor.plugins.RemoveFormatting');
        -     goog.require('goog.editor.plugins.SpacesTabHandler');
        -     goog.require('goog.editor.plugins.UndoRedo');
        -     goog.require('goog.ui.editor.DefaultToolbar');
        -     goog.require('goog.ui.editor.ToolbarController');
        -
      link
        rel= stylesheet
        href= closure-library/closure/goog/demos/css/demo.css
      link
        rel= stylesheet
        href= closure-library/closure/goog/css/button.css
      link
        rel= stylesheet
        href= closure-library/closure/goog/css/dialog.css
      link
        rel= stylesheet
        href= closure-library/closure/goog/css/linkbutton.css
      link
        rel= stylesheet
        href= closure-library/closure/goog/css/menu.css
      link
        rel= stylesheet
        href= closure-library/closure/goog/css/menuitem.css
      link
        rel= stylesheet
        href= closure-library/closure/goog/css/menuseparator.css
      link
        rel= stylesheet
        href= closure-library/closure/goog/css/tab.css
      link
        rel= stylesheet
        href= closure-library/closure/goog/css/tabbar.css
      link
        rel= stylesheet
        href= closure-library/closure/goog/css/toolbar.css
      link
        rel= stylesheet
        href= closure-library/closure/goog/css/colormenubutton.css
      link
        rel= stylesheet
        href= closure-library/closure/goog/css/palette.css
      link
        rel= stylesheet
        href= closure-library/closure/goog/css/colorpalette.css
      link
        rel= stylesheet
        href= closure-library/closure/goog/css/editor/bubble.css
      link
        rel= stylesheet
        href= closure-library/closure/goog/css/editor/dialog.css
      link
        rel= stylesheet
        href= closure-library/closure/goog/css/editor/linkdialog.css
      link
        rel= stylesheet
        href= closure-library/closure/goog/css/editortoolbar.css


    includeable reportContent
      script
        src= js/uniflow/editor/filterDialogPlugin.js
      script
        -
        -   function updateFieldContents() {
        -     goog.dom.getElement('edit_dosageRecommendation').value = myField.getCleanContents();
        -   }
        -

        -   function updatePatientHistoryContents() {
        -     goog.dom.getElement('edit_patientHistory').value = patientHistoryField.getCleanContents();
        -   }

        -   // Create an editable field.
        -   var patientHistoryField = new goog.editor.Field('view_patientHistory');

        -   // Create an editable field.
        -   var myField = new goog.editor.Field('view_dosageRecommendation');
        -
        -   // Create and register all of the editing plugins you want to use.
        -   // patientHistory
        -   patientHistoryField.registerPlugin(new goog.editor.plugins.BasicTextFormatter());
        -   patientHistoryField.registerPlugin(new uniflow.editor.FilterDialogPlugin());
        -   patientHistoryField.registerPlugin(new goog.editor.plugins.RemoveFormatting());
        -   patientHistoryField.registerPlugin(new goog.editor.plugins.UndoRedo());
        -   patientHistoryField.registerPlugin(new goog.editor.plugins.ListTabHandler());
        -   patientHistoryField.registerPlugin(new goog.editor.plugins.SpacesTabHandler());
        -   patientHistoryField.registerPlugin(new goog.editor.plugins.EnterHandler());
        -   patientHistoryField.registerPlugin(new goog.editor.plugins.HeaderFormatter());
        -   patientHistoryField.registerPlugin(new goog.editor.plugins.LinkDialogPlugin());
        -   patientHistoryField.registerPlugin(new goog.editor.plugins.LinkBubble());

        -   // reportContents
        -   myField.registerPlugin(new goog.editor.plugins.BasicTextFormatter());
        -   myField.registerPlugin(new goog.editor.plugins.RemoveFormatting());
        -   myField.registerPlugin(new goog.editor.plugins.UndoRedo());
        -   myField.registerPlugin(new goog.editor.plugins.ListTabHandler());
        -   myField.registerPlugin(new goog.editor.plugins.SpacesTabHandler());
        -   myField.registerPlugin(new goog.editor.plugins.EnterHandler());
        -   myField.registerPlugin(new goog.editor.plugins.HeaderFormatter());
        -   myField.registerPlugin(new goog.editor.plugins.LinkDialogPlugin());
        -   myField.registerPlugin(new goog.editor.plugins.LinkBubble());
        -
        -   // Specify the buttons to add to the toolbar, using built in default buttons.
        -   var buttons = [
        -     goog.editor.Command.BOLD,
        -     goog.editor.Command.ITALIC,
        -     goog.editor.Command.UNDERLINE,
        -     goog.editor.Command.FONT_COLOR,
        -     goog.editor.Command.BACKGROUND_COLOR,
        -     goog.editor.Command.FONT_FACE,
        -     goog.editor.Command.FONT_SIZE,
        -     goog.editor.Command.LINK,
        -     goog.editor.Command.UNDO,
        -     goog.editor.Command.REDO,
        -     goog.editor.Command.UNORDERED_LIST,
        -     goog.editor.Command.ORDERED_LIST,
        -     goog.editor.Command.INDENT,
        -     goog.editor.Command.OUTDENT,
        -     goog.editor.Command.JUSTIFY_LEFT,
        -     goog.editor.Command.JUSTIFY_CENTER,
        -     goog.editor.Command.JUSTIFY_RIGHT,
        -     goog.editor.Command.SUBSCRIPT,
        -     goog.editor.Command.SUPERSCRIPT,
        -     goog.editor.Command.STRIKE_THROUGH,
        -     goog.editor.Command.REMOVE_FORMAT
        -   ];

        -   // patientHistory ///////////////////////
        -   var PatientHistoryToolbar = goog.ui.editor.DefaultToolbar.makeToolbar(buttons,
        -       goog.dom.getElement('patientHistoryToolBar'));
        -
        -   // Hook the toolbar into the field.
        -   var PatientHistoryToolbarController =
        -       new goog.ui.editor.ToolbarController(patientHistoryField, PatientHistoryToolbar);
        -
        -   // Watch for field changes, to display below.
        -   goog.events.listen(patientHistoryField, goog.editor.Field.EventType.DELAYEDCHANGE,
        -       updatePatientHistoryContents);
        -
        -   patientHistoryField.makeEditable();

        -   // reportContent ///////////////////////
        -   var myToolbar = goog.ui.editor.DefaultToolbar.makeToolbar(buttons,
        -       goog.dom.getElement('toolbar'));
        -
        -   // Hook the toolbar into the field.
        -   var myToolbarController =
        -       new goog.ui.editor.ToolbarController(myField, myToolbar);
        -
        -   // Watch for field changes, to display below.
        -   goog.events.listen(myField, goog.editor.Field.EventType.DELAYEDCHANGE,
        -       updateFieldContents);
        -
        -   myField.makeEditable();



#################################################

    includeable masterMixCalculations
      script
        - $(document).ready( function() {
        -   $('#MasterMixDiv').hide();
        -   $('#stepFormSubmitButton').click( function() {
        -     newSubmitFunction();
        -   });
        - });

      script
        - function newSubmitFunction() {
        -   $(".reagent").each( function() {
        -     if ($(this).val().length > 0) {
        -       var reagentId = $(this).val();
        -       var reagentAmount = $(this).parents().siblings().children('.amount').val();
        -       var reagentType = $(this).parents().siblings().children('.type').val();
        -       var postData = {
        -         "reagentId": reagentId,
        -         "reagentAmount": reagentAmount,
        -         "reagentType": reagentType,
        -         "stepName": "Ajax POST Master Mix Reagents",
        -         "Submit": true,
        -         "formNumber": 0
        -       };
        -       $.post('/uniflow', postData)
        -         .done(function(data) {
        -           var postHtml = $.parseHTML(data);
        -           var postError = checkPostError(postHtml);
        -           if (postError !== false) {
        -             alert(postError);
        -           }
        -           else {
        -             console.log("Success!");
        -           }
        -         })
        -         .fail(function(jqxhr, textStatus, error) {
        -           var err = "POST Request Failed: " + textStatus + ", " + error;
        -           console.log(err);
        -           alert(err);
        -         });
        -     }
        -   });
        - }

      script
        - function getInstructionsAndReagentsPlate(){
        -   var masterMixArray = [];
        -   var overage = $('#overage').val();
        -   $('.well').each( function (i, obj) {
        -     var count = 0;
        -     var inputValue = obj.value;
        -     if (inputValue.length > 0) {
        -       count = nameCount(obj.value);
        -       var name = obj.value;
        -       var masterMixObject = {
        -         name: name,
        -         count: count
        -       }
        -       if (containsObject (masterMixObject, masterMixArray)) {
        -         return;
        -       }
        -       else {
        -         masterMixArray.push(masterMixObject);
        -       }
        -     }
        -   });
        -   console.log(overage);
        -   arrayPostFunction(masterMixArray, $('#overage').val());
        -   console.log('test');
        -   instructionTable();
        -   reagentTable();
        - }

      script
        - function getInstructionsAndReagentsArray(masterMixArray){
        -   var overage = $('#overage').val();
        -   console.log(masterMixArray);
        -   arrayPostFunction(masterMixArray,overage);
        -   instructionTable();
        -   reagentTable();
        - }
      script
        - function nameCount(wellValue) {
        -   var count = 0;
        -   $('.well').each( function(i, obj) {
        -     if (obj.value == wellValue) {
        -       count++;
        -     }
        -   });
        -   return count;
        - }
      script
        - function containsObject(obj, array) {
        -   var i;
        -   for (i = 0; i < array.length; i++) {
        -     if (array[i].name === obj.name) {
        -       return true;
        -     }
        -   }
        -   return false;
        - }
      script
        - function arrayPostFunction(array, overage) {
        -   $('#MasterMixDiv').show();
        -   var arrayJson = JSON.stringify(array);
        -   $('#arrayText').val(arrayJson);
        -   var postData = {
        -     "theData": arrayJson,
        -     "overage": overage,
        -     "stepName": "Ajax POST Master Mix",
        -     "Submit": true,
        -     "formNumber": 0
        -   };
        -   console.log(postData);
        -   $.post('/uniflow', postData)
        -   .done(function(data) {
        -     var postHtml = $.parseHTML(data);
        -     var postError = checkPostError(postHtml);
        -     if (postError !== false) {
        -       alert(postError);
        -     }
        -     else {
        -       console.log("Success!");
        -     }
        -   })
        -   .fail(function(jqxhr, textStatus, error) {
        -     var err = "POST Request Failed: " + textStatus + ", " + error;
        -     console.log(err);
        -     alert(err);
        -   });
        - }
      script
        - function instructionTable() {
        -   console.log('instructions start');
        -   $('#mmInstructionsDiv').load('/uniflow', {stepName: 'Ajax Get Master Mix Instructions and Volumes'});
        -   console.log('instructions end');
        - }

      script
        - function reagentTable() {
        -   console.log('reagents start');
        -   $('#mmReagentsDiv').load('/uniflow', {stepName: 'Ajax Get Master Mix Reagents'});
        -   console.log('reagents end');
        - }

      script
        - $(document).ready(function(){
        -   $('th:contains("Hidden")').addClass('hide');
        -   $('.hide').hide();
        - });

      script
        - function reagentValidation( containerId, type,  qualification, name) {
        -   console.log('reagentValidationFunction');
        -   console.log(qualification);
        -      var aliquot;
        -      var dilution;
        -     $.getJSON('/uniflow?callback=?&stepName=Ajax+Get+Reagent+Qualification&qualification='+ qualification+'&containerId=' + containerId,{},
        -    function(data,status)
        -    {
        -         if(data.length > 0) {
        -           if(data[0].qualification == qualification && data[0].type == type && data[0].expDate > data[0].todayDate)
        -           {
        -             $('[name^="'+name+'"]').parent().css("background-color", "PaleGreen");
        -           }
        -           if(data[0].qualification != qualification)
        -           {
        -              $('[name^='+name+']').parent().css("background-color", "Red");
        -              $('#qualError').empty();
        -              $('#qualError').append("<p>THIS REAGENT EITHER DOES NOT HAVE A QUALIFICATION OR THE QUALIFICATION IS EXPIRED!</p> " +
        -                 "<p> PLEASE LOOKUP THE REAGENT UNDER THE REAGENT MANAGEMENT STEPGROUP TO SEE DETAILS.</p>");
        -              $('#qualError').dialog().show();
        -           }
        -           if(data[0].type != type)
        -           {
        -             $('[name^='+name+']').parent().css("background-color", "Red");
        -             $('#typeError').empty();
        -             $('#typeError').append("<p>THE REAGENT SCANNED IS NOT " + type + ".</p><p> IT IS "+data[0].type+". </p><p>PLEASE SCAN IN THE CORRECT REAGENT TYPE</p>");
        -             $('#typeError').dialog().show();
        -           }
        -           if(data[0].expDate < data[0].todayDate)
        -           {
        -              $('[name^='+name+']').parent().css("background-color", "Red");
        -              $('#expError').empty();
        -              $('#expError').append("<p>THIS REAGENT HAS EXPIRED! PLEASE DISCARD OR SEE A MANAGER.</p>");
        -              $('#expError').dialog().show();
        -           }
        -         } else {
        -              $('[name^='+name+']').parent().css("background-color", "Red");
        -              $('#expError').empty();
        -              $('#expError').append("<p>THIS REAGENT DOES NOT EXIST!.</p>");
        -              $('#expError').dialog().show();
        -         }
        -    });
        - }


      div
        style= display: none;
        textArea arrayText
          id= arrayText
      ## Plate Button
      div
        id= plateButton
        button
          value= Get Instructions and Reagents
          onclick= getInstructionsAndReagentsPlate();
      ## Array Button
      div
        id= arrayButton
        button
          value= Get Instructions and Reagents
      vertical
        number overage
          id= overage
          screenLabel~ Overage
          value= 0.2
      div
        id= MasterMixDiv
        fieldset
          legend Master Mixes
            class= toggle
          div
            id= mmInstructionsDiv
        fieldset
          legend Reagent Scan
            class= toggle
          div
            id= mmReagentsDiv


#################################################

    includeable masterMixRecipe
    ## If numSamplesAutoCalc = true for step, a div or table holding the samples (must be container or passiveContainer!)
    ## on the page to be calculated should have class masterMixSamples!

    #### Modified from Martyna's script to be generic
    ### set to only do one (1) master mix ... too many issues if trying to be generic over multiple master mix tables
      script
        # mm1
        - var sampleElems1, mmSampleNumber1, totalNumber1, sampleNumber1, sampleErrorTolerance1;
        - function setupMasterMixRecipe1(masterMixElem, numberOfSamples, sampleErrorTolerance) {
            ## Default to 0 if not defined
        -   if(!sampleErrorTolerance) sampleErrorTolerance = 0;
        -   sampleErrorTolerance1 = parseInt(sampleErrorTolerance);
        -   if(!numberOfSamples) numberOfSamples = 0;
        -   mmSampleNumber1 = parseInt(numberOfSamples);
        -   totalNumber1 = mmSampleNumber1 + sampleErrorTolerance1;
        -
        -   sampleElems1 = $('.masterMixSamples input.newContainer,.masterMixSamples input.passiveContainer,.masterMixSamples input.container');
            ## Hide any barcodes for fields where isExtraRowForCalc = true
        -   masterMixElem.find('table.stdTable td.col6 input[value="true"]').parent().parent().children('.col1').children().hide();
        -
        -   if($('#numSamplesAutoCalc1').val() == 'true' && sampleElems1.length > 0) {
        -     sampleElems1.change(function() {
                ## Make sure volume resets are done
        -       masterMixElem.find('.masterMixSingleVol1').trigger('keyup');
                ### Calc MM volumes as samples are added
        -     });
        -   } else {
        -     masterMixElem.find('#masterMixSampleNumber1').change(function() {
                ## Make sure volume resets are done
        -       masterMixElem.find('.masterMixSingleVol1').trigger('keyup');
        -     });
        -
        -   }
            ### recalculation of volumes based on change to master mix volume
        -   masterMixElem.find('.masterMixSingleVol1').keyup(function() {
        -     var thisVal = $(this).val();
        -     $(this).parent().parent().find('input.masterMixTotalVol1').val( roundTo2Dec(totalNumber1 * parseFloat(thisVal)) );
        -     calculateTotalVolumes1(masterMixElem, sampleErrorTolerance);
        -   });
        -
        -   masterMixElem.find('tfoot').html('<tr><td colspan="2">Total Volumes:</td><td class="masterMixOverallSingleVol1"></td><td class="masterMixUnit"></td><td class="masterMixOverallTotalVol1"></td></tr>');
        -   masterMixElem.find('tfoot').find('td.masterMixUnit').html(masterMixElem.find('table .col3:first').html());
        -   calculateTotalVolumes1(masterMixElem, sampleErrorTolerance);
        -
        - return
            ## Trigger the above events right away to init values. singleVol keyup is triggered in change.
        -   if($('#numSamplesAutoCalc1').val() == 'true' && sampleElems1.length > 0) {
        -     sampleElems1.first().trigger('change');
        -   } else {
        -     masterMixElem.find('#masterMixSampleNumber1').trigger('change');
        -   }
        - }

        ### Total volume calculation function
        - function calculateTotalVolumes1(masterMixElem, sampleErrorTolerance) {
        -     var rxnMixTot = 0;
        -     masterMixElem.find('.masterMixSingleVol1').each(function(){
        -       rxnMixTot += parseFloat($(this).val());
        -     });
        -     masterMixElem.find('.masterMixOverallSingleVol1').html(roundTo2Dec(rxnMixTot));
        -     masterMixElem.find('.masterMixOverallTotalVol1').html(roundTo2Dec(rxnMixTot * totalNumber1));
        - }
        -

        - function roundTo2Dec(number) {
        -   return Math.round(number * 100) / 100;
        - }
        -
        - function checkResource(mmNum, containerId, type, qualification, name) {
        -      var aliquot;
        -      var dilution;
        -     $.getJSON('/uniflow?callback=?&stepName=Ajax+Get+Reagent+Qualification&qualification='+ qualification+'&containerId=' + containerId,{},
        -    function(data,status)
        -    {
        -         if(data[0].qualification == qualification && data[0].type == type && data[0].expDate > data[0].todayDate)
        -         {
        -             $('[name^="'+name+'"]').parent().css("background-color", "PaleGreen");
        -         }
        -         if(data[0].qualification != qualification)
        -         {
        -              $('[name^='+name+']').parent().css("background-color", "Red");
        -              $('#qualError'+mmNum).empty();
        -              $('#qualError'+mmNum).append("<p>THIS REAGENT EITHER DOES NOT HAVE A QUALIFICATION OR THE QUALIFICATION IS EXPIRED!</p> " +
        -                 "<p> PLEASE LOOKUP THE REAGENT UNDER THE REAGENT MANAGEMENT STEPGROUP TO SEE DETAILS.</p>");
        -              $('#qualError'+mmNum).dialog().show();
        -         }
        -         if(data[0].type != type)
        -         {
        -             $('[name^='+name+']').parent().css("background-color", "Red");
        -             $('#typeError'+mmNum).empty();
        -             $('#typeError'+mmNum).append("<p>THE REAGENT SCANNED IS NOT " + type + ".</p><p> IT IS "+data[0].type+". </p><p>PLEASE SCAN IN THE CORRECT REAGENT TYPE</p>");
        -             $('#typeError'+mmNum).dialog().show();
        -         }
        -         if(data[0].expDate < data[0].todayDate)
        -         {
        -              $('[name^='+name+']').parent().css("background-color", "Red");
        -              $('#expError'+mmNum).empty();
        -              $('#expError'+mmNum).append("<p>THIS REAGENT HAS EXPIRED! PLEASE DISCARD OR SEE A MANAGER.</p>");
        -              $('#expError'+mmNum).dialog().show();
        -         }
        -    });
        - }
        -
        - $(document).ready(function(){
        -   setupMasterMixRecipe1($('#mm1'), $('#masterMixSampleNumber1').val(), $('#masterMixErrorTolerance1').val());
        - });

      style
        - #mm1 table.stdTable thead tr th:last-child, #mm1 table.stdTable tbody tr td:last-child,
        - #mm1 table.stdTable thead tr th:nth-last-child(2), #mm1 table.stdTable tbody tr td:nth-last-child(2)
        - { display: none;}
        - .masterMixSingleVol1, .masterMixTotalVol1 { width: 50px;}


      formQuery~ select count(distinct label) as 'totalMMs' from inventoryMMUsage
        - where step = '{_step}'
        - group by step
        - union all select 0
        - limit 1
      formQuery~ select * from (select numSamplesAutoCalc, numSamples, errorTolerance,
        - case when label = '' then 'Master Mix' else label end as 'label'
        - from inventoryMMUsage
        - where step = '{_step}') as temp
        - union all select 'false', '1', '0', ''

      hidden totalMMs
        id= totalMMs
        value= {_:totalMMs}

      fieldset
        id= mm1
        legend !!!{_:label}
          onclick= $(this).next().toggle();
          style= cursor: pointer; width: 100px;

        div
          div
            id= typeError1
            title= Resource Type Error
            style= display:none;
          div
            id= qualError1
            title= Qualification Error
            style= display:none;
          div
            id= expError1
            title= Expiration Date Error
            style= display:none;

          hidden numSamplesAutoCalc
            class= numSamplesAutoCalc
            id= numSamplesAutoCalc1
            value= {_:numSamplesAutoCalc}

          vertical2
            text sampleNumber
              class= masterMixSampleNumber
              id= masterMixSampleNumber1
              screenLabel~ Total Number of Samples
              value= {_:numSamples}
              onchange= setupMasterMixRecipe1($('#mm1'), $('#masterMixSampleNumber1').val(), $('#masterMixErrorTolerance1').val());
            text errorTolerance
              class= masterMixErrorTolerance
              id= masterMixErrorTolerance1
              readOnly= true
              screenLabel~ Sample error tolerance:
              value= {_:errorTolerance}

          table
            sqlQuery~ select u.inventoryItem as 'Reagent', '' as 'Barcode',
              - u.amount as 'Vol./rxn', u.units as 'Units', (u.amount * (u.numSamples+u.errorTolerance)) as 'Total Vol.',
              - u.inventoryItem as 'hidden', u.isExtraRowForCalc as 'hidden'
              - from inventoryMMUsage u
              - where u.step = '{_step}' and u.label = (case when '{_:label}' = 'Master Mix' then '' else '{_:label}' end)
            columnSpecs~ masterMixRecipe1
              allowChangedRecordIds
              column 2
                inputType resource
                  class= resource
                  required~ false
                  qualifyResource~ Reagent QC
                  validate~ ! select reagentType from reagents where reagentId = '{_columnInput:2}'
                    - and reagentType <> '{_columnInput:6}'
                    - and '{_columnInput:2}' <> ''
                    errorMessage~ This reagent does not match the Reagent Type! Check again.
                  onchange= checkResource('1', $(this).val(),$(this).parent().siblings().children('.type').val(), 'Reagent QC', $(this).attr('name'));
                  sqlPreparedStatement~ update inventoryItems
                    - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                    - where inventoryItem = ?
                    - and ? <> ''
                    float {_columnInput:5}
                    string {_columnInput:6}
                    string {_columnInput:2}
                  sqlPreparedStatement~ update reagents
                    - set quantity = quantity - CAST(? AS DECIMAL(10,2))
                    - where reagentId = ?
                    - and ? <> ''
                    float {_columnInput:5}
                    string {_columnInput:2}
                    string {_columnInput:2}
                  sqlPreparedStatement~ update reagents
                    - set openDate = curDate()
                    - where reagentId = ?
                    - and openDate IS NULL
                    - and ? <> ''
                    string {_columnInput:2}
                    string {_columnInput:2}
              column 3
                inputType text
                  class= text masterMixSingleVol1
              column 5
                inputType text
                  class= text masterMixTotalVol1
                  readonly=
              column 6
                inputType hidden
                  class= type
              column 7
                inputType hidden
      hr

    # HTML to PDF
    #
    # Example:
    # Required html input and pdf output paths
    # htmlPath = '{_configPath}private/reports/tmpHTML_{_eventId}.html'
    # pdfPath = '{_configPath}private/reports/{reportId}.pdf'
    #
    # Optional replacements
    # replace = dict()
    # replace['patientName'] = '{_:patientName}'
    #
    # wkhtmlpdf options
    # args = dict()
    # args['margin-bottom'] = '25mm'
    #
    # Create pdf
    # call_htmltopdf(htmlPath, pdfPath, header='header.html', footer='footer.html', replace=replace, args=args)
    #
    # HTML to PDF
    #
    # Example:
    # Required html input and pdf output paths
    # htmlPath = '{_configPath}private/reports/tmpHTML_{_eventId}.html'
    # pdfPath = '{_configPath}private/reports/{reportId}.pdf'
    #
    # Optional replacements
    # replace = dict()
    # replace['patientName'] = '{_:patientName}'
    #
    # wkhtmlpdf options
    # args = dict()
    # args['margin-bottom'] = '25mm'
    #
    # Create pdf
    # call_htmltopdf(htmlPath, pdfPath, header='header.html', footer='footer.html', replace=replace, args=args)
    #
    includeable htmlToPdf
      jython
        import subprocess
        from com.uniconnect.uniflow.exception import SystemException
        from java.sql import SQLException
        def call_htmltopdf(html_path, pdf_path, header=None, footer=None, replace=~{~}, args=~{~}):

          default_args = ~{
            # 'no-print-media-type': None,
            'page-size': 'Letter',
            'orientation': 'Portrait',
            'margin-top': '75mm',
            'margin-right': '6mm',
            'margin-bottom': '55mm',
            'margin-left': '6mm',
            'header-spacing': '10',
            'footer-spacing' : '10'
          ~}

          if args:
            default_args.update(args)

          cmd = ['/usr/local/bin/wkhtmltopdf']
          for arg in default_args:
            cmd.append("--%s" % arg)
            if default_args[arg] is not None:
              cmd.append(default_args[arg])

          if header:
            cmd.append('--header-html')
            cmd.append(header)
          if footer:
            cmd.append('--footer-html')
            cmd.append(footer)

          if replace:
            for subst in replace:
              cmd.append('--replace')
              cmd.append(subst)
              cmd.append(replace[subst])

          cmd.append(html_path)
          cmd.append(pdf_path)

          try:
            exit_code = subprocess.call(cmd)
            if exit_code != 0:
              err_msg = "HTML to PDF Error (%d)" % exit_code
              switchboard.log(err_msg)
              print cmd
          # except Exception, e:
          #   switchboard.log('HTML to PDF Error')
          #   raise
          except Exception as e:
            switchboard.log('HTML to PDF Error')
            raise
          except StandardError as e:
            switchboard.log("---*** Standard Py Error htmlToPDF*** ")
            switchboard.log(str(e.message))
            raise
          except SystemException as e:
            switchboard.log("---*** UNIFlow SystemException htmlToPDF ***----")
            switchboard.log(str(e.message))
            raise
          except SQLException as e:
            switchboard.log("---*** SQLException htmlToPDF ***----")
            switchboard.log(str(e.message))
            raise
          except BaseException as e:
            switchboard.log("---*** PyException htmlToPDF ***----")
            switchboard.log(str(e.message))
            raise
          except TypeError as e:
            switchboard.log("---*** TypeError htmlToPDF ***----")
            switchboard.log(str(e.message))
            raise
          except:
            switchboard.log("*** Unspecified Error htmlToPDF *****")
            raise
    ### END HTML to PDF

    # Jython User Message Display
    includeable JythonUserMessage
      formOutputJython~
        import com.uniconnect.uniflow as uniflow
        this_message = '{USER_MESSAGE}'
        if this_message != 'null' and this_message != '':
          p = uniflow.Node("p", this_message)
          msg = this_message.lower()
          if msg.startswith('ERROR:'):
            p.add('class=', 'error')
          else:
            p.add('class=', 'message')
          switchboard.page.body.add(p)

####################### ACCESSIONING INCLUDES ###############################################################
    includeable patientInfo
      script
        - function searchPatients() {
        -   $('#patientsCandidates').load('/uniflow',
        -          {stepName: 'Ajax Patients Search Server',
        -           firstName: $('#patientFirstName').val(),
        -           lastName: $('#patientLastName').val(),
        -           DOB: $('#patientDOB').val(),
        -           SSN: $('#patientSSN').val(),
        -           Gender: $('#patientType').val()
        -          });
        -       $('#patientsCandidates').css('display','block');
        - }
        - function setPatient() {
        -   var patientId = $('#patientId').val();
        -   $.getJSON('/uniflow?callback=?&stepName=Ajax+Patient+Server&patientId=' + patientId,{},
        -     function(data,status) {
        -       $('#patientsCandidates').css('display','none');
        -       document.getElementsByName('newPatientId')[0].value = data[0].Id;
        -       document.getElementsByName('firstName')[0].value = data[0].firstName;
        -       document.getElementsByName('lastName')[0].value = data[0].lastName;
        -       document.getElementsByName('middleName')[0].value = data[0].middleName;
        -       document.getElementsByName('dob')[0].value = data[0].dob;
        -       document.getElementsByName('ssn')[0].value = data[0].ssn;
        -       document.getElementsByName('newPatientGender')[0].value = data[0].gender;
        -       document.getElementsByName('mrn')[0].value = data[0].mrn;
        -       eth = data[0].ethnicity.split(',');
        -       for (i_eth in eth)
        -       {
        -         $('#ethnicity').children('option[value="' + eth[i_eth].trim() +'"]').attr('selected',true);
        -       }
        -       document.getElementsByName('address1')[0].value = data[0].address1;
        -       document.getElementsByName('address2')[0].value = data[0].address2;
        -       document.getElementsByName('city')[0].value = data[0].city;
        -       document.getElementsByName('state')[0].value = data[0].state;
        -       document.getElementsByName('postalCode')[0].value = data[0].postalCode;
        -       document.getElementsByName('country')[0].value = data[0].country;
        -       document.getElementsByName('homePhone')[0].value = data[0].homePhone;
        -       document.getElementsByName('cellPhone')[0].value = data[0].cellPhone;
        -       document.getElementsByName('altPhone')[0].value = data[0].altPhone;
        -       document.getElementsByName('email')[0].value = data[0].email;
        -       var dateOfBirth = data[0].dob;
        -       var dateAr = dateOfBirth.split('-');
        -       var newDate = dateAr[1] + '/' + dateAr[2] + '/' + dateAr[0];
        -       if(typeof dateAr[1] !== "undefined") {
        -         $("[name='dob']").val(newDate); }
        -     }
        -   );
        -   $.getJSON('/uniflow?callback=?&stepName=Ajax+Clinical+Server&patientId=' + patientId,{},
        -     function(data,status) {
        -       if (data) {
        -       document.getElementsByName('currentMedications')[0].value = data[0].medications;
        -       document.getElementsByName('problemMedications')[0].value = data[0].problemMedications;
        -       document.getElementsByName('allergies')[0].value = data[0].allergies;
        -       document.getElementsByName('clinicalNotes')[0].value = data[0].clinicalNotes;
        -       document.getElementsByName('clinicalHistory')[0].value = data[0].clinicalHistory;
        -       document.getElementsByName('geneticCounselor')[0].value = data[0].geneticCounselor;
        -       document.getElementsByName('diagnosis')[0].value = data[0].diagnosis;
        -       document.getElementsByName('histodiagnostic')[0].value = data[0].histoDiagnosis;
        -       document.getElementsByName('presentationAge')[0].value = data[0].presentationAge;
        -       }
        -     }
        -   );
        -   $.getJSON('/uniflow?callback=?&stepName=Ajax+Billing+Server&patientId=' + patientId,{},
        -     function(data,status) {
        -       if (data) {
        -       document.getElementsByName('paymentOption')[0].value = data[0].paymentOption;
        -       document.getElementsByName('medicareNumber')[0].value = data[0].medicareNumber;
        -       document.getElementsByName('parentSignature')[0].value = data[0].parentSignature;
        -       document.getElementsByName('guarantorName')[0].value = data[0].guarantor;
        -       document.getElementsByName('policyHolderName_1')[0].value = data[0].policyHolderName_1;
        -       document.getElementsByName('relationship_1')[0].value = data[0].relationship_1;
        -       document.getElementsByName('insuranceCompany_1')[0].value = data[0].insuranceCompany_1;
        -       document.getElementsByName('policyNumber_1')[0].value = data[0].policyNumber_1;
        -       document.getElementsByName('groupNumber_1')[0].value = data[0].groupNumber_1;
        -       document.getElementsByName('responsibleAddress1_1')[0].value = data[0].responsibleAddress1_1;
        -       document.getElementsByName('responsibleAddress2_1')[0].value = data[0].responsibleAddress2_1;
        -       document.getElementsByName('responsibleCity_1')[0].value = data[0].responsibleCity_1;
        -       document.getElementsByName('responsibleState_1')[0].value = data[0].responsibleState_1;
        -       document.getElementsByName('responsibleZip_1')[0].value = data[0].responsibleZip_1;
        -       document.getElementsByName('phone_1')[0].value = data[0].phone_1;
        -       document.getElementsByName('policyHolderId_1')[0].value = data[0].policyHolderId_1;
        -       document.getElementsByName('policyHolderDOB_1')[0].value = data[0].policyHolderDOB_1;
        -       document.getElementsByName('policyHolderName_2')[0].value = data[0].policyHolderName_2;
        -       document.getElementsByName('relationship_2')[0].value = data[0].relationship_2;
        -       document.getElementsByName('insuranceCompany_2')[0].value = data[0].insuranceCompany_2;
        -       document.getElementsByName('policyNumber_2')[0].value = data[0].policyNumber_2;
        -       document.getElementsByName('groupNumber_2')[0].value = data[0].groupNumber_2;
        -       document.getElementsByName('responsibleAddress1_2')[0].value = data[0].responsibleAddress1_2;
        -       document.getElementsByName('responsibleAddress2_2')[0].value = data[0].responsibleAddress2_2;
        -       document.getElementsByName('responsibleCity_2')[0].value = data[0].responsibleCity_2;
        -       document.getElementsByName('responsibleState_2')[0].value = data[0].responsibleState_2;
        -       document.getElementsByName('responsibleZip_2')[0].value = data[0].responsibleZip_2;
        -       document.getElementsByName('phone_2')[0].value = data[0].phone_2;
        -       document.getElementsByName('policyHolderId_2')[0].value = data[0].policyHolderId_2;
        -       document.getElementsByName('policyHolderDOB_2')[0].value = data[0].policyHolderDOB_2;
        -       var dob1 = data[0].policyHolderDOB_1
        -       var dob2 = data[0].policyHolderDOB_2
        -       var dateAr1 = dob1.split('-');
        -       var dateAr2 = dob2.split('-');
        -       var newDate1 = dateAr1[1] + '/' + dateAr1[2] + '/' + dateAr1[0];
        -       var newDate2 = dateAr2[1] + '/' + dateAr2[2] + '/' + dateAr2[0];
        -       if(typeof dateAr1[1] !== "undefined") {
        -         $("[name='policyHolderDOB_1']").val(newDate1); }
        -       if(typeof dateAr2[1] !== "undefined") {
        -         $("[name='policyHolderDOB_2']").val(newDate2); }
        -       }
        -     }
        -   );
        - }
        -
        - function searchPatientsByOrganization() {
        -  $('#physicianId').load('/uniflow',{stepName: 'Ajax Patients By Organization Search Server'
        -     ,organizationId: $('#organizationId').val()
        -  });
        - }
        -  function onlyDigits(phoneNumber, inputId) {
        -   phoneNumber = phoneNumber.replace(/\D/g,'');
        -   $('#'+inputId).val(phoneNumber);
        -  }
      script
        - $(document).ready(function(){
        -   $('#patientLastName').focus();
        -   $('#patientLastName').select();
        -   preventReturnOnInput();
        -   $('th:contains("Hidden")').addClass('hide');
        -   $('.hide').hide();
        -   $('.accordion').accordion();
        -   $('#testIcdCode').autocomplete();
        -   $('#clearPatient').click(function() {
        -     $('.clearPatient').val('');
        -     $('.clearPatientSelect').prop('checked', false);
        -     $('#patientId').val(-1);
        -   });
        - }); //End of Document Ready!!
      formQuery~ select date_format(curdate(), '%m/%d/%Y') as 'todayDate' from dual
      formQuery~ select
        -        case
        -             when '{testType}' = 'Cytogenetics' then 'cyto'
        -             when '{testType}' = 'NGS' then 'ngs'
        -             when '{testType}' = 'Oncology' then 'onc'
        -             when '{testType}' = 'Biochemical Genetics' then 'bioGen'
        -             when '{testType}' = 'Molecular Genetics' then 'molGen'
        -             when '{testType}' = 'Genetics' then 'gen'
        -             when '{testType}' = 'Toxicology' then 'tox'
        -        else '{testType}' end as 'SamplePrefix'
      hidden testType
        value= {testType}
        id= testtype
     ###################################################################################
      vertical
        date receivedDate
          class= datePickerNow
          value= {_:todayDate}
          screenLabel~ Order Form Received Date
          placeholder= mm/dd/yyyy
      vertical
        div
          fieldset
            legend PATIENT RECORD
              class= legend toggle
            vertical
              div
                id= patientInfo
      ######################## FIND PATIENT ##################################
                h3 PATIENT SEARCH
                vertical2
                  simpleTable
                    tr
                      td &nbsp;Last Name
                      td &nbsp;First Name
                      td &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DOB
                      td &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SSN
                      td &nbsp;&nbsp;Gender
                    tr
                      style= display: none;
                      td Patient Id
                        colspan= 3
                        text patientId
                    tr
                      td
                        text patientLastName
                          style= width:80px;
                          id= patientLastName
                          onchange= return searchPatients();
                          class= clearPatient
                      td
                        text patientFirstName
                          style= width:80px
                          id= patientFirstName
                          onchange= return searchPatients();
                          class= clearPatient
                      td
                        text patientDOB
                          style= width:90px
                          id= patientDOB
                          class= datePickerDOB clearPatient
                          title= mm/dd/yyyy
                          onchange= return searchPatients();
                      td
                        text patientSSN
                          style= width:80px
                          id= patientSSN
                          class= clearPatient
                          onchange= return searchPatients();
                      td
                        select patientGender
                          id= patientType
                          setName~ gender
                          title= SETNAME:gender
                          class= clearPatient
                          required~ false
                          option Male
                            value= M
                          option Female
                            value= F
                          option Unknown
                            value= U
                          onchange= return searchPatients();
                        colspan= 2
                  button Clear Patient
                    id= clearPatient
                    style= font-size:.8em;

                  div
                    id= patientsCandidates
                    style= max-height:150px;overflow:scroll;
           ######################## END FIND PATIENT ####################################



           ####################### (NEW) PATIENT INFORMATION ############################
                vertical
                  h3 PATIENT INFORMATION
                  vertical
                    div
                      id= new_Patient
                      div
                        style= float:left;
                        vertical
                          text newPatientId
                            #screenLabel~ Patient Id
                            screenLabel~
                            id= patientId
                            value= -1
                            readonly=
                            style= display:none;
                          text firstName
                            screenLabel~ First Name
                            class= clearPatient patientInfo required
                            required~ true
                            data-parsley-required= true
                            size= 30
                          text middleName
                            screenLabel~ Middle Name
                            class= clearPatient
                            size= 30
                          text lastName
                            screenLabel~ Last Name
                            class= clearPatient patientInfo required
                            required~ true
                            data-parsley-required= true
                            size= 30
                          text mrn
                            screenLabel~ MRN
                            class= clearPatient
                          text ssn
                            screenLabel~ SSN
                            class= clearPatient
                            pattern= .*
                            placeholder= ###-##-####
                            required~ false
                            validate~ SELECT 1
                              - FROM DUAL
                              - WHERE EXISTS
                              - (
                              -   SELECT 1
                              -   FROM userPrivileges up
                              -   WHERE (up.userId = '{_userId}'
                              -     AND up.authorizedStep = 'canViewFullSSN'
                              -     AND '{ssn}'REGEXP"^[0-9]?[0-9]?[0-9]-[0-9]?[0-9]-[0-9]?[0-9]?[0-9]?[0-9]$" = 1)
                              - )
                              - OR( NOT EXISTS
                              -     (
                              -       SELECT 1
                              -       FROM userPrivileges up
                              -       WHERE up.userId = '{_userId}'
                              -         AND up.authorizedStep = 'canViewFullSSN'
                              -     )
                              -     AND ('{ssn}'REGEXP"^[0-9]?[0-9]?[0-9]-[0-9]?[0-9]-[0-9]?[0-9]?[0-9]?[0-9]$" = 1 OR '{ssn}'REGEXP'^[#][#][#]-[#][#]-[0-9]?[0-9]?[0-9]?[0-9]$' = 1)
                              - )
                              - OR '{ssn}' = ''
                              errorMessage~ Please add a valid social security number
                          date dob
                            convert~ false
                            screenLabel~ DOB
                            title= mm/dd/yyyy
                            placeholder= mm/dd/yyyy
                            class= clearPatient datePickerDOB
                            data-parsley-required= false
                            required~ false
                            validate~ select 1 from dual where STR_TO_DATE(case when ? = '' then '01/01/1900' when STR_TO_DATE(?,'%m/%d/%Y') IS NULL then '1/1/1900' else ? END ,'%m/%d/%Y') <= CURDATE()
                              string {_thisInput}
                              string {_thisInput}
                              string {_thisInput}
                              errorMessage~ DOB should be in the past.
                          select newPatientGender
                            screenLabel~ Gender
                            setName~ gender
                            class= clearPatient
                            title= SETNAME:gender
                            required~ false
                            option Male
                              value= M
                            option Female
                              value= F
                            option Unknown
                              value= U
                          select ethnicity
                            class= clearPatient
                            screenLabel~ Ethnicity
                            id= ethnicity
                            multiple=
                            setName~ ethnicities
                            required~ false
                          text accessionId
                            screenLabel~ Accession Id
                          files requisitionFiles
                            destinationFolderName~ ../private/requisitionFiles/{_eventId}
                            #destinationFilePrefix~ 0000000000
                            required~ false
                            screenLabel~ Attach Files
                            data-parsley-required= false
                            multiple=
                            maxlength= 10
                            accept= jpg|png|pdf|jpeg
                            containerId~ {_eventId}

                      div
                        style= float:left; margin-left:0px;
                        vertical
                          text address1
                            screenLabel~ AddressLine1
                            class= clearPatient
                            size= 30
                          text address2
                            screenLabel~ AddressLine2
                            class= clearPatient
                            size= 30
                          text city
                            screenLabel~ City
                            class= clearPatient
                            size= 30
                          select state
                            screenLabel~ State
                            class= combobox clearPatient
                            option
                            sqlQuery~ select abbreviation from state order by abbreviation
                          text postalCode
                            screenLabel~ Zip
                            class= clearPatient
                          text country
                            screenLabel~ Country Code
                            class= clearPatient
                          text homePhone
                            id= homePhone
                            screenLabel~ Home Phone
                            class= clearPatient
                            placeholder= ##########
                            onchange= onlyDigits($(this).val(), $(this).attr('id'));
                          text cellPhone
                            id= cellPhone
                            screenLabel~ Cell Phone
                            class= clearPatient
                            placeholder= ##########
                            onchange= onlyDigits($(this).val(), $(this).attr('id'));
                          text altPhone
                            id= altPhone
                            screenLabel~ Work/Alt. Phone
                            class= clearPatient
                            placeholder= ##########
                            onchange= onlyDigits($(this).val(), $(this).attr('id'));
                          text email
                            screenLabel~ Email
                            class= clearPatient
                            type= email
                            data-parsley-required= false
                            data-parsley-type= email
                            size= 35
                          select sendingApp
                            screenLabel~ External System
                            id= sendingApp
                            sqlQuery~ select distinct COALESCE(sendingApp,'') as 'sendingApp' from requestForms
                            required~ false

                 #######################  END (NEW) PATIENT INFORMATION ###########################

                #######################  PATIENT CLINICAL TRIAL INFORMATION ############################
    includeable clinicalTrial
      div
        style= width:800px;
        fieldset
          legend CLINICAL TRIAL INFORMATION
            class= legend toggle
          vertical
            div
              id= clinicalTrialInfo
              vertical2
                vertical
                  checkbox patientInTrial
                    screenLabel~ Patient Enrolled in Clinical Trial
                    style= width:300px;
                  files clinicalTrialFiles
                    destinationFolderName~ ../private/requisitionFiles/ClinicalTrial_{_eventId}
                    required~ false
                    screenLabel~ Clinical Trial Enrollment and Signature Upload
                    data-parsley-required= false
                    multiple=
                    maxlength= 10
                    accept= jpg|png|pdf|jpeg
                    containerId~ ClinicalTrial_{_eventId}


                #######################  END PATIENT CLINICAL TRIAL INFORMATION ##########################


    includeable patientReqSQL
      ### PATIENT SQL ######
      setFormQueryResult
        sqlQuery select '{newPatientId}' as 'patientId' from dual

      ifCondition {_resultSet:patientId}
        advanced~
        equals~ -1
        and~ {firstName}
          not~
            isBlank~
        and~ {lastName}
          not~
            isBlank~

        sqlPreparedQuery~ select 1 from dual where ? = '-1' and (? <> '' or ? <> '')
          string {_resultSet:patientId}
          string {firstName}
          string {lastName}

        setFormQueryResult
          sqlQuery select 'PA{_getNextSequence:patientId}' as 'patientId' from dual
        ### new persons record
        sqlPreparedStatement
          - insert into entities (entityId,entityType,firstName,lastName,middleName,status,eventId)
          - values (?,?,?,?,?,?,?)
          string {_resultSet:patientId}
          string Patient
          string {firstName}
          string {lastName}
          string {middleName}
          string active
          long {_eventId}
        sqlPreparedStatement
          - insert into patients (patientId,dob,ssn,gender,mrn, ethnicity, eventId)
          - values (?, case ? when '' then NULL else ? end,?,?,?,?,?)
          string {_resultSet:patientId}
          string {dob}
          string {dob}
          string {ssn}
          string {newPatientGender}
          string {mrn}
          string {ethnicity}
          long {_eventId}
        sqlPreparedStatement
          - insert into containers (containerId, containerType, eventId)
          - values (?, ?, ?)
          string {_resultSet:patientId}
          string Patient
          long {_eventId}
        sqlPreparedStatement
          - insert into contents (containerId, attribute, contentType, content, eventId)
          - values (?, ?, ?, ?, ?)
          string {_resultSet:patientId}
          string self
          string Patient
          string {_resultSet:patientId}
          long {_eventId}
        else
          ifCondition{_resultSet:patientId}
            advanced~
            not~
              equals~ -1
            ### update persons record
            sqlPreparedStatement
              - update entities
              - set entityType = ?
              -   , firstName = ?
              -   , lastName = ?
              -   , middleName = ?
              - where entityId = ?
              string Patient
              string {firstName}
              string {lastName}
              string {middleName}
              string {_resultSet:patientId}
            sqlPreparedStatement
              - update patients
              - set dob = case when ? = '' then NULL else ? end, gender = ?, mrn = ?, ethnicity = ?
              - where patientId = ?
              string {dob}
              string {dob}
              string {newPatientGender}
              string {mrn}
              string {ethnicity}
              string {_resultSet:patientId}
          ifCondition
            advanced~
            sqlPreparedQuery~ select 1 from dual where left(?,6) <> '###-##'
              string {ssn}
            ### update ssn
            sqlPreparedStatement
              - update patients
              - set ssn = ?
              - where patientId = ?
              string {ssn}
              string {_resultSet:patientId}

        sqlPreparedStatement update patients set ethnicity = '' where patientId = ?
          string {_resultSet:patientId}
        forEachSelectedOption ethnicity
          sqlPreparedStatement update patients set ethnicity = concat(coalesce(ethnicity,''), case when coalesce(ethnicity,'') = '' then '' else ',' end, ?) where patientId = ?
            string {_resultSet:ethnicity}
            string {_resultSet:patientId}

      ### address
      ###   currently forcing addressType = 'Primary'sql~
      sqlPreparedStatement
        - delete from entityAddresses
        - where entityId = ? and type = ?
        string {_resultSet:patientId}
        string Primary
      sqlPreparedStatement
        - insert into entityAddresses (entityId, address1, address2, city, state, postalCode, country, type, status, eventId)
        - select ?,?,?,?,?,?,?,?,?,?
        - from dual
        - WHERE length(?) > 0 and ? <> '-1'
        string {_resultSet:patientId}
        string {address1}
        string {address2}
        string {city}
        string {state}
        string {postalCode}
        string {country}
        string Primary
        string active
        long {_eventId}
        string {address1}
        string {_resultSet:patientId}

      sqlPreparedStatement
        - delete from entityPhones
        - where entityId = ?
        string {_resultSet:patientId}
      sqlPreparedStatement
        - insert into entityPhones (entityId,number,type,eventId)
        - select ?, ?, ?, ?
        - from dual
        - WHERE length(?) > 0 and ? <> '-1'
        string {_resultSet:patientId}
        string {homePhone}
        string Home
        long {_eventId}
        string {homePhone}
        string {_resultSet:patientId}
      sqlPreparedStatement
        - insert into entityPhones (entityId,number,type,eventId)
        - select ?, ?, ?, ?
        - from dual
        - WHERE length(?) > 0 and ? <> '-1'
        string {_resultSet:patientId}
        string {cellPhone}
        string Cell
        long {_eventId}
        string {cellPhone}
        string {_resultSet:patientId}
      sqlPreparedStatement
        - insert into entityPhones (entityId,number,type,eventId)
        - select ?, ?, ?, ?
        - from dual
        - WHERE length(?) > 0 and ? <> '-1'
        string {_resultSet:patientId}
        string {altPhone}
        string Alt
        long {_eventId}
        string {altPhone}
        string {_resultSet:patientId}
      ### email
      ###   currently forcing emailType = 'Primary'
      sqlPreparedStatement
        - delete from entityEmails
        - where entityId = ?
        -  and type = ?
        string {_resultSet:patientId}
        string Primary
      sqlPreparedStatement
        - insert into entityEmails (entityId,type,email,eventId)
        - select ?, ?, ?, ?
        - from dual
        - where length(?) > 0 and ? <> '-1'
        string {_resultSet:patientId}
        string Primary
        string {email}
        long {_eventId}
        string {email}
        string {_resultSet:patientId}
      ### REQUISITION SQL #########
      setFormQueryResult
        sqlPreparedQuery select prefix as 'sequencePrefix' from sequencePrefix where sequenceName = ?
          string reqId
      setFormQueryResult
        sqlPreparedQuery {_:sequencePrefix}
      setFormQueryResult reqId
        value= {_:prefix}{_getNextSequence:reqId}

      ### requestForms table
      sqlPreparedStatement
        - INSERT INTO requestForms
        -   (Id, patientId, externalSpecimenId, testType, sendingApp, receivedDate, eventId)
        -  VALUES
        -    (?, ?, ?, ?, ?, ?, ?)
        string {_resultSet:reqId}
        string {_resultSet:patientId}
        string {accessionId}
        string {testType}
        string {sendingApp}
        string {receivedDate}
        long {_eventId}

      sqlPreparedStatement
        - INSERT INTO queues (containerId,step,eventId)
        - VALUES (?, ?, ?)
        string {_resultSet:reqId}
        string QC Requisition
        long {_eventId}

      ### update containers table
      sqlPreparedStatement insert into containers (containerId,containerType,eventId)
        - values (?, ?, ?)
        string {_resultSet:reqId}
        string requestId
        long {_eventId}

      sqlPreparedStatement insert into containerHistory (containerId,eventId)
        - values (?, ?)
        string {_resultSet:reqId}
        long {_eventId}
      ### update contents table
      sqlPreparedStatement insert into contents (containerId,attribute, contentType, content, eventId)
        - values (?, ?, ?, ?, ?)
        string {_resultSet:reqId}
        string self
        string requestId
        string {_resultSet:reqId}
        long {_eventId}
      sqlPreparedStatement insert into contents (containerId,attribute, contentType, content, eventId)
        - values (?,?,?,?,?)
        string {_resultSet:reqId}
        string self
        string patientId
        string {_resultSet:patientId}
        long {_eventId}

      sqlPreparedStatement insert into contents (containerId,attribute, contentType, content, eventId)
        - values (?,?,?,?,?)
        string {_resultSet:patientId}
        string self
        string requestId
        string {_resultSet:reqId}
        long {_eventId}
      ### update statistics tables
      sqlPreparedStatement
        - insert into stats (eventId,type,eventDate,containerId)
        - values (?,?,curdate(),?)
        long {_eventId}
        string requestId
        string {_resultSet:reqId}

      sqlPreparedStatement
        - update containerFiles
        - set containerId = ? , fileType = 'Requisition File', location = replace(location, '../','')
        - where containerId = ?
        string {_resultSet:reqId}
        string {_eventId}

    #######################  PATIENT CLINICAL TRIAL INFORMATION ############################
    includeable clinicalTrialSQL
      sqlPreparedStatement update containerFiles
        - set containerId = ?, location = replace(location, '../',''),
        - fileType = 'Clinical Trial Enrollment Form'
        - where containerId = ?
        string {_resultSet:reqId}
        string ClinicalTrial_{_eventId}

      sqlPreparedStatement update requestForms
        - set clinicalTrial = ?
        - where id = ?
        string {patientInTrial}
        string {_resultSet:reqId}

    #### CLINICAL INFO #######################################
    includeable clinicalInfo
      div
        style= width:800px;
        fieldset
          legend CLINICAL INFORMATION
            class= legend toggle
          vertical
            div
              id= clinicalInfo
              vertical2
                vertical
                  span Current Medications
                  textArea currentMedications
                    class= clearPatient
                    screenLabel~
                    style= width:300px;
                  span Problematic Medications
                  #span Medications that have been problematic
                  textArea problemMedications
                    class= clearPatient
                    screenLabel~
                    style= width:300px;
                  span Diagnosis
                  textArea diagnosis
                    class= clearPatient
                    screenLabel~
                    style= width:300px;
                  span Age at Initial Presentation
                  text presentationAge
                    class= clearPatient
                    screenLabel~
                vertical
                  span Drug Allergies
                  textArea allergies
                    class= clearPatient
                    screenLabel~
                    style= width:300px;
                  span Clinical Notes
                  textArea clinicalNotes
                    class= clearPatient
                    screenLabel~
                    style= width:300px;
                  span Clinical History
                  textArea clinicalHistory
                    class= clearPatient
                    screenLabel~
                    style= width:300px;
                  span Genetic Counselor
                  text geneticCounselor
                    class= clearPatient
                    screenLabel~
                    style= width:300px;

    includeable clinicalReqSQL
    ### check table for existing record, update if found, insert if not
      ifCondition
        advanced~
        sqlPreparedQuery~ select 1 from dual where ? = (select patientId from patientClinical where patientId = ?)
          string {_resultSet:patientId}
          string {_resultSet:patientId}
        sqlPreparedStatement update patientClinical
          - set diagnosis = ?
          - , medications = ?
          - , problemMedications = ?
          - , allergies = ?
          - , clinicalNotes = ?
          - , clinicalHistory = ?
          - , geneticCounselor = ?
          - , presentationAge = ?
          - , eventId = ?
          - where patientId = ?
          string {diagnosis}
          string {currentMedications}
          string {problemMedications}
          string {allergies}
          string {clinicalNotes}
          string {clinicalHistory}
          string {geneticCounselor}
          string {presentationAge}
          long {_eventId}
          string {_resultSet:patientId}
        else
          sqlPreparedStatement
            - INSERT INTO patientClinical
            -  (patientId, diagnosis, medications, problemMedications,
            -   allergies, clinicalNotes, clinicalHistory, presentationAge, geneticCounselor, eventId)
            - VALUES
            -  (?, ?, ?,
            -    ?, ?, ?,
            -    ?, ?, ?, ?)
            string {_resultSet:patientId}
            string {diagnosis}
            string {currentMedications}
            string {problemMedications}
            string {allergies}
            string {clinicalNotes}
            string {clinicalHistory}
            string {presentationAge}
            string {geneticCounselor}
            long {_eventId}


##################################################################
    includeable billingInfo
      script
        - function showIcd10Description(icdCode) {
        -   $('#icd10Description').load('/uniflow', {stepName: 'Ajax ICD10 Description',
        -     icd10Code: icdCode
        -   });
        -   $('#icd10Description').dialog({ minWidth: 300 });
        - }
        - $(document).ready(function() {
        -   $('.icd10code').change(function(){
        -     showIcd10Description($(this).val());
        -   });
        -   $('#primaryInsurance').click(function(){
        -     if ( $('#insuranceCarrier').val() == '') {
        -       $('.clearBillingPrimary').val('');
        -       $('.clearBillingPrimarySelect').prop('selectedIndex', 0);
        -     }
        -   });
        -   $('#secondaryInsurance').click(function(){
        -     if ( $('#insuranceCarrier').val() == '') {
        -       $('.clearBillingSecondary').val('');
        -       $('.clearBillingSecondarySelect').prop('selectedIndex', 0);
        -     }
        -   });
        -   $('.button[name="asPrimary"], .button[name="asSecondary"]').addClass('setInsuranceCarrier');
        -   $('.setInsuranceCarrier').click(function(){
        -     insType= $(this).attr('insuranceType');
        -     setInsuranceCarrier(insType);
        -   });
        - });
      script
        - function showBillingParts() {
        -      if ($('#billTo').val() == 'Patient') {
        -        $('#ICD10').show();
        -      }
        -      else {
        -        $('#ICD10').hide();
        -      }
        -      if ($('#billTo').val() == 'Customer') {
        -        $('#billing').hide();
        -      }
        -      else {
        -        $('#billing').show();
        -      }
        -  }
        - function showMedicareFields() {
        -   var flg = 1;
        -   $('.medicare').hide();
        -   if ($('#paymentOption').val() == 'Medicare') flg = 0;
        -   if ($('#paymentOption').val() == 'Medicaid') flg = 0;
        -   if (flg == 0)
        -     $('.medicare').show();
        -   else {
        -     $('.medicare').hide();
        -   }
        - }
        - function setInsuranceCarrier(insType) {
        -   $.getJSON('/uniflow?callback=?&stepName=Ajax+Get+Insurance+Carrier&id=' + $('#insuranceCarrier').val(),{},
        -     function(data,status) {
        -       $('#carrierId' + insType).val(data[0].amdCarrierCode);
        -       $('#carrierName' + insType).val(data[0].carrierName);
        -       $('#carrierAddress1' + insType).val(data[0].address1);
        -       $('#carrierAddress2' + insType).val(data[0].address2);
        -       $('#carrierCity' + insType).val(data[0].city);
        -       $('#carrierState' + insType).val(data[0].state);
        -       $('#carrierZip' + insType).val(data[0].zipCode);
        -       $('#carrierPhone' + insType).val(data[0].phoneNumber);
        -     }
        -   );
        - }
      div
        style= width:800px;
        fieldset
          legend BILLING INFORMATION
            class= legend toggle
          vertical
            div
              id= billingInfo
              vertical
                select billTo
                  screenLabel~ Bill To **
                  id= billTo
                  option
                    value=
                  option Customer
                    value= Customer
                  option Patient
                    value= Patient
                  option No Charge
                    value= No Charge
                  option Other
                    value= Other
                  onchange= showBillingParts();
              hr
              vertical
                div
                  id= ICD10
                  style= display:none;
                  fieldset
                    legend ICD-10-CM Codes
                      class= legend
                    rowGroups
                      rowGroup
                        text icdCodes1
                          size= 5
                          class= icd10code
                          screenLabel~ Code1
                        text icdCodes2
                          size= 5
                          class= icd10code
                          screenLabel~ Code2
                        text icdCodes3
                          size= 5
                          class= icd10code
                          screenLabel~ Code3
                        text icdCodes4
                          size= 5
                          class= icd10code
                          screenLabel~ Code4
                        text icdCodes5
                          size= 5
                          class= icd10code
                          screenLabel~ Code5
                        text icdCodes6
                          size= 5
                          class= icd10code
                          screenLabel~ Code6
                  div
                    id= icd10Description
          vertical
            div
              id= billing
              h3 PAYMENT INFORMATION
              vertical2
                vertical
                  select paymentOption
                    id= paymentOption
                    class= clearPatient
                    screenLabel~ Payment Options
                    onchange= showMedicareFields();
                    option
                      value=
                    option Insurance
                      value= Insurance
                    option Medicaid
                      value= Medicaid
                    option Medicare
                      value= Medicare
                    option Self Pay
                      value= Self Pay
                div
                  id= medicare
                  class= medicare
                  style= display:none;
                  vertical
                    text medicareNumber
                      id= medicareNum
                      screenLabel~ Medicare/Medicaid #
                      class= clearPatient

              vertical2
                vertical
                  checkbox parentSignature
                    screenLabel~ Parent/Guardian Signature on file
                    class= clearPatientSelect
                vertical
                  files insuranceCard
                    destinationFolderName~ ../private/insuranceCard/{_eventId}
                    required~ false
                    data-parsley-required= false
                    multiple=
                    accept= jpg|png|pdf|jpeg
                    containerId~ {_eventId}_INS
              vertical
                fieldset
                  legend Search Insurance Carriers
                    class= legend
                    style= font-weight:bold;
                  vertical
                    select insuranceCarrier
                      id= insuranceCarrier
                      screenLabel~ Insurance Carrier
                      option
                      sqlQuery~
                        - select distinct carrierName, id
                        - from insuranceCarriers
                        - order by carrierName
                  vertical2
                    button asPrimary
                      screenLabel~
                      value= Set Primary Insurance
                      insuranceType= P
                      id= primaryInsurance
                    button asSecondary
                      screenLabel~
                      value= Set Secondary Insurance
                      insuranceType= S
                      id= secondaryInsurance
              vertical
                text guarantorName
                  screenLabel~ Name of Insured
                  class= clearPatient required clearBillingPrimary
              vertical2
                fieldset
                  legend Primary Insurance
                    class= legend
                    style= font-weight:bold;
                  vertical
                    text policyHolderName_1
                      screenLabel~ Name of Policy Holder
                      title= Last, first middle
                      class= clearPatient required clearBillingPrimary
                    select relationship_1
                      screenLabel~ Relationship
                      option
                        value=
                      option Self
                        value= Self
                      option Spouse
                        value= Spouse
                      option Child
                        value= Child
                      option Other
                        value= Other
                      required~ false
                      class= clearPatient clearBillingPrimarySelect
                    text insuranceId_1
                      screenLabel~ ID
                      id= carrierIdP
                      readonly=
                      size= 7
                      style= border:0;background-color:transparent;
                      class= clearPatient clearBillingPrimary
                    text insuranceCompany_1
                      screenLabel~ Insurance Carrier
                      id= carrierNameP
                      class= clearPatient required clearBillingPrimary
                      size= 30
                    text policyNumber_1
                      screenLabel~ Policy Number
                      class= clearPatient required clearBillingPrimary
                    text groupNumber_1
                      screenLabel~ Group Number
                      class= clearPatient clearBillingPrimary
                    text responsibleAddress1_1
                      screenLabel~ Address 1
                      id= carrierAddress1P
                      class= clearPatient clearBillingPrimary
                    text responsibleAddress2_1
                      screenLabel~ Address 2
                      id= carrierAddress2P
                      class= clearPatient clearBillingPrimary
                    text responsibleCity_1
                      screenLabel~ City
                      id= carrierCityP
                      class= clearPatient clearBillingPrimary
                    select responsibleState_1
                      screenLabel~ State
                      id= carrierStateP
                      class= clearPatient combobox clearBillingPrimarySelect
                      option
                      sqlQuery~ select abbreviation from state order by abbreviation
                    text responsibleZip_1
                      screenLabel~ Zip
                      id= carrierZipP
                      class= clearPatient clearBillingPrimary
                    text phone_1
                      screenLabel~ Phone
                      class= phone clearPatient clearBillingPrimary
                      id= carrierPhoneP
                      placeholder= ##########
                      onchange= onlyDigits($(this).val(), $(this).attr('id'));
                    text policyHolderId_1
                      screenLabel~ Policy Holder SSN
                      title= SSN
                      class= clearPatient clearBillingPrimary
                      placeholder= ###-##-####
                      validate~ format \d\d\d\-\d\d\-\d\d\d\d
                        errorMessage~ Please follow the format ###-##-####
                    date policyHolderDOB_1
                      convert~ false
                      screenLabel~ Policy Holder DOB
                      title= mm/dd/yyyy
                      class= clearPatient required datePickerDOB clearBillingPrimary
                      required~ false
                      placeholder= mm/dd/yyyy
                  vertical
                    checkbox updatePrimary
                      screenLabel~
                      span Update Existing Insurance Info
                fieldset
                  legend Secondary Insurance
                    class= legend
                    style= font-weight:bold;
                  vertical
                    text policyHolderName_2
                      screenLabel~ Name of Policy Holder
                      title= Last, first middle
                      class= clearPatient clearBillingSecondary
                    select relationship_2
                      screenLabel~ Relationship
                      option
                        value=
                      option Self
                        value= Self
                      option Spouse
                        value= Spouse
                      option Child
                        value= Child
                      option Other
                        value= Other
                      required~ false
                      class= clearPatient clearBillingSecondarySelect
                    text insuranceId_2
                      screenLabel~ ID
                      id= carrierIdS
                      readonly=
                      size= 7
                      style= border:0;background-color:transparent;
                      class= clearPatient clearBillingSecondary
                    text insuranceCompany_2
                      screenLabel~ Insurance Carrier
                      id= carrierNameS
                      class= clearPatient clearBillingSecondary
                      size= 30
                    text policyNumber_2
                      screenLabel~ Policy Number
                      class= clearPatient clearBillingSecondary
                    text groupNumber_2
                      screenLabel~ Group Number
                      class= clearPatient clearBillingSecondary
                    text responsibleAddress1_2
                      id= carrierAddress1S
                      screenLabel~ Address 1
                      class= clearPatient clearBillingSecondary
                    text responsibleAddress2_2
                      id= carrierAddress2S
                      screenLabel~ Address 2
                      class= clearPatient clearBillingSecondary
                    text responsibleCity_2
                      screenLabel~ City
                      id= carrierCityS
                      class= clearPatient clearBillingSecondary
                    select responsibleState_2
                      screenLabel~ State
                      id= carrierStateS
                      class= clearPatient combobox clearBillingSecondarySelect
                      option
                      sqlQuery~ select abbreviation from state order by abbreviation
                    text responsibleZip_2
                      screenLabel~ Zip
                      id= carrierZipS
                      class= clearPatient clearBillingSecondary
                    text phone_2
                      screenLabel~ Phone
                      id= carrierPhoneS
                      class= clearPatient clearBillingSecondary
                      placeholder= ##########
                      onchange= onlyDigits($(this).val(), $(this).attr('id'));
                    text policyHolderId_2
                      screenLabel~ Policy Holder SSN
                      title= SSN
                      class= clearPatient clearBillingSecondary
                      placeholder= ###-##-####
                      validate~ format \d\d\d\-\d\d\-\d\d\d\d
                        errorMessage~ Please follow the format ###-##-####
                    date policyHolderDOB_2
                      convert~ false
                      screenLabel~ Policy Holder DOB
                      title= mm/dd/yyyy
                      class= clearPatient datePickerDOB clearBillingSecondary
                      required~ false
                      placeholder= mm/dd/yyyy
                  vertical
                    checkbox updateSecondary
                      screenLabel~
                      span Update Existing Insurance Info

    includeable billingReqSQL
      sqlPreparedStatement
        - UPDATE requestForms
        - SET billTo = ?
        -  , icdCodes1 = ?
        -  , icdCodes2 = ?
        -  , icdCodes3 = ?
        -  , icdCodes4 = ?
        -  , icdCodes5 = ?
        -  , icdCodes6 = ?
        - WHERE id = ?
        string {billTo}
        string {icdCodes1}
        string {icdCodes2}
        string {icdCodes3}
        string {icdCodes4}
        string {icdCodes5}
        string {icdCodes6}
        string {_resultSet:reqId}

    ### billing -> for patient only records
      sqlPreparedStatement delete from patientBilling where patientId = ?
        string {_resultSet:patientId}

      ifCondition {_resultSet:patientId}
        advanced~
        not~
          equals~ -1
        sqlPreparedStatement
          - insert into patientBilling (
          - patientId,paymentOption,medicareNumber,parentSignature,guarantor
          - ,policyHolderName_1,relationship_1,carrierCode_1,insuranceCompany_1,policyNumber_1,groupNumber_1,responsibleAddress1_1
          - ,responsibleAddress2_1,responsibleCity_1,responsibleState_1,responsibleZip_1,phone_1,policyHolderId_1,policyHolderDOB_1
          - ,policyHolderName_2,relationship_2,carrierCode_2,insuranceCompany_2,policyNumber_2,groupNumber_2,responsibleAddress1_2
          - ,responsibleAddress2_2,responsibleCity_2,responsibleState_2,responsibleZip_2,phone_2,policyHolderId_2,policyHolderDOB_2
          - ,eventId) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,
          - CASE WHEN ? = '' THEN NULL ELSE ? END, ?,?,?,?,?,?,?,?,?,?,?,?,?, CASE WHEN ? = '' THEN NULL ELSE ? END, ?)
          string {_resultSet:patientId}
          string {paymentOption}
          string {medicareNumber}
          string {parentSignature}
          string {guarantorName}
          string {policyHolderName_1}
          string {relationship_1}
          string {insuranceId_1}
          string {insuranceCompany_1}
          string {policyNumber_1}
          string {groupNumber_1}
          string {responsibleAddress1_1}
          string {responsibleAddress2_1}
          string {responsibleCity_1}
          string {responsibleState_1}
          string {responsibleZip_1}
          string {phone_1}
          string {policyHolderId_1}
          string {policyHolderDOB_1}
          string {policyHolderDOB_1}
          string {policyHolderName_2}
          string {relationship_2}
          string {insuranceId_2}
          string {insuranceCompany_2}
          string {policyNumber_2}
          string {groupNumber_2}
          string {responsibleAddress1_2}
          string {responsibleAddress2_2}
          string {responsibleCity_2}
          string {responsibleState_2}
          string {responsibleZip_2}
          string {phone_2}
          string {policyHolderId_2}
          string {policyHolderDOB_2}
          string {policyHolderDOB_2}
          long {_eventId}

      ### Insurance Carrier Records

      ifCondition {insuranceId_1}
        advanced~
        isBlank~
        and~ {insuranceCompany_1}
          not~
            isBlank~
        sqlPreparedStatement
          - insert into insuranceCarriers (amdCarrierCode, carrierName, address1, address2, city, state, zipCode, phoneNumber, eventId)
          - values (?,?,?,?,?,?,?,?,?)
          string UNIC{_getNextSequence:insuranceCarrier}
          string {insuranceCompany_1}
          string {responsibleAddress1_1}
          string {responsibleAddress2_1}
          string {responsibleCity_1}
          string {responsibleState_1}
          string {responsibleZip_1}
          string {phone_1}
          long {_eventId}

      ifCondition {insuranceId_2}
        advanced~
        isBlank~
        and~ {insuranceCompany_2}
          not~
            isBlank~
        sqlPreparedStatement
          - insert into insuranceCarriers (amdCarrierCode, carrierName, address1, address2, city, state, zipCode, phoneNumber, eventId)
          - values (?,?,?,?,?,?,?,?,?)
          string UNIC{_getNextSequence:insuranceCarrier}
          string {insuranceCompany_2}
          string {responsibleAddress1_2}
          string {responsibleAddress2_2}
          string {responsibleCity_2}
          string {responsibleState_2}
          string {responsibleZip_2}
          string {phone_2}
          long {_eventId}


      ifCondition {updatePrimary}
        advanced~
        equals~ true
        sqlPreparedStatement
          - update insuranceCarriers
          - set
          -   carrierName = ?,
          -   address1 = ?,
          -   address2 = ?,
          -   city = ?,
          -   state = ?,
          -   zipCode = ?,
          -   phoneNumber = ?,
          -   eventId = ?
          - where id = ?
          string {insuranceCompany_1}
          string {responsibleAddress1_1}
          string {responsibleAddress2_1}
          string {responsibleCity_1}
          string {responsibleState_1}
          string {responsibleZip_1}
          string {phone_1}
          long {_eventId}
          string {insuranceId_1}

      ifCondition {updateSecondary}
        advanced~
        equals~ true
        sqlPreparedStatement
          - update insuranceCarriers
          - set
          -   carrierName = ?,
          -   address1 = ?,
          -   address2 = ?,
          -   city = ?,
          -   state = ?,
          -   zipCode =?,
          -   phoneNumber = ?,
          -   eventId = ?
          - where id = ?
          string {insuranceCompany_2}
          string {responsibleAddress1_2}
          string {responsibleAddress2_2}
          string {responsibleCity_2}
          string {responsibleState_2}
          string {responsibleZip_2}
          string {phone_2}
          long {_eventId}
          string {insuranceId_2}

      sqlPreparedStatement UPDATE containerFiles
        - SET containerId = ?, fileType = 'Insurance Files', location = replace(location, '../','')
        - WHERE containerId = ?
        string {_resultSet:reqId}
        string {_eventId}_INS



##################################################################

    includeable sampleInfo
      script
        - function showFields() {
        -  if ($('#sampleType').val() =='Bone Core' || $('#sampleType').val() =='FFPE Biopsy' || $('#sampleType').val() =='FFPE Slides' || $('#sampleType').val() =='Fresh Tissue' || $('#sampleType').val() =='Frozen Tissue' || $('#sampleType').val() =='Frozen Tissue, Slides') {
        -    $('#tissueInfo').show();
        -    if ($('#sampleType').val() =='FFPE block') {
        -      $('#warning').show();
        -    }
        -    else {
        -      $('#warning').hide();
        -    }
        -  } else {
        -    $('#slideFields').hide();
        -  }
        - }
        -
        - function searchPatientsByOrganization() {
        -  $('#physicianId').load('/uniflow',{stepName: 'Ajax Patients By Organization Search Server'
        -     ,organizationId: $('#organizationId').val()
        -  });
        - }
        - function helper() {
        -   $('#helperDialog').dialog();
        - }
      div
        style= width:800px;
        fieldset
          legend PATIENT SAMPLE INFORMATION
            class= legend toggle

          vertical
            div
              id= helperDialog
              style= display:none; border:1px solid #000;
              title= HELPER
              vertical
                span ** WARNING: following the links will take you into a new step **
                li <b>Customer</b> not in the list? Click <a href= /uniflow?stepName=Customers>HERE</a> to enter new Customer.
                li <b>Physician</b> not in the list? Click <a href= /uniflow?stepName=People>HERE</a> to enter new Physician.
                li <b>Specimen Type</b> not in the list? Click <a href= /uniflow?stepName=Manage+SELECT+Lists>HERE</a> to enter new Specimen Type.

            div
              id= sampleInfo
              div
                style= float:left;
                vertical
                  select organizationId
                    id= organizationId
                    class= required
                    onchange= searchPatientsByOrganization(); $('#correctPhy').hide();
                    screenLabel~ Customer
                    option
                    sqlQuery~ SELECT firstName,entityId from entities where entityType = 'Organization' order by firstName
                  select physicianId
                    id= physicianId
                    screenLabel~ Physician
                    onchange= $('#correctPhy').show();
                  div
                    id= correctPhy
                    style= display:none;
                    span Verify that correct physician is selected.
                      style= color:red;
                  select sampleType
                    id= sampleType
                    onchange= showFields();
                    option
                    screenLabel~ Specimen Type
                    sqlQuery~ select displayValue,value
                      - from validValues
                      - where setName = '{testType}SampleType'
                      - order by displayOrder asc
                  text specimenId
                    screenLabel~ Specimen Id
                    style= background-image: url(images/barcodebkg.jpg);
                    validate~ ! select containerId from containers where containerId = '{specimenId}'
                      errorMessage~ This barcode already exists in the system and must be unique.
                  text senderId
                    screenLabel~ Sender Specimen Id
                  select priority
                    screenLabel~ Priority
                    option Normal
                    option STAT


              div
                style= float:right; margin-left:20px;
                vertical
                  img
                    src= images/questionmark.png
                    style= width:20px; height:20px;
                    onclick= helper();
                vertical
                  date collectionDate
                    convert~ false
                    class= datePickerNow
                    screenLabel~ Collection Date
                    required~ false
                    placeholder= mm/dd/yyyy
                    validate~ select 1 from dual where '{_thisInput}' <= DATE_FORMAT(CURDATE(), '%m/%d/%Y')
                      errorMessage~ Collection Date should be in the past.
                  text collectionTime
                    screenLabel~ Collection Time
                    class= timePicker12hr
                    placeholder= hr:mm
                    size= 7
                    select amPm
                      screenLabel~ am/pm
                      option
                      option am
                      option pm


    includeable sampleInfoSQL
#      sqlPreparedStatement
#        - update requestForms
#        - set specimenId = ?
#        -   , externalSpecimenId = ?
#        -   , sampleType = ?
#        -   , collectionDate = ?
#        -   , collectionTime = ?
#        -   , amPm = ?
#        -   , receivedDate = ?
#        - where Id = ?
#        string {specimenId}
#        string {senderId}
#        string {sampleType}
#        string {collectionDate}
#        string {collectionTime}
#        string {amPm}
#        string {receivedDate}
#        string {_resultSet:reqId}
      sqlPreparedStatement update requestForms
        - set physicianId = ?
        - , organizationId = ?
        - , priority = ?
        - where id = ?
        string {physicianId}
        string {organizationId}
        string {priority}
        string {_resultSet:reqId}
      ### Patient Relations ###
      sqlPreparedStatement insert into entityRelations (memberId, entityId, role, eventId)
        - (select ?, ?, ?, ? from dual
        -  where not exists (select * from entityRelations where memberId = ? and entityId = ?))
        string {_resultSet:patientId}
        string {organizationId}
        string Patient
        long {_eventId}
        string {_resultSet:patientId}
        string {organizationId}
      sqlPreparedStatement insert into entityRelations (memberId, entityId, role, eventId)
        - (select ?, ?, ?, ? from dual
        -  where not exists (select * from entityRelations where memberId = ? and entityId = ?))
        string {_resultSet:patientId}
        string {physicianId}
        string Patient
        long {_eventId}
        string {_resultSet:patientId}
        string {physicianId}
      ifCondition {specimenId}
        advanced~
        not~
          isBlank~
        sqlPreparedStatement insert into contents (containerId, attribute, contentType, content, eventId)
          - values (?, ?, ?, ?, ?)
          string {_resultSet:reqId}
          string patient
          string specimenId
          string {specimenId}
          long {_eventId}
        sqlPreparedStatement insert into requestSpecimens (reqId, specimenId, specimenSource, sampleType, senderId, collectionDate, collectionTime, ampm, eventId)
          - values (?, ?, ?, ?, ?, CASE WHEN ? = '' THEN NULL ELSE ? END, ?, ?, ?)
          string {_resultSet:reqId}
          string {specimenId}
          string patient
          string {sampleType}
          string {senderId}
          string {collectionDate}
          string {collectionDate}
          string {collectionTime}
          string {amPm}
          long {_eventId}
        sqlPreparedStatement insert into contents (containerId, attribute, contentType, content, eventId)
          - values (?, ?, ?, ?, ?)
          string {_resultSet:patientId}
          string patient
          string specimenId
          string {specimenId}
          long {_eventId}

########################################

    includeable multipleSampleInfo
      script
        - function searchPatientsByOrganization2() {
        -  $('#phyId').load('/uniflow',{stepName: 'Ajax Patients By Organization Search Server'
        -     ,organizationId: $('#orgId').val()
        -  });
        - }
        - function helper2() {
        -   $('#helperDialog2').dialog();
        - }
      script
        - function CreateSampleReplicate(specimenInfo)
        - {
        -   var replicateAppend = 'R';
        -   var foundEmpty = false;
        -   $("#patientSamplesTable>tbody>tr>.col0>.text").each(function(){
        -     if((!$(this).val() && !foundEmpty) || $(this).val() == specimenInfo[0]+ replicateAppend)
        -       {
        -         $(this).val(specimenInfo[0]+ replicateAppend);
        -         $(this).parent().siblings('.col1').children('.text').val(specimenInfo[1]);
        -         $(this).parent().siblings('.col2').children('select').val(specimenInfo[2]);
        -         $(this).parent().siblings('.col3').children('.datePickerNow').val(specimenInfo[3]);
        -         $(this).parent().siblings('.col4').children('.timePicker12hr').val(specimenInfo[4]);
        -         $(this).parent().siblings('.col5').children('select').val(specimenInfo[5])
        -         foundEmpty = true;
        -       }
        -   });
        - }
      script
        - function searchProbands() {
        -   $('#probandCandidates').load('/uniflow',
        -          {stepName: 'Ajax Proband Search Server',
        -           firstName: $('#probandFirstName').val(),
        -           lastName: $('#probandLastName').val(),
        -           DOB: $('#probandDOB').val(),
        -           SSN: $('#probandSSN').val(),
        -           Gender: $('#probandType').val()
        -          });
        -       $('#probandCandidates').css('display','block');
        - }
        - $(document).ready(function() {
        -   $('#clearProband').click(function() {
        -     $('.clearProband').val('');
        -     $('.clearProbandSelect').prop('checked', false);
        -     $('#probandCandidates').empty();
        -   });
        -   $('#patientSamplesTable>tbody>tr>.col6').append('<input class="button replicateButton" type="button" value="Replicate">');
        -   $('.replicateButton').click(function() {
        -       var thisSpecimen = $(this).parent().siblings('.col0').children('.text').val();
        -       if(thisSpecimen)
        -       {
        -          var thisSenderSpecimenID = $(this).parent().siblings('.col1').children('.text').val();
        -          var thisSpecimenType = $(this).parent().siblings('.col2').children('select').val();
        -          var thisSpecimenDate = $(this).parent().siblings('.col3').children('.datePickerNow').val();
        -          var thisSpecimenTime = $(this).parent().siblings('.col4').children('.timePicker12hr').val();
        -          var thisSpecimenAMPM = $(this).parent().siblings('.col5').children('select').val();
        -          CreateSampleReplicate([thisSpecimen,thisSenderSpecimenID,thisSpecimenType,thisSpecimenDate,thisSpecimenTime,thisSpecimenAMPM]);
        -       } else {
        -         alert("Please enter a SpecimenID to replicate.");
        -       }
        -   });
        -  });
      div
        style= width:800px;
        fieldset
          legend PATIENT SAMPLES & INFORMATION
            class= legend toggle

          vertical
            div
              id= helperDialog2
              style= display:none;border:1px solid #000;
              title= HELPER
              vertical
                span ** WARNING: following the links will take you into a new step **
                li <b>Customer</b> not in the list? Click <a href= /uniflow?stepName=Customers>HERE</a> to enter new Customer.
                li <b>Physician</b> not in the list? Click <a href= /uniflow?stepName=People>HERE</a> to enter new Physician.
                li <b>Specimen Type</b> not in the list? Click <a href= /uniflow?stepName=Manage+SELECT+Lists>HERE</a> to enter new Specimen Type.

            div
              id= multiSampleInfo
              div
                style= float:left
                vertical2
                  select organizationId2
                    id= orgId
                    class= required
                    onchange= searchPatientsByOrganization2(); $('#correctPhys').hide();
                    screenLabel~ Customer
                    option
                    sqlQuery~ SELECT firstName,entityId from entities where entityType = 'Organization' order by firstName
                    required~ true
                  img
                    src= images/questionmark.png
                    style= width:20px; height:20px;
                    onclick= helper2();
                vertical
                  select physicianId2
                    id= phyId
                    screenLabel~ Physician
                    onchange= $('#correctPhys').show();
                  div
                    id= correctPhys
                    style= display:none;
                    span Verify that correct physician is selected.
                      style= color:red;
                #  select sampleType2
                #    class= required
                #    id= sampleType2
                #    #style= background-color:LemonChiffon;
                #    option
                #    screenLabel~ Specimen Type
                #    sqlQuery~ select displayValue,value
                #      - from validValues
                #      - where setName like '{testType}%'
                #      - order by displayOrder asc
                    #required~ true
                  select priority2
                    screenLabel~ Priority
                    option Normal
                    option STAT
              div
                style= float:left
                vertical
                  table
                    id= patientSamplesTable
                    caption PATIENT SAMPLES ONLY
                    sqlQuery~ select
                      - '' as 'Specimen Id'
                      - , '' as 'Sender </br> Specimen Id'
                      - , '' as 'Specimen Type'
                      - , '' as 'Collection </br> Date'
                      - , '' as 'Collection </br> Time'
                      - , 'am' as 'am/pm'
                      - , '' as 'Replicate'
                      - FROM numbers
                      - limit 6
                    columnSpecs~ receiveSamples
                      allowChangedRecordIds
                      column 1
                        inputType text
                          style= background-image: url(images/barcodebkg.jpg);
                          value= {_:SamplePrefix}{_getNextSequence:testSampleId}
                          size= 15
                      column 2
                        inputType text
                          size= 10
                      column 3
                        inputType select
                          sqlQuery~ select displayValue,value
                            - from validValues
                            - where setName = '{testType}SampleType'
                            - order by displayOrder asc
                      column 4
                        inputType date
                          class= datePickerNow
                          placeholder= mm/dd/yyyy
                          size= 13
                      column 5
                        inputType text
                          class= timePicker12hr
                          size= 6
                          placeholder= hh:mm
                      column 6
                        inputType select
                          option
                          option am
                          option pm



    includeable multiSampleSQL
      sqlPreparedStatement update requestForms
        - set physicianId = ?
        - , organizationId = ?
        - , priority = ?
        - where id = ?
        string {physicianId2}
        string {organizationId2}
        string {priority2}
        string {_resultSet:reqId}
        ### Patient Relations ###
      forRows receiveSamples
        ifCondition {_columnInput_receiveSamples:1}
          advanced~
          not~
            isBlank~
          jython
            thisNode = "receiveSamples_%d_1" % {_receiveSamples_row}
            msg = "This barcode already exists in the system and must be unique."
            sqlSelect = "select containerId from containers where containerId = ?"
            barcode = None

            ps = switchboard.connection.prepareStatement(sqlSelect)
            ps.setString(1, '{_columnInput_receiveSamples:1}')
            switchboard.resultSet = ps.executeQuery()
            while switchboard.resultSet.next():
              barcode = switchboard.resultSet.getString(1)

            if barcode is not None:
              switchboard.handleFormError("FailedValidation", ['{_columnInput_receiveSamples:1}', msg], switchboard.inputsHash.get(thisNode))

          sqlPreparedStatement insert into contents (containerId, attribute, contentType, content, eventId)
            - values (?, ?, ?, ?, ?)
            string {_columnInput_receiveSamples:1}
            string self
            string specimenId
            string {_columnInput_receiveSamples:1}
            long {_eventId}

          sqlPreparedStatement insert into contents (containerId, attribute, contentType, content, eventId)
            - (select ?, ?, ?, ?, ?
            - from dual
            -  where not exists (select * from contents where containerId = ? and content = ?))
            string {_resultSet:reqId}
            string patient
            string specimenId
            string {_columnInput_receiveSamples:1}
            long {_eventId}
            string {_resultSet:reqId}
            string {_columnInput_receiveSamples:1}

          sqlPreparedStatement insert into contents (containerId, attribute, contentType, content, eventId)
            - (select ?, ?, ?, ?, ?
            - from dual
            -  where not exists (select * from contents where containerId = ? and content = ?))
            string {_resultSet:patientId}
            string patient
            string specimenId
            string {_columnInput_receiveSamples:1}
            long {_eventId}
            string {_resultSet:patientId}
            string {_columnInput_receiveSamples:1}

          sqlPreparedStatement insert into requestSpecimens (reqId, specimenId, specimenSource, sampleType, collectionDate, collectionTime, ampm,
            - senderId , eventId)
            - values (?, ?, ?, ?, CASE WHEN ? = '' THEN NULL ELSE ? END, ?, ?, ?, ?)
            string {_resultSet:reqId}
            string {_columnInput_receiveSamples:1}
            string patient
            string {_columnInput_receiveSamples:3}
            string {_columnInput_receiveSamples:4}
            string {_columnInput_receiveSamples:4}
            string {_columnInput_receiveSamples:5}
            string {_columnInput_receiveSamples:6}
            string {_columnInput_receiveSamples:2}
            long {_eventId}


### CANT UPDATE REQUESTFORMS BECAUSE IT IS NO LONGER ONE TO ONE RELATIONSHIP



      ### Patient Relations ###
      sqlPreparedStatement insert into entityRelations (memberId, entityId, role, eventId)
        - (select ?, ?, ?, ? from dual
        -  where not exists (select * from entityRelations where memberId = ? and entityId = ?))
        string {_resultSet:patientId}
        string {organizationId2}
        string Patient
        long {_eventId}
        string {_resultSet:patientId}
        string {organizationId2}

      sqlPreparedStatement insert into entityRelations (memberId, entityId, role, eventId)
        - (select ?, ?, ?, ? from dual
        -  where not exists (select * from entityRelations where memberId = ? and entityId = ?))
        string {_resultSet:patientId}
        string {physicianId2}
        string Patient
        long {_eventId}
        string {_resultSet:patientId}
        string {physicianId2}

#######################################################################################################
    includeable familySampleInfo
      script
        - function searchProbands2() {
        -   $('#probandCandidates2').load('/uniflow',
        -          {stepName: 'Ajax Proband Search Server',
        -           firstName: $('#probandFirstName2').val(),
        -           lastName: $('#probandLastName2').val(),
        -           DOB: $('#probandDOB2').val(),
        -           SSN: $('#probandSSN2').val(),
        -           Gender: $('#probandType2').val()
        -          });
        -       $('#probandCandidates2').css('display','block');
        - }
        - $(document).ready(function() {
        -   $('#clearProband2').click(function() {
        -     $('.clearProband').val('');
        -     $('.clearProbandSelect').prop('checked', false);
        -     $('#probandCandidates2').empty();
        -   });
        -  });
      div
        style= width:800px;
        fieldset
          legend FAMILY SAMPLE INFORMATION
            class= legend
            onclick= $('#famSamples').toggle();
          div
            id= famSamples
            div
              style= float:left
              vertical
                ################ FIND PATIENT AS PROBAND ##################################
                h3 PROBAND SEARCH
                vertical
                  li Search for Proband as an existing patient in the system
                  li If the proband is found, copy/paste the Id into the corresponding field(s)
                  li If the proband is not found, leave the Id field blank
                vertical2
                  simpleTable
                    tr
                      td &nbsp;Last Name
                      td &nbsp;First Name
                      td &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DOB
                      td &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SSN
                      td &nbsp;&nbsp;Gender
                    tr
                      style= display: none;
                      td Proband Id
                        colspan= 3
                        text probandId
                    tr
                      td
                        text probandLastName2
                          style= width:80px; background-color:
                          id= probandLastName2
                          onchange= return searchProbands2();
                      td
                        text probandFirstName2
                          style= width:80px
                          id= probandFirstName2
                          onchange= return searchProbands2();
                      td
                        date probandDOB2
                          convert~ false
                          style= width:90px
                          id= probandDOB2
                          class= datePickerDOB
                          title= mm/dd/yyyy
                          onchange= return searchProbands2();
                      td
                        text probandSSN2
                          style= width:80px
                          id= probandSSN2
                          onchange=
                            - return searchProbands2();
                      td
                        select probandGender2
                          id= probandType2
                          setName~ gender
                          title= SETNAME:gender
                          required~ false
                          option Male
                            value= M
                          option Female
                            value= F
                          option Unknown
                            value= U
                          onchange= return searchProbands2();
                        colspan= 2
                  button Clear Proband
                    id= clearProband2
                    style= font-size:.8em;

                  div
                    id= probandCandidates2
                    style= max-height:150px;overflow:scroll;

            div
              vertical
                text familyId
                  screenLabel~ Family ID#
                  value= FAM{_getNextSequence:familyId}
                  readonly=
                  style= border:none; background:transparent;
            div
              style= float:left
              vertical
                table
                  caption FAMILY SAMPLES ONLY
                  sqlQuery~ select '' as 'Specimen Id'
                    - , '' as 'Specimen Type'
                    - , '' as 'Proband Type'
                    - , '' as 'Proband Id'
                    - , '' as 'Collection Date'
                    - , '' as 'Collection Time'
                    - , '' as 'am/pm'
                    - , DATE_FORMAT(curDate(), '%m/%d/%Y') as 'Received'
                    - FROM numbers
                    - limit 5
                  columnSpecs~ probandTable
                    allowChangedRecordIds
                    column 1
                      inputType text
                        style= background-image: url(images/barcodebkg.jpg);
                        size= 10
                    column 2
                      inputType select
                        sqlQuery~ select DISTINCT value from validValues
                          - where setName = '{testType}SampleType'
                    column 3
                      inputType select
                        sqlQuery~ select value from validValues where setName = 'probandType' order by displayOrder
                        required~ false
                    column 4
                      inputType text
                        size= 8
                    column 5
                      inputType date
                        required~ false
                        placeholder= mm/dd/yyyy
                        class= datePickerNow
                        size= 13
                    column 6
                      inputType text
                        class= timePicker12hr
                        size= 6
                        placeholder= hh:mm

                    column 7
                      inputType select
                        option
                        option am
                        option pm
                    column 8
                      inputType date
                        class= datePickerNow
                        required~ false
                        size= 11


    includeable familySampleInfoSQL
      forRows probandTable
        ifCondition~ {_columnInput_probandTable:1}
          advanced~
          not~
            isBlank~
          sqlPreparedStatement insert into requestSpecimens (reqId, specimenId, specimenSource, sampleType, collectionDate,
            - collectionTime, ampm, receivedDate, probandType, probandId, eventId )
            - values (?, ?, ?, ?, CASE WHEN ? = '' THEN NULL ELSE ? END, ?, ?, ?, ?, ?, ?)
            string {_resultSet:reqId}
            string {_columnInput_probandTable:1}
            string family
            string {_columnInput_probandTable:2}
            string {_columnInput_probandTable:5}
            string {_columnInput_probandTable:5}
            string {_columnInput_probandTable:6}
            string {_columnInput_probandTable:7}
            string {_columnInput_probandTable:8}
            string {_columnInput_probandTable:3}
            string {_columnInput_probandTable:4}
            long {_eventId}
          sqlPreparedStatement insert into contents (containerId, attribute, contentType, content, eventId)
            - values (?, ?, ?, ?, ?)
            string {_columnInput_probandTable:1}
            string self
            string specimenId
            string {_columnInput_probandTable:1}
            long {_eventId}
          sqlPreparedStatement insert into contents (containerId, attribute, contentType, content, eventId)
            - values (?, ?, ?, ?, ? )
            string {_resultSet:reqId}
            string proband
            string specimenId
            string {_columnInput_probandTable:1}
            long {_eventId}
          sqlPreparedStatement insert into contents (containerId, attribute, contentType, content, eventId)
            - values (?, ?, ?, ?, ? )
            string {_resultSet:patientId}
            string proband
            string specimenId
            string {_columnInput_probandTable:1}
            long {_eventId}
          sqlPreparedStatement insert into contents (containerId, attribute, contentType, content, eventId)
            - select ?, ?, ?, ?, ?
            - from dual
            - where ? <> (select content from contents where containerId = ? and attribute = ?)
            string {familyId}
            string self
            string familyId
            string {familyId}
            long {_eventId}
            string {familyId}
            string {familyId}
            string self
          sqlPreparedStatement insert into contents(containerId, attribute, contentType, content, eventId)
            - values (?, ? , ?, ?, ?)
            string {familyId}
            string proband
            string specimenId
            string {_columnInput_probandTable:1}
            long {_eventId}
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            -   values (?, ?, ?, ?),
            -          (?, ?, ?, ?),
            -          (?, ?, ?, ?),
            -          (?, ?, ?, ?),
            -          (?, ?, ?, ?),
            -          (?, ?, ?, ?)
            string {_columnInput_probandTable:1}
            string Sample Type
            string {_columnInput_probandTable:2}
            long {_eventId}
            string {_columnInput_probandTable:1}
            string Collection Time
            string {_columnInput_probandTable:6}
            long {_eventId}
            string {_columnInput_probandTable:1}
            string Collection Time Period
            string {_columnInput_probandTable:7}
            long {_eventId}
            string {_columnInput_probandTable:1}
            string Proband Type
            string {_columnInput_probandTable:3}
            long {_eventId}
            string {_columnInput_probandTable:1}
            string Proband ID
            string {_columnInput_probandTable:4}
            long {_eventId}
            string {_columnInput_probandTable:1}
            string Family ID
            string {familyId}
            long {_eventId}
          sqlPreparedStatement
            - insert into sampleProperties (sampleId, property, value, eventId)
            -   values (?, ?, ?, ?),
            -          (?, ?, ?, ?)
            string {_columnInput_probandTable:1}
            string Collection Date
            string {_columnInput_probandTable:5}
            long {_eventId}
            string {_columnInput_probandTable:1}
            string Date Received
            string {_columnInput_probandTable:8}
            long {_eventId}
          ifCondition {_columnInput_probandTable:2}
            advanced~
            isBlank~
            sqlPreparedStatement insert into reqRequiredFieldErrors (reqId, requiredFieldId, eventId)
              - select ?, Id, ?
              - from reqRequiredFieldDescriptions
              - where requiredField = ?
              string {_resultSet:reqId}
              long {_eventId}
              string sampleType
        ifCondition
          advanced~
          sqlPreparedQuery~ SELECT 1 FROM dual WHERE (SELECT specimenId FROM requestSpecimens WHERE reqId = ? AND specimenSource = 'family' LIMIT 1) IS NOT NULL
            string {_resultSet:reqId}
          sqlPreparedStatement insert into contents (containerId, attribute, contentType, content, eventId)
            - select ?, ?, ?, rs.specimenId, ?
            - from requestSpecimens rs
            - where rs.reqId = ? and rs.specimenSource = ?
            string {familyId}
            string patient
            string specimenId
            long {_eventId}
            string {_resultSet:reqId}
            string patient
          sqlPreparedStatement insert into contents (containerId, attribute, contentType, content, eventId)
            - values (?, ?, ?, ?, ?)
            string {_resultSet:reqId}
            string familyId
            string familyId
            string {familyId}
            long {_eventId}


################################################################################################################
    includeable tissueInfo
      div
        id= tissueInfo
        style= display:none;
        vertical
          fieldset
            id= slideFields
            legend TISSUE INFORMATION
              class= legend
            vertical
              text tissueType
                screenLabel~ Tissue Type
              text histodiagnostic
                screenLabel~ Diagnostic
              text tubes
                screenLabel~ # Tubes
              text otherDescription
                screenLabel~ Other Description


    includeable tissueInfoSQL
#          sqlPreparedStatement
#            - update requestForms
#            - set tissueType = ?
#            -   , histodiagnostic = ?
#            -   , tubes = ?
#            -   , otherDescription = ?
#            - where id = ?
#            string {tissueType}
#            string {histodiagnostic}
#            string {tubes}
#            string {otherDescription}
#            string {_resultSet:reqId}
      ifCondition {tissueType}
        advanced~
        not~
          isBlank~
        sqlPreparedStatement
          - insert into sampleProperties (sampleId, property, value, eventId)
          -   values (?, ?, ?, ?)
          string {specimenId}
          string Tissue Type
          string {tissueType}
          long {_eventId}
      ifCondition {tubes}
        advanced~
        not~
          isBlank~
        sqlPreparedStatement
          - insert into sampleProperties (sampleId, property, value, eventId)
          -    values (?, ?, ?, ?)
          string {specimenId}
          string Number of Tubes
          string {tubes}
          long {_eventId}
      ifCondition {histodiagnostic}
        advanced~
        not~
          isBlank~
        sqlPreparedStatement
          - insert into sampleProperties (sampleId, property, value, eventId)
          -    values (?, ?, ?, ?)
          string {specimenId}
          string Diagnostic
          string {histodiagnostic}
          long {_eventId}
      ifCondition {otherDescription}
        advanced~
        not~
          isBlank~
        sqlPreparedStatement
          - insert into sampleProperties (sampleId, property, value, eventId)
          -  values (?, ?, ?, ?)
          string {specimenId}
          string Description
          string {otherDescription}
          long {_eventId}


 ##############################################################################################################

    includeable testSelection
      div
        style= width:800px;
        fieldset
          legend TEST SELECTION
            class= legend toggle
          vertical
            id= testSelection
            div
              id= myTableDiv
              style= max-height:400px;overflow:scroll;
              table
                style= width:600px;
                class= stdTableSort
                id= myTable
                caption Select Panels or Tests
                sqlQuery~ select 'Select',tp.name 'Name'
                  - ,GROUP_CONCAT(IF(t.abbreviation is null,t.name,t.abbreviation) SEPARATOR ', ')  as 'Test(s) in Panel'
                  - ,tp.Id ''
                  -   from testsForPanel tfp
                  -   left join tests t on t.Id = tfp.testId
                  -   left join testPanels tp on tp.Id = tfp.panelId
                  - where tp.type = '{testType}' and tp.disabled = 0
                  - and t.testCode <> 'intelligene'
                  - group by tfp.panelId
                  - order by Name

                recIdURLSpecs~ t2
                  allowChangedRecordIds
                  column 1
                    data-orderable= false
                    inputType checkbox
                      sqlPreparedStatement~ insert into reqTestPanels (reqId,panelId,eventid)
                        - SELECT ?,?,? FROM dual
                        - WHERE ? = 'true'
                        string -1
                        string {_columnInput:4}
                        long {_eventId}
                        string {_columnInput:1}
                  column 4
                    data-orderable= false
                    inputType hidden
                      class= hide

    includeable testReqSQL
      ### update reqTestPanels table
      sqlPreparedStatement update reqTestPanels set reqId = ? where eventId = ?
        string {_resultSet:reqId}
        long {_eventId}

      ### update reqTests table
      sqlPreparedStatement update reqTests set reqId = ? where eventId = ?
        string {_resultSet:reqId}
        long {_eventId}

    ### update reqTests with the tests that are associated with the panels selected
      forEach select panelId
        - from reqTestPanels
        - where eventId = {_eventId}
        sqlPreparedStatement insert ignore into reqTests (reqId,testId,eventId)
          - (select rf.Id,tfp.testId, ?
          - from reqTestPanels rtp
          - join testsForPanel tfp on tfp.panelId = rtp.panelId
          - join requestForms rf on rf.eventId = ?
          - where rtp.panelId = ?)
          long {_eventId}
          long {_eventId}
          string {_resultSet:panelId}
      ### check if no tests are selected
      sqlPreparedStatement
        - insert into reqRequiredFieldErrors (reqId, requiredFieldId, eventId)
        - select ?, rfd.Id, ? from reqRequiredFieldDescriptions rfd
        - left join reqTestPanels rt on rt.reqId = ? and rt.eventId = ?
        - where (rt.reqId is null and rfd.requiredField = ?)
        string {_resultSet:reqId}
        long {_eventId}
        string {_resultSet:reqId}
        long {_eventId}
        string testSelection
#########################################################################################################

    includeable testsAndIntelligeneSelection
      div
        style= width:800px;
        fieldset
          legend TEST SELECTION
            class= legend
            onclick= $('#testSelection').toggle();
          div
            id= testSelection
            div
              id= myTableDiv
              style= float:left;max-height:375px;overflow:scroll;
              table
                style= width:290px;
                class= stdTableSort
                id= myTable
                caption Select Panels or Tests
                sqlQuery~ select 'Select',tp.name 'Name'
                  - ,GROUP_CONCAT(t.abbreviation SEPARATOR ', ')  as 'Test(s) in Panel'
                  - ,tp.Id 'Hidden'
                  -   from testsForPanel tfp
                  -   left join tests t on t.Id = tfp.testId
                  -   left join testPanels tp on tp.Id = tfp.panelId
                  - where tp.type = '{testType}' and tp.disabled = 0
                  - and t.testCode <> 'intelligene'
                  - group by tfp.panelId
                  - order by Name

                recIdURLSpecs~ t2
                  allowChangedRecordIds
                  column 1
                    inputType checkbox
                      sqlPreparedStatement~ insert into reqTestPanels (reqId,panelId,eventid)
                        + SELECT ?,?,? FROM dual
                        + WHERE ? = 'true'
                        string -1
                        string {_columnInput:4}
                        long {_eventId}
                        string {_columnInput:1}
                  column 4
                    inputType hidden
                      class= hide
            div
              style= float:left;margin-left:20px;max-height:375px;overflow:scroll;
              id= intelligene
              table
                style= width:290px;
                class= stdTableSort
                caption Select Personal Medicine Drugs
                sqlQuery~ select 'Select',tp.name 'Name'
                  - ,GROUP_CONCAT(t.abbreviation SEPARATOR ', ')  as 'Test(s) in Panel'
                  - ,tp.Id 'Hidden'
                  -   from testsForPanel tfp
                  -   left join tests t on t.Id = tfp.testId
                  -   left join testPanels tp on tp.Id = tfp.panelId
                  - where tp.type = '{testType}' and tp.disabled = 0
                  - and t.testCode = 'intelligene'
                  - group by tfp.panelId
                recIdURLSpecs~ intelligene
                  allowChangedRecordIds
                  column 1
                    inputType checkbox
                      sqlPreparedStatement~ insert into reqTestPanels (reqId,panelId,eventid)
                        + SELECT ?,?,? FROM dual
                        + WHERE ? = 'true'
                        string -1
                        string {_columnInput:4}
                        long {_eventId}
                        string {_columnInput:1}
                  column 4
                    inputType hidden
                      class= hide

    includeable testsToxSelection
      ENCTYPE= multipart/form-data
      script
        - function selectTestsFromPanel(panelId,checked) {
        -   $.getJSON('/uniflow?callback=?&stepName=Ajax+Lookup+Tests+for+Panels&panelId=' + panelId, {},
        -     function (data, status) {
        -       var testId;
        -       var testCheckbox;
        -       dataTable2.page.len(-1).draw();
        -       for (i = 0; i<data.length; i++) {
        -         testId = data[i].Id;
        -         testCheckbox = $('.testId[value="'+ testId +'"]').parent().siblings().children('.testSelect');
        -         if (checked == 1) {
        -           testCheckbox.prop('checked',true);
        -         } else {
        -           testCheckbox.prop('checked',false);
        -         }
        -       }
        -       dataTable2.page.len(10).draw();
        -
        -     }
        -   );
        - }
      script
        - var dataTable2;
        - var dataTable3;
        - var dataTable4;
        - $(document).ready(function(){
        -   $('.panelSelect').click( function() {
        -     panelId = $(this).parent().siblings().children('.panelId').val();
        -     selectTestsFromPanel(panelId, $(this).prop('checked'));
        -   });
        -   $('#checkall').click(function(){
        -   var checkval = $(this).is(':checked');
        -     $('.checkall').each(function() {
        -         $(this).attr('checked',checkval);
        -     $('.positive').attr('checked', false);
        -     });
        -   });
        -
        -   var dataTable4 = $('.drugTable').DataTable({ "pagingType": "full_numbers", "pageLength": 10,  "dom": 'lfrtip'});
        -   var dataTable = $('#medicationTable').DataTable();
        -   var dataTable1 = $('#rapidExamTable').DataTable();
        -   dataTable2 = $('#testTable').DataTable();
        -   dataTable3 = $('#panelTable').DataTable();
        -   dataTable1.page.len(-1).draw();
        -   $("#stepFormSubmitButton").click(function() {
        -       var fancyTable = $('#medicationTable').DataTable();
        -       fancyTable.destroy();
        -       fancyTable = $('#rapidExamTable').DataTable();
        -       fancyTable.destroy();
        -       fancyTable = $('#testTable').DataTable();
        -       fancyTable.destroy();
        -       fancyTable = $('#panelTable').DataTable();
        -       fancyTable.destroy();
        -       fancyTable = $('.drugTable').DataTable({ "pagingType": "full_numbers", "pageLength": 10,  "dom": 'lfrtip'});
        -       fancyTable.destroy();
        -   });
        - }); //End of Document Ready!!

      div
        id= report
        #   --------------------------------------------------------------------------------
        hr
        #   --------------------------------------------------------------------------------
        fieldset
          style= width: 810px;
          #             div
          # MEDICATIONS
          div
            style= width: 400px; float: left;
            class= currentMedications
            fieldset
              legend Current Medications/Individual Test(s) Ordered
                class= legend
              div
                vertical2
                  table
                    class= drugTable
                    id= medicationTable
                    style= width:290px;
                    sqlQuery~ SELECT
                      - d.name AS 'Drug Name'
                      - ,'' AS 'Prescribed'
                      - ,'' AS 'Order Test'
                      - , d.Id AS 'Hidden'
                      - FROM drugs d
                      - WHERE d.disabled = 0
                    columnSpecs~ drugList
                      allowChangedRecordIds
                      column 2
                        inputType checkbox
                      column 3
                        inputType checkbox
                      column 4
                        inputType text
                          class= hide
                          readonly=
                          style= border:none; background: transparent;
                          sql~ INSERT INTO reqCurrentMedications (reqId, drugId,prescribed, orderTest, eventId)
                            - SELECT {_eventId}
                            - , '{_columnInput:4}'
                            - , CASE WHEN '{_columnInput:2}' = 'true' then 1 else 0 end
                            - , CASE WHEN '{_columnInput:3}' = 'true' then 1 else 0 end
                            - , {_eventId}
                            - FROM dual
                            - WHERE '{_columnInput:2}' = 'true' or '{_columnInput:3}' = 'true'
              fieldset
                legend Options
                vertical
                  checkbox noDrugsProvided
                    screenLabel~ No Medications Provided
          # PANELS
          div
            style= width: 400px; float: left; clear: both;
            class= testPanels
            fieldset
              legend Panels
                class= legend
              div
                vertical
                  table
                    id= panelTable
                    class= drugTable
                    sqlQuery~ SELECT
                      - '' AS 'Select'
                      - , p.name AS 'Panel Name'
                      - , p.Id as 'Hidden'
                      - FROM testPanels p
                      - WHERE type = 'Toxicology'
                      - AND disabled = 0
                      - order by p.name
                    columnSpecs~ panelList
                      allowChangedRecordIds
                      column 1
                        inputType checkbox
                          class= selectField panelSelect
                          sqlPreparedStatement~ INSERT INTO reqTestPanels (reqId, panelId, eventId)
                            - SELECT ?, ?, ?
                            - FROM dual
                            - WHERE ? = 'true'
                            long {_eventId}
                            string {_columnInput:3}
                            long {_eventId}
                            string {_columnInput:1}
                      column 3
                        inputType text
                          class= hide panelId
                          readonly=
                          style= border:none; background: transparent;
          # TESTS
          div
            style= width: 400px; float: right;
            class= tests
            fieldset
              legend Individual Tests
                class= legend
              div
                vertical
                div
                  table tests
                    id= testTable
                    class= drugTable
                    sqlQuery~ SELECT
                      -   '' AS ''
                      -   , t.name AS 'Test Name'
                      -   , t.Id as 'Hidden'
                      - FROM tests t
                      - WHERE
                      - type = 'Toxicology'
#                       - and (testCode LIKE 'T___' or testCode in ('IMMU','VALI'))
                      - and disabled = 0
                      - order by t.name
                    columnSpecs~ testList
                      allowChangedRecordIds
                      column 1
                        inputType checkbox
                          class= selectField testSelect
                          sql~ INSERT INTO reqTests (reqId, testId, eventId)
                            - SELECT {_eventId}, '{_columnInput:3}', {_eventId}
                            - FROM dual
                            - WHERE '{_columnInput:1}' = 'true'
                      column 3
                        inputType text
                          class= hide testId
                          readonly=
                          style= border:none; background: transparent;

##########################################################################

    includeable testToxReqSQL
      ### update reqCurrentMedications
      sqlPreparedStatement update reqCurrentMedications set reqId = ? where eventId = ?
        string {_resultSet:reqId}
        long {_eventId}

      ### update rapidExamResults
      sqlPreparedStatement update rapidExamResults set reqId = ? where eventId = ?
        string {_resultSet:reqId}
        long {_eventId}

      ### update reqTestPanels table
      sqlPreparedStatement update reqTestPanels set reqId = ? where eventId = ?
        string {_resultSet:reqId}
        long {_eventId}

      ### update reqTests table
      sqlPreparedStatement update reqTests set reqId = ? where eventId = ?
        string {_resultSet:reqId}
        long {_eventId}

    ### update reqTests with the tests that are associated with the panels selected
#       forEach select panelId
#         - from reqTestPanels
#         - where eventId = {_eventId}
#         sql insert ignore into reqTests (reqId,testId,eventId)
#           - (select rf.Id,tfp.testId,{_eventId}
#           - from reqTestPanels rtp
#           - join testsForPanel tfp on tfp.panelId = rtp.panelId
#           - join requestForms rf on rf.eventId = {_eventId}
#           - where rtp.panelId = '{_resultSet:panelId}')
      ### check if no tests are selected
#       sql
#         - insert into reqRequiredFieldErrors (reqId, requiredFieldId, eventId)
#         - select '{_resultSet:reqId}', rfd.Id, {_eventId} from reqRequiredFieldDescriptions rfd
#         - left join reqTestPanels rt on rt.reqId = '{_resultSet:reqId}' and rt.eventId = {_eventId}
#         - where (rt.reqId is null and rfd.requiredField = 'testSelection')
#########################################################################################################


#################################################################

    includeable courtesyCopy
      div
        style= width:800px;
        fieldset
          legend COURTESY COPY
            class= legend toggle
          vertical
            id= courtesyCopy
            text copyTo
              screenLabel~ To
            text sendCourtesyTo
              screenLabel~ Via
                span Email/Fax

    includeable courtesyCopySQL
      sqlPreparedStatement
        - update requestForms
        - set copyTo = ?
        -   , sendCourtesyTo = ?
        - where id = ?
        string {copyTo}
        string {sendCourtesyTo}
        string {_resultSet:reqId}
#####################################################################
    includeable patientConsent
      div
        style= width:800px;
        fieldSet
          legend PATIENT CONSENT
            class= legend toggle
          vertical
            id= patConsent
            select consent
              screenLabel~
              required~ false
              setName~ yesno
              title= SETNAME:yesno

    includeable patConsentSQL
      sqlPreparedStatement
        - update requestForms
        - set consent = ?
        - where id = ?
        string {consent}
        string {_resultSet:reqId}
#######################################################################
    includeable accComments
      div
        style= width:800px;
        fieldset
          legend ADDITIONAL COMMENTS
            class= legend toggle
          vertical
            id= comments
            comments Comments
              screenLabel~
              style= width:500px;

    includeable accCommentsSQL
      sqlPreparedStatement
        - insert into containerNotes (containerId, noteType, note, eventId)
        - values (?,'accNotes',?,?)
        string {_resultSet:reqId}
        string {Comments}
        long {_eventId}

### Dummy Include
    includeable DummyInclude
      div
        id= dummyInclude
        style= display: none;

###

#######################################################################

    includeable fishForm0
      script
        src= js/fishForm0.js
      hidden dateFormat
        id= dateFormat
        value= {_dateShortFormat}

      div
        class= pageSection
        div
          class= sectionTitle
          span Specimens for: {_includeParm:nameOfStep}
        div
          class= sectionContent
          table
            class= formatDateTable
            sqlPreparedQuery~
              - SELECT DISTINCT
              -   CONCAT('<a href="/uniflow?lastForm=Y&stepName={_step}&recId=',sr.runId,'">',sr.currentContainerId,'</a>') AS 'Specimen ID',
              -   rf.requestId AS "Order Number",
              -   vV.displayValue AS "Order Priority",
              -   IFNULL(rf.mrn, '') AS "MRN",
              -   CONCAT(IFNULL(pa.firstName, ''), ' ', IFNULL(pa.lastName, '')) AS "Patient Name",
              -   CONCAT(s.storageContainerId, IF(s.location = 'storage', '', CONCAT(':', s.location))) AS "Storage Location",
              -   rs.specimenType AS "Specimen Type",
              -   t.name AS "Test",
              -   m.name AS "Method",
              -   DATE(e.eventDate) AS "Queue Date",
              -   e.userId AS "Queued By"
              - FROM queues q
              - INNER JOIN specimenRuns sr
              -   ON q.containerId = sr.runId
              - LEFT JOIN specimenMethods sm
              -   ON sr.specimenMethodsId = sm.id
              - LEFT JOIN requestSpecimens rs
              -   ON sm.requestSpecimensId = rs.id OR sr.currentContainerId = rs.specimenId
              - INNER JOIN requestForms rf
              -   ON rs.requestId = rf.requestId
              - LEFT JOIN tests t
              -   ON sm.testCode = t.testCode
              - LEFT JOIN methods m
              -   ON sm.methodCode = m.methodCode
              - INNER JOIN events e
              -   ON q.eventId = e.eventId
              - LEFT JOIN validValues vV
              -   ON vV.setName = 'priority' AND vV.value = rf.priority
              - LEFT JOIN patients pa
              -   ON pa.patientId = rf.patientId
              -   AND rs.patientId = pa.patientId
              - LEFT JOIN storage s
              -   ON s.content = sr.currentContainerId
              - WHERE q.step = ?
              string {_includeParm:nameOfStep}






    ### Audit Trail Include
    includeable AuditTrail
      ### PARAMETERS IN
      ###   SpecimenId -- pulls history based on specimenId
      ### PARAMETERS OUT
      ###   None
      link
        rel=  stylesheet
        href= css/dashboards/lookupSampleReport.css
      script
        src= js/auditTrail.js
      div
        class= sectionContent  verticalFlex
        table
          id= auditTrailTable
          sqlPreparedQuery~
            - SELECT
            -   CONCAT('</span><br/><span class="initialContainerId">', samp.containerId, '</span><span class="initialContainerType"> - ', CASE samp.containerType WHEN 'specimenId' THEN 'Specimen' WHEN 'aliquotId' THEN 'Aliquot' ELSE samp.containerType END)  AS "Initial Specimen",
            -   CASE ISNULL(samp.runId) WHEN 1 THEN 'Not in lab' ELSE CONCAT(IFNULL(p.name,''), ' ', IFNULL(t.name,''), ' ', IFNULL(m.name,'')) END AS "Assay",
            -   e.step AS "Step Name",
            -   date(e.eventDate) AS "Date",
            -   u.name AS "User",
            -   IFNULL(cont.containerTransfer, '<span class="noTransfer">no transfer</span>') AS "Transfer Containers",
            -   GROUP_CONCAT(DISTINCT CASE WHEN co2.containerType IN ('Reagent','Control','Consumable') THEN CONCAT(co2.containerId,' - ',CONCAT(CONCAT('<i>', CASE WHEN co2.containerType = 'Reagent' THEN r.reagentType WHEN co2.containerType = 'Control' THEN ctrl.controlType WHEN co2.containerType = 'Consumable' THEN con.consumableType END), '</i>')) ELSE '' END SEPARATOR '</br>') AS 'RESOURCES',
            -   GROUP_CONCAT(DISTINCT CASE WHEN co2.containerType = 'Instrument ID' THEN CONCAT(co2.containerId,' - ',CONCAT(CONCAT('<i>', i.instrumentType), '</i>')) ELSE '' END SEPARATOR '</br>') AS 'INSTRUMENTS'
            - FROM (
            -     select co.containerId, co.containerType, srh.runId, srh.specimenMethodsId, co.eventId
            -     FROM contents c
            -     INNER JOIN containers co
            -       ON c.containerId = co.containerId
            -     INNER JOIN specimenRunsHistory srh
            -       ON c.containerId = srh.currentContainerId
            -       AND srh.historyAction = 'INSERT'
            -     WHERE c.content = ?
            -       AND c.contentType = 'specimenId'
            -       AND (co.containerType = 'specimenId' OR co.containerType = 'aliquotId')
            -     UNION
            -     select distinct co.containerId, co.containerType, srh2.runId, srh2.specimenMethodsId, co.eventId
            -     from contents c
            -     INNER JOIN containers co
            -       ON c.containerId = co.containerId
            -     INNER JOIN specimenRunsHistory srh
            -       ON c.containerId = srh.currentContainerId
            -     INNER JOIN specimenRunsHistory srh2
            -       ON srh.id = srh2.parentWorkflowSpecimenRunId
            -       AND srh2.historyAction = 'INSERT'
            -     WHERE c.content = ?
            -       AND c.contentType = 'specimenId'
            -       AND (co.containerType = 'specimenId' OR co.containerType = 'aliquotId')
            -     UNION
            -     select distinct co.containerId, co.containerType, NULL, 0, co.eventId
            -     FROM contents c
            -     INNER JOIN containers co
            -       ON c.containerId = co.containerId
            -     LEFT JOIN specimenRunsHistory srh
            -       ON c.containerId = srh.currentContainerId
            -       AND srh.historyAction = 'INSERT'
            -     WHERE c.content = ?
            -       AND c.contentType = 'specimenId'
            -       AND (co.containerType = 'specimenId' OR co.containerType = 'aliquotId')
            -       AND srh.eventId IS NULL
            -    ) samp
            -   LEFT JOIN specimenMethods sm
            -     ON samp.specimenMethodsId = sm.id
            -   LEFT JOIN panels p
            -     ON sm.panelCode = p.panelCode
            -   LEFT JOIN tests t
            -     ON sm.testCode = t.testCode
            -   LEFT JOIN methods m
            -     ON sm.methodCode = m.methodCode
            -   LEFT JOIN containerHistory h
            -     ON samp.runId = h.containerId
            -   LEFT join events e
            -     on h.eventId = e.eventId
            -   LEFT join userInfo u
            -     ON e.userId = u.userId
            -   left join (
            -     select
            -       CONCAT('<span class="processingContainerId">', srh.currentContainerId , '</span><span class="processingContainerType"> - ', replace(co.containerType, 'Id', ' ID'), '</span>', IF(ISNULL(srh.currentParentId), '', CONCAT('<br /><span class="processingContainerId">', srh.currentParentId, ' loc: ',  IFNULL(srh.currentParentPosition,''), '</span><span class="processingContainerType"> - ', replace(co2.containerType, 'Id', ' ID'), '</span>'))) AS "containerTransfer",
            -       srh.runId, srh.lastUpdatedEventId, srh.currentContainerId
            -     FROM specimenRunsHistory srh
            -     inner join containers co
            -       on srh.currentContainerId = co.containerId
            -     left join containers co2
            -       on srh.currentParentId = co2.containerId
            -     inner join (
            -       select rh.runId, rh.lastUpdatedEventId, max(rh.historyId) AS "historyId"
            -       from specimenRunsHistory rh
            -       inner join contents c
            -         on rh.currentContainerId = c.containerId
            -       WHERE c.content = ?
            -       GROUP BY rh.runId, rh.lastUpdatedEventId  ) q
            -     ON srh.historyId = q.historyId
            -       and srh.lastUpdatedEventId = q.lastUpdatedEventId
            -       and srh.runId = q.runId
            -     WHERE CASE srh.runType WHEN 'workflow' THEN srh.historyAction = 'UPDATE' ELSE srh.historyAction IN ('INSERT', 'UPDATE') END) cont
            -   on e.eventId = cont.lastUpdatedEventId
            -  LEFT JOIN resourceHistory rh ON e.eventId = rh.eventId
            -  LEFT JOIN containers co2 ON rh.containerId = co2.containerId
            -  LEFT JOIN instruments i ON rh.containerId = i.instrumentId
            -  LEFT JOIN reagents r ON rh.containerId = r.reagentId
            -  LEFT JOIN controls ctrl ON rh.containerId = ctrl.controlId
            -  LEFT JOIN consumables con ON rh.containerId = con.consumableId
            - GROUP BY e.eventId, samp.containerId, cont.containerTransfer
            - ORDER BY samp.eventId, samp.containerId, e.eventId
            string {_includeParm:specimenId}
            string {_includeParm:specimenId}
            string {_includeParm:specimenId}
            string {_includeParm:specimenId}
